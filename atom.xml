<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2024-02-02T05:02:59.814Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Microsoft Graph PowerShell SDK への移行について 6_ロール割り当て</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement6/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement6/</id>
    <published>2024-01-21T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.814Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの小出です。</p><p>この記事は、MSOnline / AzureAD モジュール廃止について、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/">1. 概要編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">2. 移行導入編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">3. インストール・接続編</a> の続きとして連載しています。<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/">4. ではユーザーに関する操作</a> を、 <a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement5/">5. ではグループに関する操作</a> についておまとめしましたので、今回の 6. では、Microsoft Entra (Azure AD) ロールの管理について情報をまとめました。</p><p>まだ Microsoft Graph PowerShell SDK モジュールをインストールしていない場合や、Connect-MgGraph コマンドを使用した接続方法が分からない場合などは、本シリーズの 2. と 3. をご確認ください。</p><p>なお、下記にはいくつか簡易的なスクリプトの案内などもございますが、こちらのカスタマイズに関するお問い合わせは承っておりません。あくまでもサンプルとなりますので参考として利用いただき、カスタマイズにつきましてはお客様自身で実施くださいますようお願い申し上げます。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>ロールの管理については、Microsoft Entra Premium P2 もしくは Microsoft Entra ID Governance ライセンスをお持ちかどうかで、推奨される Graph API が変わります。この記事をご覧になる前に、まずは Azure ポータルにサインインし、Microsoft Entra ID を開いた下記画面の表示をご確認ください。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-1.png"></p><p>上記画面の表示内容によって、下記のように本記事をご利用ください。ライセンスによって推奨する項目が違う理由は、Microsoft Entra ID P2 以上をお持ちの場合、PIM の機能を活用できるためです。P2 ライセンスをお持ちでも Free や P1 ライセンスで提供されている API を利用することは可能ですが、これらの API では PIM で提供される「資格のある割り当て」および「期限付きの割り当て」といった情報を取得できません。このため、P2 ライセンスをお持ちのお客様には、機能をフル活用するために PIM 用の API を利用したロール管理をお勧めします。</p><table><thead><tr><th>表示されているライセンス名</th><th>確認いただきたい本記事の章と関連する Graph API ドキュメントへのリンク</th></tr></thead><tbody><tr><td>Microsoft Entra ID Free</td><td><a href="https://learn.microsoft.com/ja-JP/entra/identity/role-based-access-control/custom-assign-graph">ロール管理用 API を利用したロール管理</a></td></tr><tr><td>Microsoft Entra ID P1</td><td><a href="https://learn.microsoft.com/ja-JP/entra/identity/role-based-access-control/custom-assign-graph">ロール管理用 API を利用したロール管理</a></td></tr><tr><td>Microsoft Entra ID P2</td><td><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagementv3-overview?view=graph-rest-1.0">PIM 用 API を利用したロール管理</a></td></tr></tbody></table><h2 id="ロール管理用-API-を利用したロール管理"><a href="#ロール管理用-API-を利用したロール管理" class="headerlink" title="ロール管理用 API を利用したロール管理"></a>ロール管理用 API を利用したロール管理</h2><p>以下に、よくあるロール管理コマンドについて紹介いたします。API の詳細について確認されたい場合は、 <a href="https://learn.microsoft.com/ja-jp/graph/api/resources/rolemanagement?view=graph-rest-1.0">roleManagement リソースの種類 - Microsoft Graph v1.0</a> の公開情報の配下に、各 API の詳細について記載がありますのでそちらをご覧ください。</p><h3 id="1-1-Microsoft-Entra-ID-ロールの-roledefinitionID-と名前の一覧を取得したい"><a href="#1-1-Microsoft-Entra-ID-ロールの-roledefinitionID-と名前の一覧を取得したい" class="headerlink" title="1-1. Microsoft Entra ID ロールの roledefinitionID と名前の一覧を取得したい"></a>1-1. Microsoft Entra ID ロールの roledefinitionID と名前の一覧を取得したい</h3><p>Get-MgRoleManagementDirectoryRoleDefinition コマンドを実行することで、ロール定義の表示名、 ID、テンプレート ID (roledefinitionid)、説明などが表示されます。このコマンドで取得できる TemplateID はどのテナントも同じ共通した値となります。ただし、カスタム ロールはそのテナントに固有のロールとなりますため、ID やテンプレート ID は各テナントで独自の値となります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-2.png"></p><h3 id="2-1-グローバル管理者ロールを持っているユーザーを取得したい"><a href="#2-1-グローバル管理者ロールを持っているユーザーを取得したい" class="headerlink" title="2-1. グローバル管理者ロールを持っているユーザーを取得したい"></a>2-1. グローバル管理者ロールを持っているユーザーを取得したい</h3><p>以下のコマンドを利用すると、グローバル管理者 (テンプレート ID: 62e90394-69f5-4237-9190-012177145e10) ロールを持つユーザーを一覧することができます。この 62e9 から始まる ID が、グローバル管理者ロールを示しています。この 62e9 から始まる ID は、どのテナントでも共通するテンプレート ID です。そのため、下記コマンドをそのまま実行すれば、下記のようにグローバル管理者ロールを持っているユーザーを取得可能です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-3.png"></p><p>なお、この例の場合、PrincipalID にユーザーの ObjectID が表示されておりますが、一見誰にロールが割り当てられているかが分かりにくいと思います。上記コマンドでは ExpandProperty オプションを利用して、 principal の中身 (ロールが割り当てられているユーザーなどの情報が格納されている) を取得していますので、中身を展開するようにコマンドを記載すれば、オブジェクト ID ではない値を表示することが可能です。例えば以下では、グローバル管理者ロールを持つユーザーの UserPrincipalName のみ取得するようなコマンドにしています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span>).principal.additionalproperties.userPrincipalName</span><br></pre></td></tr></table></figure><p>上記を実行すると、以下のような結果が返され、誰にロールがあるのかすぐに判断いただけます。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-4.png"></p><h3 id="2-2-何かしらのロールを持っているユーザーを取得したい"><a href="#2-2-何かしらのロールを持っているユーザーを取得したい" class="headerlink" title="2-2. 何かしらのロールを持っているユーザーを取得したい"></a>2-2. 何かしらのロールを持っているユーザーを取得したい</h3><p>以下のように実行することで何かしらのロールを持っているユーザーを取得できます。まずすべてのロール割り当てを取得し、上記例と同様に UPN のみを取得します。パイプ（|）の左側だけですと、1 人のユーザーが 2 つ以上のロールを保持している場合に、同じ UPN が 2 回以上結果に含まれてしまいます。そのため、Sort-Object にてUPN 一覧を並び替え、重複を排除するために Get-Unique を利用しています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).principal.additionalproperties.userPrincipalName | <span class="built_in">Sort-Object</span> | <span class="built_in">Get-Unique</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-5.png"></p><h3 id="2-3-特定のカスタム-ロールを持っているユーザーを取得したい"><a href="#2-3-特定のカスタム-ロールを持っているユーザーを取得したい" class="headerlink" title="2-3. 特定のカスタム ロールを持っているユーザーを取得したい"></a>2-3. 特定のカスタム ロールを持っているユーザーを取得したい</h3><p>まずはカスタム ロール一覧から、特定のカスタム ロールの ID 取得します。その後、2-1 と同様に ID を指定して実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.isBuiltIn <span class="operator">-eq</span> <span class="variable">$false</span>&#125;</span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;6be2f6bb-cfc4-48df-8beb-51a538ec1cdf&#x27;&quot;</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span>).principal.additionalproperties.userPrincipalName</span><br></pre></td></tr></table></figure><p>もし、特定のカスタム ロールではなく、カスタム ロールのいずれかを持っているユーザーを一括して抽出したい場合は、下記が便利です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">in</span> <span class="variable">$customrole</span>)&#123;(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span>  <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span> <span class="literal">-All</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roleDefinitionId <span class="operator">-eq</span> <span class="variable">$a</span>&#125;).principal.additionalproperties.userPrincipalName&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-何かしらのロールを持っているゲスト-ユーザーを取得したい"><a href="#2-4-何かしらのロールを持っているゲスト-ユーザーを取得したい" class="headerlink" title="2-4. 何かしらのロールを持っているゲスト ユーザーを取得したい"></a>2-4. 何かしらのロールを持っているゲスト ユーザーを取得したい</h3><p>2-2 のコマンドと似ていますが、違いは「ゲスト ユーザーのみ」に絞り込む点です。2-2 のコマンドを実行すると、何かしらのロールを保持しているユーザーの UPN 一覧を取得できます。ゲスト ユーザーの場合、UPN には #EXT# という値が含まれる特徴があるので、こちらをキーワードにゲスト ユーザーを抽出します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).principal.additionalproperties.userPrincipalName | <span class="built_in">Sort-Object</span> | <span class="built_in">Get-Unique</span> | <span class="built_in">where-object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;*#EXT#*&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="3-新しいロール割り当ての作成"><a href="#3-新しいロール割り当ての作成" class="headerlink" title="3. 新しいロール割り当ての作成"></a>3. 新しいロール割り当ての作成</h3><p>PrincipalID に取得したいユーザーの ObjectID を指定します。 Roledefinitionid には、付与したいロールのテンプレート ID を指定します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleAssignment&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;62e90394-69f5-4237-9190-012177145e10&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;0b3cc095-ad6f-40cc-982f-7c71a2cf9bc7&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-6.png"></p><h3 id="4-既存のロール割り当ての削除"><a href="#4-既存のロール割り当ての削除" class="headerlink" title="4. 既存のロール割り当ての削除"></a>4. 既存のロール割り当ての削除</h3><p>上記 2-1 のように、Get-MgRoleManagementDirectoryRoleAssignment コマンドを取得して、削除したいロール割り当ての ID を取得します。この ID はテナントごと、割り当てごとに異なるため、事前に割り当て一覧を取得して ID を確認する必要があります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-7.png"></p><p>そのうえで、下記のようにコマンドを実行し、ロールの割り当てを削除します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Remove-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-UnifiedRoleAssignmentId</span> oz6hWDLGrkae4JwNQ81_Peq74fvkTYBMiWoJNnv0Wyk<span class="literal">-1</span></span><br></pre></td></tr></table></figure><h3 id="5-新しいカスタム-ロールの作成"><a href="#5-新しいカスタム-ロールの作成" class="headerlink" title="5. 新しいカスタム ロールの作成"></a>5. 新しいカスタム ロールの作成</h3><p><a href="https://learn.microsoft.com/ja-jp/graph/api/rbacapplication-post-roledefinitions?view=graph-rest-1.0&tabs=http">roleDefinitions を作成する - Microsoft Graph v1.0</a> の手順を用いて、ロールの定義を作成します。カスタム ロールの名前を displayName、説明を description に記載し、実際に許可したいアクセス権を rolePermissions 内に記載します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    description = <span class="string">&quot;Update basic properties of application registrations&quot;</span></span><br><span class="line">    displayName = <span class="string">&quot;Application Registration Support Administrator&quot;</span></span><br><span class="line">    rolePermissions = <span class="selector-tag">@</span>(</span><br><span class="line">        <span class="selector-tag">@</span>&#123;</span><br><span class="line">            allowedResourceActions = <span class="selector-tag">@</span>(</span><br><span class="line">                <span class="string">&quot;microsoft.directory/applications/basic/read&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    isEnabled = <span class="variable">$true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h2 id="ロール管理用-API-を利用したサンプル-スクリプト"><a href="#ロール管理用-API-を利用したサンプル-スクリプト" class="headerlink" title="ロール管理用 API を利用したサンプル スクリプト"></a>ロール管理用 API を利用したサンプル スクリプト</h2><p>上記コマンドを利用したサンプル スクリプトを以下に案内します。改めまして、スクリプトの代理作成やカスタマイズ、スクリプト自体のデバッグなどの支援は弊社サポートでは承っておりませんので、あらかじめご了承ください。下記のようなお問い合わせであればご支援可能ですので、その際は事前に切り分けや動作確認などを実施のうえ、一問一答形式にてお問い合わせを発行ください。</p><ul><li>スクリプトの中で「ユーザーを取得する」コマンドとして Get-MgUser が記載されているが、これをゲストのみにしたい場合はどうしたらいいか (Get-Mguser のフィルターの使い方など、Graph API クエリもしくはコマンドの記載方法についての一問一答のご質問)。</li><li>スクリプトを実行するとエラーになってしまう。切り分けとしてコマンド単体でも実行したが同じエラーになった (スクリプトではなく、コマンドの動作に関するトラブル シューティング)。</li></ul><p>Graph PowerShell コマンドで取得した内容を CSV に出力させたいというご要望がよくございますので、今回は結果を CSV に出力するサンプルを以下に紹介いたします。以下ではオブジェクトに対するロール割り当てを取得し、割り当てられているオブジェクトの表示名、ID、ロールの名前を CSV に出力します。また、後半部分では、下記公開情報にて案内のある「特権としてみなされるロールに対し割り当てを持っているユーザーについて、その数を確認し、多すぎる場合には削減する」旨の推奨メッセージを出しています。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/privileged-roles-permissions?tabs=ms-powershell">Microsoft Entra ID の特権を持つロールとアクセス許可 (プレビュー) - Microsoft Entra ID</a></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 全特権ロールの割り当て一覧を取得して、ロール名と併せて CSV に出力する。</span></span><br><span class="line"><span class="variable">$data</span> = <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$data</span> += <span class="string">&quot;asignee,asignee-objectid,rolename&quot;</span></span><br><span class="line"><span class="variable">$result</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleAssignment</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;Principal&quot;</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinition/isPrivileged eq true&quot;</span> <span class="literal">-All</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$n</span> <span class="keyword">in</span> <span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="variable">$displayname</span> = <span class="variable">$n</span>.principal.additionalProperties.displayName</span><br><span class="line">    <span class="variable">$objectID</span> = <span class="variable">$n</span>.principalID</span><br><span class="line">    <span class="variable">$rolename</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$n</span>.RoleDefinitionId).displayname</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> += <span class="variable">$displayname</span> + <span class="string">&quot;,&quot;</span> + <span class="variable">$objectID</span> + <span class="string">&quot;,&quot;</span> + <span class="variable">$rolename</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$outfile</span> = <span class="string">&quot;C:\Work\roleassginment.csv&quot;</span></span><br><span class="line"><span class="variable">$data</span> | <span class="built_in">Out-File</span> <span class="variable">$outfile</span> <span class="literal">-encoding</span> <span class="string">&quot;utf8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 特権ロール扱いのロールについて、それぞれ割り当てが 10 以上なら画面に削減するよう表示する。</span></span><br><span class="line"><span class="variable">$privadmins</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleDefinition</span> <span class="literal">-Filter</span> <span class="string">&quot;isPrivileged eq true&quot;</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$priv</span> <span class="keyword">in</span> <span class="variable">$privadmins</span>) &#123;</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$priv</span>.id</span><br><span class="line">    <span class="variable">$count</span> = ( <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roledefinitionid <span class="operator">-eq</span> <span class="variable">$id</span>&#125;).count</span><br><span class="line">    <span class="keyword">If</span>(<span class="variable">$count</span> <span class="operator">-ge</span> <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="variable">$role_displayname</span> = <span class="variable">$priv</span>.displayname</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$role_displayname</span> の管理者数が多すぎます。推奨は 10 人以下（グローバル管理者は 5 人以下）です。現在の数は <span class="variable">$count</span> です。先に出力した CSV を利用して、ロールが割り当てられているユーザーを確認し、削減を検討してください。&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CSV 結果</strong></p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-8.png"></p><p><strong>表示メッセージの例</strong></p><p>User Administrator の管理者数が多すぎます。推奨は 10 人以下（グローバル管理者は 5 人以下）です。現在の数は 11 です。先に出力した CSV を利用して、ロールが割り当てられているユーザーを確認し、削減を検討してください。</p><h2 id="PIM-用-API-を利用したロール管理"><a href="#PIM-用-API-を利用したロール管理" class="headerlink" title="PIM 用 API を利用したロール管理"></a>PIM 用 API を利用したロール管理</h2><p>PIM を利用したよくあるロール管理コマンドについて以下に紹介いたします。API の詳細について確認されたい場合は、<a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagementv3-overview?view=graph-rest-1.0">特権 ID 管理 (PIM) API を使用してMicrosoft Entraロールの割り当てを管理する - Microsoft Graph v1.0</a> の公開情報の配下に、各 API の詳細について記載がありますのでそちらをご覧ください。</p><p>アクティブな割り当て (Active Assignments) に関する操作と、資格のある割り当て (Eligible Assignments) で API やコマンドが異なるため、コマンドを探す際にはまず、「今操作したい割り当ての種類はどちらか？」を明確にして、該当する情報を探していくようにすると便利です。</p><h3 id="1-1-PIM-でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい"><a href="#1-1-PIM-でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい" class="headerlink" title="1-1. PIM でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい"></a>1-1. PIM でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい</h3><p>資格のある割り当てとアクティブな割り当てでコマンドが異なるため、2 つコマンドを実行する必要がありますが、下記にて取得可能です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 資格のある割り当てを持っているグローバル管理者を取得する。</span></span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;RoleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> Principal).principal.AdditionalProperties.userPrincipalName</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># アクティブな割り当てを持っているグローバル管理者を取得する。</span></span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;RoleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> Principal).principal.AdditionalProperties.userPrincipalName</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-9.png"></p><h3 id="1-2-PIM-で何かしらのロールを持っているユーザーを全員取得したい"><a href="#1-2-PIM-で何かしらのロールを持っているユーザーを全員取得したい" class="headerlink" title="1-2. PIM で何かしらのロールを持っているユーザーを全員取得したい"></a>1-2. PIM で何かしらのロールを持っているユーザーを全員取得したい</h3><p>1-1 に記載されているコマンドを活用して取得できます。1-1 のコマンドでは -filter オプションの後ろで「グローバル管理者のテンプレート ID を持っている」という条件を記載しておりましたので、この部分を削除すれば何かしらのロールを持っているユーザーを全員取得できます。見やすいようにロールの名前とユーザーの UPN を取得するような構成にしました。</p><p>アプリケーションにロールを割り当てている場合、アクティブな割り当てを取得するコマンドを利用すると UPN 部分が空白として表示されます (アプリケーションは UPN を持たないため)。userPrincipalName の代わりに displayName を使用すると、アプリおよびユーザーともに表示名があるため空白なく情報を取得することができます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 何かしらの資格のある割り当てを持っているユーザーを取得する。</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 何かしらのアクティブな割り当てを持っているユーザーを取得する。</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-10.png"></p><h3 id="1-3-PIM-で資格のある割り当てを持っているユーザーのみ取得したい"><a href="#1-3-PIM-で資格のある割り当てを持っているユーザーのみ取得したい" class="headerlink" title="1-3. PIM で資格のある割り当てを持っているユーザーのみ取得したい"></a>1-3. PIM で資格のある割り当てを持っているユーザーのみ取得したい</h3><p>何らかの資格のある割り当てをもっているユーザー一覧のみ取得したい場合は、下記を利用できます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$user</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).Principal.AdditionalProperties.userPrincipalName</span><br><span class="line"><span class="variable">$user</span> | <span class="built_in">sort-object</span> | <span class="built_in">Get-Unique</span></span><br></pre></td></tr></table></figure><h3 id="1-4-PIM-でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい"><a href="#1-4-PIM-でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい" class="headerlink" title="1-4. PIM でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい"></a>1-4. PIM でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい</h3><p>EndDatetime に指定されている日付をベースに、もうすぐ割り当てが終了を迎えるユーザーとロールの情報を取得することができます。資格のある割り当てとアクティブな割り当てでコマンドが異なりますが、実行方法は同じです。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 資格のある割り当て</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal | <span class="built_in">Where</span> &#123;<span class="variable">$_</span>.EndDateTime <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.EndDateTime <span class="operator">-lt</span> <span class="string">&quot;2024/1/30 0:00:00&quot;</span>&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">        endDatetime = <span class="variable">$b</span>.enddatetime</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># アクティブな割り当て</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal | <span class="built_in">Where</span> &#123;<span class="variable">$_</span>.EndDateTime <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.EndDateTime <span class="operator">-lt</span> <span class="string">&quot;2024/1/30 0:00:00&quot;</span>&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span>=<span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span>= (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">        endDatetime = <span class="variable">$b</span>.enddatetime</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-11.png"></p><h3 id="2-PIM-で資格のある割り当てをユーザーに割り当てる-期限付き"><a href="#2-PIM-で資格のある割り当てをユーザーに割り当てる-期限付き" class="headerlink" title="2. PIM で資格のある割り当てをユーザーに割り当てる (期限付き)"></a>2. PIM で資格のある割り当てをユーザーに割り当てる (期限付き)</h3><p>以下のように実行して割り当てます。PrincipalID には割り当てるユーザーなどの ObjectID を指定し、割り当てたいロールのテンプレート ID を roleDefinitionId に指定します。期限付きにしたい場合は、expiration 内の enddatetime に終了したい日付を記載します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;adminAssign&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Assign Groups Admin to IT Helpdesk group&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;fdd7a751-b60b-444a-984c-02652fe8fa1c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;717d0ac2-c100-466c-aa19-c1ca506dbf77&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-10T00:00:00Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;afterDateTime&quot;</span></span><br><span class="line">            endDatetime = <span class="string">&quot;2023-12-18T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleEligibilityScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h3 id="3-PIM-でアクティブな割り当てをユーザーに割り当てる-期限付き"><a href="#3-PIM-でアクティブな割り当てをユーザーに割り当てる-期限付き" class="headerlink" title="3. PIM でアクティブな割り当てをユーザーに割り当てる (期限付き)"></a>3. PIM でアクティブな割り当てをユーザーに割り当てる (期限付き)</h3><p>以下のように実行して割り当てることができます。PrincipalID には割り当てるユーザーなどの ObjectID を指定し、割り当てたいロールのテンプレート ID を roleDefinitionId に指定します。期限付きにしたい場合は、expiration 内 enddatetime に終了したい日付を記載します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;adminAssign&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Assign Groups Admin to IT Helpdesk group&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;fdd7a751-b60b-444a-984c-02652fe8fa1c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;717d0ac2-c100-466c-aa19-c1ca506dbf77&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-10T00:00:00Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;afterDateTime&quot;</span></span><br><span class="line">            endDatetime = <span class="string">&quot;2023-12-18T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-12.png"></p><h3 id="4-PIM-でユーザーが自身でロールのアクティブ化を行う"><a href="#4-PIM-でユーザーが自身でロールのアクティブ化を行う" class="headerlink" title="4. PIM でユーザーが自身でロールのアクティブ化を行う"></a>4. PIM でユーザーが自身でロールのアクティブ化を行う</h3><p>下記公開情報の例 5. に記載のように PowerShell コマンドを実行すればユーザーが自身でロールのアクティブ化を行うことが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/graph/tutorial-assign-azureadroles?tabs=powershell#request-3">Microsoft Graph で Privileged Identity Management (PIM) API を使用して Azure AD ロールを割り当てる</a></p><p>下記 principalID にはアクティブ化を行うユーザー自身の ID を指定し、roleDefinitionID には、アクティブ化するロールのテンプレート ID を指定ください。また、理由については justification の項目を利用いただけます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> RoleAssignmentSchedule.ReadWrite.Directory</span><br><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;SelfActivate&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;3796e4df-bf11-4b99-9be7-c65c63dfe9a6&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;a9ea8996-122f-4c74-9520-8edcd192826c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Need to invalidate all app refresh tokens for Contoso users.&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-14T00:12:00.000Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;AfterDuration&quot;</span></span><br><span class="line">            duration = <span class="string">&quot;PT5H&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ticketInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        ticketNumber = <span class="string">&quot;CONTOSO:Security-012345&quot;</span></span><br><span class="line">        ticketSystem = <span class="string">&quot;Contoso ICM&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h3 id="5-PIM-の申請を承認する"><a href="#5-PIM-の申請を承認する" class="headerlink" title="5. PIM の申請を承認する"></a>5. PIM の申請を承認する</h3><p>下記のように実行することで、アクティブ化要求を PowerShell から承認することが可能です。reviewResult にて Approve と記載し、justification には承認する理由を記載してコマンドを実行してください。</p><p>なお、このコマンドは beta バージョンのコマンドが利用されておりますので、予告なくコマンドの動作に変更が加わることがございます。運用環境での利用は推奨しておりませんが、利用の際はご留意ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> RoleAssignmentSchedule.ReadWrite.Directory,PrivilegedAccess.ReadWrite.AzureAD</span><br><span class="line"></span><br><span class="line"><span class="built_in">Import-Module</span> Microsoft.Graph.Identity.Governance</span><br><span class="line"><span class="built_in">Import-Module</span> Microsoft.Graph.Beta.Identity.Governance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 現在承認待ちの有効化の要求を取得する。</span></span><br><span class="line"><span class="variable">$pendingApprovalRequest</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-Filter</span> <span class="string">&quot;(status eq &#x27;PendingApproval&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 現在承認待ちの有効化の要求を一覧する。</span></span><br><span class="line"><span class="variable">$pendingApprovalRequest</span> | <span class="built_in">Format-List</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$roleApproval</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleAssignmentApproval</span> <span class="literal">-ApprovalId</span> <span class="variable">$pendingApprovalRequest</span>.ApprovalId</span><br><span class="line"></span><br><span class="line"><span class="comment"># 承認する旨と、その理由についてここで指定する。</span></span><br><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    reviewResult = <span class="string">&quot;Approve&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;I approve this request&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 承認処理を行う。</span></span><br><span class="line"><span class="built_in">Update-MgBetaRoleManagementDirectoryRoleAssignmentApprovalStep</span> <span class="literal">-ApprovalId</span> <span class="variable">$roleApproval</span>.Id <span class="literal">-ApprovalStepId</span> <span class="variable">$roleApproval</span>.Steps.Id <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h2 id="PIM-用の-API-を利用したロール管理のサンプル-スクリプト"><a href="#PIM-用の-API-を利用したロール管理のサンプル-スクリプト" class="headerlink" title="PIM 用の API を利用したロール管理のサンプル スクリプト"></a>PIM 用の API を利用したロール管理のサンプル スクリプト</h2><p>上記コマンドを利用したサンプル スクリプトを以下に案内いたします。改めまして恐れ入りますが、スクリプトの代理作成やカスタマイズ、スクリプト自体のデバッグなどの支援は弊社サポートでは承っておりませんのでご了承ください。今回は、PIM に関するお問い合わせでよくご質問をいただく、Entra ロールと Azure ロールの PIM 設定を一括で変更するスクリプトをそれぞれ記載します。</p><h3 id="Microsoft-Entra-ロール"><a href="#Microsoft-Entra-ロール" class="headerlink" title="Microsoft Entra ロール"></a>Microsoft Entra ロール</h3><p>割り当ての最大期間は「資格のある割り当て」が 1 年、「アクティブな割り当て」が半年になっていますが、以下の例ではこれらを 2 年にするよう全ロールのポリシーを一括で更新します。ポータル上では 2 年の表示がされないため、下記のように - になりますが正しく動作します。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-13.png"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Azure AD に接続する。</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> RoleManagement.ReadWrite.Directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure AD ロール用のポリシーをすべて取得する。</span></span><br><span class="line"><span class="variable">$PolicyList</span>=<span class="built_in">Get-MgPolicyRoleManagementPolicy</span> <span class="literal">-Filter</span> <span class="string">&quot;scopeId eq &#x27;/&#x27; and scopeType eq &#x27;DirectoryRole&#x27;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># どのようなポリシーの更新を行いたいか指定します。  </span></span><br><span class="line"><span class="comment"># 資格のある割り当てのポリシーを更新し、割り当ての最大期間を 2 年（730 日）にする。</span></span><br><span class="line"><span class="variable">$params1</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleManagementPolicyExpirationRule&quot;</span></span><br><span class="line">    id = <span class="string">&quot;Expiration_Admin_Eligibility&quot;</span></span><br><span class="line">    isExpirationRequired = <span class="string">&quot;false&quot;</span></span><br><span class="line">    maximumDuration = <span class="string">&quot;P730D&quot;</span></span><br><span class="line">    target = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;microsoft.graph.unifiedRoleManagementPolicyRuleTarget&quot;</span></span><br><span class="line">        caller = <span class="string">&quot;Admin&quot;</span></span><br><span class="line">        operations = <span class="selector-tag">@</span>(</span><br><span class="line">            <span class="string">&quot;All&quot;</span></span><br><span class="line">        )</span><br><span class="line">        level = <span class="string">&quot;Eligibility&quot;</span></span><br><span class="line">        inheritableSettings = <span class="selector-tag">@</span>()</span><br><span class="line">        enforcedSettings = <span class="selector-tag">@</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># アクティブな割り当てのポリシーを更新し、割り当ての最大期間を 2年（730 日）にする。</span></span><br><span class="line"><span class="variable">$params2</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleManagementPolicyExpirationRule&quot;</span></span><br><span class="line">    id = <span class="string">&quot;Expiration_Admin_Assignment&quot;</span></span><br><span class="line">    isExpirationRequired = <span class="string">&quot;false&quot;</span></span><br><span class="line">    maximumDuration = <span class="string">&quot;P730D&quot;</span></span><br><span class="line">    target = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;microsoft.graph.unifiedRoleManagementPolicyRuleTarget&quot;</span></span><br><span class="line">        caller = <span class="string">&quot;Admin&quot;</span></span><br><span class="line">        operations = <span class="selector-tag">@</span>(</span><br><span class="line">            <span class="string">&quot;All&quot;</span></span><br><span class="line">        )</span><br><span class="line">        level = <span class="string">&quot;Assignment&quot;</span></span><br><span class="line">        inheritableSettings = <span class="selector-tag">@</span>()</span><br><span class="line">        enforcedSettings = <span class="selector-tag">@</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Foreach</span> (<span class="variable">$policy</span> <span class="keyword">in</span> <span class="variable">$policylist</span>) &#123;</span><br><span class="line">    <span class="comment"># 資格のある割り当てのポリシー更新</span></span><br><span class="line">    <span class="built_in">Update-MgPolicyRoleManagementPolicyRule</span> <span class="literal">-UnifiedRoleManagementPolicyId</span> <span class="variable">$policy</span>.Id <span class="literal">-UnifiedRoleManagementPolicyRuleId</span> Expiration_Admin_Eligibility <span class="literal">-BodyParameter</span> <span class="variable">$params1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># アクティブな割り当てのポリシー更新</span></span><br><span class="line">    <span class="built_in">Update-MgPolicyRoleManagementPolicyRule</span> <span class="literal">-UnifiedRoleManagementPolicyId</span> <span class="variable">$policy</span>.Id <span class="literal">-UnifiedRoleManagementPolicyRuleId</span> Expiration_Admin_Assignment <span class="literal">-BodyParameter</span> <span class="variable">$params2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Azure-ロール"><a href="#Azure-ロール" class="headerlink" title="Azure ロール"></a>Azure ロール</h2><p>下記ハイライト部分をすべて “いいえ” にするスクリプトです。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-14.png"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># サブスクリプション ID とテナント ID を指定する。</span></span><br><span class="line"><span class="variable">$subscriptionId</span> = <span class="string">&quot;2ef5f4f0-e4ef-42b0-85fb-d0f5c05ee8f3&quot;</span></span><br><span class="line"><span class="variable">$tenantId</span> = <span class="string">&quot;9a6678e4-6449-45a6-81d8-97c1b4c50edd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure AD へ接続する。</span></span><br><span class="line"><span class="built_in">Connect-AzAccount</span> <span class="literal">-Tenant</span> <span class="variable">$tenantId</span> <span class="literal">-Subscription</span> <span class="variable">$subscriptionId</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure ロール一覧の名前を取得する。</span></span><br><span class="line"><span class="variable">$Roles</span>=(<span class="built_in">Get-AzRoleDefinition</span>).name</span><br><span class="line"></span><br><span class="line"><span class="comment"># スコープを指定する。</span></span><br><span class="line"><span class="variable">$scope</span> =<span class="string">&quot;/providers/Microsoft.Subscription/subscriptions/<span class="variable">$subscriptionId</span>/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#スコープを指定 (リソース グループのスコープの場合) する。</span></span><br><span class="line"><span class="comment">#$resourceGroup = &quot;testnet0717-RG&quot;</span></span><br><span class="line"><span class="comment">#$scope = &quot;/providers/Microsoft.Subscription/subscriptions/$subscriptionId/resourceGroups/$resourceGroup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実際に変更したい設定を記載する。</span></span><br><span class="line"><span class="comment"># 資格のある割り当てのみ永続を許可したい場合。</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;rules&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: false,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P365D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Eligibility&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Eligibility&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 資格のある割り当て・アクティブな割り当ての双方を永続拒否したい（必ず期限を指定する）場合。</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;rules&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P365D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Eligibility&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Eligibility&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P180D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Assignment&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Assignment&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 設定変更の処理を行う。</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rolename</span> <span class="keyword">in</span> <span class="variable">$roles</span>)&#123;</span><br><span class="line">    <span class="variable">$roleId</span> = (<span class="built_in">Get-AzRoleDefinition</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.Name <span class="operator">-eq</span> <span class="variable">$roleName</span>&#125;).Id</span><br><span class="line">    <span class="variable">$roleDefinitionId</span> = <span class="string">&quot;/subscriptions/<span class="variable">$subscriptionId</span>/providers/Microsoft.Authorization/roleDefinitions/<span class="variable">$roleId</span>&quot;</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="string">&quot;<span class="variable">$scope</span>/providers/Microsoft.Authorization/roleManagementPolicyAssignments?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$properties</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).value.properties</span><br><span class="line">    <span class="variable">$roleProperty</span> = <span class="variable">$properties</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roleDefinitionId <span class="operator">-eq</span> <span class="variable">$roleDefinitionId</span>&#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># PolicyID が必要になるので控える。</span></span><br><span class="line">    <span class="variable">$policyId</span> = <span class="variable">$roleProperty</span>.policyId</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># PolicyID を組み込んだ URL を指定する。</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$rules</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).properties.rules</span><br><span class="line">      </span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> PATCH <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span> <span class="literal">-Payload</span> <span class="variable">$payload</span></span><br><span class="line">    <span class="variable">$newResult</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$newRules</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).properties.rules</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;この記事は、MSOnline / AzureAD モジュール廃止について、&lt;a href=&quot;https://jpazureid.github.io/blog/azure-active-d</summary>
      
    
    
    
    
    <category term="Microsoft Graph PowerShell SDK" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph-PowerShell-SDK/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra Permissions Management の新機能の紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/</id>
    <published>2024-01-20T01:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.110Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 12 月 14 日に米国の <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/introducing-new-features-of-microsoft-entra-permissions/ba-p/2466925">Azure Active Directory Identity Blog で公開された Introducing New Features of Microsoft Entra Permissions Management - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft Entra Permissions Management は、組織のマルチクラウド基盤におけるあらゆる ID の権限管理を支援する Cloud Infrastructure Entitlement Management (CIEM) ソリューションです。Permissions Management を使用することで、ID とその権限を継続的に評価、管理、監視し、過去のアクティビティに基づいてアクセス許可の範囲を適切に管理することができます。</p><p>本日、Ignite での発表について詳細をお知らせすると共に、Permissions Management の新機能と API を紹介いたします。全体的な権限管理のエクスペリエンスにつながればうれしく思います。</p><h2 id="ServiceNow-アプリ内で-Permissions-Management-を利用-一般利用可能"><a href="#ServiceNow-アプリ内で-Permissions-Management-を利用-一般利用可能" class="headerlink" title="ServiceNow アプリ内で Permissions Management を利用 (一般利用可能)"></a>ServiceNow アプリ内で Permissions Management を利用 (一般利用可能)</h2><p>ユーザーは、ServiceNow ポータルからマルチ クラウド環境 (Microsoft Azure、Amazon Web Services (AWS)、Google Cloud Platform (GCP)) に対して、期限付きのオンデマンドのアクセス許可を要求できるようになりました。この統合により、ServiceNow の既存の承認ワークフローにアクセス許可の要求が追加され、組織のゼロ トラスト体制を強化することができ、マルチ クラウド環境で最小特権の原則を実施することが可能になります。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">こちら</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management1.png"></p><h2 id="Microsoft-Defender-for-Cloudとの統合-パブリック-プレビュー"><a href="#Microsoft-Defender-for-Cloudとの統合-パブリック-プレビュー" class="headerlink" title="Microsoft Defender for Cloudとの統合 (パブリック プレビュー)"></a>Microsoft Defender for Cloudとの統合 (パブリック プレビュー)</h2><p>当社は、クラウド ネイティブ アプリケーション保護プログラム (CNAPP) の取り組みを強化しており、そのために Microsoft Defender for Cloud を通じて基本的な権限管理に関する情報を提供しています。この統合により、クラウド環境における過剰なアクセス許可や設定ミスにより発生する可能性のあるセキュリティ侵害が防止されます。これにより、組織はクラウド リソースに最小特権の原則を導入すると共に、Azure、AWS、GCP 全体でアクセス許可に関するリスクを解決するための推奨事項を得ることが可能となります。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/permissions-management-for-defender-for-cloud">こちら</a> をご覧ください。</p><h2 id="Okta-と-AWS-IAM-Identity-Center-のサポート-パブリック-プレビュー"><a href="#Okta-と-AWS-IAM-Identity-Center-のサポート-パブリック-プレビュー" class="headerlink" title="Okta と AWS IAM Identity Center のサポート (パブリック プレビュー)"></a>Okta と AWS IAM Identity Center のサポート (パブリック プレビュー)</h2><p>Permissions Management をご利用のお客様は、Okta および AWS IAM Identity Center 上の ID を検出できるようになりました。これにより、お客様は、使用している ID プロバイダーやソリューションに関係なく、すべての ID とそのアクセス許可を一元的に把握できるようになります。お客様はけ数回クリックで Okta と AWS IAM Identity Center を構成いただけます。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management2.png"></p><h2 id="アクセス許可の分析レポート-パブリック-プレビュー"><a href="#アクセス許可の分析レポート-パブリック-プレビュー" class="headerlink" title="アクセス許可の分析レポート (パブリック プレビュー)"></a>アクセス許可の分析レポート (パブリック プレビュー)</h2><p>このレポートでは、Permissions Management における ID とリソース全体の詳細を一覧で確認できます。このレポートは、Permissions Management ページで直接表示するか、Excel 形式でダウンロードするか、PDF としてエクスポートすることも可能です。当該レポートは Microsoft Azure、AWS、GCP を含むサポートされているすべてのクラウド環境で利用可能です。 詳しくは<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/product-permissions-analytics-reports#download-the-permissions-analytics-report-in-pdf-format">こちら</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management3.png"></p><h2 id="新しい-API"><a href="#新しい-API" class="headerlink" title="新しい API"></a>新しい API</h2><p>パブリック プレビューとして複数の Microsoft Graph API が Permissions Management に導入され、お客様からのフィードバックに基づく主要なユースケースに対応しました。これらの新しい API により、組織は、オンボード済みの AWS アカウント、Azure サブスクリプション、および GCP プロジェクトの情報を棚卸でき、アクセス許可に関する分析情報を SIEM ツールのダッシュボードに組み込んだり、既存のチケット管理システムでアクセスのレビューを行ったりできるようになります。さらに、Permission on Demand API を用いることで、自動化ソリューションや IT サービス管理 (ITSM) ソリューションとの統合により、必要に応じてユーザー ID またはワークロード ID の権限を柔軟に昇格させることが可能となります。詳細については、<a href="https://learn.microsoft.com/en-us/graph/api/resources/permissions-management-api-overview?view=graph-rest-beta">こちら</a> をご覧ください。</p><p>いつものように、皆様のご意見、ご感想、ご提案をお待ちしております！<a href="https://feedback.azure.com/d365community">Microsoft Entra (Azure AD) フォーラム</a> で共有するか、以下にコメントを残してください。皆様のご意見をお待ちしております。</p><p>Joseph Dadzie, Partner Director of Product Management<br>Linkedin: <a href="https://www.linkedin.com/in/joedadzie/">@joedadzie</a><br>Twitter: <a href="https://twitter.com/joe_dadzie">@joe_dadzie</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 14 日に米国の &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-bl</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>サイバーセキュリティの向上 - フィッシングに強い認証に対する最新の機能強化</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/</id>
    <published>2024-01-20T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.710Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/advancing-cybersecurity-the-latest-enhancement-in-phishing/ba-p/2365681">Advancing Cybersecurity: The Latest enhancement in Phishing-Resistant Authentication - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>本日は、フィッシング耐性のある認証に向けた、いくつかの新たな機能強化をご紹介したいと思います！この機能強化は、国家のサイバー セキュリティの改善に関する大統領令 14028 (<a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">Executive Order on Improving the Nation’s Cybersecurity | The White House</a>) に準拠するために不可欠であるだけでなく、デジタル ID を利用するすべての組織とユーザーの安全を確保するうえでますます重要となっています。</p><p>全文を読むお時間のない方は以下のまとめをどうぞ。</p><ul><li>Microsoft Authenticator がフィッシングに強いパスキーのサポートを発表</li><li>Microsoft Authenticator はすべてのプラットフォームで FIPS 140-3 に準拠</li><li>PIV/CAC 認証向けの構成オプションの増加</li><li>iOS および MacOS アプリケーションでの FIDO2 サポート</li><li>マネージド ポリシーにて “Secure by design, Secure by default” を支援</li></ul><p>詳細は以下をご覧ください！</p><h2 id="Microsoft-Authenticator-がフィッシング耐性のある認証方式に！"><a href="#Microsoft-Authenticator-がフィッシング耐性のある認証方式に！" class="headerlink" title="Microsoft Authenticator がフィッシング耐性のある認証方式に！"></a>Microsoft Authenticator がフィッシング耐性のある認証方式に！</h2><p>Ignite 2023 で発表 (<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/ba-p/2747279">Identity at Microsoft Ignite: Securing access in the era of AI - Microsoft Community Hub</a>) されたように、2024 年前半には、Microsoft Entra ID のユーザーは、デバイスに紐づくパスキーを Microsoft Authenticator アプリを用いて登録して、サインインに利用できるようになります。これは、費用対効果が高く、フィッシングに強い資格情報で、Authenticator アプリがあれば誰でも利用できる仕組みです！パスキーは FIDO 標準に関連した最新のセキュリティ機能であり、Authenticator との統合により、Authenticator が提供する革新的なセキュリティ機能や高度な機能を活用することができます。</p><p><img src="/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication1.png" alt="図 1: Microsoft Authenticator アプリで管理されたパスキー"></p><p>Microsoft Authenticator をさらに強化し、コンプライアンス要件を満たすために、Android 上の Authenticator アプリが FIPS-140 に準拠しました。</p><p>Microsoft Authenticator for Android は、バージョン 6.2310.7174 以降、デバイスに紐づくフィッシング耐性のあるパスキー、プッシュ型多要素認証 (MFA)、パスワードレス電話サインイン (PSI)、時間ベースのワンタイム パスコード (TOTP) を使用するすべての Microsoft Entra 認証において、連邦情報処理標準 (FIPS 140-3) に準拠しています。Intune Company Portal を使用している組織の場合は、FIPS 準拠のため、最新バージョンの Authenticator に加えて、Intune Company Portal のバージョン 5.0.6043.0 をインストールください。</p><p>iOS 向けの Microsoft Authenticator アプリは、2022 年 12 月に発表されたように、すでに FIPS-140 に準拠しています。Microsoft Authenticator アプリの FIPS 140 準拠の詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-authentication-authenticator-app#fips-140-compliant-for-microsoft-entra-authentication">こちら</a> をご覧ください。</p><h2 id="PIV-CAC-を使用する組織のために設定項目を拡充"><a href="#PIV-CAC-を使用する組織のために設定項目を拡充" class="headerlink" title="PIV/CAC を使用する組織のために設定項目を拡充"></a>PIV/CAC を使用する組織のために設定項目を拡充</h2><p>証明書ベース認証 (CBA) の一般提供開始を発表してからこの 1 年間で、米国政府機関のお客様の Entra ID CBA の利用が 850% 以上増加しました。CBA を活用することで、AD FS などのオンプレミス IdP からの移行を図りながら、PIV/CAC を使用して使い慣れたエンドユーザー体験を提供し続けることができ、お客様はゼロ トラストへの対応をより迅速に進めることが可能となります。</p><p>弊社ではクラウド ベースの CBA への投資を継続し、直近で証明書やリソースの種類、ユーザー グループごとに認証ポリシーを調整できる機能を追加しました。ユーザごとに証明書の強度を選択したり、多要素認証やステップアップ認証のためにCBA を他の方法と併用したり、さらにはテナント全体またはユーザー グループごとに高いアフィニティで (強い) 証明書バインドを構成したりできるようになりました。</p><p><img src="/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication2.png" alt="図 2: 証明書ベースの認証におけるバインドのポリシー ルールの構成"></p><p>Microsoft Entra 証明書ベース認証の最新の機能強化の詳細については、<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/enhancements-to-microsoft-entra-certificate-based-authentication/ba-p/1061417">こちら</a> をご覧ください。</p><h2 id="モバイル向けにフィッシング耐性のある認証オプションを追加-iOS-および-macOS-アプリケーション向けの-FIDO2-サポート"><a href="#モバイル向けにフィッシング耐性のある認証オプションを追加-iOS-および-macOS-アプリケーション向けの-FIDO2-サポート" class="headerlink" title="モバイル向けにフィッシング耐性のある認証オプションを追加: iOS および macOS アプリケーション向けの FIDO2 サポート"></a>モバイル向けにフィッシング耐性のある認証オプションを追加: iOS および macOS アプリケーション向けの FIDO2 サポート</h2><p>2023 年夏に、iOS と macOS の Web ブラウザにおける FIDO2 認証のサポートを発表 (<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/advancing-modern-strong-authentication/ba-p/3773135">Advancing Modern Strong Authentication - Microsoft Community Hub</a>) しました。本日、iOS と macOS でのFIDO2 認証のパブリック プレビューを発表できることを嬉しく思います。このリリースにより、iOS に Microsoft Authenticator をインストールしているユーザー、または macOS に Microsoft Intune Company Portal をインストールしているユーザーは、FIDO2 セキュリティ キーを使用して Microsoft アプリケーションにサインインできるようになります。この機能は現在 iOS で利用可能で、macOS では 2024 年初頭に利用可能になる予定です。</p><p>FIDO2 の認証は、「開発するアプリで FIDO2 キーによるパスワードレス認証をサポートする」(<a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/support-fido2-authentication">開発するアプリで FIDO2 キーを使用してパスワードレス認証をサポートする - Microsoft identity platform | Microsoft Learn</a>) に記載されている要件を満たす、iOS および macOS の MSAL 対応サードパーティ製アプリケーションでも利用できます。</p><p>対応プラットフォームについては<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/fido2-compatibility">こちら</a>をご覧ください。</p><h2 id="CISA-に沿った「Secure-by-design-Secure-by-default」アプローチに基づき既定の状態で安全な構成を採用"><a href="#CISA-に沿った「Secure-by-design-Secure-by-default」アプローチに基づき既定の状態で安全な構成を採用" class="headerlink" title="CISA に沿った「Secure by design, Secure by default」アプローチに基づき既定の状態で安全な構成を採用"></a>CISA に沿った「Secure by design, Secure by default」アプローチに基づき既定の状態で安全な構成を採用</h2><p>今月初め、Microsoft は Secure Future Initiative (<a href="https://blogs.microsoft.com/on-the-issues/2023/11/02/secure-future-initiative-sfi-cybersecurity-cyberattacks/">A new world of security: Microsoft’s Secure Future Initiative - Microsoft On the Issues</a>) を発表しました。このイニシアティブの一環として、条件付きアクセス ポリシーの自動展開 (<a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection | Microsoft Security Blog</a>) を開始します。このイニシアティブは Cybersecurity and Infrastructure Security Agency (CISA) が提唱する “Secure by design, Secure by default” というアプローチに沿ったもので、消費者が日々利用するテクノロジーの安全性と完全性を信頼できるものにすることを目的としています。</p><p>サイバー セキュリティの課題には社会として取り組む必要があります。弊社は、政府機関、セキュリティ専門家、およびより広範なコミュニティと緊密に協力しｔえサイバー脅威に対する対策強化に取り組んでいます。弊社の目標は、政府機関のお客様に、進化するリスクに先手を打つために必要なツールと知識を提供することです。</p><p>サイバー セキュリティの強化に向けた当社の最近のリリースと継続的なコミットメントにより、大統領令の遵守に取り組んでいる米国政府のお客様を含め、当社の幅広いお客様をサポートしてまいります。共に、より安全なデジタルの未来を築いていきましょう。</p><p>Alex Weinert</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>MC705680 (2024/1/10 公開) の通知内容の説明</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/mc705680-20240110/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/mc705680-20240110/</id>
    <published>2024-01-15T00:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.130Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの金森です。</p><p>2024 年 1 月 10 日に、メッセージ センターにて [MC705680] として以下の情報公開が行われています。</p><hr><p><strong>Action required: Security hardening of Windows Hello authentication with July 2023 Windows updates</strong><br>Windows updates released on July 11, 2023 introduced a phased approach to address a vulnerability in the Microsoft Entra ID Windows Hello authentication stack <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">CVE-2023-36871</a> that could enable an attacker to create long lived authentication artifact from a low privileged process on Entra ID joined machines. This would enable the attacker to move the artifact indefinitely onto other Entra ID joined machines.<br>To address this vulnerability, Microsoft has introduced protections starting with the July 11, 2023 security updates. We strongly recommend that you update your organization’s devices immediately with Windows updates release in July 2023 or later.<br>Microsoft plans to fully address this CVE by not accepting Windows Hello authentication requests from machines running Windows security updates released in June 2023 or before. This security hardening will start February 15th, 2024 and will affect authentication/Single Sign On (SSO) on Windows devices that have not been updated with updates released in July 2023 or later.</p><p>[When will this happen:]<br>This security hardening will start on February 15th, 2024.</p><p>[How this will affect your organization:]<br>This security hardening will impact Windows Hello authentication/Single Sign On (SSO).</p><p>[What you need to do to prepare:]<br>We strongly recommend that you update immediately your organization’s devices with Windows security updates release in July 2023 or later. Your organization will be at risk of business disruption, and IT administrators are encouraged to take action and install the necessary updates as soon as possible.</p><p>[Additional information:]<br>If you have Active Directory Federation Services (ADFS) in your environment, please see <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">CVE-2023-36871 - Security Update Guide - Microsoft - Azure Active Directory Security Feature Bypass Vulnerability</a> to protect your on premises/Enterprise authentication scenarios as well.</p><hr><p>サマライズすると以下の主旨となります。</p><ul><li>Windows Hello for Business (WHfB) のセキュリティの脆弱性が確認されている</li><li>この脆弱性に対して、<strong>2023 年 7 月の月例のセキュリティ修正にて、すでに Windows に対しては修正の提供済みであり、修正を適用することで脆弱性のリスクは解消される</strong></li><li>上記の対処はクライアント視点でのアプローチであるものの、この脆弱性リスクに対して完全に対応できるよう、認証の要求先/トークンの発行を行う Microsoft Entra ID (ME-ID = Azure AD) 側でも対処を実施する</li><li><strong>2024 年 2 月 15 日</strong>から、”2023 年 7 月の月例修正を適用していない” クライアントからの、WHfB によるトークン発行要求を受け入れない対処を実施する</li><li>AD FS を利用している環境では、AD FS サーバーに対しても修正の適用と設定の追加を行う必要がある</li></ul><p>おそらく多くの方がすでに 2023 年 7 月の月例修正を適用済みの環境でご利用いただいているものと思いますが、この修正を適用済みの場合すでにリスクは解消されており、それ以上クライアントにて何らかの対処を行う必要はないのでご安心ください。<br>メッセージ センターの通知文章より不安を感じられた方もいらっしゃるかもしれませんが、QA 形式で詳細をおまとめいたしますので、不安の解消の一助となりましたら幸いです。</p><p><strong>Q.</strong> MC705680 の通知内容の動作変化が生じるのはいつからでしょうか。<br><strong>A.</strong> 2024 年 2 月 15 日となります。</p><p><strong>Q.</strong> 詳細な動作変更対象の前提情報を教えてください。<br><strong>A.</strong> Microsoft Entra 参加 (旧名 Azure AD Join) もしくは Microsoft Entra ハイブリッド参加 (旧名 Hybrid Azure AD Join) 構成の Windows 10 / 11 クライアントにて、Windows Hello for Business (WHfB) を構成しており、Windows に WHfB の方法 (PIN や生体認証) でログオンしている環境が対象です。<br>以下の環境は考慮の対象外となります。</p><ul><li>WHfB ではなく Windows Hello の構成</li><li>WHfB は構成済みであるが、Windows へのログオンを PIN や生体認証ではなくパスワードで実行している</li></ul><p><strong>Q.</strong> どのような動作変化が生じるでしょうか。<br><strong>A.</strong> 2023 年 7 月 11 日の月例修正が適用されていない場合、Windows ログオン時に WHfB の方法 (PIN や生態認証) でログオンすると [Windows ログオンに伴う PRT (Primary Refresh Token) の取得もしくは更新] が行えなくなります。<br>なお、Windows へのログオン自体が行えなくなる、ということは無く、ログオンとデスクトップの表示は変わらず行えます (PRT の取得 / 更新が行えなくなる、という影響のみとなります)。</p><p>この結果、デスクトップ上で PRT の利用が行えなくなり、PRT を用いた SSO (ブラウザやアプリ利用時に、ユーザー名/パスワードの入力を必要とせずサインインが完了する) が行えなくなり、合わせて以下のような状況が生じる可能性があります。</p><ul><li>SSO が行われなくなり、Microsoft Entra ID (ME-ID = Azure AD) のユーザー認証を対話的に求める認証画面が表示される</li><li>(条件付きアクセスにてデバイス ベースのアクセス制御を行っている場合) ME-ID へのサインインがブロックされる</li></ul><p>2023 年 7 月 11 日の月例修正が適用済みの Windows 10 / 11 クライアントでは、上記の動作が生じることなく、これまで通り PRT の取得 / 更新と利用が可能です。</p><p><strong>Q.</strong> 具体的に適用しておくべき修正を教えてください。<br><strong>A.</strong> 以下の技術情報の [セキュリティ更新プログラム] の項目にて公開しておりますので、ご参照ください。</p><p><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">Azure Active Directory のセキュリティ機能のバイパスの脆弱性</a><br>※ [よく寄せられる質問] の項目には “7 月 12 日以降にリリースされた Windows 更新プログラム” と記載がありますが、[セキュリティ更新プログラム] の項目にある対象修正は 7 月 11 日にリリースされており、こちらの修正が本問題を修正した KB となります。</p><p>なお、月例修正は累積型であるため、もし [2023 年 7 月の修正は適用していないが、2024 年 1 月の月例修正は適用済みである] 場合、すでに必要な更新は適用済みのクライアントとなり、改めて後から 2023 年 7 月の修正を適用する必要はありません。<br>現在のクライアントの OS バージョン (ファイル名を指定して実行、より winver を実行した画面から確認可能) と、上記技術情報のセキュリティ更新プログラムの一覧を比較し、より新しい OS バージョンとなっている場合は追加で行うべき対処はありません。</p><p><strong>Q.</strong> 2023 年 7 月の修正が適用されていない状態のまま、本動作変更を避ける方法はありますか。<br><strong>A.</strong> <strong>いいえ、セキュリティの脆弱性に対するアップデートであり、セキュリティ修正を適用しない状態のまま (脆弱性のリスクを維持したまま) でこれまでの運用を継続する方法はございません。</strong><br>なお、本脆弱性は Windows に WHfB でログオンするご利用シナリオが対象となり、Windows にパスワードでログオンするご利用シナリオは考慮の対象外となります。</p><p><strong>Q.</strong> WHfB は利用していませんが、AD FS サーバーを運用上利用している場合はどうすれば良いのでしょうか。<br><strong>A.</strong> 前述の脆弱性の技術情報の [よく寄せられる質問] の項目にて公開しておりますので、ご参照ください。</p><p>上記内容が皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの金森です。&lt;/p&gt;
&lt;p&gt;2024 年 1 月 10 日に、メッセージ センターにて [MC705680] として以下の情報公開が行われています。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;Action </summary>
      
    
    
    
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
    <category term="Windows Hello for Business" scheme="https://jpazureid.github.io/blog/tags/Windows-Hello-for-Business/"/>
    
    <category term="Device" scheme="https://jpazureid.github.io/blog/tags/Device/"/>
    
  </entry>
  
  <entry>
    <title>データ流出への対応: トークンの窃取について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/</id>
    <published>2024-01-07T00:30:00.000Z</published>
    <updated>2024-02-02T05:02:59.710Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2024 年 1 月 2 日に米国の Microsoft Entra Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/addressing-data-exfiltration-token-theft-talk/ba-p/3915337">Addressing Data Exfiltration: Token Theft Talk</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>データ流出の防止について前回に引き続きお話ししたいと思います。以前のブログでは、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価 (CAE)</a> を使用して <a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/apply-zero-trust-principles-to-authentication-session-management/ba-p/3615343">認証セッションをセキュリティで保護するための Microsoft のアプローチ</a> をお話し、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/tenant-restrictions-v2#step-4-set-up-tenant-restrictions-v2-on-your-corporate-proxy">テナント制限 v2</a> を使用して <a href="https://jpazureid.github.io/blog/azure-active-directory/how-tenant-restrictions-v2-can-be-used-to-prevent-data/">テナント間アクセスを安全に行う</a> 方法について解説しました。本日のトピックは、認証アーティファクトの窃取についてです。</p><p>認証アーティファクト (トークンおよび Cookie) が窃取されると、攻撃者は被害者になりすまし、被害者がアクセスできるすべての情報にアクセス出来てしまいます。数年前までトークンの窃取はまれな攻撃であり、ほとんどの場合、企業内のレッド チーム (セキュリティの脆弱性を検証する部門) によって訓練的に行われていました。この理由としては、クッキーの窃取よりも、パスワードの窃取の方が容易だったからです。しかしながら、多要素認証 (MFA) の普及に伴い、アーティファクトの盗難やリプレイを含む実際の攻撃が増えてきています。</p><p>詳細に入る前に、<a href="https://www.microsoft.com/en-us/security/blog/2022/11/16/token-tactics-how-to-prevent-detect-and-respond-to-cloud-token-theft/">Token tactics: How to prevent, detect, and respond to cloud token theft</a> に記載されているとおり、Microsoft ではトークンの窃取に対する第一線の防御策として、エンドポイント保護やデバイス管理、フィッシング耐性のある MFA、ウィルス対策ソフトを用いてデバイスを保護することを推奨しています。</p><p>では次に、認証アーティファクトの種類と、窃取の影響を最小限に抑えるためにその種類ごとに推奨される対応手法について説明していきます。すべての認証アーティファクトは、大まかに 2 つの種類に分けることができます。</p><ul><li>サインイン セッション アーティファクト: クライアントと Entra ID の間でシングル サインオン (SSO) の状態を維持するためのもの。</li><li>アプリ セッション アーティファクト: クライアント アプリにデータ アクセスを許可するためのもの。</li></ul><p><img src="/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/pic.png"></p><p>最も強力なデバイス SSO アーティファクトである <a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/concept-primary-refresh-token">プライマリ更新トークン (PRT)</a> を保護することが一番重要になります。幸いなことに、PRT はすべての OS 上で窃取に対して防御策がとられています。保護のレベルは OS の機能によって異なりますが、<a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/concept-primary-refresh-token#how-is-the-prt-protected">Windows が最も強力な保護機能を有しています</a>。<strong>PRT の保護はポリシーで制御できず、常に有効になっています。</strong></p><p>すべてのアーティファクトを今後同様に保護していくことは開発上のロードマップにありますが、これらの機能を提供するには数年かかると想定しています。トークンの窃取に対する包括的な保護を実現するためのさまざまな課題については、この <a href="https://www.rsaconference.com/library/presentation/usa/2022/token%20theft%20hip%20kids%20are%20doing%20it%20now%20what%20are%20we%20going%20to%20do%20about%20it">RSA のプレゼン資料</a> をご覧ください。当面のところは、Entra ID のセキュリティ製品を組み合わせて利用することで、トークンの窃取に対応が可能です。</p><h2 id="サインイン-セッション-アーティファクトの窃取への対処"><a href="#サインイン-セッション-アーティファクトの窃取への対処" class="headerlink" title="サインイン セッション アーティファクトの窃取への対処"></a>サインイン セッション アーティファクトの窃取への対処</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/public-preview-token-protection-for-sign-in-sessions/">条件付きアクセスのトークン保護ポリシー</a> を用いることで、盗まれたトークンが再利用されないよう暗号技術に基づく仕組みを用いて保護することが可能です。この機能は、PRT に対する既存の保護に上乗せする形で構築されてます。トークン保護ポリシーが有効な場合、保護されていないサインイン セッションの使用はブロックされます。PRT の保護が常に有効となっていることと組み合わせることで、すべての再利用可能なアーティファクトにこのような暗号技術に基づく保護が適用されます。トークンの保護は、Windows 上の Office 製品と Outlook において現在パブリック プレビュー段階です。ご利用の際は、まずレポート専用モードで開始して、組織への影響を評価ください。</p><p>トークン保護のスコープにまだ含まれていないクライアント アプリについては、<a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/overview-what-is-global-secure-access">Entra Global Secure Access</a> の <a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-compliant-network">準拠ネットワークのチェック</a> を有効にすることで保護いただけます。このポリシーにより、認証アーティファクトが常に組織のネットワークから送信されていることを保証できます。つまり、盗まれたトークンが組織のネットワークからのみ利用可能となるため、攻撃の影響範囲を大幅に縮小することが可能です。</p><h2 id="アプリ-セッション-アーティファクトの窃取への対処"><a href="#アプリ-セッション-アーティファクトの窃取への対処" class="headerlink" title="アプリ セッション アーティファクトの窃取への対処"></a>アプリ セッション アーティファクトの窃取への対処</h2><p>ネットワーク構成によっては、<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/howto-conditional-access-policy-location">条件付きアクセス: 場所によるアクセスのブロック機能</a> および <a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-continuous-access-evaluation-strict-enforcement">継続的アクセス評価 (CAE): 場所ポリシーを厳密に適用する機能</a> を構成することで、窃取されたアクセス トークンとワークロード (アプリ) Cookie の企業ネットワーク外での利用をブロック可能です。この新しい CAE の強制機能は、許可された IP 範囲外からのアクセスをブロックしますので、盗まれたトークンのネットワーク外部からの使用がブロックされ、攻撃の影響範囲が大幅に縮小します。この機能を利用するには、ユーザーは事前に定義した IP アドレスの範囲から Entra ID とワークロードの両方にアクセスする必要があります。Entra Global Secure Access (GSA) ではユーザーのデバイスの IP アドレスを提示することができるため、Entra GSA を介してデータにアクセスする企業ネットワーク ユーザーに対しては、CAE の場所ポリシーを厳密に適用できます。条件付きアクセス (CA) で <a href="https://learn.microsoft.com/ja-jp/azure/architecture/guide/security/conditional-access-framework#named-locations">ネームド ロケーション</a> を構成する場合は、ユーザーが Entra ID とワークロード (SharePoint Online など) の両方にアクセスする IP アドレスの範囲をネームド ロケーションに必ず含めるよう対応ください。</p><h2 id="トークンの窃取の検出"><a href="#トークンの窃取の検出" class="headerlink" title="トークンの窃取の検出"></a>トークンの窃取の検出</h2><p>アーティファクトの窃取を検出するには、Microsoft Entra ID Protection のリスク検出機能を利用して、トークンの窃取が懸念される場合にユーザー リスクを上げるするという方法があります。<a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-risks#anomalous-token">異常なトークン</a> や <a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-risks#token-issuer-anomaly">トークン発行者の異常</a>、および中間者攻撃の検出が行われた場合は、トークン窃取の可能性があります。それぞれの検出はオフラインで評価されますが、”異常なトークン” の検出はサインイン時にリアルタイムに評価して脅威を捉えられもしますので、その場でサインインを侵害済みであるとしてアラートを上げることもできます。これらの検出を最大限に活用するには、<a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-policies">リスクベースのアクセス ポリシー</a> を構成して、トークンの窃取が懸念される場合に、ユーザーに適切なポリシー制御が適用されるようにすることをお勧めします。リスクベースのアクセス ポリシーをトークン窃取の検出に対して適用すると、ユーザーには多要素認証が求められ、それが完了するとパスワードのリセットが求められます。必要であれば、管理者がユーザー トークンの取り消しを行うことも可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> をリスクベースのアクセス ポリシーと組み合わせることで、窃取されたアーティファクトを用いたリソース アクセスをブロックすることが可能です。ユーザー リスクが上昇すると、CAE は CAE に対応したすべての対応ワークロードに通知を行い、リスクベースのアクセス ポリシーを直ちに適用します。</p><p>トークン窃取の攻撃が増えるにつれ、Microsoft もそのような攻撃に対する防御を常に強化しています。この分野における新しい更新情報を今後もぜひお楽しみにお待ちください。</p><p>Anna Barhudarian<br>Principal Product Manager, Identity Division</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 2 日に米国の Microsoft Entra Blog で公開された &lt;a href=&quot;https://techcommunity.microsoft</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra  証明書ベース認証 (CBA) の機能強化</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/</id>
    <published>2024-01-06T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.946Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 12 月 13 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/enhancements-to-microsoft-entra-certificate-based-authentication/ba-p/1061417">Enhancements to Microsoft Entra certificate-based authentication</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Ignite 2022 では、<a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">大統領令 14028 「国家のサイバーセキュリティの向上」</a> に対する Microsoft のコミットメントの一環として、Microsoft Entra 証明書ベース認証 (CBA) の一般提供開始を発表しました。弊社はこれまで政府機関のお客様と協力してまいりましたが、PIV/CAC カードが連邦政府内で使用される最も一般的な認証方法であるという状況です。PIV/CAC カードを使用している連邦政府組織や、大統領令 14028 の要件に準拠したいとお考えのお客様、加えて Active Directory Federated Server のような連携サーバーから Entra ID の CBA に移行したいお客様にとって、直接 Entra ID に対して認証に X.509 証明書を使用できることは非常に重要です。</p><p>それ以来、弊社では多くの新機能を追加し、モバイルを含むすべてのプラットフォームで CBA を利用できるようにし、デバイス上の証明書だけでなく、YubiKey のような外部セキュリティ キーもサポートしました。お客様は、証明書やリソースの種類、ユーザーのグループごとに認証ポリシーをカスタマイズしたり、ユーザーごとに証明書の強度を選択したり、多要素認証やステップアップ認証のために CBA を他の方法と併用することも可能です。加えて、テナント全体またはユーザーのグループごとに証明書のバインドを構成したりするなど、より制御性と柔軟性を向上させることができるようになりました。</p><p>Microsoft Entra のプロダクト マネージャーである Vimala Ranganathan より、これらの新機能がフィッシングに強い MFA の実現にどのように活用いただけるかについてご説明します。</p><p>ぜひ皆様のご感想をお聞かせください！<br>Alex Weinert</p><p>–</p><p>皆さんこんにちは、</p><p>Microsoft Entra PM チームの Vimala です。CBA の新機能と機能強化について詳しく説明いたします。</p><p><strong>CBA のユーザー名のバインド</strong>: CBA は、追加で 3 つのユーザー名のバインドをサポートし、オンプレミスの Active Directory と同等の機能を提供するようになりました。追加された 3 つの証明書バインドは以下のとおりです:</p><ul><li>IssuerAndSerialNumber (発行者とシリアル番号)</li><li>IssuerAndSubject (発行者とサブジェクト)</li><li>サブジェクトのみ</li></ul><p>ユーザー名のバインド ポリシーは、Entra ID がユーザから提示された証明書を、Entra ID のユーザー アカウントとどのように一致させるかを管理者がカスタマイズできるようにするものです。既定では証明書の Subject Alternative Name (SAN) 属性の Principal Name をユーザー オブジェクトの UserPrincipalName にマッピングします。管理者は既定の設定をオーバーライドしてカスタムのマッピングを作成できます。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/how-to-certificate-based-authentication#step-4-configure-username-binding-policy">ユーザー名バインド ポリシーを構成する</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication1.png"></p><p><strong>CBA 認証ポリシー ルール</strong>: このルールは、認証の強度を単一要素または多要素のいずれとして扱うかを定めるものです。Entra ID で利用可能な他の認証方式は常に単一要素もしくは多要素のどちらか一方での扱いですが、CBA はどちらとしても扱うことができます。管理者は、認証ポリシー ルールを構成することで、Entra ID が証明書をいつ単一要素または多要素とみなすかを選び、保護のレベルを設定できます。複数のカスタム認証バインドのルールを作成し、証明書の属性 (発行者またはポリシー OID、または発行者と OID の組み合わせ) に基づいて、証明書に関する既定の保護レベルを割り当てることもできます。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/how-to-certificate-based-authentication#step-3-configure-authentication-binding-policy">認証バインド ポリシーを構成する</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication2.png"></p><p><strong>CBA アフィニティ バインド</strong> :  この設定は、ユーザー認証において証明書を検証する際に使用される証明書の属性に関するものです。先に紹介したように、証明書をユーザー オブジェクトとバインドまたは照合させるにはいくつかの方法かあります。その中には、簡単に再利用が可能なユーザー証明書のプロパティを使用しているものもあります。この再利用の容易さにより、特定のユーザー バインドの方法により高アフィニティ (強い関連付け) か低アフィニティ (弱い関連付け) かが決まります。例えば、SAN Principal Name に基づくユーザー バインド利用すると、これは低アフィニティになります。Issuer + SerialNumber に基づくユーザー バインドは高アフィニティです。Entra ID では、管理者がテナント レベルでアフィニティ バインドを設定したり、カスタム ルールを作成して高アフィニティまたは低アフィニティのマッピングを使用したりすることができ、お客様の多くの潜在的なシナリオをカバーすることが可能です。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#understanding-the-username-binding-policy">ユーザー名のバインド ポリシーについて</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication3.png"></p><p><strong>第 2 要素としての CBA</strong>: この機能により Entra リソースにアクセスするための多要素認証 (MFA) の一要素として CBA がサポートされるようになりました。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#mfa-with-single-factor-certificate-based-authentication">CBA による MFA</a> をご覧ください。</p><table><thead><tr><th>第 1 要素</th><th>第 2 要素</th><th>MFA</th></tr></thead><tbody><tr><td>単一要素による CBA</td><td>パスワードレスの電話によるサインイン (PSI)</td><td>持っているもの + 持っている/知っているもの</td></tr><tr><td>単一要素による CBA</td><td>FIDO 2</td><td>持っているもの + 持っている/知っているもの</td></tr><tr><td>パスワード</td><td>CBA (単一要素または多要素)</td><td>知っているもの + 持っているもの</td></tr></tbody></table><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication4.png"></p><p><strong>最後に使用された方法 (MRU) としての CBA</strong>: ユーザーが CBA を使用して認証に成功すると、MRU (Most Recently Used: 最後に使用された) の方法として CBA が設定されます。それ以降、サインイン画面でユーザーが自身の UPN を入力して [<strong>次へ</strong>] をクリックすると、直接 CBA の認証に移動するため、[証明書またはスマート カードを使用する] を選択する必要がなくなります。MRU の方法をクリアするには、証明書の選択画面をキャンセルし、[その他のサインイン方法] をクリックします。ユーザーが利用できる別のメソッドを選択し、認証に成功すれば MRU の方法がクリアされます。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#certificate-based-authentication-in-mostrecentlyused-mru-methods">MRU 方法での CBA</a> をご覧ください。</p><p>Windows 端末上で Entra ハイブリッド参加および Entra 参加済みデバイスをご利用のユーザーは、スマート カードで Windows にサインインし、プライマリ更新トークン (PRT) を取得して、Entra リソースにシングル サインオン (SSO) することも可能です。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-smartcard">Windows スマート カード サインイン</a> をご覧ください。</p><p>また、Microsoft Entra CBA の詳細については、<a href="http://aka.ms/aadcba">http://aka.ms/aadcba</a> および <a href="https://msus-sites.azurewebsites.net/en-us/federal/cybersecurity.aspx">Executive Order 14028</a> に対する Microsoft のコミットメントをご覧ください。</p><h2 id="今後の予定"><a href="#今後の予定" class="headerlink" title="今後の予定"></a>今後の予定</h2><p><a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure Active Directory Community</a> にフィードバックをお寄せください！弊社では、証明書失効リスト (CRL) の制限の撤廃、新しい認証局のトラスト ストア、B2B 外部ゲスト ユーザー用のリソース テナントでの CBA サポート、iOS UX の強化など、さらなる機能強化を実現するために鋭意取り組んでおります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 13 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommu</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
  </entry>
  
  <entry>
    <title>改めて知る Microsoft Entra 条件付きアクセス</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/review-ca/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/review-ca/</id>
    <published>2024-01-01T00:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.314Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの長谷川です。</p><p>Microsoft Entra 条件付きアクセスは、Microsoft Entra ID が提供する主要機能であり、非常に多くのお客様にご利用いただいています。一方で、条件付きアクセスについて誤解されている方が意外と多いと感じており、弊社サポートにはこの誤解により生じる問題や質問が多く寄せられます。</p><p>そこで本記事では、条件付きアクセスとはどういったものであるか、またどのようなコンセプトで提供されているかをイメージできるような情報をお届けします。後半では簡単なシナリオをベースに条件付きアクセスの動作を説明していきますので、本記事が条件付きアクセスへの理解の助けとなればうれしく思います。</p><h2 id="条件付きアクセスとはどんな機能か"><a href="#条件付きアクセスとはどんな機能か" class="headerlink" title="条件付きアクセスとはどんな機能か"></a>条件付きアクセスとはどんな機能か</h2><p>条件付きアクセスを一言でいうと、Microsoft 365 のサービスや Salesforce など、クラウド上で提供されているサービスへのアクセスを制御する機能です。条件付きアクセスのよくある利用例 (シナリオ) を以下にいくつか紹介します。</p><h3 id="ID-およびパスワードの認証だけでなく多要素認証でユーザーを保護する"><a href="#ID-およびパスワードの認証だけでなく多要素認証でユーザーを保護する" class="headerlink" title="ID およびパスワードの認証だけでなく多要素認証でユーザーを保護する"></a>ID およびパスワードの認証だけでなく多要素認証でユーザーを保護する</h3><p>ユーザーの資格情報 (ID/パスワードなど) が攻撃者により推測されたり外部に流出したりすると、それを入手した攻撃者は流出した資格情報を使用して Microsoft 365 などにサインインすることができます。これによりアカウントの乗っ取りが成功し、そのユーザーしか知りえない情報が漏洩したり、アカウントが悪用されたりします。</p><p>条件付きアクセスを利用している場合、Microsoft 365 や Salesforce などクラウド上のサービスへのアクセス時に、ID およびパスワードといった資格情報に加えて多要素認証を要求することができます。これにより、電話番号を用いた認証や Microsoft Authenticator を用いた認証、さらにはハードウェア トークンを用いた追加認証などパスワード以外の認証要素 (多要素認証) を求めることができるようになります。こうなることで、仮に ID およびパスワードが攻撃者の手に渡っても、多要素認証を突破できない場合は、条件付きアクセスが Microsoft 365 へのアクセスをブロックしてくれます。つまり、ID およびパスワードが窃取されただけではサインインできなくなるため、セキュリティの強化につながります。この多要素認証の要求が、条件付きアクセスのもっとも一般的な利用シナリオです。</p><h3 id="社外など特定の場所からのアクセスに制限を掛ける"><a href="#社外など特定の場所からのアクセスに制限を掛ける" class="headerlink" title="社外など特定の場所からのアクセスに制限を掛ける"></a>社外など特定の場所からのアクセスに制限を掛ける</h3><p>重要な機密情報へのアクセスは、多要素認証を要求するだけでなく、そのユーザーが社内ネットワークにいる場合のみアクセスさせたいというご要望もあると思います。多要素認証だけでなく、このような場所の制御も条件付きアクセスで実現が可能です。例えば、社内ネットワークの出口となるパブリック IP アドレスを Microsoft Entra ID に登録しておけば、その IP アドレスが送信元のアクセスだけを条件付きアクセスでブロックしないように構成できます。これにより、ユーザーが特定のネットワークからのみアクセスできる構成を取ることが可能です。このように場所によるアクセス制御も条件付きアクセスでよく利用されています。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>社外からのアクセスの場合は多要素認証を要求し、社内ネットワークからのアクセスの場合は多要素認証を要求しないというように、社内からのアクセスの場合は制限を緩めるような構成を取る例をよく見受けられます。しかしながら、このような構成はお勧めできません。というのも、攻撃者が社内ネットワークへの侵入に成功してしまうと、多要素認証が強制されず攻撃者がより行動しやすい状況となるためです。このため、多要素認証は最低限の保護として場所を選ばず強制することをお勧めします。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>IP アドレスを利用した制御と聞くと、ファイアウォール製品のようなトラフィック制御をイメージされる方もいるかと思いますが、これは誤りです。条件付きアクセスはトラフィック自体は制御しません。</p></div><h3 id="会社に登録されたデバイスからのみ-Microsoft-365-へのアクセスを許可する"><a href="#会社に登録されたデバイスからのみ-Microsoft-365-へのアクセスを許可する" class="headerlink" title="会社に登録されたデバイスからのみ Microsoft 365 へのアクセスを許可する"></a>会社に登録されたデバイスからのみ Microsoft 365 へのアクセスを許可する</h3><p>お使いの Windows PC やモバイル デバイスを Microsoft Entra ID に登録および参加させることで組織で管理している扱いにして利用することが可能です。加えて、Intune などのモバイル デバイス管理サービスを組み合わせるとデバイスに対してポリシーを適用することもできます。条件付きアクセスでは、このようにして会社の管理下にあるデバイスのみアクセスを許可するなどの構成も可能です。</p><h3 id="危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる"><a href="#危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる" class="headerlink" title="危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる"></a>危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる</h3><p>Microsoft Entra には ID Protection という機能があり、ユーザーのパスワードの漏洩や、普段利用していない外国からのアクセス、短時間の間にあり得ない距離を移動してサインインが行われるなどの異常を検知して、アラートを上げることができます。条件付きアクセスではこのアラートを利用して、サービスへのアクセスを動的にブロックしたり、サインインに多要素認証を求めたうえでアカウントのパスワード リセットを要求したりということが可能です。</p><h2 id="条件付きアクセスの制御が具体的に適用される対象"><a href="#条件付きアクセスの制御が具体的に適用される対象" class="headerlink" title="条件付きアクセスの制御が具体的に適用される対象"></a>条件付きアクセスの制御が具体的に適用される対象</h2><p>これまで、条件付きアクセスは Microsoft 365 のサービスや Salesforce など、クラウド上で提供されているサービスへのアクセスを制御する機能であると繰り返し述べてきました。この「クラウド上で提供されているサービスへのアクセスを制御する」というのが重要なポイントであり、条件付きアクセスの制御はこの「クラウド上で提供されているサービスへのアクセス」に適用されます。</p><p>例えば 「条件付きアクセスでデスクトップ上の Outlook アプリを開けないようにしたい」 という要望は、条件付きアクセスでは完全に実現することができません。これは、このご要望では保護する対象 (制御の対象) がデスクトップ上の Outlook アプリであり、上述の 「クラウド上で提供されているサービスへのアクセス」 ではないためです。</p><p>とはいえこの説明ではイメージがわきにくいと思いますので、簡単ですが条件付きアクセスの制御についてユーザーが Outlook で E メール データを閲覧するシナリオを例に説明します。ユーザーが Outlook で E メールやカレンダーを閲覧しようとする場合、ダウンロード済みのデータを除いて Outlook 上には新着 E メールなどはありません。このためユーザーは Outlook を利用して E メール サーバーにアクセスし、新着 E メールやカレンダー情報を取得します。Office 365 ではこの E メール サーバーに該当するクラウド上のサービスが Office 365 Exchange Online です。</p><p>条件付きアクセスの用語としては、Outlook をクライアント アプリと呼び、Office 365 Exchange Online のことをターゲット リソース (単にリソースとも) と呼びます。リソースとはクラウド上にあるデータの保管場所のようなものをイメージいただくと良いと思います。</p><h3 id="条件付きアクセスが無い場合のアクセスの流れ"><a href="#条件付きアクセスが無い場合のアクセスの流れ" class="headerlink" title="条件付きアクセスが無い場合のアクセスの流れ"></a>条件付きアクセスが無い場合のアクセスの流れ</h3><ol><li>ユーザーが E メールを閲覧しようとして、デスクトップ上の Outlook を開きます。</li><li>Outlook はそのユーザーの E メールデータをクラウド上 (Exchange Online) から取得する必要があるため、Exchange Online にアクセスします。</li><li>Exchange Online は、E メールデータを提供するためには Microsoft Entra ID に認証する必要があると応答し、Outlook がユーザーに対して (画面上に) Microsoft Entra ID のサインイン画面を表示します。</li><li>ユーザーは、サインイン画面に自身の資格情報を入力します。</li><li>ユーザーの入力した資格情報が正しければ、Microsoft Entra ID は Outlook に対してアクセス トークンと呼ばれるものを発行します。</li><li>Outlook はそのアクセス トークンを Office 365 Exchange Online に提示することで E メールのデータをダウンロードします。</li><li>Outlook は取得したデータを画面に表示します。</li></ol><p><img src="/blog/azure-active-directory/review-ca/1%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%8C%E7%84%A1%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E6%B5%81%E3%82%8C.png"></p><h3 id="条件付きアクセスがある場合のアクセスの流れ"><a href="#条件付きアクセスがある場合のアクセスの流れ" class="headerlink" title="条件付きアクセスがある場合のアクセスの流れ"></a>条件付きアクセスがある場合のアクセスの流れ</h3><p>ここでは例として、Office 365 へのアクセスに対して多要素認証を要求するポリシーを構成している場合を考えます。</p><ol><li>ユーザーが E メールを閲覧しようとして、デスクトップ上の Outlook を開きます。 </li><li>Outlook はそのユーザーの E メールデータをクラウド上 (Exchange Online) から取得する必要があるため、Exchange Online にアクセスします。</li><li>Exchange Online は、E メールデータを提供するためには Microsoft Entra ID に認証する必要があると応答し、Outlook がユーザーに対して (画面上に) Microsoft Entra ID のサインイン画面を表示します。</li><li>ユーザーは、サインイン画面に自身の資格情報を入力します。 </li><li>ユーザーの入力した資格情報が正しければ、Microsoft Entra ID は条件付きアクセス ポリシーを確認し、Exchange Online へのアクセスに適用されるポリシーがあるかを確認します。</li><li>Exchange Online は Office 365 の一部であるため、多要素認証を要求するポリシーがみつかります。</li><li>この結果として、Microsoft Entra ID からユーザーに対して多要素認証が要求されます。</li><li>多要素認証に応えられない場合は処理を中断し、アクセス トークンは Outlook に発行されません。多要素認証に応えられればサインイン成功と判断し、Outlook に対してアクセス トークンを発行します。</li><li>Outlook はそのアクセス トークンを Office 365 Exchange Online に提示することで E メールのデータをダウンロードします。 </li><li>Outlook は取得したデータを画面に表示します。 </li></ol><p><img src="/blog/azure-active-directory/review-ca/2%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E9%81%A9%E7%94%A8%E6%99%82%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E6%B5%81%E3%82%8C.png"></p><p>上述の流れのように、条件付きアクセスの処理の中では、クライアント アプリ (Outlook) ではなく、そのクライアント アプリがアクセスしようとしている先のクラウド上のサービス (Exchange Online) を意識することが重要です。</p><p>裏を返すと、条件付きアクセスを用いて、既に Outlook にダウンロードされた E メール データへのアクセスを制御するということはできません。Outlook にはオフライン アクセスという機能があり、インターネットに接続されていない環境でも、ダウンロード済みの E メールやカレンダーを閲覧可能です。「条件付きアクセスでデスクトップの Outlook アプリを開けないようにしたい」という要望を条件付きアクセスで完全に実現することができないのはこのためです。</p><p>なお、クラウド上のサービスである Exchange Online を対象にした条件付きアクセス ポリシーを構成すれば、どのクライアント アプリからのアクセスであっても、そのポリシーが適用されます。Outlook からのアクセスであっても、Teams からであっても、自作の E メール アプリからであっても、Exchange Online (E メールやカレンダー) へのアクセスにはその条件付きアクセス ポリシーが適用されます。これも、条件付きアクセスは、クライアント アプリ (Outlook や Teams) ではなく、そのクライアント アプリがアクセスしようとしている先のクラウド上のサービス (Exchange Online) へのアクセスを制御する機能であるとご理解いただければ納得しやすいかと思います。</p><h2 id="条件付きアクセスの適用のされ方とポリシーの構成に対する考え方"><a href="#条件付きアクセスの適用のされ方とポリシーの構成に対する考え方" class="headerlink" title="条件付きアクセスの適用のされ方とポリシーの構成に対する考え方"></a>条件付きアクセスの適用のされ方とポリシーの構成に対する考え方</h2><p>条件付きアクセスは上述のように様々なアクセス制御を構成できますが、具体的にポリシーを構成する際は、以下のような点を考慮することをお勧めします。</p><ul><li>条件付きアクセスでは、ポリシーを設定しない (既定の状態の) 場合、すべてのアクセスが許可されます (資格情報以外の制御がかかりません)。</li><li>条件付きアクセスではアクセスのブロックや MFA の要求のようにアクセスに制限を掛けることはことはできますが、許可を設定する概念がありません。  </li><li>条件付きアクセスには、ファイアウォールのルールのように、どのポリシーにも当てはまらないものを最終的に既定でブロックするようなポリシーはなく、構成もできません。 </li><li>条件付きアクセスではポリシーの適用順序 (優先順位) を構成することはできません。</li><li>複数の条件付きアクセス ポリシーに合致する場合、それらが組み合わされて最も厳しい制御が適用されます。</li></ul><p>以上から、ファイアウォールのルール作成のようなイメージで条件付きアクセス ポリシーの作成を行うことはできません。</p><p>条件付きアクセス ポリシーを構成する際は、社員の方々 (実際の人間) の「会社のビル」や「会社のビル内の特定のフロア」への入退出の管理をイメージいただくと良いと思います。例えば、ある人が会社のビルに入る場合、入り口のゲートに社員証をかざしたり、守衛の方に社員証を見せるなどすると思います。会社のビルにアクセスする際には基本的にすべての人がこのような最低限の認証を行うはずです。皆が社員証を提示して入館したら、ビル内を基本的に自由に移動できますが、個人情報を扱うフロアに入るには追加の認証 (暗証番号など) が必要となる場合や、機密情報を扱う部屋には数名の限られた人のみ入室できるという場合もあるはずです。社員証を紛失したと報告してきた社員については、既存の社員証を廃止して再度本人確認する必要も生じます。</p><p>上記のような例に基づくと以下のような条件付きアクセス ポリシーが導き出されます。</p><ul><li>ポリシー 1: すべてのユーザーに資格情報と多要素認証を要求する (ビルへの入館に社員証を呈示することに相当)</li><li>ポリシー 2: 重要なサービスへのアクセスにはより強度の高い多要素認証を要求 もしくは 会社が管理するデバイスを要求する (個人情報を扱うフロアに入るには追加の認証が必要に相当)</li><li>ポリシー 3: 特定のサービスへのアクセスはすべての人をブロックする (一部のユーザーのみブロックから除外する) (数名の限られた人のみ入室できるに相当)</li><li>ポリシー 4: リスク (資格情報の漏洩) が生じたユーザーにはパスワード リセットを強制する (社員証を紛失した際に相当)</li></ul><p>以上のように、まず広く全員をカバーするポリシーを作り、それに加えて、アクセス先の各リソースやシナリオごとに追加の認証や条件を設けるというのがお勧めするポリシーの構成です。会社のビルへの入館やその後の社員の移動、リスクの発生など現実世界の人の動きをイメージいただくとよいと思います。Microsoft Entra という製品名は Entrance (入り口) を模していることもあり、このようなサービスへの入り口とお考えいただければ幸いです。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>条件付きアクセスがどのような機能であるかを簡単に説明しました。こちらを参考のうえ、条件付きアクセスをさらに活用いただければと思います。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供しますので、ぜひ弊社サポート サービスをご利用ください。</p><p>本記事と併せて以下の記事も是非ご参照ください。</p><ul><li><a href="/blog/azure-active-directory/qanda-conditional-access/">Azure AD の条件付きアクセスに関する Q&amp;A</a></li><li><a href="https://github.com/yusukekodama/PMActivities/blob/master/Webinar/Schedule.md#season-3-2019%E5%B9%B4-3%E6%9C%88---6%E6%9C%88%E5%AE%9F%E6%96%BD">詳説！Azure AD 条件付きアクセス - 設計のやり方編</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの長谷川です。&lt;/p&gt;
&lt;p&gt;Microsoft Entra 条件付きアクセスは、Microsoft Entra ID が提供する主要機能であり、非常に多くのお客様にご利用いただいています。一方で、条件付</summary>
      
    
    
    
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の更新情報 (2023 年 11 月)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-in-microsoft-entra-2023-11/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/what-s-new-in-microsoft-entra-2023-11/</id>
    <published>2023-12-03T01:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.382Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 11 月 30 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/what-s-new-in-microsoft-entra/ba-p/3796394">What’s new in Microsoft Entra</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft はこのほど、組織のセキュリティ態勢の改善を支援することを目的として、Microsoft Entra 製品ファミリーにさまざまな新しいセキュリティ ツールと機能を導入しました。サイバー攻撃がますます巧妙化し、クラウドベースのサービスやモバイル デバイスの利用が増加する中、組織には自らのセキュリティを管理するための効果的なツールの導入が不可欠となっています。</p><p>進化する脅威を先取りし、AI の時代に安全なアクセスを実現するために、今月の <a href="https://ignite.microsoft.com/en-US/home">Microsoft Ignite</a> では、いくつかの重要な発表を行いました:</p><ul><li>ID のリスクへの迅速な対応を支援する Microsoft Entra + Security Copilot。</li><li>Microsoft Defender for Cloud と Microsoft Entra Permissions Management を統合し、マルチクラウド基盤の ID とアクセス許可に関する情報を統合。</li><li>Microsoft マネージド条件付きアクセス ポリシーの自動展開によるお客様の保護</li><li>Microsoft の Security Service Edge (SSE) 製品 (Microsoft Entra Internet Access および Microsoft Entra Private Access) の進化。</li><li>Microsoft Entra 証明書ベース認証 (CBA)。</li></ul><p>詳細は、ブログ「<a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/">Microsoft Ignite における ID: AI 時代におけるアクセスのセキュリティ保護</a>」をご覧ください。</p><p>本日は、過去 2 ヶ月間 (2023 年 10 月～ 11 月) の新機能リリースと、2023 年 11 月の変更管理を発表いたします。また、これらの変更点は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">リリース ノート</a> や電子メールでもお知らせしています。弊社では、お客様が新しい <a href="https://entra.microsoft.com/">Entra 管理センター</a> 内でも、非推奨、廃止、およびサービスの破壊的変更を含むライフサイクルの変更を管理しやすくするため、継続して取り組んでおります。</p><p>これらの最近のアップデートは、Microsoft Entra の製品エリアごとに整理しておりますので、最新のアップデートをすばやく見つけてアクセスいただけると存じます。これらの新機能が、より良い ID およびアクセス ソリューションの提供につながれば幸いです。</p><h2 id="製品の更新情報のまとめ"><a href="#製品の更新情報のまとめ" class="headerlink" title="製品の更新情報のまとめ"></a>製品の更新情報のまとめ</h2><ul><li>Microsoft Entra ID</li><li>Microsoft Entra ID Governance</li><li>Microsoft Entra Workload ID</li><li>Microsoft Entra External ID</li><li>Microsoft Entra Permissions Management</li></ul><h2 id="Microsoft-Entra-ID"><a href="#Microsoft-Entra-ID" class="headerlink" title="Microsoft Entra ID"></a>Microsoft Entra ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/advancing-modern-strong-authentication/">macOS および iOS におけるネイティブアプリでの FIDO2 サポート</a></li><li><a href="https://techcommunity.microsoft.com/t5/windows-it-pro-blog/what-s-new-with-windows-at-microsoft-ignite-2023/ba-p/3980507#2">AVD と Windows 365 での SSO とパスワードレス認証</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-conditional-access-cloud-apps#microsoft-admin-portals">Microsoft 管理ポータルでの条件付きアクセスのサポート</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/custom-security-attributes-overview">Microsoft Entra ID におけるカスタム セキュリティ属性</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/">Microsoft Entra ID を用いた Windows Local Administrator Password ソリューション</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new#general-availability---enhanced-devices-list-management-experience">デバイスを一覧して管理する機能の改善</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/how-to-app-protection-policy-windows">Windows MAM</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new#general-availability---users-cant-modify-gps-location-when-using-location-based-access-control">場所ベースのアクセス管理を利用している場合に GPS の場所の書き変え不可</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions">有料ライセンスを持つテナントのみ Microsoft Entra ID テナントを作成可能に</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new">Android 版 Authenticator が FIPS-140 に準拠</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new">Chrome の CloudAPAuthEnabled をデバイスベースの条件付きアクセスで利用可能に</a></li></ul><h3 id="変更のアナウンス"><a href="#変更のアナウンス" class="headerlink" title="変更のアナウンス"></a>変更のアナウンス</h3><h4 id="条件付きアクセス-ポリシーの自動展開"><a href="#条件付きアクセス-ポリシーの自動展開" class="headerlink" title="条件付きアクセス ポリシーの自動展開"></a>条件付きアクセス ポリシーの自動展開</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 11 月初めに、リスク情報、ライセンス、および使用状況に基づいて、お客様のテナントを自動的に保護する条件付きアクセス ポリシーの展開を <a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">発表</a> しました。これは、Microsoft マネージド条件付きアクセス ポリシーと呼ばれるもので、お客様を自動的に保護することをお知らせするものです。このポリシーは、Microsoft が作成し、お客様のテナントで有効になるポリシーです。以下のポリシーが対象となる一部のテナントに展開されます:</p><table><thead><tr><th align="left">ポリシー</th><th align="left">対象のユーザー</th><th align="left">生じる動作</th></tr></thead><tbody><tr><td align="left">Require multifactor authentication for admin portals</td><td align="left">管理者ユーザー</td><td align="left">このポリシーは、特権ロールを持つ管理者を対象とし、それら管理者が Microsoft 管理者ポータルにサインインするときに多要素認証を要求します。</td></tr><tr><td align="left">Require multifactor authentication for per-user multifactor authentication users</td><td align="left">“ユーザーごとの MFA” 機能を使用しているユーザー</td><td align="left">このポリシーは、”ユーザーごとの MFA” 機能を使用しているユーザーに適用され、すべてのクラウド アプリに多要素認証を要求します。これにより “ユーザーごとの MFA” 機能から条件付きアクセスへの移行を促進します。</td></tr><tr><td align="left">Require multifactor authentication for high-risk sign-ins</td><td align="left">Microsoft Entra ID Premium P2 を十分な数お持ちのお客様</td><td align="left">このポリシーはテナントのすべてのユーザーを対象とし、リスクの高いサインイン時に多要素認証と再認証を要求します。</td></tr></tbody></table><p>対象となるすべてのテナントに対して、事前に通知の上、これらのポリシーを段階的に展開していきます。テナントでポリシーが表示されるようになったら、90 日以内にポリシーを確認し、カスタマイズするか、無効にするようご対応ください。この 90 日間は、ポリシーはレポート専用モードとなります。つまり、条件付きアクセスはポリシーを適用することなく、ポリシーが仮に適用された場合の結果をログに記録します。詳細については、ブログ「<a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection</a>」を参照ください。</p><div class="alert is-info"><p class="alert-title">Note</p><p>サポート チームによる訳注: Microsoft マネージド条件付きアクセス ポリシーの詳細については、サポート チームより日本語のブログ記事である <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-managed-conditional-access-policies/">Microsoft マネージド条件付きアクセス ポリシー</a> を公開しております。併せてご参照ください。</p></div><h4 id="Azure-AD-Graph-の廃止に関する更新情報"><a href="#Azure-AD-Graph-の廃止に関する更新情報" class="headerlink" title="Azure AD Graph の廃止に関する更新情報"></a>Azure AD Graph の廃止に関する更新情報</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 6 月、弊社は Azure AD Graph API サービスの非推奨化に関する 3 年にわたる事前通知の期間が完了したことを <a href="https://jpazureid.github.io/blog/azure-active-directory/important-azure-ad-graph-retirement-and-powershell-module/">発表</a> しました。このサービスは現在、廃止サイクルに入っており、廃止 (シャットダウン) は段階的に行われる予定です。弊社は、この廃止とMicrosoft Graph への移行に際しお客様を可能な限りサポートするようお約束するとともに、この変更に取り組む中で高い透明性と対話の取り組みを進めて参ることをお約束します。</p><h5 id="Azure-AD-Graph-の廃止-第一段階"><a href="#Azure-AD-Graph-の廃止-第一段階" class="headerlink" title="Azure AD Graph の廃止: 第一段階"></a>Azure AD Graph の廃止: 第一段階</h5><p>Azure AD Graph の廃止の第一段階は、2024 年後半に開始される予定です。具体的な日付は、最低 3 ヶ月前に予告し、その後のアップデートで共有します。</p><p>この第一段階に入ると、特定の日付以降に作成されたアプリケーションは、Azure AD Graph API (<a href="https://graph.windows.net/">https://graph.windows.net</a>) へのリクエスト時にエラーが生じるようになります。弊社ではこの時点で Microsoft Graph への移行が完了していないアプリケーションがまだ存在する可能性があることも承知しておりますので、この時点以降に作成されたアプリケーションが Azure AD Graph API をしばらくの期間延長して利用できるようにするための <strong>オプション設定</strong> を提供する予定です。インストールやセットアップの一環としてアプリケーションを作成および登録するようなソフトウェアをお客様が開発または配布しており、さらにこれらのアプリケーションが Azure AD Graph API にアクセスする必要がある場合は、廃止の影響を避けるために、速やかに移行作業を開始ください。このオプション設定は、アプリケーションの作成後に設定することができ、構成の変更は <a href="https://learn.microsoft.com/ja-jp/graph/applications-authenticationbehaviors?tabs=http">AuthenticationBehaviors</a> のインターフェイスを通して行います。</p><p>この計画の実施時期とオプション設定の構成に関するより詳細なガイダンスは、次回の更新でお知らせする予定です。</p><h5 id="Azure-AD-Graph-API-を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？"><a href="#Azure-AD-Graph-API-を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？" class="headerlink" title="Azure AD Graph API を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？"></a>Azure AD Graph API を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？</h5><p>Azure AD Graph API を使用しているテナント内のアプリケーションを特定するための新しい機能の提供に取り組んでいます。この機能は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/monitoring-health/howto-use-recommendations">Microsoft Entra の推奨事項</a> の機能を通じて利用可能になる予定です。この機能は、2024 年初頭に利用可能になる予定です。</p><h5 id="その他に利用可能なツール"><a href="#その他に利用可能なツール" class="headerlink" title="その他に利用可能なツール"></a>その他に利用可能なツール</h5><ul><li><a href="https://learn.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-overview">Azure AD Graph から Microsoft Graph にアプリを移行する</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-planning-checklist">Azure AD Graph アプリ移行計画のチェックリスト</a></li><li><a href="https://github.com/microsoft/AzureADGraphApps">Azure AD Graph を使用している可能性のあるアプリを特定するためのスクリプト</a></li><li><a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/azuread-msoline-cmdlet-map?view=graph-powershell-1.0">Microsoft Graph PowerShell SDK の PowerShell コマンドレットへの対応表</a></li></ul><h4 id="カスタム-セキュリティ属性に関する監査ログの動作変更"><a href="#カスタム-セキュリティ属性に関する監査ログの動作変更" class="headerlink" title="カスタム セキュリティ属性に関する監査ログの動作変更"></a>カスタム セキュリティ属性に関する監査ログの動作変更</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 10 月より、一般公開に際してカスタム セキュリティ属性の監査ログに変更が加えられます。これにより監査ログを確認しているお客様においては日常業務に影響が出る可能性があります。プレビュー中にカスタム セキュリティ属性の監査ログを参照していた場合、監査ログの確認に関わる運用作業が中断されないようにするため、<strong>2024 年 2 月まで</strong> に以下の対応を実行する必要があります:</p><ul><li>監査ログの新しい出力場所を使用する。</li><li>監査ログを確認するユーザーに「Attribute Log」のロールを割り当てる。</li><li>監査ログをエクスポートする場合は新しい診断設定を作成する。</li></ul><p>詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/custom-security-attributes-manage?tabs=admin-center#changes-to-audit-logs-behavior">監査ログの動作に対する変更</a> を参照ください。</p><h4 id="新規アプリケーションにおける-signInAudience-プロパティの既定値の変更"><a href="#新規アプリケーションにおける-signInAudience-プロパティの既定値の変更" class="headerlink" title="新規アプリケーションにおける signInAudience プロパティの既定値の変更"></a>新規アプリケーションにおける signInAudience プロパティの既定値の変更</h4><p>[お客様による対応は不要です]</p><p>2024 年 3 月以降、Microsoft Graph のアプリケーション API を使用して作成された新しいアプリケーションでは、アプリケーション登録時の「signInAudience」プロパティの既定値が「AzureADandPersonalMicrosoftAccount」から「AzureADMyOrg」に変更されます。弊社の分析によると、ほとんどの新規アプリケーションでは、アプリケーションがテナント外のユーザーに利用されることはありません。この対応により、アプリケーションの応答速度とセキュリティが向上します。アプリケーションの signInAudience についての詳細は、ドキュメント <a href="https://learn.microsoft.com/ja-jp/graph/api/resources/application?view=graph-rest-1.0#signinaudience-values">アプリケーション リソースの種類 - Microsoft Graph v1.0 | Microsoft Learn</a> を参照ください。</p><h4 id="アプリ-インスタンス-ロックが既定で有効になる"><a href="#アプリ-インスタンス-ロックが既定で有効になる" class="headerlink" title="アプリ インスタンス ロックが既定で有効になる"></a>アプリ インスタンス ロックが既定で有効になる</h4><p>[お客様による対応は不要です]</p><p>2024 年 3 月以降、Microsoft Graph のアプリケーション API を使用して作成された新しいアプリケーションでは、既定で「アプリ インスタンス ロック」が有効になります。2023 年 9 月よりワークロード ID 用にアプリ インスタンス ロックと呼ばれる機能が提供されました。この機能により、アプリ開発者は、重要なプロパティを改竄しようとする攻撃者からマルチテナント アプリを保護できます。Entra ID ポータルを使用して作成されたアプリケーションは、すでにこの設定が既定で有効になっておりますので、今後は、MS Graph、PowerShell、SDK などの他のアプリ作成機能でも有効になる予定です。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/howto-configure-app-instance-property-locks">アプリケーションでアプリ インスタンス プロパティ ロックを構成する方法 - Microsoft identity platform | Microsoft Learn</a> を参照ください。</p><h4 id="従来のプロフィール-ページがマイ-アカウントに置き換わる"><a href="#従来のプロフィール-ページがマイ-アカウントに置き換わる" class="headerlink" title="従来のプロフィール ページがマイ アカウントに置き換わる"></a>従来のプロフィール ページがマイ アカウントに置き換わる</h4><p>[お客様による対応は不要です]</p><p>本年 6 月に、従来のプロフィール ページが新しいページに置き換えられることを <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-new-feature-and-change-announcements/">発表</a> しました。今後、<strong>2024 年 1 月</strong> までに既存のプロフィール ページ (<a href="https://account.activedirectory.windowsazure.com/r#/profile">https://account.activedirectory.windowsazure.com/r#/profile</a>) がマイ アカウント (<a href="https://www.myaccount.microsoft.com/">https://www.myaccount.microsoft.com</a>) に置き換えられます。マイ アカウントでは、アカウントの詳細、言語、プライバシー設定、セキュリティ情報などを管理することが可能です。マイ アカウントは数年前から利用可能であり、従来のプロフィール ページのすべての機能を備えています。今回の廃止により、お客様はより良く、より先進的な体験に移行されます。自動的に新しいマイ アカウントに遷移するため、お客様による操作は必要ありません。</p><h2 id="Microsoft-Entra-ID-Governance"><a href="#Microsoft-Entra-ID-Governance" class="headerlink" title="Microsoft Entra ID Governance"></a>Microsoft Entra ID Governance</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/app-provisioning/inbound-provisioning-api-concepts">API 駆動型のインバウンドプロビジョニング</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagement-for-groups-api-overview?view=graph-rest-1.0">グループ用の PIM の API</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/exchange-hybrid">Microsoft Entra Cloud 同期が Exchange ハイブリッドの書き戻しをサポート</a></li></ul><h2 id="Microsoft-Entra-Workload-ID"><a href="#Microsoft-Entra-Workload-ID" class="headerlink" title="Microsoft Entra Workload ID"></a>Microsoft Entra Workload ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/enterprise-apps/restore-application?tabs=http&pivots=aad-powershell">マネージド サービス ID のソフト デリート機能</a></li></ul><h2 id="Microsoft-Entra-External-ID"><a href="#Microsoft-Entra-External-ID" class="headerlink" title="Microsoft Entra External ID"></a>Microsoft Entra External ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/users/clean-up-stale-guest-accounts#monitor-guest-accounts-at-scale-with-inactive-guest-insights-preview">ゲストに対するガバナンス - 利用されていないゲストのレビュー</a></li></ul><h2 id="Microsoft-Entra-Permissions-Management"><a href="#Microsoft-Entra-Permissions-Management" class="headerlink" title="Microsoft Entra Permissions Management"></a>Microsoft Entra Permissions Management</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">Microsoft Entra Permissions Management と ServiceNow の連携</a></li></ul><p>以上の内容が参考になれば幸いです。</p><p>Shobhit Sahay</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 11 月 30 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommun</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Ignite における ID: AI 時代におけるアクセスのセキュリティ保護</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/</id>
    <published>2023-12-03T00:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.078Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 11 月 15 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/ba-p/2747279">Identity at Microsoft Ignite: Securing access in the era of AI</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>デジタルの世界が拡大し続けるにつれ、サイバーセキュリティのリスクと課題も拡大しています。サイバー攻撃のスペシャリストを抱える悪意ある組織が、国家や犯罪組織から資金提供を受ける一方、我々が守るべき ID、エンドポイント、アプリ、データは増え続けています。また、AI の新時代では、悪意のある攻撃者 (内部犯を含む) が組織に損害を与える方法は数えきれないぐらい存在するでしょう。</p><p>弊社が <a href="https://www.microsoft.com/ja-jp/security/business/microsoft-entra?rtc=1">Microsoft Entra</a> に追加する機能はすべて、進化する脅威の状況を先取りできるようにするためのものです。すべては、お客様が自身の環境をより容易に安全に保てるようにするという 1 つの原則に帰着します。攻撃からの防御を担当するチームを擁する大企業であれ、IT 部門をまったく持たない中小企業であれ、適切なツールを導入し、適切なポリシーを設定するお手伝いをしたいと考えています。<a href="https://ignite.microsoft.com/en-US/home">Microsoft Ignite 2023</a> では、Microsoft Entra の新機能と機能強化を発表しました:</p><p><strong>発表:</strong></p><ul><li>Microsoft Entra + Security Copilot</li><li>Security Service Edge - Microsoft Entra Internet Access および Microsoft Entra Private Access ですべてのアプリケーションとリソースへのアクセスを保護</li><li>Microsoft マネージド条件付きアクセス ポリシーの自動展開</li><li>より強固な権限管理のための機能の統合</li></ul><h2 id="Microsoft-Entra-Security-Copilot"><a href="#Microsoft-Entra-Security-Copilot" class="headerlink" title="Microsoft Entra + Security Copilot"></a>Microsoft Entra + Security Copilot</h2><p>アクセスを保護するには、テクノロジーだけでなく、ビジネス ポリシーや規制についても深く理解する必要があり、時にこれがセキュリティ専門家に過大な業務を負わせることにつながります。この度、<a href="https://www.microsoft.com/ja-jp/security/business/ai-machine-learning/microsoft-security-copilot?rtc=1">Microsoft Security Copilot</a> が Microsoft Entra に追加され、一般的なタスクの自動化、迅速なトラブルシューティング、複雑なポリシーの解釈、ワークフローの設計を支援できるようになりました。</p><p>Microsoft Entra 管理センターでは、Security Copilot に対し、その条件付きアクセス ポリシーが何を行うものなのか、なぜ MFA がトリガーされたのかを、簡単な会話形式で説明してもらうことができます。Security Copilot を使用して、ユーザーがサインインできなかった理由など、ID 関連のトラブルシューティングを行うこともできます。また、組み込みの Security Copilot エクスペリエンスでは、リスクのある各 ID について、リスクの概要、修復手順、推奨ガイダンスが表示され、ID のリスクに迅速に対応できます。ワークフローの作成支援機能を使用して、新入社員のオンボーディングなど、入社、異動、退職のシナリオで ID ガバナンスのライフサイクル ワークフローを構築する際に、より効率的に操作が可能となります。</p><p>セキュリティ インシデントを調査する場合、関連するサインイン ログと監査ログについて Security Copilot に尋ねることで、文脈に基づいた分析情報を得ることができます。そして、特定のユーザー、グループ、ワークロード、サインイン、ロール、セキュリティ アラートなどの詳細を取得することも可能です。Security Copilot の <a href="https://forms.office.com/pages/responsepage.aspx?id=v4j5cvGGr0GRqy180BHbR2sE-_D9S11Ir8rACvMiWdVUREM4TUg1TzNNS0MzNlNBOVQxVEdQV1VLRi4u">プライベート プレビュー</a> に今すぐ登録すると共に、今後のすべての開発に関する最新情報を入手するために、<a href="https://info.microsoft.com/ww-landing-security-ai-interest-form.html?LCID=EN-US">こちらにサインアップ</a> ください。さらに、Microsoft Security Copilot を自社のソリューションで使用したいと考えているセキュリティ パートナーの皆様は、<a href="https://forms.microsoft.com/pages/responsepage.aspx?id=v4j5cvGGr0GRqy180BHbR7GkZxmcvGdGql1aVgLqRR1UNEk0MTVPVjg1VjhPMUJHVTZETlRXSk1RQy4u">Security Copilot パートナー エコシステム</a> にご登録ください。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai1.jpg" alt="Microsoft Entra 管理センターでは、Microsoft Security Copilot が、その条件付きアクセス ポリシーは何をするためのものなのか、なぜ MFA が要求されたのかなどを、簡単な会話形式で説明してくれます。"></p><h2 id="Security-Service-Edge-ですべてのアプリケーションとリソースへのアクセスを保護"><a href="#Security-Service-Edge-ですべてのアプリケーションとリソースへのアクセスを保護" class="headerlink" title="Security Service Edge ですべてのアプリケーションとリソースへのアクセスを保護"></a>Security Service Edge ですべてのアプリケーションとリソースへのアクセスを保護</h2><p>Microsoft の Security Service Edge (SSE) ソリューションは <a href="https://entra.microsoft.com/#view/Microsoft_Azure_Network_Access/Welcome.ReactView">現在プレビュー中</a> で、Microsoft Entra Internet Access と Microsoft Entra Private Access により、ユーザーとデバイスがどこにいようと、あらゆるアプリケーションやリソースへのアクセスを保護します。</p><p>Microsoft の SSE ソリューションと Microsoft Entra 製品群の統合により、あらゆるアプリケーションや Web サイトへのアクセスを許可する前に、ID、デバイス、アプリケーション、さらに今後はネットワークの条件を考慮した、統合された条件付きアクセス ポリシーを適用することが可能になります。これは、アプリケーションがどの ID プロバイダーを使用しているかに関係なく、さらにアプリケーションに変更を加えることなく機能します。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai2.png"></p><p>皆様の多くが既にお試しの <a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-internet-access?rtc=2">Microsoft Entra Internet Access</a> は、Microsoft 365 トラフィックを安全に保つための ID 中心のセキュア Web ゲートウェイ (SWG) です。弊社は、2023 年末までにすべてのインターネット アプリとリソースを含むようにパブリック プレビューを拡張し、次のような新しいコア機能を追加する予定です:</p><ul><li><strong>アクセスの文脈を考慮した SWG</strong>: Web コンテンツフィルタリング機能を備えたもので、エンド ユーザーによる安全でないコンテンツやコンプライアンス違反のコンテンツへのアクセスを制限します。</li><li><strong>ユニバーサル条件付きアクセス</strong>: 外部 Web サイトやフェデレーション連携していない SaaS アプリケーションなど、あらゆるネットワークの宛先に適応型のアクセス制御を拡張します。</li><li><strong>準拠済みネットワークのチェック機能</strong>: これは条件付きアクセスにて利用できる、管理のしやすい追加機能です。この機能により、Microsoft Entra に統合された統合クラウド アプリケーションをトークンの盗難から保護し、ユーザーを重要なクラウド サービスにアクセスさせつつ、テナント固有のネットワーク セキュリティ ポリシーを確実に適用できるようにします。</li><li><strong>アクセス元 IP の復元機能</strong> が ID Protection と条件付きアクセスの場所のポリシーで利用可能となります。これにより、各ユーザーの本来のアクセス元 IP を維持し、信頼できる場所のチェックと継続的なアクセス評価、ID リスクの検出、およびログ記録の下位互換性が可能となります。</li></ul><p><a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-private-access?rtc=1">Microsoft Entra Private Access</a> は、あらゆる社内アプリケーションやリソースのための、ID を中心としたゼロ トラスト ネットワーク アクセス (ZTNA) です。プライベート プレビューの新機能は以下のとおりです:</p><ul><li>TCP に加えて、UDP やプライベート DNS などより多くのプロトコルをサポートします。これにより、従来の仮想プライベート ネットワーク (VPN) から最新の ZTNA ソリューションに移行が可能となります。</li><li>条件付きアクセス制御に加え、多要素認証 (MFA) などの最新の認証方式により、リモート ユーザーとオンプレミス ユーザーによるすべての社内アプリケーションおよびリソースへのアクセスを保護します。</li></ul><p>当社の SSE ソリューションは、Microsoft のセキュリティ スタックおよびオープン パートナー エコシステム全体にわたる統合を通じて、お客様の既存のセキュリティおよびネットワーク ソリューションと連携が可能です。弊社では、<a href="https://docs.netskope.com/en/netskope-help/integrations-439794/solution-guides/microsoft-security-and-netskope-integration-solution-guide/microsoft-and-netskope-sse-coexistence/">Netskope</a> を始めとするこの分野の他のベンダーと提携し、同じ環境でのシームレスな相互運用を実証中です。お客様の環境のネットワーク トラフィックに対し、最適な SSE ソリューションを柔軟に選択できるようにすることをお約束します。併せて、Internet Access と Private Access の両方について、Windows と Android に対するクロス OS のクライアントサポートが現在パブリックプレビューにあること、また MacOS と iOS のサポートもプライベート プレビューにあることも発表しました。SSE ソリューションは現在、中国とロシアを除く全世界で利用可能であり、将来的には SSE のエッジ ロケーションも提供される予定です。</p><p>近日開催予定の <a href="https://techcommunity.microsoft.com/t5/tech-community-live/microsoft-security-tech-accelerator/ec-p/3968748#M20">Tech Accelerator Ask Microsoft Anything (AMA) セッション</a> に是非参加し、Microsoft の SSE ソリューションに関するあらゆる疑問について製品のエキスパートにご相談ください。</p><h2 id="Microsoft-マネージド条件付きアクセス-ポリシーの自動ロールアウトなど"><a href="#Microsoft-マネージド条件付きアクセス-ポリシーの自動ロールアウトなど" class="headerlink" title="Microsoft マネージド条件付きアクセス ポリシーの自動ロールアウトなど"></a>Microsoft マネージド条件付きアクセス ポリシーの自動ロールアウトなど</h2><p>昨年、弊社では約 700 万の既存テナントに対して Microsoft Entra ID (旧 <a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/new-name">Azure Active Directory</a>) のセキュリティの既定値群を有効にし、これらのテナントにおける侵害の件数を 80% 削減しました。お客様からの好意的なフィードバックに基づき、弊社ではさらに、お客様のリスク情報、現在の使用状況、およびライセンスに基づいて、対象となるテナントに条件付きアクセス ポリシーを自動的に作成することで、より多くの Microsoft Entra ID のお客様が自身を保護できるよう支援してまいります。<strong>Microsoft マネージド条件付きアクセス ポリシー</strong> が展開されると、リスクが高いと想定されるシナリオにて多要素認証 (MFA) を実施する 3 つのポリシーが作成されます。詳細については、Alex Weinert の最近のブログ記事 <a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai3.png" alt="こちらが Microsoft マネージド条件付きアクセス ポリシーが作成されたテナントです。ポリシーの詳細が右側のコンテキスト ウィンドウに表示されています。選択されているポリシーでは、特定の管理者ロールが Microsoft 管理ポータルにアクセスする際に多要素認証の実施を必須とすることが示されています。"></p><p>しかし、すべての MFA の方法が同等にユーザーを保護するわけではありません。FIDO2 セキュリティ キー、Windows Hello、**Microsoft Entra 証明書ベース認証 (CBA)**、パスキーなど、より効果的な MFA の方法では暗号技術が使用されており、認証にフィッシング耐性が付与されます。Microsoft Entra CBA のプレビューでは、証明書、リソースの種類、ユーザーおよびグループごとに認証ポリシーを調整することが可能です。これらのフィッシングに強い認証方式により、パスワードを完全に排除することが可能になり、パスワードの推測、傍受、フィッシングを防ぐことが可能となります。</p><p>Microsoft は、Windows 11 を皮切りに、エコシステム全体でパスキーのサポートに取り組んでいます。Windows Hello を使用して Web サイト、アプリケーション、またはサービスのパスキーを作成すると、顔、指紋、またはデバイスの PIN を使用してデバイスからサインイン可能となります。これにより、企業や政府機関のお客様は、物理的な FIDO2 セキュリティ キーに代わる、フィッシングに強い新たな選択肢を得ることができます。Microsoft Entra ID ユーザーは、まもなく <strong>Microsoft Authenticator アプリ</strong> にて管理されるパスキーを使用してサインインできるようになります。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai4.png"></p><p>最後に、<a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-id-protection?rtc=1">Microsoft Entra ID Protection</a> では、トークンの有効期間が異常に長い場合や、なじみのない場所からトークンが再生された場合などの異常を検出するようになりました。アラートが上がると、条件付きアクセスを用いて直ちにトークンを失効させ、パスワードのリセットやステップアップ MFA などの他の対策とともに、管理者による手動での介入を必要とせずに再認証を強制することができます。また、ユーザーがオンプレミスでパスワードを変更した場合に、Entra ID Protection は <a href="https://jpazureid.github.io/blog/azure-active-directory/Remediate-User-Risks-in-Microsoft-Entra-ID-Protection-Through-On-premises-Password-Changes/">自動的にリスクを修復</a> できるようになりました。これにより、ハイブリッド組織はユーザー リスク ポリシーをより簡単に利用できるようになります。</p><h2 id="より強固な権限管理のための機能の統合"><a href="#より強固な権限管理のための機能の統合" class="headerlink" title="より強固な権限管理のための機能の統合"></a>より強固な権限管理のための機能の統合</h2><p><a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-permissions-management?rtc=1">Microsoft Entra Permissions Management</a> は、このたび権限リスクに関する分析情報を提供する 2 つの重要な統合機能を備えました。これにより、お客様はよりセキュリティ態勢を改善できるようになります。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/permissions-management-for-defender-for-cloud">Microsoft Defender for Cloud (MDC) 統合</a> のプレビューは、ID とアクセス許可に関する分析情報を他のクラウド セキュリティ情報と統合し、単一のインターフェイスで表示します。このビューでは、権限リスクに対処するための実用的な推奨事項やアクセス許可のクリープ インデックスが表示され、Azure、Amazon Web Services (AWS)、Google Cloud のクラウド リソースに対して最小権限でのアクセスを簡単に実施できるようになります。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai5.png" alt="Microsoft Entra Permissions Management と Microsoft Defender for Cloud (MDC) (現在パブリック プレビュー中) の統合により、他のクラウドのセキュリティ態勢に関する分析情報を単一のインターフェイスに統合して効率的に確認できるようになります。"></p><p>このたび一般提供が開始された <a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">2 つ目の統合</a> により、ServiceNow のお客様は、ServiceNow ポータルを介してマルチクラウド環境 (Azure、AWS、Google Cloud) に対し、期限付きのオンデマンド許可を要求できるようになりました。IT サービス管理 (ITSM) ソリューションは多くのお客様で利用されているため、ServiceNow の既存の承認ワークフローにアクセス許可要求を追加することで、ゼロ トラストの体制より強化することが可能となります。ユーザーがアクセス承認を要求すると、ServiceNow のプラグインが Permissions Management から最新のデータを取得し、要求されたユーザー権限を要求者のロールに基づく期限付きの承認とともに ServiceNow に送り返します。</p><h2 id="進化するセキュアな-ID-とネットワーク-アクセス"><a href="#進化するセキュアな-ID-とネットワーク-アクセス" class="headerlink" title="進化するセキュアな ID とネットワーク アクセス"></a>進化するセキュアな ID とネットワーク アクセス</h2><p>包括的な機能を備えた Microsoft Entra という単一の統合ソリューションを採用することで、管理者のアクセス セキュリティを簡素化し、エンドユーザにより良い体験を提供することができます。</p><p>Microsoft Entra の製品群は互いに連携し、お客様の ID、デバイス、ネットワーク、およびワークロードのセキュリティを保護してまいります。これは、特定のユーザーの種類に限らず、お客様、パートナー、デジタル ワークロードなど、あらゆる種類に対応が可能です。そして今、Microsoft Entra は SSE ソリューションによって、ID とネットワークのアクセス制御を単一のポリシー エンジンに統合させようと取り組んでいます。</p><p>Microsoft Entra の最新のイノベーションにより、すべての人のあらゆるものへのアクセスを簡単に保護できるようになることを願っています。</p><p>最近の発表の詳細については、Ignite 2023 での私のセッション <a href="https://ignite.microsoft.com/en-US/sessions/07952ef8-8603-4a94-8185-975ae95e53bb?source=sessions">Secure access in the AI era: What’s new in Microsoft Entra</a> をご覧ください。</p><h2 id="詳細はこちら"><a href="#詳細はこちら" class="headerlink" title="詳細はこちら"></a>詳細はこちら</h2><p>Microsoft のセキュリティ ソリューションの詳細については、<a href="https://www.microsoft.com/ja-jp/security/?rtc=1">当社の Web サイト</a> をご覧ください。<a href="https://www.microsoft.com/en-us/security/blog/">セキュリティ ブログ</a> をブックマークしておくと、セキュリティに関する最新情報をチェックできます。また、<a href="https://twitter.com/MSFTSecurity">@MSFTSecurity</a> でサイバーセキュリティに関する最新ニュースや最新情報をフォローください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 11 月 15 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommu</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ID に必要な通信先エンドポイントのまとめ</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/</id>
    <published>2023-12-01T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.766Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの大庭です。</p><p>今回はよくご質問をいただく Microsoft Entra ID をご利用いただく際に必要となるエンドポイント (URL/IP アドレス) について案内します。Microsoft Entra ID においては認証からアカウント管理、アカウント同期に至るまで複数のサービスを提供しており、ご利用いただく機能によってアクセス先のエンドポイントが異なります。お客様によっては、ネットワーク プロキシにて厳密に接続可能なエンドポイント (URL) 先を制御されている場合があり、そういった制御を行われているお客様では、正常にサービスを利用するために個別にエンドポイント (URL/IP アドレス) への通信を許可する必要があります。</p><p>本記事においては、現時点で提供している Microsoft Entra ID の各サービスに関し、必要となるエンドポイントを記載した公開資料へのリンクをまとめます。これにより、「どのエンドポイントに対してアクセス許可をすればいいのかまとめて知りたい！」といったご要望にお応え出来たら幸いです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>サポート チームにて可能な限り迅速かつ網羅的な情報の更新に努めておりますが、本記事にてすべての情報の網羅ができているわけではありません。サービスが利用するエンドポイントはドキュメントの更新とともに変化する可能性があります。正式な案内については各公開情報を参照いただくか、弊社サポート サービスまでお問い合わせください。</p></div><h2 id="Microsoft-Entra-ID-で基本的に利用されるエンドポイント"><a href="#Microsoft-Entra-ID-で基本的に利用されるエンドポイント" class="headerlink" title="Microsoft Entra ID で基本的に利用されるエンドポイント"></a>Microsoft Entra ID で基本的に利用されるエンドポイント</h2><p>まず初めに Microsoft Entra ID を利用いただく際に基本的に必要となるエンドポイントは、<a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges?view=o365-worldwide#microsoft-365-common-and-office-online">Office 365 の URL と IP アドレスの範囲</a> に記載されている ID 56 , ID 59 そして ID 125 になります。こちらは Microsoft 365 を利用する際に Micorosft Entra ID を利用するシナリオで最低限必要となるエンドポイントをまとめたものです。Microsoft Entra ID をご利用いただく際は、認証を行うクライアントからこれらのエンドポイントについてネットワークの疎通を確保ください。</p><h2 id="Microsoft-Entra-ID-でデバイス管理に利用するエンドポイント"><a href="#Microsoft-Entra-ID-でデバイス管理に利用するエンドポイント" class="headerlink" title="Microsoft Entra ID でデバイス管理に利用するエンドポイント"></a>Microsoft Entra ID でデバイス管理に利用するエンドポイント</h2><p>Entra ID では Microsoft Entra ハイブリッド参加、Microsoft Entra 参加そして Microsoft Entra 登録、という 3 つの方法でデバイスを登録することができます。いずれの方法を利用する場合でも、<a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/how-to-hybrid-join#network-connectivity-requirements">Microsoft Entra ハイブリッド参加を構成する</a> のページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-ID-にて利用規約を利用するエンドポイント"><a href="#Microsoft-Entra-ID-にて利用規約を利用するエンドポイント" class="headerlink" title="Microsoft Entra ID にて利用規約を利用するエンドポイント"></a>Microsoft Entra ID にて利用規約を利用するエンドポイント</h2><p>Microsoft Entra ID にて利用規約を利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/terms-of-use#frequently-asked-questions">Microsoft Entra の利用規約のよく寄せられる質問</a> のページにある “Q: 利用規約サービスにはどのエンドポイントが認証に使用されますか？” に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-Connect-に関連するエンドポイント"><a href="#Microsoft-Entra-Connect-に関連するエンドポイント" class="headerlink" title="Microsoft Entra Connect に関連するエンドポイント"></a>Microsoft Entra Connect に関連するエンドポイント</h2><p>Microsoft Entra Connect を利用して、ハイブリッド ID ソリューション (オンプレミスからのアカウントの同期) を利用される際に必要な URL と IP アドレスの一覧については上記の「Microsoft Entra ID で基本的に利用されるエンドポイント」の節をご覧ください。また併せて、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/tshoot-connect-connectivity">Microsoft Entra Connect の接続に関する問題のトラブルシューティング</a> のページも参照をお勧めします。開放が必要なネットワーク ポートとプロトコルについては、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/reference-connect-ports">ハイブリッド ID で必要なポートとプロトコル</a> のページにも説明がありますのでご覧ください。</p><h2 id="Microsoft-Entra-Connect-Health-Service-に利用するエンドポイント"><a href="#Microsoft-Entra-Connect-Health-Service-に利用するエンドポイント" class="headerlink" title="Microsoft Entra Connect Health Service に利用するエンドポイント"></a>Microsoft Entra Connect Health Service に利用するエンドポイント</h2><p>Microsoft Entra Connect Health Service を利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/how-to-connect-health-agent-install#outbound-connectivity-to-azure-service-endpoints">Microsoft Entra Connect Health エージェントのインストール</a> ページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-アプリケーション-プロキシ-コネクタにて利用されるエンドポイント"><a href="#Microsoft-Entra-アプリケーション-プロキシ-コネクタにて利用されるエンドポイント" class="headerlink" title="Microsoft Entra アプリケーション プロキシ コネクタにて利用されるエンドポイント"></a>Microsoft Entra アプリケーション プロキシ コネクタにて利用されるエンドポイント</h2><p>Microsoft Entra アプリケーション プロキシ コネクタを利用される際は、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/app-proxy/application-proxy-add-on-premises-application#prepare-your-on-premises-environment">アプリケーション プロキシを使用してオンプレミス アプリを追加する</a> ページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-プロビジョニング-サービスを利用する-IP-アドレスの範囲"><a href="#Microsoft-Entra-プロビジョニング-サービスを利用する-IP-アドレスの範囲" class="headerlink" title="Microsoft Entra プロビジョニング サービスを利用する IP アドレスの範囲"></a>Microsoft Entra プロビジョニング サービスを利用する IP アドレスの範囲</h2><p>Microsoft Entra プロビジョニング サービスを利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/app-provisioning/use-scim-to-provision-users-and-groups#ip-ranges">チュートリアル: Microsoft Entra ID の SCIM エンドポイントのプロビジョニング</a> に記載されている IP アドレスの範囲を参照ください。</p><h2 id="オンプレミスにある-Multi-Factor-Authentication-Server-が利用するエンドポイント"><a href="#オンプレミスにある-Multi-Factor-Authentication-Server-が利用するエンドポイント" class="headerlink" title="オンプレミスにある Multi-Factor Authentication Server が利用するエンドポイント"></a>オンプレミスにある Multi-Factor Authentication Server が利用するエンドポイント</h2><p>2024 年 9 月 30 日にサービスの提供終了がアナウンスがされていますが、オンプレミスの MFA サーバーを利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/howto-mfaserver-deploy#azure-multi-factor-authentication-server-firewall-requirements">Azure Multi-Factor Authentication Server のファイアウォールの要件</a> に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Private-Access-用にアプリケーション-プロキシ-コネクタにて利用されるエンドポイント"><a href="#Microsoft-Private-Access-用にアプリケーション-プロキシ-コネクタにて利用されるエンドポイント" class="headerlink" title="Microsoft Private Access 用にアプリケーション プロキシ コネクタにて利用されるエンドポイント"></a>Microsoft Private Access 用にアプリケーション プロキシ コネクタにて利用されるエンドポイント</h2><p>Microsoft Entra Private Access 用にアプリ プロキシ コネクタについては、<a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-configure-connectors#allow-access-to-urls">Microsoft Entra Private Access 用にアプリ プロキシ コネクタを構成する方法</a> に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Azure-管理センターおよび一般的なサービスに利用されるエンドポイント"><a href="#Microsoft-Azure-管理センターおよび一般的なサービスに利用されるエンドポイント" class="headerlink" title="Microsoft Azure 管理センターおよび一般的なサービスに利用されるエンドポイント"></a>Microsoft Azure 管理センターおよび一般的なサービスに利用されるエンドポイント</h2><p>Microsoft Entra ID の認証ではないですが、Azure ポータルや一般的なアカウント サービスに必要となるエンドポイントは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls?tabs=public-cloud">ファイアウォールまたはプロキシ サーバーで Azure portal の URL を許可する</a> のページに記載されているエンドポイントを許可ください。</p><p>今後、Entra ID をご利用いただく際に本ブログの内容が少しでも参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの大庭です。&lt;/p&gt;
&lt;p&gt;今回はよくご質問をいただく Microsoft Entra ID をご利用いただく際に必要となるエンドポイント (URL/IP アドレス) について案内します。Microsof</summary>
      
    
    
    
    
    <category term="Entra ID" scheme="https://jpazureid.github.io/blog/tags/Entra-ID/"/>
    
    <category term="Network" scheme="https://jpazureid.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>エンタイトルメント管理におけるカスタム拡張機能の利用方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/access-package-with-custom-extension/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/access-package-with-custom-extension/</id>
    <published>2023-11-26T01:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.690Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>今回は、Microsoft Entra ID のエンタイトルメント管理 (アクセス パッケージ) の機能をより活用できる、カスタム拡張機能について紹介します。</p><p>今回の記事は、アクセス パッケージを既にご利用いただいており、基本的な操作を理解いただいている方をターゲットとした、中級者向けの案内です。アクセス パッケージを初めて触るお客様や、これから導入を検討されているお客様などで基本的な概要を確認されたい場合、以前公開いたしました以下の記事を先にご覧ください。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/access-management-with-access-package/">アクセス パッケージを利用した一括でのアクセス権の管理</a></p><p>今回は、カスタム拡張機能を利用した操作の例を紹介します。次回の記事にて、ライフサイクル ワークフローとこのアクセス パッケージのカスタム拡張機能を利用した上級編シナリオのご紹介を予定しております。まずは本記事にて基本的な手順や利用方法を確認いただければと思います。</p><h2 id="カスタム拡張機能とは"><a href="#カスタム拡張機能とは" class="headerlink" title="カスタム拡張機能とは"></a>カスタム拡張機能とは</h2><p>アクセス パッケージに対する要求や割り当て期限が迫っている時など特定のイベントについて、事前に設定したカスタム タスクを実行する機能です。アクセス パッケージを作成するときに、任意項目なのでスキップしてしまいがちですが、以下のように「カスタム拡張機能」を指定するよう構成することができます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension1.png"></p><p>たとえば上記スクリーンショットでは、アクセス パッケージの割り当てが行われたことを E メールで通知するようにカスタム拡張機能を構成しています。その他にもカスタム拡張機能の実行のタイミングとして以下を選択可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension2.png"></p><p>カスタム拡張機能自体は「カタログ」内に項目があり、以下から新しい拡張機能を作成することができます。また、以下の例では PackageTask1 というロジック アプリにカスタム拡張機能を紐づけ、カスタム拡張機能が呼び出されるとこのロジック アプリが実行される仕組みになっています。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension3.png"></p><p>ロジック アプリを呼び出した後、具体的にどんな処理を行わせたいかは、お客様側で自由に記載することができます。また、プログラミング スキルがなくても、以下のようなデザイナーを使って、どのような処理を行いたいかを GUI 上で構成することが可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension4.png"></p><h2 id="事前に理解いただきたいこと"><a href="#事前に理解いただきたいこと" class="headerlink" title="事前に理解いただきたいこと"></a>事前に理解いただきたいこと</h2><ul><li>ロジック アプリと連携するためには、事前に Azure サブスクリプションの用意が必要です。</li><li>ロジック アプリ側で課金が発生します。<strong>コスト面も必ず評価のうえご利用ください。</strong></li><li>アクセス パッケージの機能については、 Microsoft Entra ID Premium P2 ライセンスが必要ですが、カスタム拡張属性も利用したい場合、<strong>新しい Microsoft Entra ID Governance ライセンスが必要です。</strong></li><li>スクリプト作成支援と同様、<strong>ロジック アプリの具体的な記載方法などについてはサポートでは支援が難しい場合があります。</strong> ロジック アプリの作成方法などはロジック アプリの観点で支援が可能ですが、具体的にデザイナーにどのような処理を記載すればよいのか、コードとしてどのような記載を行えばよいのかといった支援は、スクリプト代行と同等となりますため、ロジックアプリ観点、アクセス パッケージ観点の双方でも案内が難しいことが考えられます。「ユーザーを取得したいが、利用する Microsoft Graph API はどれか？」といったご質問であれば対応可能です。</li></ul><p>可能な限り本ブログで機能については解説いたしておりますが、基本的には <a href="https://learn.microsoft.com/ja-jp/entra/id-governance/entitlement-management-logic-apps-integration">エンタイトルメント管理でカスタム拡張機能を使用して Logic Apps をトリガーする</a> を参考いただき、まずはお客様側で実装いただけますと幸いです。</p><h2 id="実際の構成例"><a href="#実際の構成例" class="headerlink" title="実際の構成例"></a>実際の構成例</h2><p>アクセス パッケージを割り当てた時に追加で実施したいタスクとして、「割り当てられたユーザーのプロパティ変更」や「割り当てられたユーザーへの E メール送信」などが挙げられます。今回は、アクセス パッケージが割り当てられたら「割り当てられたユーザーの部署 (department 属性) および ExtenrionAttribute1 属性を変更する」、「変更された旨と、パッケージ内のリソース リンクをユーザーに E メール通知する」といった拡張機能を実装してみたいと思います。手順は大きく分けて 4 つあります。</p><ol><li>カタログにカスタム拡張機能を追加し、ロジック アプリを作成する</li><li>カスタム拡張機能をアクセス パッケージに紐づける</li><li>マネージド ID を用意し、権限を付与する</li><li>ロジック アプリ内でどのような操作をするか記載する</li></ol><p>順に以下に案内しておりますが、手順は下記公開情報と同様になりますので、併せて参考となれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/id-governance/entitlement-management-logic-apps-integration">エンタイトルメント管理でカスタム拡張機能を使用して Logic Apps をトリガーする</a></p><h3 id="1-カタログにカスタム拡張機能を追加しロジック-アプリを作成する"><a href="#1-カタログにカスタム拡張機能を追加しロジック-アプリを作成する" class="headerlink" title="1. カタログにカスタム拡張機能を追加しロジック アプリを作成する"></a>1. カタログにカスタム拡張機能を追加しロジック アプリを作成する</h3><ol><li><p>Azure ポータルにサインインし、[Azure Active Directory] - [Identity Governance] - [カタログ] - [新しいカタログ] よりカタログを作成します。名前と説明を入力し、作成ください。カタログはアクセス パッケージに含めることが出来るリソース (グループ、アプリケーション、SPO サイト) を纏めるために利用します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension5.png"></p></li><li><p>作成したカタログについて、メニューから [カスタム拡張機能] を選択し [カスタム拡張機能の追加] をクリックします。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension6.png"></p></li><li><p>カスタム拡張機能に名前と説明を付けます。どのようなカスタム タスクが実行されるかを説明に記載しておくと分かりやすいです。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension7.png"></p></li><li><p>アクセス パッケージにこの拡張機能を紐づける時、どのようなタイミングでトリガーされるかを指定します。今回は「要求ワークフロー」を指定します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension8.png"></p></li><li><p>ロジック アプリの実行中に、アクセス パッケージの割り当て処理などを一時停止するかを指定します。今回は department 属性を正しく変更し E メールが送信できたら処理を再度開始したいので、「起動して待機」を指定します。待機時間などは既定値のままですが、任意に変更できます。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension9.png"></p></li><li><p>このカスタム拡張機能に紐づけるロジック アプリを作成します。サブスクリプションとリソース グループを選択し、ロジック アプリの名前を指定して、「ロジック アプリの作成」をクリックします。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension10.png"></p></li><li><p>ロジック アプリのデプロイが完了するのを待機します。以下のように成功メッセージが表示されれば次へ進みます。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension11.png"></p></li><li><p>最終確認画面で作成をクリックすれば完了です。</p></li><li><p>下記のように、一覧に表示されていることを確認します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension12.png"></p></li></ol><h3 id="2-カスタム拡張機能をアクセス-パッケージに紐づける"><a href="#2-カスタム拡張機能をアクセス-パッケージに紐づける" class="headerlink" title="2. カスタム拡張機能をアクセス パッケージに紐づける"></a>2. カスタム拡張機能をアクセス パッケージに紐づける</h3><p>既存のパッケージ ポリシーを開き、上記で作成したカスタム拡張機能を紐づけます。具体的には、ポリシーの作成/編集画面において、ステージ (いつ実行するか) とカスタム拡張機能 (何を実行するか) を指定します。今回は、「割り当てが付与されたときに customextension1 というタスクを実行する」ようにしました。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension13.png"></p><h3 id="3-マネージド-ID-を用意し権限を付与する"><a href="#3-マネージド-ID-を用意し権限を付与する" class="headerlink" title="3. マネージド ID を用意し権限を付与する"></a>3. マネージド ID を用意し権限を付与する</h3><p>今回のロジック アプリでは「割り当てられたユーザーの部署 (department 属性) および ExtenrionAttribute1 属性を変更する」、「変更された旨と、パッケージ内のリソース リンクをユーザーに E メール通知する」という 2 つのタスクを Microsoft Graph API を利用して実現します。呼び出されたロジック アプリで Graph API クエリを実行するためには、ロジック アプリ内で認証を構成する必要があります。Microsoft Entra ID にアプリを作成してクライアント シークレットなどを利用して認証を行うこともできますが、今回はマネージド ID を利用する方法を紹介します。</p><p>上記で作成されたロジック アプリにアクセスし、 ID を開くと、マネージド ID の状態が表示されます。既定ではオフになっています。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension14.png"></p><p>オンに変更すると、以下のメッセージが表示されるので「はい」を選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension15.png"></p><p>システム割り当てマネージド ID が有効化されたことを確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension16.png"></p><p>有効になると、マネージド ID のオブジェクト ID が表示されるので確認し、ID を控えます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension17.png"></p><p>Microsoft Entra ID - [エンタープライズ アプリケーション] を開き、「アプリケーションの種類」フィルターを “マネージド ID” にしたうえで先ほどの ID を入力し、アプリがあることを確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension18.png"></p><p>グローバル管理者の権限で PowerShell を開き、以下のコマンドを実行して マネージド ID に Graph API の権限を付与します。実際にこのマネージド ID でどのような操作を行わせたいかによって、付与する権限は変わりますが、今回はユーザーのプロパティ更新と E メールの送付をしたいので、ここではそれぞれ必要となる権限である Directory.ReadWrite.All と Mail.Send を付与します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># グローバル管理者でサインインします。</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> <span class="string">&quot;Application.Read.All&quot;</span>,<span class="string">&quot;AppRoleAssignment.ReadWrite.All&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$graph</span>= <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;AppId eq &#x27;00000003-0000-0000-c000-000000000000&#x27;&quot;</span></span><br><span class="line"><span class="variable">$directoryReadWritePermission</span>= <span class="variable">$graph</span>.AppRoles | <span class="built_in">Where-Object</span> Value <span class="operator">-eq</span> <span class="string">&quot;Directory.ReadWrite.All&quot;</span>| <span class="built_in">Where-Object</span> AllowedMemberTypes <span class="operator">-contains</span> <span class="string">&#x27;Application&#x27;</span> | <span class="built_in">Select-Object</span> <span class="literal">-First</span> <span class="number">1</span></span><br><span class="line"><span class="variable">$mailSendPermission</span> = <span class="variable">$graph</span>.AppRoles | <span class="built_in">Where-Object</span> Value <span class="operator">-eq</span> <span class="string">&quot;Mail.Send&quot;</span> | <span class="built_in">Where-Object</span> AllowedMemberTypes <span class="operator">-contains</span> <span class="string">&#x27;Application&#x27;</span> | <span class="built_in">Select-Object</span> <span class="literal">-First</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上の手順で確認したマネージド ID の Object ID を以下の &lt;ObjectID&gt; 部分に代入します。</span></span><br><span class="line"><span class="variable">$msi</span>= <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-ServicePrincipalId</span> &lt;ObjectID&gt; </span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgServicePrincipalAppRoleAssignedTo</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$graph</span>.Id <span class="literal">-AppRoleId</span> <span class="variable">$directoryReadWritePermission</span>.Id <span class="literal">-ResourceId</span> <span class="variable">$graph</span>.Id <span class="literal">-PrincipalId</span> <span class="variable">$msi</span>.Id</span><br><span class="line"><span class="built_in">New-MgServicePrincipalAppRoleAssignedTo</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$graph</span>.Id <span class="literal">-AppRoleId</span> <span class="variable">$mailSendPermission</span>.Id <span class="literal">-ResourceId</span> <span class="variable">$graph</span>.Id <span class="literal">-PrincipalId</span> <span class="variable">$msi</span>.Id</span><br></pre></td></tr></table></figure><p>マネージド ID に権限が割り当てられると、以下のように [アクセス許可] タブに権限が表示されますので確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension19.png"></p><p>次に、ユーザー管理者ロールをマネージド ID に付与しておきます。Microsoft Entra ID の [ロールと管理者] から「ユーザー管理者」ロールを検索します (ユーザーの属性を編集するために本ロールが必要なためです)。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension20.png"></p><p>メンバーの選択の項目をクリックし、マネージド ID と同じ名前のアプリケーションを選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension21.png"></p><p>アプリケーションのロール割り当てに関しては、アクティブな割り当てのみがサポートされています。この警告は気にせずに先に進んで問題ありません。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension22.png"></p><p>アクティブが選択されていることを確認のうえ、ロールを付与します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension23.png"></p><h3 id="4-ロジック-アプリ内でどのような操作をするか記載する"><a href="#4-ロジック-アプリ内でどのような操作をするか記載する" class="headerlink" title="4. ロジック アプリ内でどのような操作をするか記載する"></a>4. ロジック アプリ内でどのような操作をするか記載する</h3><p>上記までできたら、実際にロジック アプリで、カスタム拡張機能が呼び出されたときにどうするかを記載していきます。</p><ol><li>Identity Governance - カタログ - 該当のカタログを選択 - カスタム拡張機能より、以下の画面を開きます。</li><li>以下のように「ロジック アプリ」列がリンクになっているので、以下の例では Governance_ExtensionApp1 のリンクをクリックします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension24.png"></p><ol start="3"><li>以下のような画面が開きます。既定の設定はそのままにします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension25.png"></p><ol start="4"><li>表示されているステップの間の矢印の上にあるプラス ボタンをクリックし、[アクションの追加] をクリックします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension26.png"></p><ol start="5"><li>追加できるアクションの数々が表示されるので各処理を記述していきます。</li></ol><p>今回は以下のようなアクションを追加していきます。</p><ol><li>アクセス パッケージから渡された情報をもとに変数に格納</li><li>ユーザーの情報を取得</li><li>ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する</li><li>メールの送付先となるアドレスを準備する</li><li>パッケージ内のリソース リンクをユーザーにメール通知する</li></ol><h4 id="1-アクセス-パッケージから渡された情報をもとに変数に格納"><a href="#1-アクセス-パッケージから渡された情報をもとに変数に格納" class="headerlink" title="1. アクセス パッケージから渡された情報をもとに変数に格納"></a>1. アクセス パッケージから渡された情報をもとに変数に格納</h4><p>アクセス パッケージから渡された情報が triggerBody の中に含まれています。渡された情報の中の、「パッケージが割り当てられたターゲットの ObjectID」を取得すると、割り当てられたユーザーを特定することができます。そこで、ここではまず $userID という変数に「パッケージが割り当てられたターゲットの ObjectID」を代入しています。アクセス パッケージの割り当て情報の中の Target 内 ObjectID に記載されているという点を示すために、値にあたる部分は動的なコンテンツとして記載します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension28.png"></p><p>動的なコンテンツの追加は、値のボックスをクリックしたときに表示される選択肢の中から以下を選ぶと、上のように埋め込むことができます。式としては、triggerBody()?[‘Assignment’]?[‘Target’]?[‘ObjectId’] となります。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension29.png"></p><h4 id="2-ユーザーの情報を取得"><a href="#2-ユーザーの情報を取得" class="headerlink" title="2. ユーザーの情報を取得"></a>2. ユーザーの情報を取得</h4><p>ユーザーの情報を取得するためには、 <a href="https://learn.microsoft.com/ja-jp/graph/api/user-get?view=graph-rest-1.0&tabs=http">ユーザーの取得 - Microsoft Graph v1.0</a> を使用します。アクセス パッケージが割り当てられたユーザーの情報は、先ほど $userID 属性に格納したので、以下のように記載します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension30.png"></p><p>また、 Add new parameter を開き、認証のチェックをオンにします。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension31.png"></p><p>先ほど事前にマネージド ID を構成し権限を割り当てたので、以下のように、システム割り当てマネージド ID を選択します。対象ユーザーの項目には、<a href="https://graph.microsoft.com/">https://graph.microsoft.com</a> を入力してください。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension32.png"></p><h4 id="3-ユーザーの部署-department-属性と-ExtensionAttribute1-の属性を更新する"><a href="#3-ユーザーの部署-department-属性と-ExtensionAttribute1-の属性を更新する" class="headerlink" title="3. ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する"></a>3. ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する</h4><p>次に、もう一つ HTTP アクションを追加し、ユーザーを更新するための API を記載します。更新するユーザー情報は、 $userID の変数から利用します。具体的な更新 API は <a href="https://learn.microsoft.com/ja-jp/graph/api/user-update?view=graph-rest-1.0&tabs=http">ユーザーを更新する - Microsoft Graph v1.0</a> に記載がありますので、こちらをもとに必要な情報を埋めていきます。例えば本文内に、「どの部署名に更新したいのか」部署の名前を指定しておきます。今回は、IT という部署に移動したいので以下のように記載します。なお、上記と同様に「認証」のチェックを有効化し、マネージド ID を指定ください。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension33.png"></p><h4 id="4-メールの送付先となるアドレスを準備する"><a href="#4-メールの送付先となるアドレスを準備する" class="headerlink" title="4. メールの送付先となるアドレスを準備する"></a>4. メールの送付先となるアドレスを準備する</h4><p>最後に、E メールをユーザー本人に送付したいので、$mail という変数を作り、事前に取得したユーザー情報の中から Mail 属性の値を取得して格納します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension34.png"></p><p>アクセス パッケージの割り当てによって初めて E メールボックスが作成される場合、アクセス パッケージ割り当て直後にメールを送付するとエラーになる可能性が考えられるため、10 分ほど待機するフローを挿入します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension35.png"></p><p>E メールの送付元となるユーザーを $MailSender という変数に定義します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension36.png"></p><h4 id="5-パッケージ内のリソース-リンクをユーザーにメール通知する"><a href="#5-パッケージ内のリソース-リンクをユーザーにメール通知する" class="headerlink" title="5. パッケージ内のリソース リンクをユーザーにメール通知する"></a>5. パッケージ内のリソース リンクをユーザーにメール通知する</h4><p>E メールの送付は <a href="https://learn.microsoft.com/ja-jp/graph/api/user-sendmail?view=graph-rest-1.0&tabs=http">user: sendMail - Microsoft Graph v1.0</a> の API で実行できますので、以下のように実行します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension37.png"></p><p>本文は以下のように記載し、受信者 (toRecipients) のアドレスに送信先となる $mail を指定します。ここでアクセス パッケージで割り当てたリソース (グループ、アプリケーション、SPO サイト) のリンク先も記載しておきます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension38.png"></p><p>先に記載した HTTP と同様に、認証のチェックをオンに変更し、マネージド ID を指定します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension39.png"></p><p>本文の記載が少々見にくいかと思いますので、以下が参考となりますと幸いです。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;IT 部門へようこそ！\n 異動処理と権限の付与が完了しましたので、メールでお知らせします。\n IT 部門用のチームやSPO サイトが用意されていますので、下記リンクよりアクセスできるか確認してください。\n\n ▼ IT 部門のページ\n SPO サイト\n &#x27;SPO サイトのリンク&#x27; \n\n  チーム\n &#x27;チームのリンク&#x27; \n\n もしアクセスできない場合は、CC に記載されているアドレス宛にメールにてご連絡ください。\n&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;contentType&quot;</span>: <span class="string">&quot;Text&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;ccRecipients&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;emailAddress&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;admin@contoso.onmicrosoft.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;IT 部門へようこそ！&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;toRecipients&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;emailAddress&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;user@contoso.onmicrosoft.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;saveToSentItems&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ちなみに、ロジック アプリの記載においては、デバッグやトラブル シューティングをしながら進めることが多いと思います。ロジック アプリの概要画面を確認すると、成功もしくは失敗の一覧が表示されているので、処理状況の確認が可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension40.png"></p><p>失敗のログをクリックすると、処理のどこでエラーになったのかも分かります。そのため、たとえば以下の場合だと、 HTTP 3 のアクションを見直せばよいことが分かります。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension41.png"></p><p>必要に応じて、<a href="https://jpazinteg.github.io/blog/LogicApps/Integration-graphApi/">Logic Apps 観点のブログ</a> もご確認ください。</p><h3 id="実際の動作"><a href="#実際の動作" class="headerlink" title="実際の動作"></a>実際の動作</h3><p>ユーザーにアクセス パッケージのリンクへアクセスしてもらいます。要求ポリシーが複数ある場合はどちらか選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension42.png"></p><p>必要に応じて、期間や理由を記載のうえパッケージを要求します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension43.png"></p><p>ポリシーの内容にもよりますが、承認などを経てパッケージが割り当てられます。割り当てられると「割り当て」画面にユーザーが表示されます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension44.png"></p><p>パッケージが割り当てられたので、カスタム タスクが発動します。ユーザーの属性が変更されるなどし、最後に以下のような E メールが送付されます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension45.png"></p><p>実行履歴を確認すると、すべて成功しているかどうかなどを確認いただけます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension46.png"></p><p>今回は、アクセス パッケージとカスタム拡張機能を利用したサンプルについて紹介しました。上記内容を参考とし、お客様側のご要件およびご要望に合うカスタム拡張機能を実装いただければ幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;今回は、Microsoft Entra ID のエンタイトルメント管理 (アクセス パッケージ) の機能をより活用できる、カスタム拡張機能について紹介します。&lt;/p&gt;
&lt;p&gt;今回の記事は、アクセス パッケージ</summary>
      
    
    
    
    
    <category term="Entitlement Management" scheme="https://jpazureid.github.io/blog/tags/Entitlement-Management/"/>
    
    <category term="Access Package" scheme="https://jpazureid.github.io/blog/tags/Access-Package/"/>
    
  </entry>
  
  <entry>
    <title>条件を利用した Azure RBAC のロール割り当て</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/rbac-role-assignment-using-conditions/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/rbac-role-assignment-using-conditions/</id>
    <published>2023-11-26T00:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.294Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>本記事は、2023 年 10 月 25 日に公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/delegate-azure-role-assignment-management-using-conditions/ba-p/3954216">Delegate Azure role assignment management using conditions</a> をもとに、日本語に分かりやすくおまとめした記事となります。ご不明点などございましたら、お気軽にサポートまでお問い合わせください。</p><hr><p>今回、 Azure ロールを割り当てる時に条件を指定する機能がパブリック プレビューとして公開されました。</p><p>これまでは、他の人にロールを割り当て可能な権限を委譲する際は、所有者もしくはユーザー アクセス管理者のロールを割り当てる必要がありました。具体的には、例えばこの記事を読んでいらっしゃる皆様がサブスクリプションの所有者を持っていると仮定して、社内の開発者から「開発で利用したいのでサブスクリプションのロールを他の人に割り当てる権限が欲しい」という要望をいただいたとします。このとき、これまでサブスクリプションの所有者として社内の開発者にできることとしては、「開発者に、所有者もしくはユーザー アクセス管理者を付与する」という操作でした。</p><p>しかし、開発者に所有者もしくはユーザー アクセス管理者を付与をしてしまうと、開発者が以下のようなこともできてしまいます。これは開発者に付与するには大きすぎる権限です。</p><ul><li>所有者となった場合、サブスクリプションを削除したり、開発に関係のないリソースを変更したりできる</li><li>いずれのロールの場合も、自身に追加でロールを割り当てて権限を昇格することができる</li></ul><p>一方で、開発者から依頼があったときだけロールを付与する形にすると、スムーズな開発を妨げたり、承認フローで余計な時間がかかったりということとなります。</p><p>今回のパブリック プレビューでは、特定の条件を指定してロールの割り当てを作成する権限を付与できるようになりました。具体的には以下の 2 つの方法がありますので、それぞれ案内します。 </p><ul><li>条件を利用して制約されたロールを割り当てる</li><li>条件を組み込んだ新しい組み込みロールを作成する</li></ul><h2 id="条件を使用してロールの割り当て管理を委任する方法"><a href="#条件を使用してロールの割り当て管理を委任する方法" class="headerlink" title="条件を使用してロールの割り当て管理を委任する方法"></a>条件を使用してロールの割り当て管理を委任する方法</h2><p>この方法は、アクセス許可を委任するユーザーに対し、ロールが利用できる条件を細かく指定するものです。例えば、以下の Alice という管理者は、ユーザー アクセス管理者を持っていますので、誰に対してもロールを割り当てられます。今回、Dara というユーザーに、ロール割り当て操作を委任することにしましたが、Alice が持っているユーザー アクセス管理者ロールのように、誰にでも自由にロールを割り当てられる構成にはしたくありません。</p><p>この時に今回の「条件を利用した Azure RBAC のロール割り当て」が活用できます。今回 Alice は Dara に対し、以下の条件を付けて「Role Based Access Control Administrator (Preview)」というロールを付与しました。</p><ul><li>AcrPull と AcrPush ロールは付与してもよいが、その他のロールは他のユーザーに付与できない</li><li>ユーザーやグループに対してはロールを付与できないが、サービス プリンシパルになら付与できる</li></ul><p>すると、Dara は ① のようにサービス プリンシパルに対して、 AcrPull や AcrPush のロールを付与することができます。一方、② や ③ では、ユーザーに対してロールを付与しようとしているため、条件に合わず割り当てができません。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions1.png"></p><p>Role Based Access Control Administrator (Preview) の付与方法は下記のとおりです。この操作を行うのは上記画面例ですと Alice になります。</p><ol><li><p>サブスクリプション - アクセス制御（IAM） - 役割の画面を開き、ロール名を検索します。ポータルが日本語の場合でも、現時点ではロール名は英語のため、英語で検索ください。下記のように、ロールが表示されていることを確認します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions2.png"></p></li><li><p>上記画面の [追加] - [ロールの割り当ての追加] をクリックし、割り当ての追加画面を開きます。</p></li><li><p>下記の画面が表示されるので、 [特権管理者ロール] のメニューを選択のうえロール名を検索し、クリックします。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions3.png"></p></li><li><p>このロールを割り当てたいユーザー（上記画面例ですと Dara にあたるユーザー）を指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions4.png"></p></li><li><p>次の画面に進み、委任の種類が “制約あり (おすすめ)” となっていることを確認します。さらに、その下にある「条件を追加する」をクリックします。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions5.png"></p></li><li><p>下記の画面が表示されるので、追加したい条件によって選択します。今回は、ロールとプリンシパルのタイプを指定したいので、真ん中を指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions6.png"></p></li><li><p>右側に下記のような画面が表示されるので、許可してもよいロールやプリンシパルを指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions7.png"></p></li><li><p>選択が完了すると、下記のように「構成済み」となる点を確認します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions8.png"></p></li><li><p>下記画面にて最終確認を行い、ロールの割り当てを実施すれば完了です。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions9.png"></p></li></ol><h2 id="条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法"><a href="#条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法" class="headerlink" title="条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法"></a>条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法</h2><p>この方法は、新しく利用できるようになった組み込みロールを使う方法です。具体的には、Virtual Machine Data Access Administrator (preview) というロールや、Key Vault Data Access Administrator (preview) というロールが利用できるようになりました。こちらのロールを利用することで、関連するロールのみをユーザーに割り当てることができるようになります。</p><p>具体的に以下の図のとおりに説明いたしますと、Virtual Machine Data Access Administrator (preview) が割り当てられたユーザー Dara は、② や ③ のように、仮想マシンの管理者ログイン ロールや、仮想マシンのユーザー ログイン ロールを付与することができます。一方、① のように仮想マシンのアクセスに関連のないロールについては付与できないため、① の割り当ては失敗します。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions10.png"></p><p>割り当て方法は通常のロール割り当てと同様で、ロール割り当て画面で上記 2 つのロールのいずれかを指定する形になります。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions11.png"></p><p>ロールを割り当てるユーザー（上記例ですと Dara にあたるユーザー）を指定してロールを割り当てます。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions12.png"></p><p>もし、割り当て可能なプリンシパルを制限したい場合は、先の例と同様に条件を指定することも可能です。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions13.png"></p><p>条件を使用した場合は、下記のように構成済みと表示されているかを確認し、割り当てを完了します。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions14.png"></p><p>Data Access Administrator という文字列が含まれているロールには、既定で条件が組み込まれています。下記のように、ロールのアクセス許可を確認する画面で JSON タブを開き、condition と記載されている部分を確認すれば条件を確認可能です。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions15.png"></p><p>今後、一般的なシナリオを想定して、条件を組み込んだロールを追加していく予定です。簡単なロールの割り当てでリソースの管理ができるようになりますので、今後のアップデートをお待ちください。詳細につきましては、 <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/delegate-role-assignments-examples?tabs=template">条件 (プレビュー) を使用して Azure ロールの割り当てを委任する例</a> の公開情報も参考となりますと幸いです。</p><p>本機能に関するフィードバックにつきましては、下記画面の右上にございます「フィードバック」から承っております。お客様のご意見・ご要望をお待ちいたしております。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions16.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 10 月 25 日に公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blo</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Authenticator の新機能によるセキュリティの改善</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/emphasizing-security-by-default-with-advanced-microsoft/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/emphasizing-security-by-default-with-advanced-microsoft/</id>
    <published>2023-11-21T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.942Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 11 月 6 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/emphasizing-security-by-default-with-advanced-microsoft/ba-p/3773130">Emphasizing Security by Default with Advanced Microsoft Authenticator Features</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>弊社では、これまで多要素認証 (MFA) の重要性を強調し、MFA の方法によって認証の強度に違いがあること、特に Microsoft Authenticator は電話認証 (そろそろ使うのやめましょう！) よりもかなり安全性が高いことを繰り返し申し上げてきました。またこれまでの取り組みとして、Microsoft Authenticator における番号の一致機能を実装することで、MFA 疲労攻撃を行う悪意ある攻撃者の阻止に取り組んできました。</p><p>この番号の一致機能は非常に効果的であるものの、MFA 疲労攻撃を仕掛けてくる攻撃者の影響をユーザーが受けてしまう余地はまだあります。というのも、モバイル デバイス上に表示される認証のポップアップ通知が (ユーザーにとっては非常に便利な機能ではあるのですが) 攻撃者によるフィッシングの “きっかけ” を与えてしまうことがあるのです。この対応として、通常とは異なると判断された認証要求に関しては、Authenticator アプリのポップアップ通知を抑制するという追加の対応を取ることといたしました。これらの変更は 9 月末に完了し、信頼性の低いポップアップ通知の数を減らすことに成功しました。この展開が始まって以来、<strong>600 万件以上のパスワードレスおよび MFA 通知</strong> を防ぐことができました。これら抑制した通知の大部分は、顧客にとって価値のないハッカーによる通知でした。</p><h2 id="危険な-Authenticator-通知の抑制"><a href="#危険な-Authenticator-通知の抑制" class="headerlink" title="危険な Authenticator 通知の抑制"></a>危険な Authenticator 通知の抑制</h2><p>この機能の展開後、現在では、認証要求の発信元が見知らぬ場所である場合や、その他の異常が見られる場合など、潜在的なリスクが検出された場合に Authenticator によるポップアップ通知を抑制しています。この対応により、お客様にとって価値のない認証ポップアップを排除することとなり、ユーザーの不便さを大幅に軽減しました。</p><p>認証要求に問題がなければ、以下のようにモバイル　デバイスに通知が届きます。</p><p><img src="/blog/azure-active-directory/emphasizing-security-by-default-with-advanced-microsoft/pic1.png"></p><p>危険と思われる認証要求があった場合、<strong>ユーザーにポップアップ通知が表示されません</strong>。代わりに、Authenticator アプリを開き、表示された番号を入力してサインインするよう求められます。</p><p>ユーザーが Authenticator アプリを開けば、認証要求が表示され、ユーザーはそれを承諾もしくは拒否することが可能となります。</p><p><img src="/blog/azure-active-directory/emphasizing-security-by-default-with-advanced-microsoft/pic2.png"></p><p>ユーザーが Authenticator アプリを開けば、その内容をユーザーが確認可能です。</p><p><img src="/blog/azure-active-directory/emphasizing-security-by-default-with-advanced-microsoft/pic3.png"></p><h2 id="Authenticator-の通知の取得"><a href="#Authenticator-の通知の取得" class="headerlink" title="Authenticator の通知の取得"></a>Authenticator の通知の取得</h2><p>通知が勝手に削除されるわけではないのでご安心ください。単に通知が抑制されるだけであり、Authenticator アプリを開けばユーザーが認証要求を確認することが可能です。ユーザーが通常とは異なる場所から、実際に自身で認証要求を行った場合も、Authenticator アプリを開くことで通知を取得することができます。Authenticator アプリはすべての認証通知をまとめる箇所として機能しますので、見逃した要求があっても簡単にそれを確認できるはずです。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>この機能の実装により、ユーザーによりスムーズで安全な体験が提供できたと考えています。テクノロジーの進化に伴い、ユーザーの利便性を高めると同時にセキュリティを強化することは極めて重要です。この <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-authenticator-app">新しいアプローチ</a> はその良い例といえるでしょう。</p><p>Alex Weinert<br>VP Director of Identity Security, Microsoft</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 11 月 6 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommuni</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>パブリック プレビュー Microsoft Entra Internet Access のご紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-internet-access/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-internet-access/</id>
    <published>2023-11-16T01:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.170Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>本記事は、2023 年 9 月 18 日に公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-internet-access-an-identity-centric-secure-web/ba-p/3922548">Microsoft Entra Internet Access: An Identity-Centric Secure Web Gateway Solution</a> の記事を日本語に分かりやすくおまとめしなおした記事となります。ご不明点などございましたら、お気軽にサポートまでお問い合わせをいただけますと幸いです。</p><p>なお、本記事は 下記記事の続編となりますので、併せてご確認ください。</p><ol><li><a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/">Microsoft Entra - Security Service Edge へ拡大するための新機能</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-private-access-an-identity-centric-zero-trust-network-access-solution/">Microsoft Entra Private Access: ID を中心としたゼロ トラスト ネットアーク アクセス ソリューション</a></li></ol><p>ご不明点などございましたら、お気軽にサポートまでお問い合わせください。</p><hr><h2 id="これまでのシリーズ記事"><a href="#これまでのシリーズ記事" class="headerlink" title="これまでのシリーズ記事"></a>これまでのシリーズ記事</h2><p>多くのお客様では、ネットワークの境界にファイアウォールなどを設置し、内部ネットワークへのアクセスには VPN を使うなどしていると思います。こうした方法は、ネットワーク内にリソースとユーザーを囲い込み、外部からのリモート アクセスを許可するという従来のシナリオでは有益でしたが、クラウド化やリモート ワークおよびハイブリッド ワークの広がりにより現代のセキュリティ要件やビジネス要件を満たせなくなってきつつあります。</p><p>また、内部ネットワークにさえは入れれば権限管理が厳密に行われてないことも多く、ユーザーの資格情報が 1 人漏洩するだけで、攻撃の横展開を許し、機密情報など重要な情報が流出してしまう危険などもあります。従業員が様々な場所からインターネットを介し、より安全に情報にアクセスできるよう、Microsoft では、2023 年 7 月に、2つの新しい機能が利用できるようになりました。</p><ul><li>Microsoft Entra Internet Access</li><li>Microsoft Entra Private Access</li></ul><p>この概要を、上記 1. のブログにて以前紹介し、Microsoft Entra Private Access の詳細な紹介を 2. にておまとめしております。今回は残りの、 Microsoft Entra Internet Access の機能について紹介します。</p><h2 id="Microsoft-Entra-Internet-Access"><a href="#Microsoft-Entra-Internet-Access" class="headerlink" title="Microsoft Entra Internet Access"></a>Microsoft Entra Internet Access</h2><p>Microsoft Entra Internet Access は、ID を中心とした Secure Web Gateway (SWG) と呼ばれる機能です。悪意のあるインターネット通信、安全でないコンテンツ、コンプライアンス違反のコンテンツなどの脅威から保護します。一部のシナリオ向けに先にパブリック プレビューが開始されておりましたが、現在まだご利用いただけていないシナリオにおいても、間もなくパブリック プレビューが開始されます。この機能は、以前ご案内した Microsoft Entra Private Access やその他の Microsoft Entra 製品と連動しています。例えば、条件付きアクセスを利用して、Microsoft 365 を含む様々なインターネット上の情報と SaaS アプリケーションへのアクセス ポリシーを一本化可能です。</p><p><img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access1.png"></p><p>セキュリティ担当者は、ユーザー、デバイス (エンドポイント)、ネットワークなどに対し、きめ細やかなアクセス制御を行うことができます。Web フィルタリング、クロステナント保護、データ損失防止、パケット インスペクションなど高度な機能によって、ユーザーやアプリ、リソースを保護できます。</p><h2 id="特徴"><a href="#特徴" class="headerlink" title="特徴"></a>特徴</h2><ol><li><p>ID 中心のアクセス制御と Microsoft Entra との連携</p><p> Microsoft Entra と深く紐づいている機能のため、条件付きアクセスにてより多くの対象を保護できるようになります。あらゆる外部通信、インターネット リソース、およびクラウド アプリケーションの指定などが可能です。「継続的なアクセス評価」も含まれるようになるため、例えば ID への攻撃が検出された場合など、条件が変われば即座にアクセスを取り消すことができるようになります。</p><p> この条件付きアクセスとの統合により、SWG、CASB、ファイアウォールの各種ポリシーを適用しながら、デバイス、ユーザー、場所、およびリスクなどきめ細かな条件を活用して、企業の状況に応じたセキュリティ要件を実現することができます。</p></li><li><p>高いパフォーマンスと柔軟性</p><p> マイクロソフトのプライベート広域ネットワークやマイクロソフトのグローバルネットワーク、ユーザーに最も近い PoP (Points of Presence) を利用したグローバル分散プロキシを利用することで、余分なホップを排除してアプリやリソースへのルーティングを最適化しています。これにより、離れた場所からのアクセスでも高速で利用できます。</p><p> また、ユーザーの所在地からわずかミリ秒しか離れていないエッジを通じて、リモートで働く従業員と支社をシームレスに接続できるようになりました。これにより、インターネットとの往来におけるトラフィックの無用な往復や単一障害点を回避することができます。</p></li><li><p>Microsoft 365 アプリケーションのセキュリティとデータ監視の強化</p><p> Microsoft 365 向けに、独自のセキュリティと監視機能を多数提供しています。Microsoft 365 向けのデータ保護の仕組みとしては、きめ細かな適応型アクセス制御、トークンの盗難やデータの流出に対する保護が含まれます。また、ユーザー、デバイス、および場所に関するほぼリアルタイムなログ取得を通じて、セキュリティ上重要な活動を監視しています。</p></li><li><p>サードパーティの SSE ソリューションとのサポート</p><p> Microsoft Entra Internet Access は、すべてのインターネット リソース、SaaS、Microsoft 365 へのアクセスを保護するメインのソリューションとして導入することも、他の SSE ソリューションと並行して導入することもできます。たとえば Microsoft Entra Internet Access は Microsoft 365 向けのセキュリティと監視機能に利用し、それ以外のインターネット トラフィックと SaaS アプリは、選択した他の SSE ソリューションで保護するような構成も可能です。お客様の環境に応じて、Microsoft Entra Internet Access のみを利用するか、現在利用している他のサービスと併用するか柔軟に決めることができます。</p><p> トラフィックは、エンドユーザーのデバイスからクライアント ベースのアプローチで取得することも可能ですし、またはリモート ネットワークから Ipsec トンネルを実行する方法でも取得可能です。Microsoft Entra の管理センターで、Microsoft 365 トラフィックへのセキュアなアクセスを簡単に有効にすることができます。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access2.png"></p></li></ol><h2 id="Internet-Access-の主要な機能"><a href="#Internet-Access-の主要な機能" class="headerlink" title="Internet Access の主要な機能"></a>Internet Access の主要な機能</h2><ol><li><p>条件付きアクセスのカバー範囲の拡大</p><p> これまで条件付きアクセスでは、ターゲット リソースとしてアプリケーションを明示的に指定したり、アプリ フィルターを用いて特定のカスタム セキュリティ属性をもつアプリを対象にするような構成としていたかと思います。この新機能を利用すると、下記の画面にてインターネット トラフィックを選択できるようになるため、ポリシーの対象として、アプリだけでなく、アクセス先のネットワーク自体を指定できるようになり、より広くきめ細かな範囲にポリシーを適用できるようになります。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access3.png"></p><p> ※ 2023/10/19 現在、インターネット トラフィックおよびプライベート アクセス  トラフィックへの条件付きアクセスの適用はサポートされていません。それぞれ下記の公開情報をもとに、代替案やプライベート プレビューへの申請をご検討ください。</p><p> <a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/concept-universal-conditional-access#known-limitations">Global Secure Access 経由のユニバーサル条件付きアクセスについて説明します</a></p><ul><li>プライベート アクセス トラフィックへの条件付きアクセス ポリシーの適用は現在サポートされていません。 この動作をモデル化するために、クイック アクセスと Global Secure Access アプリに対してアプリケーション レベルで条件付きアクセス ポリシーを適用できます。 詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-target-resource-private-access-apps">Private Access アプリに条件付きアクセス ポリシーを適用する</a> を参照ください。</li><li>インターネット トラフィックへの条件付きアクセス ポリシーの適用は現在サポートされていません。 インターネット トラフィックはプライベート プレビュー段階です。 プライベート プレビューへのアクセスを要求するには、[こちらの Forms](<a href="https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7Lm8YtbKDdHu3wnC0DGKg5UQUhPRU44R0RLVEwySTJYVUVGNEwyVjVIVi4u%5D">https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7Lm8YtbKDdHu3wnC0DGKg5UQUhPRU44R0RLVEwySTJYVUVGNEwyVjVIVi4u]</a> から申請ください。</li></ul></li><li><p>データ流出の防止</p><p> テナント制限 v2 は強力なデータ流出防止機能であり、管理対象デバイスや指定されたネットワークからの外部アクセスのリスクを管理できます。 Microsoft Entra Internet Accessでは、企業側でプロキシを使用することなく、すべての OS およびブラウザ プラットフォームで一括してテナント制限の機能を適用できるため、より柔軟できめ細かな制御が可能になります。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access4.png"></p></li><li><p>トークンの窃取からの保護</p><p> Internet Access 機能では、条件付きアクセスに統合された構成として、準拠済みネットワークの概念を導入しています。この制御により、Microsoft Entra と統合されたクラウド アプリケーションをトークンの盗難から保護し、ユーザーが重要なクラウド サービスにアクセスする際に、テナント固有のネットワーク セキュリティポリシーを迂回しないようにすることができます。また、トークンの盗難が検出された場合は、継続的なアクセス評価を使用して Microsoft 365 アプリやリソースへのアクセスを即座にブロックすることもできます。</p><p> なお、Microsoft 365 トラフィックに対する条件付きアクセスについては、継続的アクセス評価が現在サポートされていないため、今後のアップデートをお待ちください。</p><p> <a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/concept-universal-conditional-access#known-limitations">Global Secure Access 経由のユニバーサル条件付きアクセスにおける既知の制限事項</a></p></li><li><p>ソース IP アドレスを維持する</p><p> 一般的なプロキシは、ユーザーの元のソース IP を隠蔽し、条件付きアクセスの場所ポリシーの適用を困難にしてしまいます。そのため、リスク検出とアクティビティログの精度に影響を与えていました。Microsoft Entra Internet Access は、ユーザーの元のソース IP が維持されるようにすることで、条件付きアクセス、継続的なアクセス評価、ID のリスク検出、およびログにおける信頼できる場所の確認において、下位互換性を提供します。</p><p> 関連する設定箇所については以下をご覧ください。まず、グローバル設定 - セッション管理 内の下記画面にてチェックをオンにします。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access5.png"></p><p> 下記にて場所ポリシーを厳密に管理するよう条件付きアクセスを構成することで、場所に関するポリシーがより厳密に動作します。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access6.png"></p></li><li><p>条件付きアクセスでネットワーク アクセス制御を統一的に管理 </p><p> ユーザー、デバイス、場所、リスク構成など、条件付きアクセスで利用可能な豊富な条件に基づいて、あらゆるインターネットの宛先にネットワーク セキュリティ ポリシーを適用できるようになります。条件付きアクセスのセッション タブに「Global Secure Access Policy を利用する」の設定が追加され、今後利用できるようになります。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access7.png"></p></li><li><p>エンド ユーザーによる安全でないコンテンツへのアクセスを制限します。</p><p> 条件付きアクセスにおける、ユーザー、デバイス、場所の制御により、Web コンテンツ フィルタリング (URL、FQDN、Web カテゴリ) をもちいたアクセス制限も可能になります。攻撃対象の領域を減らし、ネットワーク セキュリティの管理体験がよりシンプルになります。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access8.png"></p><p> ※ 本機能は現在プライベート プレビューのため、まだ一般にはご利用いただけません。下記のような画面が表示されますので、パブリック プレビューの展開をお待ちください。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access9.png"></p></li><li><p>製品レポートとダッシュボード</p><p> レポートとダッシュボードにより、環境の全体像を簡単に把握し、組織で共有することが可能となります。導入状況を確認し、新たなリスクを検出し、問題を迅速に修正することもできます。当社のダッシュボードは、マイクロソフトの SSE ソリューションを通じて接続されているユーザー、デバイス、宛先のその時点での全体像を提供します。来年早々には、ポリシーに関する解析情報と推奨事項が強化され、高度なアプリとネットワークの検出機能が提供される予定です。クライアントがインストールされているアクティブなデバイスの数や、どのあて先に通信が多く行われているかなども確認可能です。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access10.png"></p></li><li><p>ネットワーク トラフィック ログに基づくカスタム ビューとダッシュボード</p><p> トラフィック ログのページでは、ソリューションを通じて発生したすべてのリクエストとレスポンスのトランザクションを可視化することができます。これらのログでは、デバイス ID、オペレーティング システム名とバージョンなど、デバイスから収集された情報を見ることもできます。 また、ソース IP とポート、宛先 IP とポート、FQDN などの関連するパケット情報も見ることができます。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access11.png"></p><p> 診断設定で NetworkAccessTrafficLogs にチェックを入れて転送すると、 Log Analytics 側にてログを確認することができます。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access12.png"></p><p> Entra 管理センター上では一覧でしか確認できませんが、クエリを利用すれば、特定の条件のログを抽出することなども可能です。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access13.png"></p></li><li><p>Microsoft 365 のセキュリティ イベントをリアルタイムに可視化</p><p>精細なログから、Microsoft 365 アプリとリソースの脅威を簡単かつ迅速に検出いただけます。インターネット アクセス ソリューションは、Microsoft 365 のログをユーザー、場所、デバイスの豊富な情報で拡張し、ユーザーの利用に影響を与えずに、ほぼリアルタイムに情報を提供します。</p><p><img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access14.png"></p></li></ol><p>下記の機能は現在開発中で、来年早々にリリースされる予定です:</p><ul><li>送受信トラフィックの制限機能: ユーザーの利用形態を考慮したクラウド ファイアウォールを活用することで、たきめ細かなポリシー条件により、IP アドレス、ポート、プロトコルなどに基づいて制限を行えるようにします。</li><li>悪意のあるネットワーク活動の特定とブロック: 侵入検知防御システム (IDPS) と脅威インテリジェンスにより、既知の悪意のある IP/FQDN/URL を特定およびブロックします。</li><li>暗号化されたトラフィックの検査: すべての TCP/UDP トラフィックに対してきめ細かな TLS のインスペクションを行います。</li></ul><h2 id="Microsoft-Entra-Internet-Access-の展開方法"><a href="#Microsoft-Entra-Internet-Access-の展開方法" class="headerlink" title="Microsoft Entra Internet Access の展開方法"></a>Microsoft Entra Internet Access の展開方法</h2><p>下記公開情報に記載の手順を 4 つ実施いただくことで構成が可能です。2 の手順にて、エンド ユーザーのデバイスにクライアントをインストールする手順がございますので、あらかじめ要件を満たす Microsoft Entra 参加済みデバイスもしくはハイブリッド参加済みデバイスをご用意のうえ実施いただけますと幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-get-started-with-global-secure-access#microsoft-entra-internet-access">Global Secure Access の概要 (プレビュー)</a></p><p>   <img src="/blog/azure-active-directory/microsoft-entra-internet-access/microsoft-entra-internet-access15.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 9 月 18 日に公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog</summary>
      
    
    
    
    
    <category term="Global Secure Access" scheme="https://jpazureid.github.io/blog/tags/Global-Secure-Access/"/>
    
  </entry>
  
  <entry>
    <title>認証に電話網を使うのはそろそろやめよう</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/it-s-time-to-hang-up-on-phone-transports-for-authentication/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/it-s-time-to-hang-up-on-phone-transports-for-authentication/</id>
    <published>2023-11-16T00:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.126Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2020 年 11 月 10 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/it-s-time-to-hang-up-on-phone-transports-for-authentication/ba-p/1751752">It’s Time to Hang Up on Phone Transports for Authentication</a> の抄訳です。新着記事ではありませんが、以前より繰り返し様々な記事で参照されており、多くのお客様にとって有用であるため抄訳しました。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>以前のブログ <a href="https://jpazureid.github.io/blog/azure-active-directory/your-password-doesnt-matter/">パスワードで攻撃は防げない - Your Pa$$word doesn’t matter</a> では、パスワードに潜む脆弱性を明らかにしました。加えて、「でもパスワード以外の他の認証方法も侵害される可能性あるでしょ」という無数の DM や E メールに対する答えとして、<a href="https://jpazureid.github.io/blog/azure-active-directory/all-your-creds-are-belong-to-us/">君達の資格情報は全ていただいた！</a> の記事を執筆しました。この <a href="https://jpazureid.github.io/blog/azure-active-directory/all-your-creds-are-belong-to-us/">君達の資格情報は全ていただいた！</a> の記事では、パスワード以外の認証方法にも脆弱性があることを概説し、FIDO、Windows Hello、Authenticator App のようなパスワードレスかつ暗号的に保護された認証方法の有用性をアピールしました。</p><p>本日、皆様が <strong>SMS と音声の多要素認証 (MFA) の仕組みはもう使うべきでない</strong> と確信を持ち、実際にそれを行動に移せるよう、その後押しをしたいと思っています。SMS と音声の仕組みは公衆交換電話網 (PSTN) に基づいており、これは現在利用可能な MFA の方法の中で最も安全性が低いと言えます。MFA の採用が増えるにつれ、攻撃者の関心は MFA をいかに突破するかに向けられつつあります。加えて、特別にデザインされた認証の仕組みがセキュリティと利便性をより高めている中で、SMS と音声の安全性の低さは際立つばかりです。パスワードレスの強力な認証へ今すぐ移行ください。Authenticator アプリを利用すれば、今すぐに安全な認証が行え、しかも進化する脅威にも対応が可能です。</p><p>繰り返しになりますが、<strong>MFA はもはや必須</strong> です。議論は、どの MFA の方法を使用するかであり、MFA を使用すべきかどうかではありません。以前のブログにも書いたとおり「多要素認証 (MFA) は、アカウントの保護を真剣に考えているのであれば、最低限取り組むべきこととして変わりありません。パスワードに加えて何かしらのものを使えば、攻撃者のコストは大幅に増加します。このため、何らか MFA を使用しているアカウントが乗っ取られる率というのは、全体の 0.1% 以下になります。」</p><h2 id="問題が入り込む余地が多すぎ"><a href="#問題が入り込む余地が多すぎ" class="headerlink" title="問題が入り込む余地が多すぎ"></a>問題が入り込む余地が多すぎ</h2><p>PSTN には、資格情報を悪用するあらゆるアプローチが適用出来てしまうのです。OTP のフィッシングも可能ですし、ソーシャル エンジニアリングも可能、アカウントの乗っ取りももちろん可能、デバイスの盗難も可能です。PSTN には他のすべての認証機器の脆弱性があり、加えて PSTN 固有の問題も抱えています。</p><h2 id="適応性がない"><a href="#適応性がない" class="headerlink" title="適応性がない"></a>適応性がない</h2><p>PSTN のメッセージを受信するデバイスは多種多様なため、メッセージのフォーマットが限定されていることが挙げられます。メッセージのフォーマットを多種多様にしたり、長くしたりすることはできず、OTP を短いテキスト メッセージや電話で送信すること以上のことはできません。サービス提供において重要なのは、ユーザーの期待や技術的進歩、および攻撃者の行動にリアルタイムに適応することです。残念ながら、SMS と音声の形式にはこういった適応性がないため、ユーザービリティとセキュリティの観点での技術革新の余地は非常に限られています。</p><h2 id="データが平文で転送されている"><a href="#データが平文で転送されている" class="headerlink" title="データが平文で転送されている"></a>データが平文で転送されている</h2><p>SMS と音声のプロトコルが開発された当初は、暗号化については特に検討なく設計されました。実用的なユーザビリティの観点から、これらのプロトコルに暗号化を組み込むことはできません。なぜなら、ユーザーが暗号化されたメッセージを読めなくなってしまうからです (メッセージのサイズの膨張など、既存のプロトコルにこれらを組み込めない他の理由もあります)。つまり、これは電話交換網にアクセスできる人やデバイスの無線が届く範囲内の人であれば、誰でも傍受できることを意味します。前述の <a href="https://jpazureid.github.io/blog/azure-active-directory/all-your-creds-are-belong-to-us/">君達の資格情報は全ていただいた！</a> の記事で述べたように、攻撃者は <a href="https://www.securitynewspaper.com/2018/02/19/intercept-mobile-communications-calls-messages-easily-without-hacking/">ソフトウェアウェアベースの無線を使用してメッセージを傍受</a> したり、近くの <a href="https://securitywatch.pcmag.com/hacking/314370-black-hat-intercepting-calls-and-cloning-phones-with-femtocells">FEMTO</a> を使用したり、<a href="https://www.theverge.com/2017/6/13/15794292/ss7-hack-dark-web-tap-phone-texts-cyber-crime">SS7 傍受サービス</a> を使用したりして電話網の通信を盗聴することが可能です。これは、PSTN システムに固有の脆弱性であり、周到に準備した攻撃者であればこういった攻撃手法も利用可能なのです。</p><h2 id="ソーシャル-エンジニアリングが容易である"><a href="#ソーシャル-エンジニアリングが容易である" class="headerlink" title="ソーシャル エンジニアリングが容易である"></a>ソーシャル エンジニアリングが容易である</h2><p>ほとんどの PSTN システムはオンラインのアカウントと充実したカスタマー サポートの仕組みに支えられています。残念ながら、カスタマー サポートの担当者は誘惑、強制、賄賂、または恐喝の影響を受ける可能性があります。これらのソーシャル エンジニアリングの攻撃が成功すれば、カスタマー サポート自らが攻撃者に対して SMS または音声チャネルへアクセスさせてしまうことになります。ソーシャル エンジニアリング攻撃は E メールのシステムにも影響を与えますが、主要な E メール システム (例えば、Outlook や Gmail) は、サポート全体をとおしてアカウントの侵害を防ぐための防止策がよりしっかりと準備されています。こういったことで、PSTN システムではメッセージの傍受から、転送攻撃、SIM ジャッキングまで、さまざまなことが引き起こされます。</p><h2 id="モバイル事業者の信頼性に依存する"><a href="#モバイル事業者の信頼性に依存する" class="headerlink" title="モバイル事業者の信頼性に依存する"></a>モバイル事業者の信頼性に依存する</h2><p>残念ながら、PSTN システムには 100% の信頼性はなく、信頼性の報告自体も 100% 一貫しているわけではありません。これは地域やキャリアによりますが、メッセージが手元に届くまでの経路によって、到達までにどれくらいの時間かかるか、またはそもそも届くのか届かないのかが変わってきます。場合によっては、キャリアは配信が失敗したのに配信成功と報告することもあります。メッセージの配信に時間がかかりすぎて、ユーザーからするとメッセージが届いていないと思ってしまうこともあるぐらいです。地域によっては、配信の成功率が 50% 以下というところもあるのです。SMS は「送信したらそれでおしまい」というタイプの配信の仕組みなので、MFA のサービスを提供する事業者はメッセージの配信に関する問題の有無を確認できるようなリアルタイムのデータを持っていません。統計的な配信完了率やヘルプ デスクのコール数から問題の発生状況を類推しているのです。このことから、ユーザーに問題の発生状況を通知したり、電話網以外の代替案をお勧めしたりするのが難しいことがわかります。</p><h2 id="規制当局による変更の影響を受けやすい"><a href="#規制当局による変更の影響を受けやすい" class="headerlink" title="規制当局による変更の影響を受けやすい"></a>規制当局による変更の影響を受けやすい</h2><p>SMS におけるスパムの増加により、規制当局は識別コード、送信レート、メッセージ内容、送信許可、および「STOP」のようなメッセージへの応答に関する規制を要求しています。しかし残念ながら、これらの規制はすぐに変更されますし、地域によって一貫性がなく、大規模な配信停止を引き起こす可能性もあります (実際に引き起こしています)。配信の障害が多ければ多いほど、ユーザーの不満は増すばかりです。</p><h2 id="一連の認証の流れを意識させづらい"><a href="#一連の認証の流れを意識させづらい" class="headerlink" title="一連の認証の流れを意識させづらい"></a>一連の認証の流れを意識させづらい</h2><p>SMS テキストや音声という媒体には、ユーザーに伝えられる情報量に制限があります。SMS は 160 文字、GSM を使用しない場合は 70 文字を配信できますが、エンコーディングが必要な言語になると、メッセージ分割なしではその半分程度しか配信できないのが実際のところです。フィッシングは深刻な脅威であり、ユーザーに可能な限り多くの情報を提供したい (または、Windows Hello や FIDO を使用してフィッシングを不可能にしたい) と考えていますが、SMS や音声形式は、認証が要求された際の一連の流れや詳細情報を提供する機能に制限があるのです。</p><h2 id="他の認証方法が進化してきた"><a href="#他の認証方法が進化してきた" class="headerlink" title="他の認証方法が進化してきた"></a>他の認証方法が進化してきた</h2><p>まとめますと、きっと今後皆さまも MFA を使用するようになると思いますが、問題はどの MFA を使用するのかなのです。モバイル デバイスを使用しているほとんどのユーザーに関しては、適切な答えはアプリベースの認証です。つまり弊社においては、それは <a href="https://www.microsoft.com/authenticator">Microsoft Authenticator</a> を意味します。Microsoft Authenticator は暗号化された通信を使用しており、認証ステータスについての双方向通信を行えます。また、ユーザーが自分自身を安全に保つためのさらなる追加情報と制御機能をアプリに追加するべく開発を進めています (訳注: 2020 年当初)。2019 年だけでも、アプリ ロック、ロック画面からの通知の非表示、アプリ内のサインイン履歴の機能などを追加しました。SMS と音声通話は今後もそのまま進化しませんが、お客様が Microsoft Authenticator アプリを実際に利用しようとした際には、こういった Microsoft Authenticator アプリの新機能はさらに増えて進化し続けているのです。</p><p>PSTN を利用するのはやめて、Microsoft Authenticator を使いましょう。これだけでユーザーはより良い認証の体験がえられ、より安全になるのです。</p><p>安全にお過ごしください！</p><p>Alex (Twitter: <a href="http://twitter.com/alex_t_weinert">@alex_t_weinert</a>))</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2020 年 11 月 10 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommun</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ハイブリッド参加を再構成する (簡易版)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/</id>
    <published>2023-11-14T03:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.166Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの長谷川です。</p><p>この記事では、対象デバイスの Microsoft Entra ハイブリッド参加を再構成する手順の簡易版を紹介します。</p><p>完全版は<a href="/blog/azure-active-directory/haadj-re-registration/">こちら</a>に掲載されていますが、完全版ではオンプレミスの Active Directory サーバーへの管理アクセスが必要になります。<br>しかしながら Active Directory サーバーへ管理アクセスしなくても Microsoft Entra ハイブリッド参加を再構成することができる場合があるため、完全版から Active Directory サーバーへの管理アクセスを除いた簡易版の手順を作成しました。<br>まずこの簡易版を利用し、簡易版で状況が変わらなければ完全版を利用する、といった流れで活用いただければと思います。</p><h2 id="1-注意事項"><a href="#1-注意事項" class="headerlink" title="1. 注意事項"></a>1. 注意事項</h2><p>再度 Microsoft Entra ハイブリッド参加を構成するためには、そのデバイス上での管理者権限と、デバイスがオンプレミスの Active Directory およびインターネットの両方にアクセスできる環境 (社外にデバイスがある場合は、オンプレミス AD 環境への VPN 接続) が必要です。</p><h2 id="2-事前準備-Windows-Hello-for-Business-のリセット"><a href="#2-事前準備-Windows-Hello-for-Business-のリセット" class="headerlink" title="2. 事前準備: Windows Hello for Business のリセット"></a>2. 事前準備: Windows Hello for Business のリセット</h2><p><strong>Windows Hello for Business (略称 WHfB) を利用していない場合はこの手順はスキップください。</strong></p><ol><li><p>端末にサインインします。</p></li><li><p><strong>ユーザー権限</strong> でコマンド プロンプトを起動します (管理者として実行から起動しないようご注意ください)。</p></li><li><p>以下のコマンドを実行して、WHfB の情報をリセットします。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certutil -deletehellocontainer</span><br></pre></td></tr></table></figure></li><li><p>次のコマンドを実行し、<code>NgcSet : NO</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li></ol><h2 id="3-事前準備-Intune-の登録解除"><a href="#3-事前準備-Intune-の登録解除" class="headerlink" title="3. 事前準備: Intune の登録解除"></a>3. 事前準備: Intune の登録解除</h2><p><strong>Intune 登録していなければスキップください。</strong></p><ol><li>[Microsoft Intune 管理センター (intune.microsoft.com)] &gt; [デバイス] &gt; [すべてのデバイス] から該当デバイスを検索し、存在する場合は対象デバイスを開いて [削除] ボタンをクリックして削除します (削除完了するまでに少し時間がかかります)。</li></ol><h2 id="4-Microsoft-Entra-ハイブリッド参加の再構成"><a href="#4-Microsoft-Entra-ハイブリッド参加の再構成" class="headerlink" title="4. Microsoft Entra ハイブリッド参加の再構成"></a>4. Microsoft Entra ハイブリッド参加の再構成</h2><p>Microsoft Entra ID から離脱し Microsoft Entra ハイブリッド参加を解除、その後再構成します。</p><ol><li><p>対象のデバイスに対象のドメイン ユーザーでサインインし、 <strong>管理者権限</strong> でコマンド プロンプトを起動し、次のコマンドで Microsoft Entra ハイブリッド参加を解除します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /leave</span><br></pre></td></tr></table></figure></li><li><p>次のコマンドで <code>AzureAdJoined : NO</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li><li><p>[Azure Portal (portal.azure.com)] &gt; [Microsoft Entra ID] &gt; [デバイス] &gt; [すべてのデバイス] に 結合の種類 が <code>Microsoft Entra hybrid joined</code> の対象のデバイス オブジェクトが存在していることを確認します。もし、対象のデバイス オブジェクトが存在しない場合は Microsoft Entra Connect の同期 (既定では 30 分間隔) を待ちます。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/microsoft-entra-hybrid-joined-re-registration-simplified4-3.jpg" alt="Microsoft Entra hybrid joined の対象のデバイス オブジェクトが存在していることを確認"></p></li><li><p>対象のデバイスがオンプレミスの Active Directory およびインターネットの両方にアクセスできるネットワーク環境に接続していることを確認します (社内ネットワーク環境に接続するなど)。</p></li><li><p><strong>管理者権限</strong> でタスク スケジューラを起動し [タスク スケジューラ ライブラリ] &gt; [Microsoft] &gt; [Windows] &gt; [Workplace Join] を開きます。</p></li><li><p>[Automatic-Device-Join] を 右クリックし [実行する(R)] を選択します。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/microsoft-entra-hybrid-joined-re-registration-simplified4-6.jpg" alt="Automatic-Device-Join を実行"></p></li><li><p>コマンド プロンプトを起動し次のコマンドを実行し <code>AzureAdJoined : YES</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li><li><p>[Azure Portal (portal.azure.com)] &gt; [Microsoft Entra ID] &gt; [デバイス] &gt; [すべてのデバイス] で対象のデバイス オブジェクトの [登録済み] の項目が日付であることを確認します。</p><p> <img src="/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/microsoft-entra-hybrid-joined-re-registration-simplified4-8.jpg" alt="すべてのデバイスで登録済みを確認"></p></li><li><p>対象デバイスにて 画面のロック &gt; アンロック をすることでプライマリ更新トークン (PRT) を取得します。(すぐにアンロックしていただいて問題ありません)</p></li><li><p>対象のデバイスにて対象の <strong>ユーザー権限</strong> でコマンド プロンプトを起動し、次のコマンドを実行して <code>AzureAdPrt : YES</code> となっていることを確認します (管理者として実行から起動しないようご注意ください)。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li></ol><h2 id="5-事後確認-Intune-の登録"><a href="#5-事後確認-Intune-の登録" class="headerlink" title="5. 事後確認: Intune の登録"></a>5. 事後確認: Intune の登録</h2><p><strong>この手順は Intune 登録しなければ不要です。</strong> また、反映に時間がかかることがあります。</p><ol><li> [Azure Portal (portal.azure.com)] &gt; [Microsoft Entra ID] &gt; [デバイス] &gt; [すべてのデバイス] で対象のデバイス オブジェクトの [MDM] の項目に値が入り [準拠している] が「はい」となっていることを確認します。</li><li>[Microsoft Intune 管理センター (intune.microsoft.com)] &gt; [デバイス] &gt; [すべてのデバイス] から該当デバイスを検索し対象デバイスの [対応] の項目が「準拠している」となっていることを確認します。</li></ol><h2 id="6-事後作業-WHfB-の再プロビジョニング"><a href="#6-事後作業-WHfB-の再プロビジョニング" class="headerlink" title="6. 事後作業: WHfB の再プロビジョニング"></a>6. 事後作業: WHfB の再プロビジョニング</h2><p><strong>WHfB を利用していなければ不要です。</strong></p><ol><li>端末を再起動します。</li><li>対象のユーザーでサインインすると WHfB のプロビジョニングが自動的に始まりますのでウィザードに沿ってセットアップします (ウィザードの中で多要素認証が要求されます)。</li></ol><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>Microsoft Entra ハイブリッド参加の再構成の簡易版を紹介しました。手順が運用の助けになると嬉しく思います。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供しますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの長谷川です。&lt;/p&gt;
&lt;p&gt;この記事では、対象デバイスの Microsoft Entra ハイブリッド参加を再構成する手順の簡易版を紹介します。&lt;/p&gt;
&lt;p&gt;完全版は&lt;a href=&quot;/blog/az</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Troubleshooting" scheme="https://jpazureid.github.io/blog/tags/Troubleshooting/"/>
    
    <category term="Hybrid Azure AD Join" scheme="https://jpazureid.github.io/blog/tags/Hybrid-Azure-AD-Join/"/>
    
    <category term="Microsoft Entra hybrid join" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra-hybrid-join/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft マネージド条件付きアクセス ポリシー</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-managed-conditional-access-policies/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-managed-conditional-access-policies/</id>
    <published>2023-11-13T03:00:00.000Z</published>
    <updated>2024-02-02T05:03:00.198Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームです。</p><p>今回は、最近お問い合わせをよくいただく「Microsoft マネージド条件付きアクセス ポリシー」についてです。Microsoft マネージド条件付きアクセス ポリシーについて、概要とよくいただくご質問を Q&amp;A 形式でおまとめいたしました。既存のドキュメントではカバーされていない動作や質問について今後も適宜内容を拡充していきますので、ご参照いただければと思います。</p><p>2020 年に Microsoft Entra ID は「セキュリティの既定値群」の機能を導入し、お客様に無料で多要素認証を提供することでお客様のセキュリティ強化に取り組んできました。そしてこの度、更なるセキュリティ向上のための継続的な取り組みとして、2023 年 11 月から 12 月後半にかけて、「Microsoft マネージド 条件付きアクセス ポリシー」の機能が導入されます。</p><p>Microsoft マネージド条件付きアクセス ポリシーは、Microsoft Entra ID P1 および P2 ライセンスをお持ちのお客様を対象にしたものです。P1 および P2 ライセンスをお持ちであるにもかかわらず、まだ条件付きアクセス ポリシーを有効活用していないと思われるお客様に対して、弊社がお客様テナントに自動的に条件付きアクセス ポリシーを作成します。この機能の有効化対象となったお客様には、以下の 3 つのポリシーがテナントに自動的に作成されます (後述しますように自動的に作成される条件があるため必ずしも 3 つ全てが作成されるわけではありません)。</p><ul><li>Microsoft 管理ポータルへアクセスする管理者に多要素認証を必須とする</li><li>“ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする</li><li>リスクの高いサインインに対して多要素認証と再認証を必須とする</li></ul><p>これらのポリシーはレポート専用モードで作成されます。このため即時にユーザーに影響はなく、アクセスがブロックされたり MFA が要求されたりすることはありません。また、これらのポリシーが仮に有効化された場合に想定されるユーザー影響についてのレポートも生成されます。</p><p>Microsoft マネージド条件付きアクセス ポリシーは、作成されてから 90 日間レポート専用モードの状態が維持されます。その間に管理者がポリシーを有効もしくは無効とすることが可能です。無効化せずにレポート専用モードの状態を維持した場合、90 日間の猶予期間の後に、ポリシーは有効となります。ポリシーが有効になると、ポリシーの対象となるユーザーは各ポリシーの条件に従って多要素認証が要求され、より高いセキュリティで保護されることになります。</p><h1 id="各ポリシーの詳細"><a href="#各ポリシーの詳細" class="headerlink" title="各ポリシーの詳細"></a>各ポリシーの詳細</h1><p>3 つの Microsoft マネージド条件付きアクセス ポリシーは、それぞれ作成条件が異なります。どのポリシーがお客様テナントで作成されるかはテナントの設定や状況に依存します。テナントによっては、3 つのポリシー全てが作成される場合もあれば、一部のポリシーのみ作成される場合や、どのポリシーも作成されない場合もあります。</p><p>それぞれのポリシーについての概要および作成の対象となるテナントに以下におまとめしました。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Microsoft マネージド 条件付きアクセス ポリシーの自動作成は、2023 年 11 月から 12 月後半に順次行われます。このため現時点でこれらのポリシーはお客様のテナントに存在しない可能性があります。ポリシーの作成はシステムにより自動的に行われるため、どのテナントにいつポリシーが作成されるかを弊社からお答えすることは困難です。現時点でポリシーがテナントに存在しなくても、焦らずお待ちください。お客様テナントが以下の条件に合致してポリシーが自動作成されても 90 日の猶予があるため、その間にお客様影響が及ぶことはありません。 </p></div><h2 id="Policy-1-Microsoft-管理ポータルへアクセスする管理者に多要素認証を必須とする"><a href="#Policy-1-Microsoft-管理ポータルへアクセスする管理者に多要素認証を必須とする" class="headerlink" title="Policy 1 : Microsoft 管理ポータルへアクセスする管理者に多要素認証を必須とする"></a>Policy 1 : Microsoft 管理ポータルへアクセスする管理者に多要素認証を必須とする</h2><p>このポリシーは、特権を持つ管理者ロールを対象に、Microsoft 管理ポータルにアクセスする際に多要素認証を要求します。このポリシーでは、以下の 14 の Microsoft Entra ロールが対象となります。</p><ul><li>グローバル管理者</li><li>アプリケーション管理者</li><li>認証管理者</li><li>課金管理者</li><li>クラウド アプリケーション管理者</li><li>条件付きアクセス管理者</li><li>Exchange 管理者</li><li>ヘルプデスク管理者</li><li>パスワード管理者</li><li>特権認証管理者</li><li>特権ロール管理者</li><li>セキュリティ管理者</li><li>SharePoint 管理者</li><li>ユーザー管理者</li></ul><p>また、このポリシーは、以下の管理ポータルへのアクセスが対象となります。</p><ul><li>Azure ポータル</li><li>Exchange 管理センター</li><li>Microsoft 365 管理センター</li><li>Microsoft 365 Defender ポータル</li><li>Microsoft Entra 管理センター</li><li>Microsoft Intune 管理センター</li><li>Microsoft Purview コンプライアンス ポータル</li></ul><p>このポリシーは、以下の 2 つの条件を両方満たすテナントに自動的に作成されます。</p><ul><li>「セキュリティの既定値群」機能が無効である</li><li>月間アクティブ管理者ユーザー分の Microsoft Entra ID P1 または P2 のライセンスがテナントに存在する</li></ul><h2 id="Policy-2-“ユーザーごとの-MFA”-機能を使用しているユーザーに多要素認証を必須とする"><a href="#Policy-2-“ユーザーごとの-MFA”-機能を使用しているユーザーに多要素認証を必須とする" class="headerlink" title="Policy 2 : “ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする"></a>Policy 2 : “ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする</h2><p>このポリシーは、”ユーザーごとの MFA” 機能を使用しているユーザーを対象に、全てのクラウド アプリにアクセスする際に MFA を要求します。このポリシーは、”ユーザーごとの MFA” 機能と同様に動作します。”ユーザーごとの MFA” 機能はレガシーな機能として非推奨であるため、”ユーザーごとの MFA” 機能から「条件付きアクセスを用いた多要素認証を要求する構成」への移行を促すポリシーとなります。</p><p>このポリシーは、以下の 3 つの条件をすべて満たすテナントに自動的に作成されます。</p><ul><li>「セキュリティの既定値群」機能が無効である</li><li>“ユーザーごとの MFA” 機能で MFA が有効/強制されているユーザーが 500 未満である</li><li>上記ユーザー数分の Microsoft Entra ID P1 または P2 ライセンスがテナントに存在する</li></ul><h2 id="Policy-3-リスクの高いサインインに対して多要素認証と再認証を必須とする"><a href="#Policy-3-リスクの高いサインインに対して多要素認証と再認証を必須とする" class="headerlink" title="Policy 3 : リスクの高いサインインに対して多要素認証と再認証を必須とする"></a>Policy 3 : リスクの高いサインインに対して多要素認証と再認証を必須とする</h2><p>このポリシーは、テナント内のすべてのユーザーを対象とし、リスクの高いサインインを検出した場合に多要素認証と再認証を要求します。</p><p>「リスクの高いサインイン」とは、ユーザーのサインインが通常とは異なる場合を意味します。たとえば、通常とは異なる移動、パスワード スプレー攻撃、トークンの問題などが含まれます。これらのリスク定義の詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-risks#sign-in-risk-detections">リスク検出とは</a>の記事を参照ください。</p><p>このポリシーは、以下の 2 つの条件を両方満たすテナントに自動的に作成されます。 </p><ul><li>月間アクティブ ユーザー分の Microsoft Entra ID P2 ライセンスがテナントに存在する</li><li>リスク ベースの条件付きアクセス ポリシーが構成されていない  </li></ul><h1 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h1><p>以下に、 Microsoft マネージド 条件付きアクセス ポリシーについて、お問い合わせの多いご質問を Q&amp;A 形式でおまとめいたしました。</p><hr><p><span style="color:green">Q</span>. いつ Microsoft マネージド条件付きアクセス ポリシーが作成されますか？</p><p><span style="color:red">A</span>. Microsoft マネージド条件付きアクセス ポリシー (以降ポリシー) は、2023 年 11 月から 12 月後半にかけて作成されます。</p><hr><p><span style="color:green">Q</span>. まだ自社テナントに Microsoft マネージド条件付きアクセス ポリシーがありません。いつ作成されるか具体的な日時を教えてくれますか？</p><p><span style="color:red">A</span>. 恐れ入りますが、いつどのテナントに Microsoft マネージド条件付きアクセス ポリシーが作成されるかをお答えすることは困難です。ポリシーの作成はシステムにより自動的に順次行われます。恐れ入りますが、現時点でポリシーがテナントに存在しなくても、焦らずお待ちください。弊社サポートにお問い合わせをいただいても、確実な答えは致しかねます。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーが作成されると、どのような影響がありますか？</p><p><span style="color:red">A</span>. これらのポリシーは、レポート専用モードで作成されるため、即時に影響はありません。これらのポリシーは、90 日間レポート専用モードの状態が維持され、その間に管理者がポリシーを有効もしくは無効とすることが可能です。レポート専用モードを維持した場合、90 日間の猶予期間の後に、ポリシーは自動的に有効となります。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーを無効化することはできますか？</p><p><span style="color:red">A</span>. はい、ポリシーを無効にすることができます。自動有効化をご要望でない場合は、無効に設定してください。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーを無効化する方法を教えてください。</p><p><span style="color:red">A</span>. 条件付きアクセス ポリシーの設定ページから対象のポリシーを選択し、その状態 (“State”) を [無効] にご変更ください。</p><p><img src="/blog/azure-active-directory/microsoft-managed-conditional-access-policies/1.png"></p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーのポリシー内容を変更することはできますか？</p><p><span style="color:red">A</span>. Microsoft マネージド条件付きアクセス ポリシー自体の設定を変更することはできません。管理者が可能な操作はポリシーの状態の変更 (有効、無効またはレポート専用) と、除外対象として特定のユーザー、グループ、ロールを指定することのみです。ポリシーの内容を変更したい場合、該当のポリシーを複製することで、ご要件に沿って複製したポリシーをカスタマイズすることができます。自動的に作成されたポリシーを無効に設定し、複製を行いカスタマイズしたポリシーを有効とすることで、お客様のご要件に沿った内容のポリシーをご利用いただけます。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーを削除することはできますか？</p><p><span style="color:red">A</span>. いいえ、自動的に作成されたポリシー自体を削除することはできません。ポリシーが適用されないようにするためには、対象のポリシーを無効に設定してください。</p><hr><p><span style="color:green">Q</span>.  自社テナントの条件付きアクセス ポリシーの設定を見直す必要はありますか？</p><p><span style="color:red">A</span>. 必ずしもテナントの条件付きアクセス ポリシーを見直す必要はございませんが、この機会に、お客様のご要件に応じて必要なセキュリティ上の保護が適用されているか確認することをお勧めいたします。また、 Microsoft マネージド条件付きアクセス ポリシーは多くの利用シナリオにおいて、有効化しておくことが望ましい設定となりますので、すでに同様の設定を実施していない環境では、有効とすることを推奨します。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーが作成されるテナントの条件を教えてください。</p><p><span style="color:red">A</span>. それぞれの Microsoft マネージド ポリシーが作成される条件は以下のとおりです。</p><ul><li><p>Microsoft 管理ポータルへのアクセスする管理者に多要素認証を必須とするポリシー<br>セキュリティの既定値群が無効であり、かつ月間アクティブな管理者分の Microsoft Entra ID P1 または P2 のライセンスを持つテナントが対象となります。</p></li><li><p>“ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする Microsoft マネージド条件付きアクセス ポリシー<br>セキュリティの既定値群が無効であり、全てのユーザー分の Microsoft Entra ID P1 または P2 ライセンスを持ち、さらにユーザーごとの MFA が有効/強制されているユーザーが 500 未満のテナントが対象となります。</p></li><li><p>リスクの高いサインインに対して多要素認証と再認証を必須とするポリシー<br>月間アクティブユーザー分の Microsoft Entra ID P2 ライセンスを持ち、リスク ベースの条件付きアクセス ポリシーが構成されていないテナントが対象となります。</p></li></ul><hr><p><span style="color:green">Q</span>.  作成された Microsoft マネージド条件付きアクセス ポリシーはどこで確認できますか？</p><p><span style="color:red">A</span>.  Microsoft Entra ポータルまたは Azure ポータルの条件付きアクセス ポリシーの設定ページから、Microsoft マネージド条件付きアクセス ポリシーと作成数を確認することができます。</p><hr><p><span style="color:green">Q</span>.  テナントやユーザーの設定やライセンスを変更したら Microsoft マネージド条件付きアクセス ポリシーも変更されますか？</p><p><span style="color:red">A</span>. Microsoft マネージド ポリシーは、ポリシーが初めに作成された時点でのテナントの設定に依存します。一度ポリシーが追加されたら、テナントやユーザーの設定が変更されても、ポリシーの内容は変更されません。また、初めにポリシーが作成された時点で追加されなかったポリシーが、それ以降に追加されることもございません。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセス ポリシーが作成されるとライセンスは消費されますか？</p><p><span style="color:red">A</span>. Microsoft マネージド条件付きアクセス ポリシーの対象となるユーザーに自動的にライセンスが割り当てられることはありません。Microsoft マネージド条件付きアクセス ポリシーを利用される場合には、その対象となるユーザーへ Microsoft Entra ID P1 以上 (Policy3 の場合は Microsoft Entra ID P2) のライセンスを割り当てください。</p><hr><p><span style="color:green">Q</span>.  “ユーザーごとの MFA” の機能を現在利用しているかどうか、どうやって確認すればいいでしょうか？</p><p><span style="color:red">A</span>. “ユーザーごとの MFA” を利用しているかは [Azure Portal (portal.azure.com)] &gt; [Microsoft Entra ID (Azure Active Directory)] &gt; [ユーザー] &gt; [ユーザーごとの MFA] からご確認いただけます。対応する公開情報のページは<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/howto-mfa-userstates#view-the-status-for-a-user">こちら</a>です。</p><p>一覧に表示されるユーザーの [MULTI-FACTOR AUTHENTICATION の状態] が [有効] もしくは [強制] となっている場合、”ユーザーごとの MFA” の機能により MFA が要求されています。<br>※ [MULTI-FACTOR AUTHENTICATION の状態] についてフィルターを利用した検索が可能です。</p><p><img src="/blog/azure-active-directory/microsoft-managed-conditional-access-policies/2.png"></p><hr><p><span style="color:green">Q</span>.  「”ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする Microsoft マネージド条件付きアクセス ポリシー」は、どのユーザーが対象になりますか？</p><p><span style="color:red">A</span>. このポリシーが作成された時点で、”ユーザーごとの MFA” 機能により多要素認証が有効または強制されている既存のユーザーが、ポリシーの対象となります。「”ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする Microsoft マネージド ポリシー」が追加された後に作成されたユーザーや新たに “ユーザーごとの MFA” を有効化されたユーザーは、このポリシーの対象とはなりません。</p><hr><p><span style="color:green">Q</span>.  「”ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする Microsoft マネージド条件付きアクセス ポリシー」が作成された後、”ユーザーごとの MFA” 機能の設定はどうなりますか？</p><p><span style="color:red">A</span>.  「”ユーザーごとの MFA” 機能を使用しているユーザーに多要素認証を必須とする Microsoft マネージド条件付きアクセス ポリシー」が作成された後も、”ユーザーごとの MFA” 機能の設定は以前の状態のまま維持されます。”ユーザーごとの MFA” 機能はレガシーな非推奨の機能であるため、条件付きアクセス ポリシーによる多要素認証への移行をお勧めします。Microsoft マネージド条件付きアクセス ポリシーの対象となったユーザーについては、”ユーザーごとの MFA” 機能による多要素認証の状態を無効へ変更ください。</p><hr><p><span style="color:green">Q</span>.  Microsoft マネージド条件付きアクセスポリシーは Azure AD B2C テナントに作成されますか？</p><p><span style="color:red">A</span>.  いいえ、Microsoft マネージド条件付きアクセスポリシーは Azure AD B2C テナントには作成されません。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は、最近お問い合わせをよくいただく「Microsoft マネージド条件付きアクセス ポリシー」についてです。Microsoft マネージド条件付きアクセス ポリシーについて、概要</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>パブリック プレビュー - Microsoft Graph アクティビティ ログが利用できるようになりました</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/graph-activity-log-in-preview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/graph-activity-log-in-preview/</id>
    <published>2023-11-10T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.986Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID の小出です。</p><p>本記事は、 2023 年 10 月 13 日に公開されました <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-graph-activity-log-is-now-available-in-public-preview/ba-p/3848269">Microsoft Graph Activity Log is Now Available in Public Preview</a> を分かりやすく日本語におまとめしなおした記事となります。ご不明点などございましたら、お気軽にサポートまでお問い合わせください。</p><hr><p>Microsoft Graph API に対してアプリケーションが何をしているのか気になったことはありませんでしょうか。今回、その詳細を確認できる Microsoft Graph アクティビティ ログがパブリック プレビューとして今回利用可能となりました。これにより、Microsoft Graph API を通じてテナントに対して行われるすべての要求を可視化できるようになりました。</p><p>パブリック プレビューは直近開始されたばかりです。お客様によってはまだ利用できない可能性もありますが、今後 2 週間以内にすべての地域で利用できるようになりますため、展開を少々お待ちください。</p><h2 id="できること"><a href="#できること" class="headerlink" title="できること"></a>できること</h2><p>現在でも、サインイン ログを収集して Microsoft Graph API に対する認証および認可アクティビティを分析したり、監査ログを収集して重要なリソースの変更を確認したりすることができます。Microsoft Graph アクティビティ ログを使用すると、サインイン ログでのトークン要求と監査ログでの最終的なリソースの変更に加えて、Microsoft Graph API 呼び出しの履歴 (読み取り、書き込み、削除) を調査できるようになります。</p><p>たとえば下記では、Microsoft Graph API に対する要求 URL (requestUrl) に /users が含まれるログを抽出したものになりますが、RequestUri を確認すると、getMemberGroups が呼び出されており、対象ユーザーが所属しているグループの情報を <a href="https://learn.microsoft.com/ja-jp/graph/api/directoryobject-getmembergroups?view=graph-rest-1.0&tabs=http">directoryObject: getMemberGroups</a> を利用して取得したことが分かります。また、実行された時刻や HTTP メソッド、IP アドレスなども確認可能です。</p><p><img src="/blog/azure-active-directory/graph-activity-log-in-preview/graph-activity-log-in-preview1.png"></p><p>Microsoft Graph アクティビティ ログには、リクエストとクライアントアプリケーションに関する情報が含まれます。一般的な使用例としては、次のようなものがあります:</p><ul><li>ユーザー アカウントが侵害された後、影響調査のためテナント内で行ったアクティビティを特定する。</li><li>Microsoft Graph API の不審/異常な使用を特定するための分析環境を構築する (すべてのユーザーを列挙するアプリケーションや、403 エラー多く引き起こしている偵察目的のリクエストの特定など)。</li><li>予期しない、または不必要に特権をもつアプリケーションを調査する。</li><li>テナントの帯域制限を使い果たすほどの極端な呼び出し量など、クライアント アプリケーションの問題または予期しない動作を特定する。</li></ul><p>ログの検索を行うためには、 Log Analytics でのクエリの書き方を理解する必要があります。今回はいくつかサンプルを紹介します。</p><p>過去1日以内にグループの変更または削除を要求したアプリケーションをまとめる: </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MicrosoftGraphActivityLogs</span><br><span class="line">| where TimeGenerated &gt; ago(1d)</span><br><span class="line">| where RequestUri contains &#x27;/group&#x27;</span><br><span class="line">| where RequestMethod != &quot;GET&quot;</span><br><span class="line">| summarize UriCount=dcount(RequestUri) by AppId, UserId, ServicePrincipalId, ResponseStatusCode</span><br></pre></td></tr></table></figure><p>認証に失敗した最近のリクエストを見る:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MicrosoftGraphActivityLogs</span><br><span class="line">| where TimeGenerated &gt; ago(1h)</span><br><span class="line">| where ResponseStatusCode == 401 or ResponseStatusCode == 403</span><br><span class="line">| project AppId, UserId, ServicePrincipalId, ResponseStatusCode, RequestUri, RequestMethod</span><br><span class="line">| limit 1000</span><br></pre></td></tr></table></figure><p>リクエスト数が上位 20 のアプリ インスタンスを取得する:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MicrosoftGraphActivityLogs</span><br><span class="line">| where TimeGenerated &gt; ago(1d)</span><br><span class="line">| summarize RequestCount=count() by AppId, IpAddress, UserAgent</span><br><span class="line">| sort by RequestCount</span><br><span class="line">| limit 20</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/graph-activity-log-in-preview/graph-activity-log-in-preview2.png"></p><p>Microsoft Graph アクティビティ ログは、上記のとおり Log Analytics にエクスポートして解析することが一般的ですが、診断設定からその他のストレージにもログをエクスポートできます。下記の画面で Microsoft Graph Activity Logs を選択し、エクスポート先となるサービスを選択します。Log Analytics 以外にも、ストレージ アカウントなどにエクスポートすることなども可能です。なお、Log Analytics Workspace に収集されたログでは、ポータル上でのクエリ実行、アラート、クエリの保存機能、ワークブックなど、Azure Monitor Logs の全機能を使用できるため、単にログを保管するだけでなく追跡や監視を行いたい場合に便利です。</p><p><img src="/blog/azure-active-directory/graph-activity-log-in-preview/graph-activity-log-in-preview3.png"></p><p>詳細につきましては、以下の公開情報も併せてご確認ください。</p><p><a href="https://learn.microsoft.com/ja-jp/graph/microsoft-graph-activity-logs-overview">Microsoft Graph アクティビティ ログにアクセスする (プレビュー)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID の小出です。&lt;/p&gt;
&lt;p&gt;本記事は、 2023 年 10 月 13 日に公開されました &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blo</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ID を使用した Windows ローカル管理者パスワードソリューションの一般提供を開始しました！</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/</id>
    <published>2023-11-09T00:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.670Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 名取 です。</p><p>本記事は、2023 年 10 月 23 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/windows-local-administrator-password-solution-with-microsoft/ba-p/3911999">Solution with Microsoft Entra ID now Generally Available!</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>本日、Microsoft Entra ID と <a href="https://learn.microsoft.com/ja-jp/mem/intune/protect/windows-laps-overview">Microsoft Intune</a> を使用した <a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/howto-manage-local-admin-passwords">Windows Local Administrator Password Solution (LAPS)</a> の一般提供を発表できることを嬉しく思います。この機能は、Microsoft Entra 参加済みデバイスと Microsoft Entra ハイブリッド参加済みデバイスの両方で使用できます。これにより、すべての組織が Windows 上のローカル管理者アカウントを保護してセキュリティを確保し、<a href="https://www.microsoft.com/en-us/download/details.aspx?id=36036">Pass-the-Hash(PtH)</a> およびラテラル トラバーサル型の攻撃を軽減できるようになります。</p><p>2023 年 4 月のパブリック プレビューの発表以来、数千のお客様と数百万のデバイスで Windows LAPS の展開と利用が大幅に進んでいることに、感謝申し上げたいと思います。</p><p>この機能は、2023 年 4 月 11 日以降の Windows Update がインストールされた以下の Windows OS プラットフォームで利用可能です:</p><ul><li>Windows 11 22H2 </li><li>Windows 11 21H2 </li><li>Windows 10 20H2, 21H2 and 22H2 </li><li>Windows Server 2022 </li><li>Windows Server 2019 </li></ul><p>Windows LAPS のクライアント側設定を管理するには以下を使用します:</p><ul><li>MDM 管理された Microsoft Entra 参加/ハイブリッド参加デバイス用の <a href="https://learn.microsoft.com/ja-jp/windows/client-management/mdm/laps-csp">Windows LAPS 構成サービス プロバイダー (CSP)</a></li><li>Microsoft Entra ハイブリッド参加デバイス用の <a href="https://learn.microsoft.com/ja-jp/windows-server/identity/laps/laps-management-policy-settings#windows-laps-group-policy">Windows LAPS グループ ポリシー オブジェクト (GPO)</a></li></ul><p>お客様からのフィードバックに基づいて、さらに多くの機能のサポートを追加しています。現在は以下のようなことが可能です:</p><ul><li><strong>Windows LAPS を有効にする</strong> には、テナント全体のポリシーとクライアント側のポリシーを使用します。これによりローカル管理者パスワードが Microsoft Entra ID にバックアップされます。</li><li><strong>クライアント ポリシーを構成する</strong> には Microsoft Intune ポータルを使用し、ローカル管理者のパスワード管理用にアカウント名、パスワードの有効期限、長さ、複雑さ、パスワードの手動リセットなどを設定できます。</li><li><strong>パスワードを回復する</strong> 際は、Microsoft Entra/Microsoft Intune ポータルまたは Microsoft Graph API/PSH を利用できます。</li><li><strong>すべての LAPS 対応デバイスを列挙する</strong> には、Microsoft Entra ポータルまたは Microsoft Graph API/PSH を利用できます。</li><li><strong>Microsoft Entra ID のロールベースのアクセス制御 (RBAC) ポリシーを作成する</strong> ことで、カスタム ロールと管理単位を使用してパスワード回復の権限を付与できます。</li><li><strong>監査ログを確認する</strong> ことで、Microsoft Entra ポータルまたは Microsoft Graph API/PSH 経由で、パスワードの更新および取得イベントを監視できます。</li><li><strong>条件付きアクセス ポリシーを構成する</strong> ことでパスワード回復の権限を持つディレクトリ ロールを保護できます。</li></ul><p><img src="/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available_1.png"></p><p><img src="/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available_2.png"></p><p>今後提供予定の (ロードマップにある) 機能:</p><ul><li>Windows LAPS が設定された場合にローカル管理者アカウントを自動作成。</li><li>ローカル管理者パスワードが認証に使用された場合にデバイスが Microsoft Entra ID に通知。</li><li>デバイス所有者が自身で (セルフサービスで) ローカル管理者パスワードを必要な時間だけ回復。</li></ul><p>いつものように、皆様からのフィードバック、ご意見、ご提案をお待ちしております！ <a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Microsoft Entra ID フォーラム</a>でぜひ共有ください。皆様のご意見をお待ちしております。 </p><p>Sandeep Deo (@<a href="https://twitter.com/MsftSandeep">MsftSandeep</a>)<br>Principal Product Manager<br>Microsoft Identity Division</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 名取 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 10 月 23 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>AADSTS75011 エラーを回避するための根本対処にはアプリケーション側での対処が必要です!</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/aadsts75011/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/aadsts75011/</id>
    <published>2023-11-06T15:00:00.000Z</published>
    <updated>2024-02-02T05:02:59.678Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの沓澤です。</p><p>SAML 連携をしているアプリケーション (SP) にサインインをしようとした際に、AADSTS75011 エラーが生じるというお問い合わせを定期的にいただきます。</p><p>AADSTS75011 エラーの画面を Microsoft Entra ID が提供しているものの、AADSTS75011 エラーを根本的に回避したい場合には SP 側での対処が必要です。</p><p>本記事では AADSTS75011 エラーの原因と SP 側での対処案について説明します。</p><p>AADSTS75011 エラーについてまとめられた以下の公開情報を基に説明します。</p><p><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/error-code-aadsts75011-auth-method-mismatch">エラー - サービスで認証されたユーザーが要求された認証方法 AuthnContextClassRef と一致しない AADSTS75011 認証方法</a></p><h2 id="AADSTS75011-エラーの発生原因"><a href="#AADSTS75011-エラーの発生原因" class="headerlink" title="AADSTS75011 エラーの発生原因"></a>AADSTS75011 エラーの発生原因</h2><p>SP で指定された AuthnContext と、サインインを試行したユーザーの AuthnContext が異なる場合に AADSTS75011 エラーが発生します (AuthnContext: 認証方法)。</p><p>例をあげると、SP が機密情報にアクセスするようなアプリケーションであるために証明書ベースの認証を期待しているものの、サインインを試行したユーザーがパスワード ベースでの認証を完了している場合にこのエラーが発生します (下図参照)。<br><img src="/blog/azure-active-directory/aadsts75011/75011_user_password.png" alt="75011-1"></p><p>赤線部分にユーザーが実際に使用した認証方法が記載され、青線部分が SP が期待する認証方法が記載されています。</p><p>他 SP へのサインイン時にパスワード ベースの認証をして SSO を完了させた場合に、この証明書ベースの認証を期待する SP にサインインをするときには対話的な認証が生じずに、パスワード ベースでの認証が済んでいるという状態で非対話的にサインインを試行する動作をします。</p><blockquote><p>[!NOTE]<br>証明書ベースの認証として判定される例としては、以下のような認証方法を使用した場合です</p><ul><li>Microsoft Entra CBA</li><li>AD FS での証明書認証</li><li>Windows Hello for Business を使用した PRT での認証</li><li>Microsoft Authenticator を使用したパスワードレス認証</li></ul></blockquote><h3 id="AADSTS75011-エラーが生じるタイミング"><a href="#AADSTS75011-エラーが生じるタイミング" class="headerlink" title="AADSTS75011 エラーが生じるタイミング"></a>AADSTS75011 エラーが生じるタイミング</h3><p>AADSTS75011 エラーの根本的対処には SP 側での対処が必要であるため、お客様には根本的対処の可否について SP 側へのお問い合わせ等を検討いただいております。</p><p>SP 側へお問い合わせをいただく際により詳細な情報が必要というお客様も多くいらっしゃいましたので、本記事では SAML プロトコルのシーケンスと合わせ、AADSTS75011 エラーが生じるタイミングについて説明します。</p><p>下図は SAML プロトコルのシーケンスです。<br><img src="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/media/single-sign-on-saml-protocol/saml-single-sign-on-workflow.png" alt="SAMLprotocol"></p><p>AADSTS75011 エラーが生じるタイミングは、上図の 4 と 5 の間です。<br>そのため、エラーが生じるまでの流れを説明します。</p><ol><li><code>User</code> が <code>Service Provider</code> (<code>SP</code>) にアクセスします。</li><li><code>SP</code> はユーザーを認証するために Microsoft Entra ID にリダイレクトするよう <code>User</code> に指示します (SP によって Microsoft Entra ID へのリダイレクトが行われるきっかけは異なります)。<br>このとき SP は SAML リクエストを含むリダイレクト先 URL を生成します (<a href="https://login.microsoftonline.com/">https://login.microsoftonline.com/</a><tenantid>/saml2?SAMLRequest=xxx)。</li></ol><p><strong>この SAML リクエストの中に <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/single-sign-on-saml-protocol#requestedauthncontext">RequestedAuthnContext</a> 要素が含まれています。</strong><br>RequestedAuthnContext 要素は、SP がユーザーに対して要求する認証方法を指定するための要素です。<br>つまり、ここで証明書ベースの認証を指定したりなどの認証方法の指定ができます。</p><ol><li><code>User</code> のブラウザーを通して、2. で <code>SP</code> が指示したリダイレクト先 (Microsoft Entra ID) にリクエストが生じます。</li><li>サインインを試行するユーザーの認証状況を確認します。Microsoft Entra ID で認証済みの場合は通常は 5 への進みます。<br>ただ、SAML リクエストの中に RequestedAuthnContext が含まれる際には、直近で使用した認証方法を確認します。</li></ol><p><strong>このとき、直近で使用した認証方法 (<code>User</code> が使用した認証方法) と RequestedAuthnContext で指定された認証方法 (<code>SP</code> が指定した認証方法) とが異なる場合に AADSTS75011 エラーが発生します。</strong></p><p>SP 側で認証方法を指定するのが先であり、Microsoft Entra ID 側で認証方法の一致を判定するのが後です。</p><p>そのため、根本対処としては SP 側での対処が必要であるエラーではあるものの、Microsoft Entra ID 側でエラー画面を表示されます。</p><h2 id="SP-側での-AADSTS75011-エラーの対処案について"><a href="#SP-側での-AADSTS75011-エラーの対処案について" class="headerlink" title="SP 側での AADSTS75011 エラーの対処案について"></a>SP 側での AADSTS75011 エラーの対処案について</h2><p>対処案としては以下 2 つです。</p><ul><li>SAML リクエスト内の “RequestedAuthnContext” 要素 を省略する</li><li>SAML リクエスト内の “ForceAuthn” 要素を true に変更する</li></ul><p>それぞれ説明します。</p><h3 id="SAML-リクエスト内の-“RequestedAuthnContext”-要素-を省略する"><a href="#SAML-リクエスト内の-“RequestedAuthnContext”-要素-を省略する" class="headerlink" title="SAML リクエスト内の “RequestedAuthnContext” 要素 を省略する"></a>SAML リクエスト内の “RequestedAuthnContext” 要素 を省略する</h3><p>SAML リクエストは前項の通り、一般的にはアプリケーション側で生成されます。</p><p>そのため、SAML リクエストの変更可否についてもアプリケーション観点での調査が必要です。</p><p>アプリケーションによっては管理画面から “RequestedAuthnContext” 要素の省略を設定できるものもあります。</p><p>参考 (外部サイト): <a href="https://slack.com/intl/ja-jp/help/articles/203772216-SAML-%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%AA%E3%83%B3#enterprise-grid-%E3%83%97%E3%83%A9%E3%83%B3-1">SAML シングルサインオン | Slack</a></p><blockquote><ol start="10"><li>SAML のレスポンスとアサーションに署名するかどうかを選択します。お使いの IDP で End to End Encryption (E2EE) キー が必要な場合には、「AuthnRequest に署名する」の横にあるチェックボックスを選択して、証明書を表示します。「AuthnContextClassRef」の値も環境に応じて設定できます。</li></ol></blockquote><p>AuthnContextClassRef は RequestedAuthnContext 要素内で定義する要素です。</p><p>SP の管理者または利用者からの “RequestedAuthnContext” 要素の変更可否についてはアプリケーション側へのお問い合わせ等をご検討ください。</p><h4 id="▼-省略すべきかの判断について"><a href="#▼-省略すべきかの判断について" class="headerlink" title="▼ 省略すべきかの判断について"></a>▼ 省略すべきかの判断について</h4><p>判断についてはお客様での最終判断が必要です。</p><p>ただ、よくお問い合わせで見かけるパターンとして、SP 側が認証強度が弱い認証方法を指定している状況で、ユーザーが認証強度が SP 側が指定する認証方法よりも高い認証方法を使用したためにエラーが生じるというケースが多く見られます。</p><p>具体的に例を挙げると、 SP 側でパスワード ベースの認証方法を指定しているものの、ユーザーが証明書ベースの認証を使用している場合です。<br>一般的にパスワード ベースの認証よりも証明書ベースの認証の方が認証強度が高いとされています。</p><p>認証強度が高い認証方法を使用中のユーザーをブロックする理由がなければ、”RequestedAuthnContext” の省略について前向きに検討いただくのが良いかと存じます。</p><h3 id="SAML-リクエスト内の-“ForceAuthn”-要素を-true-に変更する"><a href="#SAML-リクエスト内の-“ForceAuthn”-要素を-true-に変更する" class="headerlink" title="SAML リクエスト内の “ForceAuthn” 要素を true に変更する"></a>SAML リクエスト内の “ForceAuthn” 要素を true に変更する</h3><p>SAML リクエスト内に <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/single-sign-on-saml-protocol#authnrequest">ForceAuthn</a> 要素を含め、その値を true とすることで、SP にサインインする度に認証が要求されます。</p><p>認証が要求されましたら、SP が期待するの認証方法で認証を実行ください。</p><p>SAML リクエスト内に ForceAuthn 要素を true として指定できるかどうかについては、RequestedAuthnContext の変更可否同様に、アプリケーション側へお問い合わせ等をご検討ください。</p><p>また、上述のとおり、SP にサインインする都度、対話的な認証が要求されることが想定動作であるため、ユーザーの利便性を考慮した上でのご検討をお願いいたします。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>本記事では AADSTS75011 エラーの原因と SP 側での対処案について主に説明しました。</p><p>現時点では認証方法の不一致が原因で AADSTS75011 エラーが発生した場合、Microsoft Entra ID 観点で実施できる対処策がないため、上記情報を参考に対処策を検討いただけますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの沓澤です。&lt;/p&gt;
&lt;p&gt;SAML 連携をしているアプリケーション (SP) にサインインをしようとした際に、AADSTS75011 エラーが生じるというお問い合わせを定期的にいただきます。&lt;/p&gt;
&lt;p&gt;AADS</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="SAML" scheme="https://jpazureid.github.io/blog/tags/SAML/"/>
    
  </entry>
  
</feed>
