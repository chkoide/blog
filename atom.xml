<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2023-07-28T06:27:30.583Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure AD Connect インストール前の確認事項</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/checklist-before-installing-aad-connect/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/checklist-before-installing-aad-connect/</id>
    <published>2023-07-25T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.583Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure &amp; Identity サポート チームです。<br>Azure AD Connect の新規構築、サーバー移行時に多くお問い合わせいただく事前に確認点をお纏めいたしました。<br>大きく分けて要件としては下記となります。</p><ul><li>A. Azure AD Connect の要件</li><li>B. Azure AD Connect Health Agent の要件</li><li>C. 認証方法による要件</li><li>D. パスワードライトバック機能</li></ul><p>それぞれの要件につきまして、良くあるご質問、技術情報を含め纏めさせていただきました。</p><h2 id="A-Azure-AD-Connect-の要件"><a href="#A-Azure-AD-Connect-の要件" class="headerlink" title="A. Azure AD Connect の要件"></a>A. Azure AD Connect の要件</h2><p>Azure AD Connect 自体の要件としては下記技術情報のとおりとなります。</p><ul><li>Azure AD Connect の前提条件<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-install-prerequisites">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-install-prerequisites</a></li></ul><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="[Q&amp;A]"></a>[Q&amp;A]</h3><hr><ul><li>Q. Azure AD Connect をドメイン コントローラー上にインストールして問題ないか ?</li><li>A. 技術的には共存させることは可能ですが、運用面やトラブル シューティング観点では、別のサーバーに構築する方が安心です。Azure AD Connect もドメイン コントローラーと同等のセキュリティで保護することを推奨していますが、ドメイン コントローラーには特に厳しい制限を課していることが一般的となりますため、通信やセキュリティの要件などを考慮し、お客様側で判断してください。</li></ul><hr><ul><li>Q. Azure AD Connect を他のサービスが稼働している既存のサーバーに構成しても問題か？</li><li>A. 各要件を満たしている場合には特に技術的な制約はありませんが、弊社としてはドメイン コントローラーと同様、機能ごとにサーバーを分けることを推奨しています。<br>運用面にてメンテナンスやセキュリティ面での可用性を確保できるように構成してください。</li></ul><hr><ul><li>Q. Azure AD Connect をスタンドアローン (ワークグループ) で構成可能か。</li><li>A. 構成自体はカスタム インストールにて行うことが可能ですが、ドメイン メンバー サーバーに構成する必要があります。</li></ul><hr><h2 id="B-Azure-AD-Connect-Health-Agent-for-Sync-の要件"><a href="#B-Azure-AD-Connect-Health-Agent-for-Sync-の要件" class="headerlink" title="B. Azure AD Connect Health Agent for Sync の要件"></a>B. Azure AD Connect Health Agent for Sync の要件</h2><p>Azure AD Connect に同梱されている Azure AD Connect Health Agent for Sync を構成する場合、プロキシ構成や要件は Azure AD Connect とは別に用意されています。<br>弊社に Azure AD Connect インストール時にこの要件 (主にネットワーク関連の設定箇所) を満たしていないことでインストール ウィザードで警告が表示されるなどのお問い合わせを多くいただいております。<br>各エンドポイント、プロキシの設定をインストール前に確認をお願いします。</p><ul><li>Azure AD Connect Health エージェントのインストール<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-health-agent-install">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-health-agent-install</a></li></ul><h3 id="Q-amp-A-1"><a href="#Q-amp-A-1" class="headerlink" title="[Q&amp;A]"></a>[Q&amp;A]</h3><hr><ul><li>Q. Azure AD Connect Health Agent をインストールし、同期対象となるテナントにて Azure AD Premium ライセンスがないが問題ないか ?<br>A. インストール自体の処理やライセンス規約などに問題は起きません。<br> ただし、 Azure ポータルからの監視機能が使用できないなどの制約が生じます。</li></ul><hr><p> </p><ul><li>Q. Azure AD Connect Health Agent for Sync を誤ってアンインストールしてしまった場合の対象方法を教えてください。</li><li>A. Azure AD Connect のインストール ウィザードを再試行することで再インストールされます。</li></ul><hr><ul><li>Q. Azure AD Connect Health Agent for Sync 単体でアップグレード可能か ?</li><li>A. いいえ、Azure AD Connect に同梱となり単体でのアップグレードは行えません。 </li></ul><hr><h2 id="C-認証方法による要件"><a href="#C-認証方法による要件" class="headerlink" title="C. 認証方法による要件"></a>C. 認証方法による要件</h2><p>Azure AD Connect で構成する認証方式 (パスワード ハッシュ同期 (PHS) かパススルー認証) により要件は異なります。</p><h3 id="C-1-パスワード-ハッシュ同期-PHS"><a href="#C-1-パスワード-ハッシュ同期-PHS" class="headerlink" title="C-1. パスワード ハッシュ同期 (PHS)"></a>C-1. パスワード ハッシュ同期 (PHS)</h3><p>パスワード ハッシュ同期では Azure AD Connect のインストール要件を満たしていれば、追加でポートの開放や設定は不要となります。</p><ul><li>Azure AD Connect 同期を使用したパスワード ハッシュ同期の実装<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-password-hash-synchronization">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-password-hash-synchronization</a></li></ul><p> </p><h3 id="C-2-パススルー認証"><a href="#C-2-パススルー認証" class="headerlink" title="C-2. パススルー認証"></a>C-2. パススルー認証</h3><p>パススルー認証エージェント (PTA) は Azure AD Connect をインストールするサーバーが 1 台目となり、他のサーバーに PTA を別途インストールすることにより複数台で構成することを推奨しています。<br>PTA をインストールするサーバーでは上述の A. B. とは別にネットワーク要件を満たす必要があります。<br> <br>ファイアウォールでの構成にて各エージェントの要件は下記となります。</p><ul><li>Azure Active Directory パススルー認証: クイック スタート - 手順 1: 前提条件を確認する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-pta-quick-start#step-1-check-the-prerequisites">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-pta-quick-start#step-1-check-the-prerequisites</a></li></ul><p>プロキシを経由し Azure AD と接続する場合には、WPAD が構成されていない環境の場合には下記技術情報に記載のとおり構成ファイルを編集する必要があります。</p><ul><li>パススルー認証エージェントは、送信 Web プロキシ サーバーで通信できますか。<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/how-to-connect-pta-faq#------------------web-------------------">https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/how-to-connect-pta-faq#------------------web-------------------</a></li></ul><h3 id="Q-amp-A-2"><a href="#Q-amp-A-2" class="headerlink" title="[Q&amp;A]"></a>[Q&amp;A]</h3><hr><ul><li>Q. パスワード ハッシュ同期を複数の Azure AD Connect サーバーで構成することが可能か。</li><li>A. いいえ、できません。パスワード ハッシュ同期はアクティブの Azure AD Connect サーバーでのみ行われます。その他の Azure AD Connect サーバーはステージング サーバーとなり、パスワード ハッシュ同期が有効化されている場合も、動作は停止しています。</li></ul><hr><ul><li>Q. PTA の必要数は ?</li><li>A. 1 台で動作はしますが、下記技術情報のとおり、運用環境では 3 つ以上実行することを推奨しております。Azure AD Connect 1 台 (PTA 1 台目) + PTA 2 台目 + PTA 3 台目<br>  <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-pta-quick-start#step-1-check-the-prerequisites">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-pta-quick-start#step-1-check-the-prerequisites</a></li></ul><h2 id="D-パスワードライトバック機能"><a href="#D-パスワードライトバック機能" class="headerlink" title="D. パスワードライトバック機能"></a>D. パスワードライトバック機能</h2><p>パスワードの書き戻しを有効とした場合には、Azure AD から Active Directory へのパスワードの書き戻し処理のために下記の要件を満たす必要があります。 </p><ul><li>オンプレミス Active Directory への書き込み権限<br>Azure AD Connect に対するアカウントのアクセス許可を構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect</a></li></ul><blockquote><p>[補足]<br>セルフパスワード リセット サービス (SSPR) を構成する場合には、下記 URL およびデータセンター IP  アドレスへの送信 HTTPS アクセスが許可される必要があります。<br>  *.passwordreset.microsoftonline.com<br>  *.servicebus.windows.net<br> <br>  Microsoft Azure Datacenter IP Ranges<br>  <a href="https://www.microsoft.com/en-us/download/details.aspx?id=41653">https://www.microsoft.com/en-us/download/details.aspx?id=41653</a> </p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure &amp;amp; Identity サポート チームです。&lt;br&gt;Azure AD Connect の新規構築、サーバー移行時に多くお問い合わせいただく事前に確認点をお纏めいたしました。&lt;br&gt;大きく分けて要件としては下記となります。&lt;/p&gt;
&lt;ul&gt;
</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect Health Notification メールについて</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-health-notification/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-health-notification/</id>
    <published>2023-07-24T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.571Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/03/01/aadc-health-notification/">https://blogs.technet.microsoft.com/jpazureid/2018/03/01/aadc-health-notification/</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p><p>2018 年 3 月 1 日に「Azure AD Connect Health Notification メールについて」 として公開しておりましたが、情報が古くなってまいりましたので、 2023 年 7 月 25 日時点の最新情報として改めて更新のうえ公開しております。</p></div><p>こんにちは！ Azure Identity サポートの小出です。  </p><p>Azure AD Connect を利用してオンプレミスと Azure AD を連携している環境で最近 (2018 年 2 月) 突然次のような通知メールが届いているケースがあると思います。<br>この通知メールについて Q&amp;A 形式で纏めました。  </p><p>&lt;本文サンプル&gt;<br><img src="/blog/azure-active-directory-connect/azure-ad-connect-health-notification/notification1.png"></p><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-health-notification/notification2.png"></p><h2 id="Q-このメールは何を通知しているのか？"><a href="#Q-このメールは何を通知しているのか？" class="headerlink" title="Q. このメールは何を通知しているのか？"></a>Q. このメールは何を通知しているのか？</h2><p>A. Azure AD Connect Health Agent による Azure データセンターへの正常性データのアップロードが RAISED (発生日時) から RESOLVE (解決日時) まで行われていなかったことを通知しています。<br>Azure AD Connect はオンプレミスの Active Directory のユーザー情報を Azure AD に同期しますが、その他にもオンプレミスのサーバーの監視をおこなう Azure AD Connect Health Agent というエージェントがあります。<br>このエージェントは定期的にオンプレミスの監視対象とするサーバーの情報を Azure AD にアップロードします。<br>今回の通知は、そのアップロードが一定期間  RAISED (発生日時) から RESOLVE (解決日時) まで、行えていなかったことを管理者に通知しています。<br>Azure AD Connect Health Agent サービスによるアップロードが 2 時間以上行われていないと Azure Portal 上にそのことを示す通知が行われます。<br>Azure Portal : URL:<a href="https://aka.ms/aadconnecthealth">https://aka.ms/aadconnecthealth</a>  </p><p>メールは上記サンプルのように、基本的には発生した時と解消した時の2回通知されます。</p><h2 id="Q-Resolved-だが、監視通信は正常な状態になっているのか？"><a href="#Q-Resolved-だが、監視通信は正常な状態になっているのか？" class="headerlink" title="Q. [Resolved] だが、監視通信は正常な状態になっているのか？"></a>Q. [Resolved] だが、監視通信は正常な状態になっているのか？</h2><p>A. “監視通信が行えていない” という情報が削除された結果であり、実際に監視通信が正常ではない状態が継続している可能性があります。  </p><p>例えば、Azure AD Connect (AADC) サーバーを数時間程度シャットダウンした場合には、停止後から約 2 時間で監視通信が行えていない内容の通知メールが送付され、起動後から約 2 時間で監視通信が再開できた (今回の通知メールと同じ内容の) 通知メールが送付されます。<br>そのため、1 つの目安として通知メール内の “RAISED (問題発生日時)” と “RESOLVE (問題解決日時)” を参照し、メンテナンスや意図した作業に伴い AADC サーバーから Azure AD に向けた通信が行えないような状態に心当たりがないか確認します。</p><h2 id="Q-通知メールはどのタイミングで配信されるのか？"><a href="#Q-通知メールはどのタイミングで配信されるのか？" class="headerlink" title="Q. 通知メールはどのタイミングで配信されるのか？"></a>Q. 通知メールはどのタイミングで配信されるのか？</h2><p>A. データセンター側では約 2 時間おきにアップロード状況の確認が行われています。</p><p>確認が行われるまでに 2 時間以上アップロードされていない場合にメールで通知されるため、アップロードがされなくなってから、通知メールが配信されるまでは少なくとも 2 時間、場合によっては 4 時間ほど要します。</p><h2 id="Q-監視通信が行えていないが、Azure-Active-Directory-との同期処理は問題ないか？"><a href="#Q-監視通信が行えていないが、Azure-Active-Directory-との同期処理は問題ないか？" class="headerlink" title="Q. 監視通信が行えていないが、Azure Active Directory との同期処理は問題ないか？"></a>Q. 監視通信が行えていないが、Azure Active Directory との同期処理は問題ないか？</h2><p>A. オンプレミスのサーバーを監視する Agent による通信に関してであり、ディレクトリ同期ができているか、できていないかとは関係しません。  </p><h2 id="Q-監視通信を使用していないので、無効化する手順は？"><a href="#Q-監視通信を使用していないので、無効化する手順は？" class="headerlink" title="Q. 監視通信を使用していないので、無効化する手順は？"></a>Q. 監視通信を使用していないので、無効化する手順は？</h2><p>A. 下記のサービスを停止することで無効化することが可能です。</p><ul><li>Azure AD Connect Health Sync Insights Service  </li><li>Azure AD Connect Health Sync Monitoring Service  </li></ul><h2 id="Q-監視通信が正常に行えているか確認する方法は？"><a href="#Q-監視通信が正常に行えているか確認する方法は？" class="headerlink" title="Q. 監視通信が正常に行えているか確認する方法は？"></a>Q. 監視通信が正常に行えているか確認する方法は？</h2><p>A. Azure AD Connect サーバーにて、上述の 2 つのサービスが稼働していることを確認します。<br>Azure AD Connect サーバーにて、下記のコマンドを実行します。  </p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Test-AzureADConnectHealthConnectivity</span> <span class="literal">-Role</span> Sync <span class="literal">-ShowResult</span>  </span><br></pre></td></tr></table></figure><p>コマンド実行例)</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Test-AzureADConnectHealthConnectivity</span> <span class="literal">-Role</span> Sync <span class="literal">-ShowResult</span>  <span class="built_in">Test-AzureADConnectHealthConnectivity</span><span class="string">&#x27;s execution in details are as follows:  </span></span><br><span class="line"><span class="string">Starting Test-AzureADConnectHealthConnectivity ...  </span></span><br><span class="line"><span class="string">Connectivity Test Step 1 of 3: Testing dependent service endpoints begins ...  </span></span><br><span class="line"><span class="string">AAD CDN connectivity is skipped.  </span></span><br><span class="line"><span class="string">Connecting to endpoint https://login.microsoftonline.com  Endpoint validation for https://login.microsoftonline.com is Successful.  </span></span><br><span class="line"><span class="string">Connecting to endpoint https://login.windows.net  Endpoint validation for https://login.windows.net is Successful.  </span></span><br><span class="line"><span class="string">Connecting to endpoint https://policykeyservice.dc.ad.msft.net/clientregistrationmanager.svc  </span></span><br><span class="line"><span class="string">Endpoint validation for https://policykeyservice.dc.ad.msft.net/clientregistrationmanager.svc is Successful.  </span></span><br><span class="line"><span class="string">Connecting to endpoint https://policykeyservice.dc.ad.msft.net/policymanager.svc  </span></span><br><span class="line"><span class="string">Endpoint validation for https://policykeyservice.dc.ad.msft.net/policymanager.svc is Successful.  </span></span><br><span class="line"><span class="string">Connectivity Test Step 1 of 3 - Testing dependent service endpoints completed successfully.  </span></span><br><span class="line"><span class="string">Connectivity Test Step 2 of 3 - Blob data upload procedure begins ...  </span></span><br><span class="line"><span class="string">Tenant Id is successfully collected during agent registration.  </span></span><br><span class="line"><span class="string">Connectivity Test Step 2 of 3 - Blob data upload procedure completed successfully.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Connectivity Test Step 3 of 3 - EventHub data upload procedure begins ...  </span></span><br><span class="line"><span class="string">Tenant Id is successfully collected during agent registration.  </span></span><br><span class="line"><span class="string">Connectivity Test Step 3 of 3 - EventHub data upload procedure completed successfully.  </span></span><br><span class="line"><span class="string">Test-AzureADConnectHealthConnectivity completed successfully...  </span></span><br></pre></td></tr></table></figure><ul><li>3 つの確認ステップが実行されますので、それぞれ “completed successfully” となるかを確認ください。  </li></ul><p>Title : Azure AD Connect Health サービスへの接続テスト<br>URL:<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/connect-health/active-directory-aadconnect-health-agent-install#test-connectivity-to-azure-ad-connect-health-service">https://docs.microsoft.com/ja-jp/azure/active-directory/connect-health/active-directory-aadconnect-health-agent-install#test-connectivity-to-azure-ad-connect-health-service</a></p><h2 id="Q-監視通信の通知メールの宛先を変更方法は？"><a href="#Q-監視通信の通知メールの宛先を変更方法は？" class="headerlink" title="Q. 監視通信の通知メールの宛先を変更方法は？"></a>Q. 監視通信の通知メールの宛先を変更方法は？</h2><p>A. Azure Portal 画面より変更、無効化することが可能です。  </p><ol><li>Azure ポータル（<a href="http://portal.azure.com)にサインインします./">http://portal.azure.com）にサインインします。</a>  </li><li>左側のメニューから [Azure Active Directory] – [Azure AD Connect] - [Connect 同期] をクリックします。  </li><li>[正常性と分析] の下にある [Azure AD Connect Health] をクリックします。  </li><li>[Azure Active Directory Connect (Sync)] の枠内にある [同期サービス] をクリックし、対象テナントをクリックします。  </li><li>[操作] の枠内をクリックします。  </li><li>[通知設定] をクリックします。<br>通知を無効化する場合 : “新しいアラートの通知を電子メールで受け取ります。” 項目のチェックをオフに設定します。<br>通知先を変更する場合 : 変更を行うメールアドレス欄を選択し、変更後のアドレスを入力します。  </li><li>[保存] をクリックします。  </li></ol><p>Title : Azure Active Directory Connect Health の操作<br>URL:<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/connect-health/active-directory-aadconnect-health-operations">https://docs.microsoft.com/ja-jp/azure/active-directory/connect-health/active-directory-aadconnect-health-operations</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Graph PowerShell v2.0 でサポートされた認証方法と変更点</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-graph-powershell-v2.0/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-graph-powershell-v2.0/</id>
    <published>2023-07-20T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.311Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの沓澤です。</p><p>多くのお客様にお使いいただいている Microsoft Graph PowerShell モジュールの v2.0 が 2023/7/5 にリリースされました！モジュールの再インストールやアップデートを実施した際に Microsoft Graph PowerShell v2.0 以降がインストールされるようになります。Microsoft Entra ID 関連の変更点としては、サポートされる認証方法が増えます。一方で、Microsoft Entra ID を含め全てのサービスに関連いたしますが、今回のアップデートには破壊的変更があります。</p><p>本記事では Microsoft Graph PowerShell v2.0 のインストール方法の説明した後、サポートされるようになった認証方法と破壊的変更の内容について説明します。</p><h2 id="Microsoft-Graph-PowerShell-v2-0-のインストール"><a href="#Microsoft-Graph-PowerShell-v2-0-のインストール" class="headerlink" title="Microsoft Graph PowerShell v2.0 のインストール"></a>Microsoft Graph PowerShell v2.0 のインストール</h2><p>Microsoft Graph PowerShell は Microsoft Graph REST API (v1.0/Beta) を呼び出すためのモジュールです。Microsoft Graph PowerShell v1.x では 1 つのモジュール (Microsoft Graph PowerShell) で Microsoft Graph REST API v1.0 と Microsoft Graph REST API Beta の両方を呼び出せます。</p><p>一方、Microsoft Graph PowerShell v2.0 では、大きく二つのモジュールに分けられており、Microsoft Graph REST API v1.0 の呼び出しには Microsoft Graph PowerShell モジュールを使用し、Microsoft Graph REST API Beta の呼び出しには Microsoft Graph PowerShell Beta モジュールを使う必要があります。そのため、Microsoft Graph REST API Beta の呼び出しを計画している場合には Microsoft Graph PowerShell Beta のインストールが必要です。</p><p><img src="/blog/azure-active-directory/microsoft-graph-powershell-v2.0/module-image.png"></p><p>以下では、Microsoft Graph PowerShell モジュールおよび Microsoft Graph PowerShell Beta モジュールのインストール方法を説明します。</p><p>公開情報は既に v2.0 を前提とした説明に更新されていますので詳細は <a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-1.0#installation">Install the Microsoft Graph PowerShell SDK</a> をご確認ください。</p><h3 id="Microsoft-Graph-PowerShell-モジュールのインストールおよびアップデート"><a href="#Microsoft-Graph-PowerShell-モジュールのインストールおよびアップデート" class="headerlink" title="Microsoft Graph PowerShell モジュールのインストールおよびアップデート"></a>Microsoft Graph PowerShell モジュールのインストールおよびアップデート</h3><p>Microsoft Graph PowerShell を初めて使用する場合は以下のコマンドでインストールください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> Microsoft.Graph</span><br></pre></td></tr></table></figure><p>既に Microsoft Graph PowerShell v1.x を使用中の場合は以下のコマンドでアップデートできます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-Module</span> Microsoft.Graph</span><br></pre></td></tr></table></figure><h3 id="Microsoft-Graph-PowerShell-Beta-モジュールのインストール"><a href="#Microsoft-Graph-PowerShell-Beta-モジュールのインストール" class="headerlink" title="Microsoft Graph PowerShell Beta モジュールのインストール"></a>Microsoft Graph PowerShell Beta モジュールのインストール</h3><p>Microsoft Graph PowerShell Beta モジュールは、Microsoft Graph PowerShell モジュールと別々にインストールできます。言い換えますと Microsoft Graph PowerShell と Microsoft Graph PowerShell Beta は共存できます。運用環境にて Beta エンドポイントの利用を避けたい (v1.0 エンドポイントのみを利用したい) 場合は、上記手順で Microsoft Graph PowerShell モジュールのみをインストールし、Microsoft Graph PowerShell Beta モジュールをインストールしないということも可能です。</p><p>インストールするには以下コマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> Microsoft.Graph.Beta</span><br></pre></td></tr></table></figure><h2 id="v2-0-からサポートされる認証方法"><a href="#v2-0-からサポートされる認証方法" class="headerlink" title="v2.0 からサポートされる認証方法"></a>v2.0 からサポートされる認証方法</h2><p>以下 2 つを使用した認証方法がサポートされるようになりました。</p><ul><li>マネージド ID</li><li>クライアント シークレット</li></ul><h3 id="マネージド-ID"><a href="#マネージド-ID" class="headerlink" title="マネージド ID"></a>マネージド ID</h3><p>システム割り当てマネージド ID での認証をする場合は以下コマンドを実行ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Connent<span class="literal">-MgGraph</span> <span class="literal">-Identy</span></span><br></pre></td></tr></table></figure><p>ユーザー割り当てマネージド ID での認証をする場合は以下コマンドを実行ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Identity</span> <span class="literal">-u</span> &lt;ユーザー割り当てマネージド ID のアプリケーション ID&gt;</span><br></pre></td></tr></table></figure><h3 id="クライアント-シークレット"><a href="#クライアント-シークレット" class="headerlink" title="クライアント シークレット"></a>クライアント シークレット</h3><p>クライアント シークレットで認証する場合は以下コマンドを実行ください。認証ポップアップにクライアント シークレットの文字列を入力します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ClientSecretCredential</span> = <span class="built_in">Get-Credential</span> <span class="literal">-Username</span> <span class="string">&quot;&lt;アプリケーション ID&gt;&quot;</span> Message <span class="string">&quot;Enter the client secret string.&quot;</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-TenantId</span> <span class="string">&quot;&lt;テナント Id&gt;&quot;</span> <span class="literal">-ClientSecretCredential</span> <span class="variable">$ClientSecretCredential</span></span><br></pre></td></tr></table></figure><h2 id="破壊的変更"><a href="#破壊的変更" class="headerlink" title="破壊的変更"></a>破壊的変更</h2><p>Microsoft Graph PowerShell を使用し Microsoft Entra ID 関連のデータ操作をする際に、関連するものを数点ピックアップします。</p><p>詳細については GitHub の <a href="/blog/docs/upgrade-to-v2/">v2.0 へのアップグレード ガイド</a> をご確認ください</p><h3 id="Select-MgProfile-コマンドの廃止"><a href="#Select-MgProfile-コマンドの廃止" class="headerlink" title="Select-MgProfile コマンドの廃止"></a>Select-MgProfile コマンドの廃止</h3><p>Microsoft Graph PowerShell v1.x では Select-MgProfile コマンドにより Microsoft Graph REST API v1.0 と Microsoft Graph REST API Beta との呼び出し先の振り分けていました。v2.0 からは Select-MgProfile コマンドは廃止され、上述のとおり Microsoft Graph PowerShell モジュールからは Microsoft Graph REST API v1.0 を呼び出し、Microsoft Graph PowerShell Beta モジュールからは Microsoft Graph REST API Beta を呼び出すように変更になりました。</p><h3 id="Microsoft-Graph-REST-API-Beta-を呼び出す際のコマンドの命名規則が-lt-Verb-gt-MgBeta-lt-Noun-gt-に"><a href="#Microsoft-Graph-REST-API-Beta-を呼び出す際のコマンドの命名規則が-lt-Verb-gt-MgBeta-lt-Noun-gt-に" class="headerlink" title="Microsoft Graph REST API Beta を呼び出す際のコマンドの命名規則が &lt;Verb&gt;-MgBeta&lt;Noun&gt; に"></a>Microsoft Graph REST API Beta を呼び出す際のコマンドの命名規則が &lt;Verb&gt;-Mg<strong>Beta</strong>&lt;Noun&gt; に</h3><p>Micrsosft Graph REST API Beta を呼び出す際には Microsoft Graph PowerShell Beta モジュール内のコマンドを使用します。命名規則は &lt;Verb&gt;-Mg<strong>Beta</strong>&lt;Noun&gt; です。</p><p>下表に例を記載します。</p><table><thead><tr><th align="center">v1.0</th><th align="center">Beta</th></tr></thead><tbody><tr><td align="center">Get-MgUser</td><td align="center">Get-MgBetaUser</td></tr><tr><td align="center">Get-MgUserMessage</td><td align="center">Get-MgBetaUserMessage</td></tr></tbody></table><h3 id="Connect-MgGraph-コマンドにおける-ForceRefresh-オプションの廃止"><a href="#Connect-MgGraph-コマンドにおける-ForceRefresh-オプションの廃止" class="headerlink" title="Connect-MgGraph コマンドにおける -ForceRefresh オプションの廃止"></a>Connect-MgGraph コマンドにおける -ForceRefresh オプションの廃止</h3><p>Connect-MgGraph -ForceRefresh が使用不可になり、代わりに Disconnect-MgGraph 後に Connect-MgGraph を実行する必要があります。</p><h3 id="Connect-MgGraph-コマンドにおける-AccessToken-オプションでは-SecureString-型の引数が必要に"><a href="#Connect-MgGraph-コマンドにおける-AccessToken-オプションでは-SecureString-型の引数が必要に" class="headerlink" title="Connect-MgGraph コマンドにおける -AccessToken オプションでは SecureString 型の引数が必要に"></a>Connect-MgGraph コマンドにおける -AccessToken オプションでは SecureString 型の引数が必要に</h3><p>以下コマンドではエラーが生じます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-AccessToken</span> &lt;アクセス トークンの文字列&gt;</span><br></pre></td></tr></table></figure><p>代わりに以下のように SecureString 型の引数を指定する必要があります:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$st</span> = <span class="built_in">ConvertTo-SecureString</span> &lt;アクセス トークンの文字列&gt; <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-AccessToken</span> <span class="variable">$st</span></span><br></pre></td></tr></table></figure><h3 id="モジュール名のリネーム"><a href="#モジュール名のリネーム" class="headerlink" title="モジュール名のリネーム"></a>モジュール名のリネーム</h3><p>モジュール名の変更を下表にまとめます:</p><table><thead><tr><th align="center">v1.x</th><th align="center">v2.0</th></tr></thead><tbody><tr><td align="center">DeviceManagement.Enrolment</td><td align="center">DeviceManagement.Enrollment</td></tr><tr><td align="center">DeviceManagement.Enrollment</td><td align="center">Identity.Governance</td></tr></tbody></table><p>スクリプト内で Import-Module をしている場合にはモジュール名の変更が必要です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの沓澤です。&lt;/p&gt;
&lt;p&gt;多くのお客様にお使いいただいている Microsoft Graph PowerShell モジュールの v2.0 が 2023/7/5 にリリースされました！モジュールの再インストールやアップデート</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Microsoft Graph" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph/"/>
    
    <category term="Microsoft Graph PowerShell" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph-PowerShell/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra - Security Service Edge へ拡大するための新機能</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/</id>
    <published>2023-07-19T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.299Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 姚 (ヨウ) です。</p><p>本記事は、2023 年 7 月 11 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-expands-into-security-service-edge-with-two-new/ba-p/3847829">Microsoft Entra Expands into Security Service Edge with Two New Offerings - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>柔軟な仕事環境やデジタル トランスフォーメーションにより、どのようにして情報に安全にアクセスするかという方法も変化してきています。従来のネットワークをベースにしたセキュリティのアプローチは現在の環境には適さなくなってきました。従来の方法は、エンド ユーザーの体験を損なうだけでなく、ユーザーに対して、ネットワーク全体に必要以上のアクセス権を与えることになります。攻撃者が、1 名の情報漏洩ユーザー、1 つの感染デバイスなど、1 つのきっかけを得るだけで、内部ネットワークへ自由に入り込み、重要情報資産が流出することになります。</p><p><img src="/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/over_view.png"></p><p>先進的なアクセス ソリューションをシステムに導入したとしても、複数の ID とネットワーク ツールを統合し、管理する必要があります。なぜなら、単独の ID またはネットワーク ツールだけでは、すべてのアクセス ポイントを保護することはできないからです。もしうまく統合できないツールを利用してしまうと、重要な統合ポイントを見逃してしまう可能性があります。熟練した攻撃者はそういったソリューションの間にある隙間を攻撃するのです。全アプリケーションまたはリソースを保護するためには簡単かつアジャイルなアプローチが必要です。本日弊社が紹介する新しいネットワーク モデルにより、アクセス保護の仕方も変わってくるでしょう。</p><p>本日は <a href="https://www.microsoft.com/en-us/security/blog/2023/07/11/microsoft-entra-expands-into-security-service-edge-and-azure-ad-becomes-microsoft-entra-id/">2 つの新しい製品</a> を紹介いたします。</p><ul><li>Microsoft Entra Internet Access</li><li>Microsoft Entra Private Access</li></ul><p>ID とネットワーク ソリューションを連携させることにより、個々のアプリにどのツールが適切か考えたり、ID 担当チームが作成したポリシーとネットワーク担当チームが作成したポリシーとを連携させる方法を検討したりすることに時間に費やす必要はなくなります。Microsoft Entra の条件付きアクセスを利用して ID とネットワークを総合的に制御することができるようになります。</p><p>クラウドベースの ID 中心のネットワーク アクセス ソリューションを通して、すべてのエンドユーザー、アプリケーション、外部リソースそして IT システムをつなぐことができるようになります。このクラウド サービスはレガシーのオンプレミス システムと比較すると、変化に柔軟で管理が容易であり、コスト効率がよいため、ユーザーの生産性を損なうことはありません。このモデルはゼロ トラストの原則をベースとしており、ID を検証すると共に、リスクに基づいた検出も行うことで、ユーザーの仕事に必要なアプリケーション、リソースにアクセスできるよう支援します。</p><h2 id="Microsoft-Entra-Internet-Access"><a href="#Microsoft-Entra-Internet-Access" class="headerlink" title="Microsoft Entra Internet Access"></a>Microsoft Entra Internet Access</h2><p>Microsoft Entra Internet Access は、SaaS アプリケーションおよびインターネット通信向けの、ID を軸とした Secure Web Gateway (SWG) であり、悪意がある接続や危険/非準拠なコンテンツ、外部インターネットからの脅威から保護するためのサービスです。例えば、高リスクと判断されたユーザーまたは非準拠デバイスからのアクセスは、セルフサービス パスワード リセットのページを除いて通信をすべてブロックするということが可能になります。これは、条件付きアクセスの条件の設定をネットワークの条件で拡張するようなものとお考えください。これにより、例えばセッション トークンが盗まれたとしても、その再利用を抑止するために、”準拠ネットワーク” からのみリソースへのアクセスを許可するようにも構成できます。</p><p>Universal Tenant Restrictions という Microsoft 365 向けの独自の機能も備えており、匿名アクセスを含め他テナントや個人アカウントへのデータ流出を防止し、リアルタイムに近い脅威の検出、ユーザー、場所およびデバイスに対する高精度のリスク評価、および Microsoft 365 アプリへのよりシームレスなアクセスを実現します。Microsoft Entra Internet Access はメイン ソリューションとしても、ほかの SSE ソリューションと組み合わせても展開でき、新しい Microsoft Graph API による統合も提供されます。また、ネットワーク トラフィックの情報は、エンドユーザーのクロスプラットフォームの OS およびリモート ネットワークの IPSec トンネリングを利用しても取得できます。</p><p>Microsoft 365 用および Windows 用の Microsoft Entra Internet Access が現在パブリック プレビューとして公開されています。他のすべてのトラフィック、クラウド ファイヤーウォール、脅威検知および他の OS のサポートは今年の後半に公開予定です。</p><p><img src="/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/internet_access.png"></p><h2 id="Microsoft-Entra-Private-Access"><a href="#Microsoft-Entra-Private-Access" class="headerlink" title="Microsoft Entra Private Access"></a>Microsoft Entra Private Access</h2><p>Microsoft Entra の Application Proxy をご存じかと思います。現在数千のお客様が内部ウェブ アプリケーションへのアクセスに Application Proxy を利用しています。本日、これにより優れたソリューションを発表いたします。Application Proxy と同じアプリ コネクターを共有する仕組みでありながら、組織の内部のリソース、ポートまたはプロトコールへのアクセスを保護する、ID 中心のゼロトラスト ネットワーク  アクセス (ZTNA) ソリューションです。</p><p>Microsoft Entra Private Access により、ユーザーがオフィスまたはリモートのどこにいようと、アプリケーションがオンプレミスのデータセンターまたは外部クラウドのどこにホストされていようと、より迅速かつ簡単にアプリケーションへ接続となります。これらのアプリケーションに対して何ら変更を加える必要はありません。追加の変更なく、多要素認証 (MFA) やデバイス準拠の検証、ID Protection、ID Governance、およびシングル サインオンを TCP/UDP をベースとしたアプリケーションに構成できます。加えて、SSH、RDP、SAP、SMB ファイル共有やほかの内部リソースもサポートします。</p><p>属性ベースの条件付きアクセス ポリシーを利用することにより、エンタープライズ向けのアプリケーションの重要度に基づき、より効果的に複数のアプリケーションを対象にしてシンプルなポリシーを作成することはできます。例えば、MFA を要求するポリシー、デバイスの準拠を要求するポリシー、ユーザーが低リスクであることを要求するポリシー、重要なアプリケーションに対して準拠したネットワークからのアクセスを要求するポリシーが挙げられます。特定のアプリケーションを対象にした個別のポリシーを構成することももちろん可能です。条件付きアクセス ポリシーと継続的アクセス評価 (CAE) との統合によって、レガシー アプリケーションの認証方法である Kerberos または NTLM を変更することなく、安全かつシームレスに先進的な認証を追加することができます。Microsoft Entra Private Access は現在パブリック プレビューです。</p><p><img src="/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/private_access.png"></p><h2 id="ID-中心の-Security-Service-Edge-SSE-ソリューションでどこからでもアプリケーションやリソースへ安全にアクセス"><a href="#ID-中心の-Security-Service-Edge-SSE-ソリューションでどこからでもアプリケーションやリソースへ安全にアクセス" class="headerlink" title="ID 中心の Security Service Edge (SSE) ソリューションでどこからでもアプリケーションやリソースへ安全にアクセス"></a>ID 中心の Security Service Edge (SSE) ソリューションでどこからでもアプリケーションやリソースへ安全にアクセス</h2><p>Microsoft Entra Internet Access と Private Access に加えて、弊社の SaaS - セキュリティに特化した CASB (Cloud Access Security Broker) - である Microsoft Defender for Cloud Apps を組み合わせることによって Microsoft の Security Service Edge ソリューションが構成されます。このソリューションは Microsoft の広範なセキュリティ製品と深く統合されており、オープンなパートナー エコシステムを形成するため、既存のネットワークとセキュリティ ソリューションとも連携できます。</p><p>Microsoft Internet Access と Private Access は、同じエージェントを共有しており、複数の種類の OS で動作し、なおかつ複数の種類のデバイスとネットワークで一貫した接続性を提供いたします。アプリケーションまたはウェブサイトに対して、利用する IdP に関係なく、しかもアプリケーションを変更することなく、ID、デバイス、アプリケーション、そして今後はネットワーク条件を考慮した制御を一つの条件付きアクセス ポリシーで実現できるようになるのです。</p><p><img src="/blog/azure-active-directory/microsoft-entra-expands-into-securityserviceedge-with-two-new-offerings/sse.png" alt="ID 中心の Security Service Edge (SSE) ソリューションでどこからでもアプリケーションやリソースへ安全にアクセス可能となります。一つの条件付きアクセスの制御を用いて、ネットワーク アクセスのセキュリティをよりシンプルにし、より良いユーザー体験をお届けします。"></p><p>Microsoft の SSE ソリューションは世界最大の企業ネットワークの 1 つである <a href="https://learn.microsoft.com/en-us/azure/networking/microsoft-global-network">Microsoft Global Network</a> によって提供されます。Microsoft Global Network は、<a href="https://azure.microsoft.com/en-us/explore/global-infrastructure/global-network/#features">185 以上のグローバルなネットワーク接続拠点</a> に加え、世界中に巨大な網目のように配置されたエッジ ノードにより、61 の Azure リージョンの<a href="https://azure.microsoft.com/en-us/explore/global-infrastructure/">データセンター</a> を結んでいます。これにより、ユーザーとデバイスをパブリックおよびプライベートのリソースにシームレスかつ安全に接続できるようになります。現在、Microsoft の SSE は北米とヨーロッパの一部の地域で提供されていますが、今年中に利用できる地域を追加する予定です。</p><p>我々の SSE ソリューションの導入により、Microsoft Internet Access と Private Access がユーザーの ID、デバイス 準拠状態、アプリケーション、そして今では新しいネットワークの準拠状態を条件として、どのアプリケーションおよびリソースに対しても、ID を中心とした単一のアプローチで安全な接続を実現します。すべてのアクセス ポリシーを統合し、継続的アクセス評価によりさらにポリシーを強化するということが、これまで以上に簡単になりました。</p><p>引き続き製品の Deep Dive ブログにもご期待ください。また、7 月 20 日の <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/live-series-6-27-amp-7-20-microsoft-entra-tech-accelerator/ba-p/2520433">Tech Accelerator Product Deep Dive Session</a> では、Microsoft Internet Access と Private Access がいかに組織のデジタル資産へのアクセスをより安全にするかという点をさらに紐解いて説明いたします。</p><p>このソリューションをより良くするために、ぜひパブリック プレビューに参加いただき、フィードバックを提供ください。</p><p>以下の公開情報もご参照いただけますと幸いです。</p><ul><li><a href="https://www.microsoft.com/security/business/identity-access/microsoft-entra-internet-access">Microsoft Entra Internet Access</a></li><li><a href="https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-private-access">Microsoft Entra Private Access</a></li><li><a href="https://aka.ms/SSEPublicPreview">Get started and try previews</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 姚 (ヨウ) です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 7 月 11 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect アップグレード手順詳細</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/how-to-upgrade-details/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/how-to-upgrade-details/</id>
    <published>2023-07-13T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.591Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity サポートの小出です。</p><p>以前、Azure AD Connect の非推奨プロセスに伴い、多くのお客様にて推奨バージョンへのアップグレードご検討いただいている状況となり、弊社にも多くのお問い合わせをいただいておりました。<br>現在はすでに v1.x は廃止され、多くのお客様が v2.x を利用されていますので、以前展開していた手順詳細資料をこの度アップデートいたしました。</p><p>なお、2023 年 10 月 1 日以降は AADC v1.x からの接続を停止することから、まだ v1.x を利用しているお客様においては、早急にアップグレードの対応を実施いただいているかと思います。</p><p>利用されているバージョンが v1.x、v2.x にかかわらず、利用できる手順となりますので、実際の作業時の参考にしていただければ幸いです。</p><p>今回ご紹介する手順のシナリオは下記の 3 パターンとなります。</p><ul><li>A. Azure AD Connect 2 台構成によるスウィング アップグレード</li><li>B. Azure AD Connect 1 台構成に 1 台追加で構成し、アップグレード</li><li>C. Azure AD Connect 1 台構成によるインプレースアップグレード</li></ul><p>それぞれの手順の流れと手順内容を pptx ファイルに纏めさせていただいています。<br>ご利用いただいている環境に応じて、ご参照ください。</p><h2 id="A-Azure-AD-Connect-2-台構成によるスウィング-アップグレード"><a href="#A-Azure-AD-Connect-2-台構成によるスウィング-アップグレード" class="headerlink" title="A. Azure AD Connect 2 台構成によるスウィング アップグレード"></a>A. Azure AD Connect 2 台構成によるスウィング アップグレード</h2><h3 id="lt-手順概要-gt"><a href="#lt-手順概要-gt" class="headerlink" title="&lt;手順概要&gt;"></a>&lt;手順概要&gt;</h3><ol><li>既存環境の各サーバーにて、動作状況の確認などアップグレード前の事前確認を行います。</li><li>カスタム同期ルールをはじめ、設定内容を保存します。</li><li>Server B の Azure AD Connect のインプレース アップグレードを行います。</li><li>Server B にて、アップグレード後の動作状況を確認します。</li><li>Server A にて Azure AD Connect のステージング モードを有効化します。</li><li>Server B にて Azure AD Connect のステージング モードを無効化し、アクティブにします。</li><li>Server A の Azure AD Connect のインプレース アップグレードを行います。</li><li>Server A にて、アップグレード後の動作状況を確認します。</li></ol><h3 id="lt-手順詳細-gt"><a href="#lt-手順詳細-gt" class="headerlink" title="&lt;手順詳細&gt;"></a>&lt;手順詳細&gt;</h3><p><a href="/blog/azure-active-directory-connect/how-to-upgrade-details/aadc-upgrade-a-2023v2.pptx">アップグレード手順詳細 A</a></p><h2 id="B-Azure-AD-Connect-1-台構成に-1-台追加で構成し、アップグレード"><a href="#B-Azure-AD-Connect-1-台構成に-1-台追加で構成し、アップグレード" class="headerlink" title="B. Azure AD Connect 1 台構成に 1 台追加で構成し、アップグレード"></a>B. Azure AD Connect 1 台構成に 1 台追加で構成し、アップグレード</h2><h3 id="lt-手順概要-gt-1"><a href="#lt-手順概要-gt-1" class="headerlink" title="&lt;手順概要&gt;"></a>&lt;手順概要&gt;</h3><ol><li>既存環境の ServerA にて、動作状況の確認などアップグレード前の事前確認を行います。</li><li>カスタム同期ルールをはじめ、設定内容を保存します。</li><li>Server B となる新しいサーバーを用意します。</li><li>新規構築した ServerB に Azure AD Connect をインストールします。 (ステージング モード有効)</li><li>Server B で動作状況を確認します。</li><li>Server A にて、 Azure AD Connect のステージング モードを有効化します。</li><li>Server B にて、 Azure AD Connect のステージング モードを無効化し、アクティブにします。</li><li>Server A の Azure AD Connect のインプレース アップグレードを行います。</li><li>Server A で動作状況を確認します。</li></ol><h3 id="lt-手順詳細-gt-1"><a href="#lt-手順詳細-gt-1" class="headerlink" title="&lt;手順詳細&gt;"></a>&lt;手順詳細&gt;</h3><p><a href="/blog/azure-active-directory-connect/how-to-upgrade-details/aadc-upgrade-b-2023v2.pptx">アップグレード手順詳細 B</a></p><h2 id="C-Azure-AD-Connect-1-台構成によるインプレースアップグレード"><a href="#C-Azure-AD-Connect-1-台構成によるインプレースアップグレード" class="headerlink" title="C. Azure AD Connect 1 台構成によるインプレースアップグレード"></a>C. Azure AD Connect 1 台構成によるインプレースアップグレード</h2><h3 id="lt-手順概要-gt-2"><a href="#lt-手順概要-gt-2" class="headerlink" title="&lt;手順概要&gt;"></a>&lt;手順概要&gt;</h3><ol><li>既存環境の動作状況の確認</li><li>設定内容の保存</li><li>アップグレード</li><li>アップグレードの動作確認 (手順1. と同じ)</li></ol><h3 id="lt-手順詳細-gt-2"><a href="#lt-手順詳細-gt-2" class="headerlink" title="&lt;手順詳細&gt;"></a>&lt;手順詳細&gt;</h3><p><a href="/blog/azure-active-directory-connect/how-to-upgrade-details/aadc-upgrade-c-2023v2.pptx">アップグレード手順詳細 C</a></p><h2 id="資料の選び方について"><a href="#資料の選び方について" class="headerlink" title="資料の選び方について"></a>資料の選び方について</h2><p>どの資料が適切な手順が分からない場合には、下記フローも参考にしてください。<br><img src="/blog/azure-active-directory-connect/how-to-upgrade-details/which-step-is-best-for-the-upgdrade.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity サポートの小出です。&lt;/p&gt;
&lt;p&gt;以前、Azure AD Connect の非推奨プロセスに伴い、多くのお客様にて推奨バージョンへのアップグレードご検討いただいている状況となり、弊社にも多くのお問い合わせをいただいておりました。</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>ハードマッチによる Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/upn-hard-match/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/upn-hard-match/</id>
    <published>2023-07-13T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.759Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/10/05/135/">https://blogs.technet.microsoft.com/jpazureid/2017/10/05/135/</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p></div><blockquote><p>2020/09/26 更新<br><a href="/blog/azure-active-directory-connect/aboutSoftMatching/">ソフトマッチによるAzure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法</a> のブログの公開に併せて、タイトルに “ハードマッチ” の記載を追記しました。</p><p>2023/7/14 更新<br>MSOL コマンド部分を新しい Microsoft Graph PowerShell SDK コマンドに置き換えました。</p></blockquote><p>こんにちは、Azure &amp; Identity サポート チームです。</p><p>今回は Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法の一つで、ハードマッチと呼ばれる方法についてご紹介します。</p><p>既に Azure AD 上にユーザー アカウントが存在している状態で、そのユーザーを後からオンプレミスの Active Directory (AD) に追加し、同期をおこなうときにその既存のアカウントをそのまま利用したいということがあると思います。</p><p>このようなケースではオンプレミス AD で対象となるアカウントのメール アドレス、または UPN 名を一致させた上で同期をおこなうという手法が一般的には取られます (これをソフトマッチと呼びます)。このソフトマッチができない場合 (UPN 名が異なるアカウントを紐づける必要がある場合など) にはハード マッチと呼ばれる方法で直接的に同期時にオブジェクトの一意性を確保する ID 情報 Immutable ID を紐づけます。</p><p>Azure AD Connect の既定の構成では、オンプレミス AD の ObjectGUID (バージョン 1.1.486.0 以前) あるいは msDS-ConsistencyGuid (バージョン 1.1.524.0 以降) を Base64 でエンコードした値を Immutable ID (source Anchor) として紐づけています。</p><p>以下では Azure AD Connect で ObjectGUID を ImmutableId と紐づける構成とている場合においてハードマッチによる同期をおこなう設定をご紹介します。</p><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><ol><li>オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認します</li><li>Azure AD 上で ImmutableId が設定されてないことを確認します</li><li>Azure AD 上のアカウントに ImmutableId を手動で設定します</li><li>手動で差分ディレクトリ同期を実施します</li></ol><p>※ 4 を除き、同期処理が止まっている状態で作業をご実施ください。同期処理が止まっていないと紐づけしたいオンプレミス AD のアカウントが同期されてしまい、Immutable ID を紐づけできません。</p><h3 id="1-オンプレミス-AD-にて-Base64-でエンコードされた-ObjectGUID-を確認"><a href="#1-オンプレミス-AD-にて-Base64-でエンコードされた-ObjectGUID-を確認" class="headerlink" title="1. オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認"></a>1. オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認</h3><p>オンプレミス上の紐づけ対象のアカウントの GUID 情報を取得します。</p><ol><li>オンプレミス Active Directory の任意の DC 上で [管理ツール] - [Active Directory ユーザーとコンピューター] を開きます。</li><li>メニューから [表示] - [拡張機能] にチェックを入れます。</li><li>該当ユーザー アカウントのプロパティを開きます。</li><li>[属性エディター] タブを開き、”distinguishedName” 値を選択し、[表示] をクリックします。</li><li>distinguishedName 値 (以下、DN 値) の内容をコピーします。</li><li>コマンド プロンプト (PowerShell でも可) を起動し、以下のコマンドを実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">ldifde <span class="operator">-f</span> c:\ ldifde_user.txt <span class="literal">-d</span> <span class="string">&quot;手順 5. でコピーした内容&quot;</span> <span class="literal">-p</span> subtree</span><br></pre></td></tr></table></figure><p>コマンド例：</p><p><img src="/blog/azure-active-directory-connect/upn-hard-match/hardmatch_11.png"></p><p>1-7. 出力されたファイルを開き、ObjectGUID の値を確認します。<br>出力結果例：</p><p><img src="/blog/azure-active-directory-connect/upn-hard-match/hardmatch_2.png"></p><h2 id="2-Azure-AD-上で-ImmutableId-が設定されてないことを確認"><a href="#2-Azure-AD-上で-ImmutableId-が設定されてないことを確認" class="headerlink" title="2. Azure AD 上で ImmutableId が設定されてないことを確認"></a>2. Azure AD 上で ImmutableId が設定されてないことを確認</h2><p>Azure AD の紐づけ対象のアカウントに ImmutableId が設定されていないことを確認します。ImmutableId が設定されている場合には、すでに同期対象となっていることを示します。</p><ol><li>インターネットに接続している任意のコンピューター上で “Windows PowerShell 用 Windows Azure Active Directory モジュール” を管理者として実行します。</li><li>起動した PowerShell にて Connect-MsolService コマンドを実行します。<br>※ 認証ダイアログが表示されますので、管理者ユーザーの資格情報を入力して [OK] ボタンをクリックします。</li><li>下記のコマンドを実行します。</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId  &quot;対象ユーザーの UPN&quot; -Select OnPremisesImmutableId | fl OnPremisesImmutableId</span><br></pre></td></tr></table></figure><p>コマンド例：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId test12127@m365x61971868.onmicrosoft.com -Select Userprincipalname,OnPremisesImmutableId | fl OnPremisesImmutableId,userprincipalname</span><br></pre></td></tr></table></figure><ol start="4"><li>出力されたファイルを開き、ImmutableId の値を確認します。</li></ol><p>出力結果例：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OnPremisesImmutableId :（クラウド内ユーザーの場合、空白になります）</span><br><span class="line">UserPrincipalName     : test12127@m365x61971868.onmicrosoft.com</span><br></pre></td></tr></table></figure><h3 id="3-ImmutableId-を手動で設定"><a href="#3-ImmutableId-を手動で設定" class="headerlink" title="3. ImmutableId を手動で設定"></a>3. ImmutableId を手動で設定</h3><p>ディレクトリ同期ツールにて、ユーザーの情報を関連付けるには下記の情報を使用します。</p><ul><li>オンプレミス AD 側: objectGUID</li><li>Azure AD 側: ImmutableId</li></ul><ol><li>インターネットに接続している任意のコンピューター上で “Windows PowerShell 用 Windows Azure Active Directory モジュール” を管理者として実行します。</li><li>起動した PowerShell にて Connect-MsolService コマンドを実行します。<br>※認証ダイアログが表示されますので、管理者ユーザーの資格情報を入力して [OK] ボタンをクリックします。</li><li>下記のコマンドを実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-MgUser</span> <span class="literal">-UserId</span> 対象ユーザーの UPN <span class="literal">-OnPremisesImmutableId</span> &lt;オンプレ AD ユーザーの  Base64 エンコードされた objectGUID 値&gt;</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-MgUser</span> <span class="literal">-UserId</span> test12127@m365x61971868.onmicrosoft.com <span class="literal">-OnPremisesImmutableId</span> <span class="number">2</span>/<span class="number">9</span>JCtHr0EmH+hL07o11vAaa</span><br></pre></td></tr></table></figure><p>3-4. 下記のコマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgUser</span> <span class="literal">-UserId</span> 対象ユーザーの UPN <span class="literal">-Select</span> Userprincipalname,OnPremisesImmutableId | <span class="built_in">fl</span> OnPremisesImmutableId,userprincipalname</span><br></pre></td></tr></table></figure><p>コマンド例：</p><p><img src="/blog/azure-active-directory-connect/upn-hard-match/hardmatch_4.png"></p><h3 id="4-手動で差分ディレクトリ同期を実施"><a href="#4-手動で差分ディレクトリ同期を実施" class="headerlink" title="4. 手動で差分ディレクトリ同期を実施"></a>4. 手動で差分ディレクトリ同期を実施</h3><p>※ 2016 年 2 月に公開された新しいバージョン (1.1.105.0 以上) の Azure AD Connect を使用した手順をご案内いたします。</p><ol><li>ディレクトリ同期サーバーに管理者権限でログインします。</li><li>管理者の PowerShell を起動して、以下のコマンドを実行します。</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Start-ADSyncSyncCycle -PolicyType Delta</span><br></pre></td></tr></table></figure><p>※ 今回ご紹介しているケースのように Azure AD Connect が構成済みである場合は上記コマンドで差分同期をすることとなります。</p><ol start="3"><li>Office 管理ポータルで作業対象ユーザーの [同期の種類] が [クラウド] から [Active Directory ] に変わったことを確認します。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="UPN" scheme="https://jpazureid.github.io/blog/tags/UPN/"/>
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
    <category term="Hard match" scheme="https://jpazureid.github.io/blog/tags/Hard-match/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の新機能と変更のアナウンス</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-new-feature-and-change-announcements/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-new-feature-and-change-announcements/</id>
    <published>2023-07-11T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.303Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 6 月 30 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-new-feature-and-change-announcements/ba-p/3796396">Microsoft Entra new feature and change announcements</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft はこのほど、Entra 製品群に、組織のセキュリティ改善目的とした、さまざまな新しいセキュリティ ツールと機能を導入いたしました。サイバー攻撃がますます巧妙化し、クラウドベースのサービスやモバイル デバイスの利用が増加する中、組織がセキュリティを管理するための効果的なツールを導入することは不可欠です。</p><p>本日は、前四半期 (2023 年 4 月～ 6 月) の新機能リリースと既存機能の変更点 (2023 年 6 月の変更管理) をお伝えします。また、これらの変更点は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">リリース ノート</a> や電子メールでもお知らせしています。弊社では、新しい <a href="https://entra.microsoft.com/">Entra 管理センター</a> においても、お客様がライフサイクルの変更 (廃止、引退、サービスの破壊的変更) を管理しやすくなるよう改善を続けています。</p><p>これらの最近のアップデートは、機能エリアまたはテーマごとにまとめておりますので、最新のアップデートを素早く見つけてアクセス出来るようになっています。これらの新機能により、先進的な ID およびアクセス ソリューションをお客様に提供することを目指してまいります。</p><h2 id="製品アップデートの概要"><a href="#製品アップデートの概要" class="headerlink" title="製品アップデートの概要"></a>製品アップデートの概要</h2><ul><li>Azure Active Directory</li><li>Microsoft Entra Permissions Management</li><li>Microsoft Entra Workload Identities</li><li>Microsoft Entra External ID</li><li>Microsoft Entra Identity Governance</li></ul><h2 id="Azure-Active-Directory"><a href="#Azure-Active-Directory" class="headerlink" title="Azure Active Directory"></a>Azure Active Directory</h2><h3 id="新機能のリリース"><a href="#新機能のリリース" class="headerlink" title="新機能のリリース"></a>新機能のリリース</h3><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-certificate-based-authentication-cba-on-mobile/">モバイルでの Azure AD 証明書ベースの認証 (CBA)</a></li><li><a href="https://learn.microsoft.com/ja-jp/mem/intune/configuration/use-enterprise-sso-plug-in-ios-ipados-macos?pivots=all">Apple デバイスでのエンタープライズ SSO</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/howto-enforce-signed-saml-authentication">SP-initiated フローでの SAML 要求署名の検証</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-strengths">条件付きアクセスの認証強度</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/authentication-conditional-access#assigning-conditional-access-policies-to-external-user-types">条件付きアクセスにおける外部ユーザーの種類ごとのきめ細かな制御</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-identity-protection-risks#sign-in-risk">Azure AD ID Protection: 検証済み脅威アクター IP のサインインの検知</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal#step-3-select-the-appropriate-role">既定で安全な構成: Azure RBAC におけるロール選択画面</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-system-preferred-multifactor-authentication">システム優先多要素認証</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new#general-availability---my-security-info-now-shows-microsoft-authenticator-type">My Security Info の画面での Microsoft Authenticator の種類の表示</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-authenticator-lite">Authenticator Lite (Outlook)</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-mfasettings#report-suspicious-activity">ID Protection と統合された疑わしいアクティビティの報告機能</a></li><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/pending-devices">保留中のデバイスに対する自己修復機能</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-powershell-connector">Azure AD プロビジョニング エージェントを通した PowerShell と Web サービス コネクターのサポート</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions">ユーザーによる新規テナントの作成制限機能</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions">ユーザーによる BitLocker キーへのアクセス制限機能</a></li></ul><h3 id="既存の機能の変更"><a href="#既存の機能の変更" class="headerlink" title="既存の機能の変更"></a>既存の機能の変更</h3><h4 id="My-Security-Info-でのパスワード管理の操作性が向上"><a href="#My-Security-Info-でのパスワード管理の操作性が向上" class="headerlink" title="My Security Info でのパスワード管理の操作性が向上"></a>My Security Info でのパスワード管理の操作性が向上</h4><p>[お客様側での対応は必要なし]</p><p><strong>2023 年 10 月</strong> より、段階的な展開を経て、エンドユーザーによるパスワード管理の体験を改善し、My Security Info 管理ポータル (<a href="https://mysignins.microsoft.com/security-info">My Sign-Ins | Security Info | Microsoft.com</a> でパスワードを管理できるようにする機能を提供します。ユーザーはパスワードを変更できるようになり、多要素認証 (MFA) が可能なユーザーは My Security Info でパスワードをリセットできるようになります。<strong>2023 年 12 月</strong> までに、パスワードを変更するための従来の動作は、この新しい機能にリダイレクトされます。この変更はすべてのお客様に対して自動的に行われますので、お客様側での対応は不要です。</p><h4 id="音声ワンタイム-パスワードの導入"><a href="#音声ワンタイム-パスワードの導入" class="headerlink" title="音声ワンタイム パスワードの導入"></a>音声ワンタイム パスワードの導入</h4><p>[お客様側での対応が必要な場合があります]</p><p>音声通話は、最も安全性の低い認証方法です。MFA を行うには、Microsoft Authenticator (MFA とパスワードレスの両方の選択肢を提供) や、Windows Hello for Businessなど さらに優れた方法があります。弊社では、すべてのお客様に音声通話から別の方法への移行を推奨していますが、音声通話に依存しているお客様もいらっしゃるため、音声通話方式のセキュリティ改善を進めています。新しい方法では、”#” を押して認証を確認するのではなく、ワンタイム パスコード (OTP) が音声通話中にユーザーに読み上げられます。音声による OTP は、現在の SMS 認証方式の発展形である「電話 OTP」認証方式の一部として導入されます。この認証方式には 2 つの配信方法 (SMS と音声 OTP) があり、それらは自動的に最適な方式が選択されて配信されます。従来の # を押す方式は廃止されるため、音声 OTP に移行することをお勧めします。  </p><p><strong>2023 年 7 月</strong> 以降、Azure AD の無償 (Free) ライセンスを使用するすべての新規テナントには、この新しい最適化された配信方法が提供されます。Azure AD Free ライセンスをご利用の既存のテナントには、<strong>8 月</strong> 上旬からこの機能の展開を開始します。Azure AD Premium ライセンスをご利用のお客様については、電話 OTP 認証方法に関するすべての構成が利用可能になった後で展開が開始されます。また別の公のアナウンスにて、今後数ヶ月間にわたるスケジュールをお知らせする予定です。この変更により影響を受けるお客様には、<a href="https://go.microsoft.com/fwlink/p/?linkid=2070717">Microsoft 365 管理センターのメッセージ センター</a> から個別に管理者に通知いたします。</p><h4 id="登録キャンペーンの改善"><a href="#登録キャンペーンの改善" class="headerlink" title="登録キャンペーンの改善"></a>登録キャンペーンの改善</h4><p>[お客様側での対応が必要な場合があります]</p><p>ユーザーが <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/it-s-time-to-hang-up-on-phone-transports-for-authentication/ba-p/1751752">SMS や音声などの公衆交換電話網 (PSTN) から移行</a> できるように、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-registration-campaign">登録キャンペーン機能</a> を改善します。最大 3 回までプロンプトをスキップできるようにし、それ以降は登録フローに進む必要があります。</p><p>次に、登録キャンペーンの設定が [Microsoft マネージド] に設定されている Azure AD テナントにおいて、この機能を有効に変更します。これにより、現在 MFA を PSTN 方式 (SMS と音声) に完全に依存しているユーザーに対して登録キャンペーンが有効になります。<strong>2023 年 7 月</strong> 以降、Azure AD の無償ライセンスを持つテナントから段階的にこの変更を開始し、世界中のすべての組織に展開する予定です。スケジュールについては、改めて公開する予定です。この変更がお客様の組織に影響を与えるタイミングになりましたら、<a href="https://go.microsoft.com/fwlink/p/?linkid=2070717">Microsoft 365 管理センターのメッセージ センター</a> で管理者に通知しますので、ご注意ください。</p><h4 id="Azure-AD-での-IPv6-の有効化"><a href="#Azure-AD-での-IPv6-の有効化" class="headerlink" title="Azure AD での IPv6 の有効化"></a>Azure AD での IPv6 の有効化</h4><p>[お客様側での対応が必要な場合があります]</p><p>すべての Microsoft リージョンで IPv6 ロールアウトが <strong>6 月 30 日</strong> に完了するため、Azure AD のお客様に影響が出る可能性があります。ユーザーがブロックされたり、通常よりも多くの MFA リクエストを受け取ったりする可能性があります。このような場合は、テナントのサインインログを確認することをお勧めします。</p><p>テナントの名前付きロケーションに設定されていない IPv6 範囲からエンドユーザーが接続していることが原因でこのような影響が生じている可能性があります。この問題に対処するには、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#identifying-ipv6-traffic-with-azure-ad-sign-in-activity-reports">このページ</a> で説明されている手順に従って、テナントの環境で IPv6 の範囲を特定し、必要な設定を構成ください。</p><p>以下のガイダンスを IT 管理チームの関連メンバーと共有することも検討ください: </p><ul><li><p><strong>IT / セキュリティ管理者</strong>: <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#identifying-ipv6-traffic-with-azure-ad-sign-in-activity-reports">Azure AD のサインイン アクティビティ レポートでの IPv6 トラフィックを特定する</a> で説明したサインイン レポートを使用します。結果として取得したアドレスの一覧を使用して、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#ipv4-and-ipv6-address-ranges">こちら</a> の手順に従って、IPv6 範囲を Azure AD の ネームド ロケーションに追加する必要があるかどうかを判断ください。また、必要に応じて、社内のネットワーク チームと協力して、組織の IPv6 範囲を確認することも重要です。</p></li><li><p><strong>ネットワーク管理者</strong>: IT / セキュリティ管理者と協力して、ネットワーク基盤の IPv6 範囲を特定ください。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#ipv4-and-ipv6-address-ranges">こちら</a> の手順に従って、テナントの既存の Azure AD ネームド ロケーションにこれらの範囲を追加します。</p></li></ul><h4 id="My-Account-が従来のプロフィール-ページに置き換わる"><a href="#My-Account-が従来のプロフィール-ページに置き換わる" class="headerlink" title="My Account が従来のプロフィール ページに置き換わる"></a>My Account が従来のプロフィール ページに置き換わる</h4><p>[お客様側での対応は必要なし]</p><p>継続的なサービス改善の一環として、<strong>2023 年 10 月</strong> に従来のプロフィール ページ (<a href="https://account.activedirectory.windowsazure.com/r/#/profile">https://account.activedirectory.windowsazure.com/r/#/profile</a>) を新しく先進的な My Account の画面に置き換えます。7 月から 10 月にかけて、プロフィール ページ上のバナーで、置き換え予定についてお知らせします。</p><p>10 月になりましたら、プロフィール ページの URL は自動的に My Account にリダイレクトされます。旧 URL を許可リストまたはブックマークに登録していない限り、対応は不要です。許可リストを設定している場合は、My Account を含むように許可リストを更新する必要があります。My Account は本日より <a href="https://myaccount.microsoft.com/">https://myaccount.microsoft.com</a> でアクセスできます。</p><h4 id="ユーザーごとの多要素認証-MFA-設定の最新化"><a href="#ユーザーごとの多要素認証-MFA-設定の最新化" class="headerlink" title="ユーザーごとの多要素認証 (MFA) 設定の最新化"></a>ユーザーごとの多要素認証 (MFA) 設定の最新化</h4><p>[お客様側での対応は必要なし]</p><p>継続的なサービス改善の一環として、<strong>2023 年 10 月</strong> より、<a href="https://entra.microsoft.com/">Microsoft Entra 管理センター</a> の画面デザインに合わせた、最新の “<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userstates">ユーザーごとの MFA</a> の設定デザインが展開されます。このユーザー体験のアップデートの一環として、機能が削除されることはありません。この変更はすべてのお客様に対して自動的に行われるため、必要なアクションはありません。</p><h4 id="Azure-AD-Graph-の廃止と-PowerShell-モジュールの非推奨"><a href="#Azure-AD-Graph-の廃止と-PowerShell-モジュールの非推奨" class="headerlink" title="Azure AD Graph の廃止と PowerShell モジュールの非推奨"></a>Azure AD Graph の廃止と PowerShell モジュールの非推奨</h4><p>[お客様側での対応が必要な場合があります]</p><p>2019 年に、弊社では Azure AD Graph サービスの <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/update-your-applications-to-use-microsoft-authentication-library/ba-p/1257363">非推奨を発表</a> し、Azure AD Graph が <strong>2023 年 6 月 30 日</strong> 以降のある時点で機能しなくなることを <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/update-your-applications-to-use-microsoft-authentication-library/ba-p/1257363">お伝え</a> してきました。また、3 つのレガシー PowerShell モジュール (Azure AD、Azure AD Preview、MS Online) が 2023 年 6 月 30 日に非推奨となることも以前にお伝えしました。弊社では、多くのお客様がまだこれらの移行を完了していないことを理解しており、この移行期間中にお客様と協力して影響を最小限に抑え、回避するために引き続き取り組むことをお約束しています。</p><p>弊社は、Azure AD Graph の廃止プロセスと PowerShell モジュールの非推奨化に関するスケジュールおよび詳細に関する最新情報を公開しました。詳細は <a href="https://jpazureid.github.io/blog/azure-active-directory/important-azure-ad-graph-retirement-and-powershell-module/">こちら</a> をご覧ください。</p><p>要約は以下のとおりです: </p><ul><li><strong>PowerShell</strong>: レガシー PowerShell モジュールでサポートされているいくつかのシナリオが、Microsoft Graph PowerShell SDK ではまだ利用できないことを認識しております。このため、レガシー PowerShell モジュールの非推奨日を <strong>2024 年 3 月 30 日</strong> に延期しました。</li><li><strong>Azure AD Graph</strong>: 2023 年 6 月 30 日をもって、Azure AD Graph は廃止サイクルに入ります。6 月 30 日にアプリケーションへの影響はありませんが、Azure AD Graph API には、セキュリティ関連の修正以外の SLA やメンテナンスの保証をいたしません。弊社は、段階的に Azure AD Graph をリタイアすることを宣言しており、各ステップについては 3 カ月前に予告します。最初のステップでは、新しく作成されたアプリケーションが Azure AD Graph を使用できないようにします。次回の更新で、このステップのスケジュールと詳細をお知らせします。</li></ul><p>すべてのお客様に、Azure AD Graph を使用するアプリケーションを Microsoft Graph API に移行し、レガシー モジュールを使用する PowerShell スクリプトの移行を開始することを強くお勧めします。</p><h2 id="Microsoft-Entra-Permissions-Management"><a href="#Microsoft-Entra-Permissions-Management" class="headerlink" title="Microsoft Entra Permissions Management"></a>Microsoft Entra Permissions Management</h2><h3 id="新機能のリリース-1"><a href="#新機能のリリース-1" class="headerlink" title="新機能のリリース"></a>新機能のリリース</h3><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/cloud-infrastructure-entitlement-management/product-privileged-role-insights">Microsoft Entra Permissions Management Azure Active Directory Insights</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/cloud-infrastructure-entitlement-management/product-data-billable-resources">Microsoft Entra Permissions Management: 請求対象リソース</a></li></ul><h2 id="Microsoft-Entra-Workload-Identities"><a href="#Microsoft-Entra-Workload-Identities" class="headerlink" title="Microsoft Entra Workload Identities"></a>Microsoft Entra Workload Identities</h2><h3 id="新機能のリリース-2"><a href="#新機能のリリース-2" class="headerlink" title="新機能のリリース"></a>新機能のリリース</h3><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/workload-identities/workload-identity-federation">マネージド ID 用ワークロード ID フェデレーション</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new#general-availability---managed-identity-in-microsoft-authentication-library-for-net">.NET 用 Microsoft Authentication Library のマネージド ID</a></li></ul><h2 id="Microsoft-Entra-External-ID"><a href="#Microsoft-Entra-External-ID" class="headerlink" title="Microsoft Entra External ID"></a>Microsoft Entra External ID</h2><h3 id="既存機能の変更"><a href="#既存機能の変更" class="headerlink" title="既存機能の変更"></a>既存機能の変更</h3><h4 id="B2B-サインイン体験の今後の変更点"><a href="#B2B-サインイン体験の今後の変更点" class="headerlink" title="B2B サインイン体験の今後の変更点"></a>B2B サインイン体験の今後の変更点</h4><p>[お客様側での対応は必要なし]</p><p>現在、B2B ゲスト ユーザーがリソース テナントにサインインするよう促されると、背景とロゴのブランドにリソース テナントのものが反映されます。B2B ゲストがユーザー プリンシパル名 (UPN) を入力すると、ロゴはホーム テナントのものに変わりますが、背景のブランドはそのまま変わりません。</p><p>弊社は、クロステナントのコラボレーションの認証リクエストにおけるこのブランドのユーザー体験の変更に取り組んでいます。新しいユーザー体験では、B2B ゲスト ユーザーがサインインを要求された場合、UPN を入力した後、ホーム テナントのログイン ページにリダイレクトされ、ブランドのユーザー体験はリソース テナントではなくホーム テナントのものが反映されます。サインインに成功すると、ユーザーはリソース テナントでアプリにサインインします。</p><p>この変更は <strong>2023 年 7 月</strong> から開始し、<strong>2023 年 10 月</strong> までに完了する予定です。B2B コラボレーションを理解するには、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/what-is-b2b">Azure AD B2B コラボレーションの概要</a> をご覧ください。</p><h2 id="Microsoft-Entra-Identity-Governance"><a href="#Microsoft-Entra-Identity-Governance" class="headerlink" title="Microsoft Entra Identity Governance"></a>Microsoft Entra Identity Governance</h2><h3 id="新機能のリリース-3"><a href="#新機能のリリース-3" class="headerlink" title="新機能のリリース"></a>新機能のリリース</h3><ul><li><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-id-governance-is-generally-available/ba-p/2466932">Microsoft Entra ID Governance</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/what-are-lifecycle-workflows">ライフサイクル ワークフロー</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/multi-tenant-organizations/cross-tenant-synchronization-overview">クロステナント同期によるシームレスなアプリケーション アクセス</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/concept-pim-for-groups">グループ用 PIM</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/pim-how-to-change-default-settings#on-activation-require-azure-ad-conditional-access-authentication-context">PIM ロールのアクティブ化にはアクティブ化前に条件付きアクセス ポリシーの評価が必要</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/pim-resource-roles-configure-alerts">Azure でアクティブな永続的ロールの割り当てもしくは PIM 外での割り当てでアラートを発生</a></li><li><a href="https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-sspr-policy#administrator-reset-policy-differences">セルフ サービス パスワード リセット (SSPR) で PIM の資格ある割り当てと間接的なグループ ロール割り当てをサポート</a></li><li><a href="https://learn.microsoft.com/en-us/azure/active-directory/governance/entitlement-management-logic-apps-integration">エンタイトルメント管理のカスタム拡張属性</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-external-users#review-your-conditional-access-policies">条件付きアクセス ポリシーでエンタイトルメント管理を対象/除外可能に</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/cloud-sync/custom-attribute-mapping">Azure AD Cloud Sync を使用したディレクトリ拡張のサポート</a></li></ul><p>2023 年 7 月 11 日 (火) に開催されるデジタル イベント <a href="https://aka.ms/MSFTEntra">Reimagine secure access with Microsoft Entra</a> をお見逃しなく。ぜひご参加ください！</p><p>ライブまたはリプレイをご覧になるには、<a href="https://aka.ms/MSFTEntra">今すぐご登録</a> ください。</p><p>Shobhit Sahay</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 6 月 30 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD に連携している各種証明書、クライアント シークレットの有効期限の抽出方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/get-certificates-secrets-expirydateandtime/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/get-certificates-secrets-expirydateandtime/</id>
    <published>2023-07-04T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.095Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの栗井です。</p><p>Azure AD の [アプリの登録] から各アプリに連携している証明書・クライアント シークレット、ならびに [エンタープライズ アプリケーション] で SAML SSO を構成いただいている場合に登録している SAML 署名証明書は、いずれも有効期限があります。</p><p>Azure Portal の画面上では、有効期限を一覧で確認できないため、Microsoft Graph などの API を利用する必要がございます。</p><p>本記事では、下記公開情報内の Azure AD PowerShell を使用したサンプルをもとに、Microsoft Graph PowerShell を使用して各種証明書・シークレットの有効期限を CSV ファイルに出力する手順を紹介いたします。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/scripts/powershell-export-all-app-registrations-secrets-and-certs">アプリの登録用にシークレットと証明書をエクスポートする</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/scripts/powershell-export-all-enterprise-apps-secrets-and-certs">エンタープライズ アプリのシークレットと証明書をエクスポートする</a></li></ul><div class="alert is-info"><p class="alert-title">Note</p><p>2023/7/12 に上記の公開情報でも Microsoft Graph PowerShell を使用したサンプル スクリプトに書き換えられました。</p><p>公開情報内のサンプル スクリプトについてもサンプルの 1 つとしてご参照ください。</p></div><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><div class="alert is-important"><p class="alert-title">重要</p><p>こちらで紹介するサンプル スクリプトについては、あくまでもサンプルの情報となります。</p><p>運用環境でそのまま利用されることは想定しておらず、ご利用の際には、十分な検証作業を実施をお願いします。</p><p>執筆時点以降のクラウド サービスの動作変更に伴い、大幅な改変が必要となることがあります。</p><p>(本情報の執筆時点でテスト環境における検証作業は実施していますが、動作を保証するものではありません)</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>また、サンプルについてのサポート サービスの提供はしておりません。</p><p>恐れ入りますが、スクリプトを利用したことで生じる影響、スクリプトの改変や、スクリプトの動作に関するご質問については、 Azure 技術サポートにて受け付けることができない場合があります。</p><p>サンプル スクリプトが動作しない場合などは、 Github Issue やプル リクエストでのレポートをお願いいたします。</p></div><h2 id="事前準備-Microsoft-Graph-PowerShell-SDK-のインストール"><a href="#事前準備-Microsoft-Graph-PowerShell-SDK-のインストール" class="headerlink" title="事前準備: Microsoft Graph PowerShell SDK のインストール"></a>事前準備: Microsoft Graph PowerShell SDK のインストール</h2><p>PowerShell を使用する端末で、Microsoft Graph PowerShell SDK が未インストールの場合は、下記の手順を実施ください。</p><ol><li>Windows 端末上で PowerShell を管理者権限で起動します。</li><li>下記コマンドを実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> Microsoft.Graph</span><br></pre></td></tr></table></figure><p>インストールの前提事項などの詳細情報は下記公開情報に記載がございますので、ご入用に応じて参照ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/installation?view=graph-powershell-beta#installation">Install the Microsoft Graph PowerShell SDK</a></li></ul><h2 id="操作の開始-Azure-AD-への認証"><a href="#操作の開始-Azure-AD-への認証" class="headerlink" title="操作の開始: Azure AD への認証"></a>操作の開始: Azure AD への認証</h2><p>後述の手順を実施いただく前に、下記コマンドを実行のうえ、Azure AD テナントに接続ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> “Application.Read.All, User.Read.All”</span><br></pre></td></tr></table></figure><p>テナント接続時のサインイン画面では、以下のいずれかのロールを持つ管理者ユーザーの資格情報で認証を実施ください。</p><ul><li>クラウド アプリケーション管理者</li><li>アプリケーション管理者</li><li>グローバル閲覧者</li><li>グローバル管理者</li></ul><p>認証に成功すると、下記メッセージが表示されます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Welcome To Microsoft Graph!</span><br></pre></td></tr></table></figure><p>テナントに接続後に後述のスクリプトを実行し、各種証明書・シークレットの有効期限を CSV ファイル出力することができます。</p><h2 id="アプリの登録-から確認できるアプリケーションのクライアント-シークレットおよび証明書の有効期限の一括出力"><a href="#アプリの登録-から確認できるアプリケーションのクライアント-シークレットおよび証明書の有効期限の一括出力" class="headerlink" title="[アプリの登録] から確認できるアプリケーションのクライアント シークレットおよび証明書の有効期限の一括出力"></a>[アプリの登録] から確認できるアプリケーションのクライアント シークレットおよび証明書の有効期限の一括出力</h2><p>以下公開情報をもとに、[アプリの登録] から確認できるアプリケーションについての情報をエクスポートするサンプル スクリプトを案内いたします:<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/scripts/powershell-export-all-app-registrations-secrets-and-certs">アプリの登録用にシークレットと証明書をエクスポートする</a></p><p>処理順やエクスポートする項目については上記の公開情報となるべく同じにしております。</p><p>案内いたしますサンプルスクリプトでは以下の情報をエクスポートします:</p><ul><li>アプリケーションの表示名</li><li>アプリケーション ID</li><li>クライアント シークレットの有効期限の開始日時 (UTC)</li><li>クライアント シークレットの有効期限の終了日時 (UTC)</li><li>所有者</li><li>所有者のオブジェクト ID</li></ul><h3 id="サンプル-スクリプト-1"><a href="#サンプル-スクリプト-1" class="headerlink" title="サンプル スクリプト 1"></a>サンプル スクリプト 1</h3><p>[アプリの登録] の画面からはアプリケーション オブジェクトの確認ができます。<br>アプリケーション オブジェクトについての説明は本ブログでは割愛いたしますが、詳細を確認されたい方は下記公開情報をご確認ください:<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/app-objects-and-service-principals">Azure Active Directory のアプリケーション オブジェクトとサービス プリンシパル オブジェクト</a></p><p>Get-MgApplication コマンドを使用し、アプリケーション オブジェクトの一覧を取得します。<br>その後、アプリケーション オブジェクト内のプロパティを読み取っています。<br>アプリケーション オブジェクトのプロパティの一覧は下記公開情報にございます:<br><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/application?view=graph-rest-1.0#properties">アプリケーション リソースの種類</a></p><p>サンプル スクリプト 1 を実行すると、”Add the Path you’d like us to export the CSV file to, in the format of &lt;C:\Users&lt;USER&gt;\Desktop\Users.csv&gt;” と表示されますので、その後に、ファイルをエクスポートするパスを入力ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Applications</span> = <span class="built_in">Get-MgApplication</span> <span class="literal">-ExpandProperty</span> Owners <span class="literal">-All</span></span><br><span class="line"><span class="variable">$Logs</span> = <span class="selector-tag">@</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$app</span> <span class="keyword">in</span> <span class="variable">$Applications</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable">$AppName</span> = <span class="variable">$app</span>.DisplayName</span><br><span class="line">  <span class="variable">$ApplID</span> = <span class="variable">$app</span>.AppId</span><br><span class="line">  <span class="variable">$AppCreds</span> = <span class="variable">$app</span> | <span class="built_in">Select-Object</span> PasswordCredentials, KeyCredentials</span><br><span class="line">  <span class="variable">$secret</span> = <span class="variable">$AppCreds</span>.PasswordCredentials</span><br><span class="line">  <span class="variable">$cert</span> = <span class="variable">$AppCreds</span>.KeyCredentials</span><br><span class="line"></span><br><span class="line">  <span class="variable">$UserIDs</span> = <span class="selector-tag">@</span>()</span><br><span class="line">  <span class="variable">$Owners</span> = <span class="selector-tag">@</span>()</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$Owner</span> <span class="keyword">in</span> <span class="variable">$app</span>.Owners)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;@odata.type&quot;</span>] <span class="operator">-eq</span> <span class="string">&quot;#microsoft.graph.servicePrincipal&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable">$Owners</span> += <span class="selector-tag">@</span>&#123;ID = <span class="variable">$Owner</span>.Id; Name = <span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;appDisplayName&quot;</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;@odata.type&quot;</span>] <span class="operator">-eq</span> <span class="string">&quot;#microsoft.graph.user&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable">$UserIDs</span> += <span class="variable">$Owner</span>.Id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$OwnerName</span> = <span class="string">&quot;&lt;&lt;No Owner&gt;&gt;&quot;</span></span><br><span class="line">  <span class="variable">$OwnerID</span> = <span class="string">&quot;&lt;&lt;No Owner&gt;&gt;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$UserIDs</span>.Count <span class="operator">-ne</span> <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$UserFilter</span> = <span class="string">&quot;id in (&#x27;<span class="variable">$</span>(<span class="variable">$UserIDs</span> -join &quot;</span><span class="string">&#x27;,&#x27;</span><span class="string">&quot;)&#x27;)&quot;</span></span><br><span class="line">    <span class="comment"># e.g) id in (&#x27;xxxx&#x27;, &#x27;yyyy&#x27;)</span></span><br><span class="line">    <span class="built_in">Get-MgUser</span> <span class="literal">-Filter</span> <span class="variable">$UserFilter</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">      <span class="variable">$Owners</span> += <span class="selector-tag">@</span>&#123;</span><br><span class="line">        ID = <span class="variable">$_</span>.Id;</span><br><span class="line">        Name = <span class="variable">$_</span>.UserPrincipalName</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$OwnerName</span> = <span class="variable">$Owners</span>.Name <span class="operator">-join</span> <span class="string">&quot;;&quot;</span></span><br><span class="line">    <span class="variable">$OwnerID</span> = <span class="variable">$Owners</span>.ID <span class="operator">-join</span> <span class="string">&quot;;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$s</span> <span class="keyword">in</span> <span class="variable">$secret</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$StartDate</span> = <span class="variable">$s</span>.StartDateTime</span><br><span class="line">    <span class="variable">$EndDate</span> = <span class="variable">$s</span>.EndDateTime</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$StartDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$EndDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$c</span> <span class="keyword">in</span> <span class="variable">$cert</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$CStartDate</span> = <span class="variable">$c</span>.StartDateTime</span><br><span class="line">    <span class="variable">$CEndDate</span> = <span class="variable">$c</span>.EndDateTime</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$CStartDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$CEndDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">&quot;Add the Path you&#x27;d like us to export the CSV file to&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">&quot;e.g &lt;C:\Users\&lt;USER&gt;\Desktop\Users.csv&gt;&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"><span class="variable">$Path</span> = <span class="built_in">Read-Host</span></span><br><span class="line"><span class="variable">$Logs</span> | <span class="built_in">Export-CSV</span> <span class="variable">$Path</span> <span class="literal">-NoTypeInformation</span> <span class="literal">-Encoding</span> UTF8</span><br></pre></td></tr></table></figure><h2 id="エンタープライズ-アプリケーション-から確認できる-SAML-アプリケーションのクライアント-シークレットおよび証明書の有効期限の一括出力"><a href="#エンタープライズ-アプリケーション-から確認できる-SAML-アプリケーションのクライアント-シークレットおよび証明書の有効期限の一括出力" class="headerlink" title="[エンタープライズ アプリケーション] から確認できる SAML アプリケーションのクライアント シークレットおよび証明書の有効期限の一括出力"></a>[エンタープライズ アプリケーション] から確認できる SAML アプリケーションのクライアント シークレットおよび証明書の有効期限の一括出力</h2><p>以下公開情報をもとに、SAML 署名証明書の有効期限の一覧を出力するサンプルスクリプトを案内いたします:<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/scripts/powershell-export-all-enterprise-apps-secrets-and-certs">エンタープライズ アプリのシークレットと証明書をエクスポートする</a></p><p>処理順やエクスポートする項目については上記の公開情報となるべく同じにしております。</p><p>案内いたしますサンプルスクリプトでは以下の情報をエクスポートします:</p><ul><li>アプリケーションの表示名</li><li>アプリケーション ID</li><li>アプリケーションの作成日時 (UTC)</li><li>証明書の有効期限の開始日時 (UTC)</li><li>証明書の有効期限の終了日時 (UTC)</li><li>所有者</li><li>所有者のオブジェクト ID</li></ul><h3 id="サンプル-スクリプト-2"><a href="#サンプル-スクリプト-2" class="headerlink" title="サンプル スクリプト 2"></a>サンプル スクリプト 2</h3><p>[エンタープライズ アプリケーション] の画面からはサービス プリンシパル オブジェクトの確認ができます。</p><p>Get-MgServicePrincipal コマンドをフィルターを付けて使用し、サービス プリンシパル オブジェクトの一覧の中から SAML ベースの SSO を構成済みのサービスプリンシパルだけを取得します。<br>サンプル スクリプト 2 内のコメントのとおり、2020 年初頭以降に作成されたアプリケーションでは PreferredSingleSignOnMode プロパティに値がセットされますが、それ以前に作成されたアプリケーションでは preferredSingleSignOnMode は null です。<br>2020 年初頭以前に作成された SAML ベースの SSO を構成済みのアプリケーションの一覧については貴社にて管理をお願いいたします。</p><p>その後、サービス プリンシパル オブジェクト内のプロパティを読み取っています。<br>サービス プリンシパル オブジェクトのプロパティの一覧は下記公開情報にございます:<br><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/serviceprincipal?view=graph-rest-1.0#properties">servicePrincipal リソースの種類</a></p><p>サンプル スクリプト 2 を実行すると、”Add the Path you’d like us to export the CSV file to, in the format of &lt;C:\Users&lt;USER&gt;\Desktop\Users.csv&gt;” と表示されますので、その後に、ファイルをエクスポートするパスを入力ください。</p><p>サンプル スクリプト 2 では、SAML ベースの SSO を構成されているアプリケーションを含め全てのアプリケーションを取得することもできます。<br>その場合にはサンプル スクリプト上部の以下箇所のコメントアウトを外してください:<br><code>#$EnterpriseApps = Get-MgServicePrincipal -ExpandProperty Owners -All</code></p><p>その後に以下箇所をコメントアウトしてください:<br><code>$EnterpriseApps = Get-MgServicePrincipal -ExpandProperty Owners -Filter &quot;preferredSingleSignOnMode eq &#39;saml&#39;&quot;</code></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># すべてのエンタープライズ アプリケーションを取得する場合は以下のコメントアウトを外してください。</span></span><br><span class="line"><span class="comment">#$EnterpriseApps = Get-MgServicePrincipal -ExpandProperty Owners -All</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SAML ベースのSSO を構成しているエンタープライズアプリケーションの一覧を取得</span></span><br><span class="line"><span class="variable">$EnterpriseApps</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-ExpandProperty</span> Owners <span class="literal">-Filter</span> <span class="string">&quot;preferredSingleSignOnMode eq &#x27;saml&#x27;&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ※注意事項</span></span><br><span class="line"><span class="comment"># 2020 年初頭 (1 ～ 3 月) 以降に作成されたアプリのみ</span></span><br><span class="line"><span class="comment"># SAML を構成した際に preferredSingleSignOnMode に 値がセットされる動作になりました。</span></span><br><span class="line"><span class="comment"># そのため、2020 年初頭以前に作成されたアプリでは、</span></span><br><span class="line"><span class="comment"># 現在、SAML を構成していても preferredSingleSignOnMode が null となっております。</span></span><br><span class="line"><span class="comment"># 2020 年初頭以前に作成されたアプリの場合、</span></span><br><span class="line"><span class="comment"># PowerShell や Graph API などで SAML を構成していると判別できる値を取得することができず、</span></span><br><span class="line"><span class="comment"># SAML を構成しているアプリ一覧として取得することが難しい状況となります。</span></span><br><span class="line"><span class="comment"># 将来的には、古いアプリにおいても新しいアプリと同様に</span></span><br><span class="line"><span class="comment"># 正しい preferredSingleSignOnMode が取得できるようになることが計画されていることを確認しましたが、</span></span><br><span class="line"><span class="comment"># 対応時期などは未定です</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Logs</span> = <span class="selector-tag">@</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$Eapp</span> <span class="keyword">in</span> <span class="variable">$EnterpriseApps</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable">$AppName</span> = <span class="variable">$Eapp</span>.DisplayName</span><br><span class="line">  <span class="variable">$ApplID</span> = <span class="variable">$Eapp</span>.AppId</span><br><span class="line">  <span class="variable">$CreatedDate</span> = <span class="variable">$Eapp</span>.AdditionalProperties.createdDateTime</span><br><span class="line"></span><br><span class="line">  <span class="variable">$AppCreds</span> = <span class="variable">$Eapp</span> | <span class="built_in">Select-Object</span> PasswordCredentials, KeyCredentials</span><br><span class="line"></span><br><span class="line">  <span class="variable">$UserIDs</span> = <span class="selector-tag">@</span>()</span><br><span class="line">  <span class="variable">$Owners</span> = <span class="selector-tag">@</span>()</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$Owner</span> <span class="keyword">in</span> <span class="variable">$Eapp</span>.Owners)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;@odata.type&quot;</span>] <span class="operator">-eq</span> <span class="string">&quot;#microsoft.graph.servicePrincipal&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable">$Owners</span> += <span class="selector-tag">@</span>&#123;ID = <span class="variable">$Owner</span>.Id; Name = <span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;appDisplayName&quot;</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$Owner</span>.AdditionalProperties[<span class="string">&quot;@odata.type&quot;</span>] <span class="operator">-eq</span> <span class="string">&quot;#microsoft.graph.user&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable">$UserIDs</span> += <span class="variable">$Owner</span>.Id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$OwnerName</span> = <span class="string">&quot;&lt;&lt;No Owner&gt;&gt;&quot;</span></span><br><span class="line">  <span class="variable">$OwnerID</span> = <span class="string">&quot;&lt;&lt;No Owner&gt;&gt;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$UserIDs</span>.Count <span class="operator">-ne</span> <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$UserFilter</span> = <span class="string">&quot;id in (&#x27;<span class="variable">$</span>(<span class="variable">$UserIDs</span> -join &quot;</span><span class="string">&#x27;,&#x27;</span><span class="string">&quot;)&#x27;)&quot;</span></span><br><span class="line">    <span class="comment"># e.g) id in (&#x27;xxxx&#x27;, &#x27;yyyy&#x27;)</span></span><br><span class="line">    <span class="built_in">Get-MgUser</span> <span class="literal">-Filter</span> <span class="variable">$UserFilter</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">      <span class="variable">$Owners</span> += <span class="selector-tag">@</span>&#123;</span><br><span class="line">        ID = <span class="variable">$_</span>.Id;</span><br><span class="line">        Name = <span class="variable">$_</span>.UserPrincipalName</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$OwnerName</span> = <span class="variable">$Owners</span>.Name <span class="operator">-join</span> <span class="string">&quot;;&quot;</span></span><br><span class="line">    <span class="variable">$OwnerID</span> = <span class="variable">$Owners</span>.ID <span class="operator">-join</span> <span class="string">&quot;;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$secret</span> = <span class="variable">$AppCreds</span>.PasswordCredentials</span><br><span class="line">  <span class="variable">$cert</span> = <span class="variable">$AppCreds</span>.KeyCredentials</span><br><span class="line"></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">  <span class="comment">#$Log | Add-Member -MemberType NoteProperty -Name &quot;Created Date&quot; -Value $CreatedDate</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">  <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$s</span> <span class="keyword">in</span> <span class="variable">$secret</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$StartDate</span> = <span class="variable">$s</span>.StartDateTime</span><br><span class="line">    <span class="variable">$EndDate</span> = <span class="variable">$s</span>.EndDateTime</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Created Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$CreatedDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$StartDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Secret End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$EndDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$Null</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$Null</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$c</span> <span class="keyword">in</span> <span class="variable">$cert</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$CStartDate</span> = <span class="variable">$c</span>.StartDateTime</span><br><span class="line">    <span class="variable">$CEndDate</span> = <span class="variable">$c</span>.EndDateTime</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> = <span class="built_in">New-Object</span> System.Object</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationName&quot;</span> <span class="literal">-Value</span> <span class="variable">$AppName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;ApplicationID&quot;</span> <span class="literal">-Value</span> <span class="variable">$ApplID</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Created Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$CreatedDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate Start Date&quot;</span> <span class="literal">-Value</span> <span class="variable">$CStartDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Certificate End Date&quot;</span> <span class="literal">-value</span> <span class="variable">$CEndDate</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner&quot;</span> <span class="literal">-Value</span> <span class="variable">$OwnerName</span></span><br><span class="line">    <span class="variable">$Log</span> | <span class="built_in">Add-Member</span> <span class="literal">-MemberType</span> NoteProperty <span class="literal">-Name</span> <span class="string">&quot;Owner_ObjectID&quot;</span> <span class="literal">-value</span> <span class="variable">$OwnerID</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$Logs</span> += <span class="variable">$Log</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">&quot;Add the Path you&#x27;d like us to export the CSV file to&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">&quot;e.g &lt;C:\Users\&lt;USER&gt;\Desktop\Users.csv&gt;&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"><span class="variable">$Path</span> = <span class="built_in">Read-Host</span></span><br><span class="line"><span class="variable">$Logs</span> | <span class="built_in">Export-CSV</span> <span class="variable">$Path</span> <span class="literal">-NoTypeInformation</span> <span class="literal">-Encoding</span> UTF8</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上です。<br>上記内容が少しでも皆様の参考となりますと幸いです。ご不明な点がございましたら、弊社サポートまでお気軽にお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの栗井です。&lt;/p&gt;
&lt;p&gt;Azure AD の [アプリの登録] から各アプリに連携している証明書・クライアント シークレット、ならびに [エンタープライズ アプリケーション] で SAML SSO を構成いただいている場合</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Application" scheme="https://jpazureid.github.io/blog/tags/Application/"/>
    
  </entry>
  
  <entry>
    <title>偽の ID (識別子) のアンチパターン</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/the-false-identifier-anti-pattern/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/the-false-identifier-anti-pattern/</id>
    <published>2023-07-02T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.479Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 6 月 20 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/the-false-identifier-anti-pattern/ba-p/3846013">The False Identifier Anti-pattern</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>本日は、ID の世界における危険なアンチパターンである <strong>偽の ID (識別子) のアンチパターン</strong> を取り上げます。<a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">アンチパターン</a> とは、繰り返し発生する問題に対する一般的な対応策のことで、こういった問題は多くが悪い結果をもたらし、想定と反対の結果をもたらすリスクとなるものです。<a href="https://adactio.com/journal/1357/">パスワードのアンチパターン</a> も聞いたことがあるかもしれません。本日お話しする内容は、もしかしたらより危険なパターンかもしれません。</p><p><strong>偽の ID (識別子) のアンチパターン</strong> は、シングル サインオン時に、アプリケーションまたはサービスが連携 ID プロバイダから受け取るアサーションにおいて、その subject 以外の属性が “一意で持続性があり、信頼できるアカウント識別子である” と想定した際に発生します。</p><p><a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/id-token-claims-reference">OpenID Connect の id_token</a> や <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/reference-saml-tokens">SAML 2.0 のアサーション</a> などの構造化されたセキュリティ ドキュメントには、電話番号やソーシャル メディアのハンドル名、電子メール アドレスなどのユーザー データが含まれることがあります。これらユーザー情報の詳細は、(電子メールの送信や電話の発信など) 一部のシナリオで一意の識別子として使用され、場合によってはログインの識別子としても使用されます。しかし、”連絡やコラボレーションを目的とした情報属性としてこれら識別子を使用すること” と、”フェデレーションの一連の流れの中でトークンの一部から一意性の保証がない値をピックアップし、その値を一意性のある識別子として使用して認可やデータ アクセスに使用すること” には、決定的な違いがあります。</p><h2 id="OpenID-Connect-でエンド-ユーザーの識別に-subject-以外のクレームを使用することは標準に非準拠である"><a href="#OpenID-Connect-でエンド-ユーザーの識別に-subject-以外のクレームを使用することは標準に非準拠である" class="headerlink" title="OpenID Connect でエンド ユーザーの識別に subject 以外のクレームを使用することは標準に非準拠である"></a>OpenID Connect でエンド ユーザーの識別に subject 以外のクレームを使用することは標準に非準拠である</h2><p>OpenID Connect 1.0 の著者らは、仕様が設計された 10 年前にこのアンチパターンを認識していました。仕様には、すべての Relying Party (SSO のトランザクションから ID 情報を取得するアプリケーションやサービス) が、アカウント キーとして常に sub 属性を使用するべきであるという記載があります。<a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken">OpenID Connect core specification セクション 2</a> (<a href="http://openid-foundation-japan.github.io/openid-connect-core-1_0.ja.html#IDToken">日本語</a>) では、sub を次のように定義しています:</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/sub_ja.png"></p><p>加えて、<a href="https://openid.net/specs/openid-connect-core-1_0.html#ClaimStability">OpenID Connect の仕様 セクション 5.7</a> (<a href="http://openid-foundation-japan.github.io/openid-connect-core-1_0.ja.html#ClaimStability">日本語</a>) では明示的に以下のように述べています。</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/claimstability_ja.png"></p><p>OpenID Connect の Relying Party が、トークンに含まれる sub (subject) クレームと発行者 (isser) クレームの組み合わせ以外を OpenID Connect のアカウント識別子として使用すると、連携 ID プロバイダと Relying Party の間で <strong>標準への非準拠</strong> が生じ、仕様に準拠しない動作となるため、潜在的にユーザーにリスクを負わせることになります。もしあなたが Relying Party 側で標準への準拠を担当しているのであれば、やるべきことは一つです。</p><p>OpenID Connect の仕様における明確な要件を確認しておくことは非常に重要です。トークンのペイロードに含まれる一般的なクレームを一意なアカウント識別子として使用してしまうとが、なぜこれほど問題になるのでしょうか？セクション 5.7 の文章に、必要なヒントがすべて示されています。</p><h2 id="ローカルでの一意な識別子"><a href="#ローカルでの一意な識別子" class="headerlink" title="ローカルでの一意な識別子"></a>ローカルでの一意な識別子</h2><p>識別子がローカルで一意である場合、ID プロバイダーはドメイン内のユーザー間で値が重複しないように検出し、重複を防止します。ローカルでの一意性が強制されていれば、シングル サインオン (SSO) 時に 2 つの異なる ID プロバイダーのアカウントが同じ文字列で表されることはありません。しかし、現在の ID 基盤では、ユーザーが複数の組織や企業、学校などのコミュニティに属している場合があり、それらのコミュニティが重複または反復する通信チャネルを保持している可能性は十分にあります。</p><p>テスト用アカウントと本番用アカウントを持っている社員は、両方のアカウントで同じ電話番号を設定するかもしれません。また、非従業員が企業間コラボレーションのために招待されたゲスト アカウントと顧客アカウントを持ち (ID プロバイダの小売サービスを使用するため)、両方とも同じ電子メール アドレスを使用する場合もあります。これらの例では、電子メールと電話番号はローカルで一意ではなく、アカウントを区別するには不十分です。しかし、トークンに含めるペイロードとしては許容されます。これは、これら属性がトークン内で一意性の要件を持たないペイロードの一部であり、トークンの Subject (一意性の要件がある) に関する追加情報を提供するためのものだからです。</p><h2 id="単一の発行者内で再割り当てを行わない"><a href="#単一の発行者内で再割り当てを行わない" class="headerlink" title="単一の発行者内で再割り当てを行わない"></a>単一の発行者内で再割り当てを行わない</h2><p>セクション 5.7 の 2 つ目の節は、属性のライフサイクルに言及しています。電子メール アドレスおよび電話番号とユーザーとの紐づけが解かれるタイミングとしては様々なものがあり得ます。問題はその次に何が起こるかです。識別子が 2 つの異なるタイミングで 2 つの異なるユーザに割り当てられると、後に割り当てられたユーザーが、その前に割り当てられていたユーザーの権限とデータを得てしまうリスクがあります。</p><p>例えば、ある組織が Fred Smith という人を雇い、<a href="mailto:&#x66;&#x73;&#x6d;&#x69;&#x74;&#x68;&#x40;&#x63;&#x6f;&#109;&#x70;&#97;&#x6e;&#x79;&#46;&#x63;&#x6f;&#x6d;">&#x66;&#x73;&#x6d;&#x69;&#x74;&#x68;&#x40;&#x63;&#x6f;&#109;&#x70;&#97;&#x6e;&#x79;&#46;&#x63;&#x6f;&#x6d;</a> という電子メール アドレスを割り当てたとします。Fred がやがて退職し、Frida Smith が採用され、同じ電子メール アドレスが割り当てられました。この時、例え電子メール アドレスが同じでも、トークンの Subject は Fred と Frida で異なる値である必要があります。これにより、Frida が Fred のデータにアクセスする可能性を防ぐことができます。</p><h2 id="時間が経過した際の安定性"><a href="#時間が経過した際の安定性" class="headerlink" title="時間が経過した際の安定性"></a>時間が経過した際の安定性</h2><p>企業の合併や買収のような事が生じた際に、社外のゲストやパートナーで連絡先情報の変更が生じる可能性についても考慮が必要です。例えば A 社が B 社を買収した場合には、社員の連絡先情報 (電子メール アドレスなど) を変更する必要が生じますが、同時にユーザーが引き続き SSO 可能とすることが重要です。トークンの Subject は、社名の変更、企業の移行、新しい市外局番へのオフィスの移転、その他のイベントが生じても影響を受けないだけの安定性が必要となります。</p><h2 id="現実世界での例"><a href="#現実世界での例" class="headerlink" title="現実世界での例"></a>現実世界での例</h2><p>実例を見ていきましょう。Frida という会計士がいるとします。この人は Company3 という企業で働き、Company1 と Company2 という企業にサービスを提供しています (Company2 では 2 つの部門で働いている)。Frida の専門は RP.com という SaaS の会計アプリケーションで、彼女は一日中そのアプリケーションで様々な顧客のために業務を行っています。Frida が持っている電子メール アドレスは 1 つだけで、これは雇用主である Company3 から得たものです。彼女が 4 つの ID プロバイダーのアカウントにサインインし、RP.com に SSO しようとするとどうなるでしょうか？</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/loginfigure1.png" alt="Frida は 3 つの会社において、4 つの異なるアカウントに 1 つの電子メール アドレスを使ってサインインします。トークンの Subject のマッピングはどのようになるべきでしょうか？"></p><h3 id="可能性-1-RP-com-で偽の識別子のアンチパターンを回避した場合"><a href="#可能性-1-RP-com-で偽の識別子のアンチパターンを回避した場合" class="headerlink" title="可能性 1: RP.com で偽の識別子のアンチパターンを回避した場合"></a>可能性 1: RP.com で偽の識別子のアンチパターンを回避した場合</h3><p>RP.com が OpenID Connect の仕様に準拠していれば、Frida は問題なく各アカウントにサインインし、関連するデータを参照したり、適切なユーザーとやりとりしたり出来るでしょう。RP.com は適切なユーザーを適切なセキュリティ コンテキストで処理することになります。</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/loginfigure2.png" alt="Frida の 4 つの IdP 上のアカウントが 4 つの Relying Party のアカウントに安全にマッピングされました。"></p><h3 id="可能性-2-RP-com-が偽の識別子のアンチパターンに陥った場合"><a href="#可能性-2-RP-com-が偽の識別子のアンチパターンに陥った場合" class="headerlink" title="可能性 2: RP.com が偽の識別子のアンチパターンに陥った場合"></a>可能性 2: RP.com が偽の識別子のアンチパターンに陥った場合</h3><p>RP.com が電子メール アドレスを安定的な識別子として利用するというアンチパターンにハマってしまった場合、以下のようなことが起こりえます。</p><p>まず 1 つ目は、単一のテナント内でのアカウントの混同です。この場合、ID プロバイダーは RP.com に対し、同じ電子メール アドレスをもつトークンを 2 つの異なるアカウント用のものとして送信することになります。RP.com が Subject を使用していない場合、Frida に (そして彼女の雇用主にも) 面倒な事態が生じます。RP.com は 2 つの異なるアカウントを表すトークンを 1 つのアカウントを表すものと見なしてしまうため、認証プロセスが不安定になり、Frida の業務遂行が困難となる可能性があります。その結果、ユーザーのセッションにおいて Frida の 2 つのアカウントのうち、1 つにしかアクセスできなくなったり、2 つの RP.com アカウント間でバックエンドのデータが不安定に上書きされたりする可能性もあります。仮に Frida が 1 つ目は通常業務用、2 つ目は重要な調査用という目的で Company2 に 2 つのアカウントを持っていた場合、2 つのアカウントが混同されることで、重要なデータが通常のデータと混同され、不適切に処理されてしまう可能性もあります。</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/loginfigure3.png" alt="Frida の 4 つの IdP 上のアカウントが、誤ってマッピングされてしまうというよくないパターンです。"></p><h3 id="可能性-3-RP-com-が偽の識別子のアンチパターンの最悪のシナリオに陥った場合"><a href="#可能性-3-RP-com-が偽の識別子のアンチパターンの最悪のシナリオに陥った場合" class="headerlink" title="可能性 3: RP.com が偽の識別子のアンチパターンの最悪のシナリオに陥った場合"></a>可能性 3: RP.com が偽の識別子のアンチパターンの最悪のシナリオに陥った場合</h3><p>RP.com が偽の識別子の最悪なアンチパターンにハマってしまった場合、RP.com が識別子を作成する際に、複数の Relying Party テナント間で電子メール アドレスのみを参照するという最悪なシナリオに陥る可能性もあります。この場合、4 つの異なるユーザー アカウントを表す 4 つの異なるトークンが、同じ文字列として RP.com で 1 つのものとして識別されることになります。</p><p>4 つのアカウントのどれがどのような状況でアクセスされるかは、Relying Party 側がサービスをどのように設計しているかによってきます。Frida がどの IdP のアカウントでサインインしても、常に RP 側の 1 つのアカウントつにしかアクセスできなくなるという可能性もあります。Cookie を発行するテナント固有のスタート ページがある場合もありますし、各テナントに独自のサブドメインがある可能性もありますので、その場合はそれら入り口から各サービスに適切にサインインできるかもしれません。</p><p>最悪のシナリオがより一層悪化するのは、どのテナントのセッションがロードされるかを決定するメカニズムが外部から操作できる場合です。Frida 自身は、あるアカウントと別のアカウントが混同され “なりすまし状態” になることは考えもしないと思いますが、攻撃者はそういったことを考えるでしょう。攻撃者が自分のテナントを登録し、SSO で接続し、Frida の電子メール アドレスを指定することができれば、Frida が RP.com でやり取りする 3 つの会社すべてを危険にさらす事も可能です。</p><p><img src="/blog/azure-active-directory/the-false-identifier-anti-pattern/loginfigure4.png" alt="Frida の 4 つの IdP 上のアカウントが、テナント内でもテナント間でも誤ってマッピングされるという最悪の例です"></p><h2 id="SAML-における偽の識別子"><a href="#SAML-における偽の識別子" class="headerlink" title="SAML における偽の識別子"></a>SAML における偽の識別子</h2><p>OpenID Connect の話題ばかりなので、SAML (Security Assertion Markup Language) の場合はどうだろうかとお考えの方もいると思います。アンチパターンはどちらのプロトコルでも同じですが、SAML の仕様にも、業界がクロス ドメイン識別子に関して学んだ数々の教訓が込められています。SAML の実装がまだ問題になる場合もあるものの、実装の詳細によってニュアンスが異なってきます:</p><ul><li>SAML 仕様は複雑であるため、Relying Party が独自の実装を展開するのは困難です。Relying Party が ID 属性を誤ってマッピングする可能性はありますが、SAML アサーションを検証するライブラリやツールが十分に成熟していることが多く、可能な限りリスクは軽減されています。</li><li>SAML 仕様では、電子メール アドレスが有効かつ一般的に使用されるトークンの Subject です。しかし、SAML の一般的な利用シナリオは、組織が電子メールを「所有」し一意性を強制するという、制限の強い業務用のケースです。一方で、この制限の強いパラダイムは、BYOI (Bring Your Own Identity) および B2B の連携のユースケースによって崩れつつあるため、Relying Party だけでなく ID プロバイダーにとってもリスクが増しているという現状があります。</li><li>SAML 仕様には、OAuth ベースの OpenID Connect が使用するエンドユーザーの同意フローに相当するようなものが実装されていません。これは、管理者が許可すれば、エンドユーザがアプリにアクセスする際に、その利用に同意できるというものです (Azure AD では <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/user-admin-consent-overview">ユーザーと管理者の同意</a> 機能によって管理される)。</li></ul><p>このアンチパターンの認識と対策については、先進的な組織や企業が既に取り組んでいます。<a href="https://docs.oasis-open.org/security/saml-subject-id-attr/v1.0/cs01/saml-subject-id-attr-v1.0-cs01.html#_Toc536097222">SAML V2.0 Subject Identifier Attributes Profile Version 1.0</a> のセクション 2.1 では、2019 年に次のように述べています: “セキュリティ プロトコルとアプリケーションにおける認証対象 (subject) の識別においては、様々な問題が生じた歴史があります。それは表現の不備や、不具合の混入、電子メール アドレスの誤用や特定の市場のみを考慮したアプローチ、意図した意味や制約が正確に伝わらないといったものです。</p><p>SAML と OpenID Connect のどちらの ID プロバイダーも、偽の識別子のアンチパターンのリスクにさらされる可能性がありますが、OpenID Connect の仕様策定者の功績により、仕様に準拠した認定済みの ID プロバイダーは十分に保護されているといえます。</p><p>トークンの対象者を表す識別子 (Subject) は、ライブラリまたはクラウド基盤のレベルで生成されることが多く、通常は管理者がデータストアから接続ごとに個別にマッピングするような情報ではありません。もし SAML ID プロバイダーの管理者が、SAML アサーションにおいて電子メール アドレスを対象ユーザーの識別子として使用し、さらには対象の Relying Party に対して認可されたユーザーが、ローカルで一意であることが保証されず、再割り当てされないことも保証されず、長期間にわたって不変であることも保証されない電子メール アドレスを持っていたとすると、その組織は偽の識別子のアンチパターンの餌食となり、危険なリスクを負うことになります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>世の中にある Relying Party に対するメッセージはシンプルで、<strong>連携アカウントを識別する際には、常にトークンの Subject と発行者 (Issuer) を一緒に使用してプライマリ キーを形成する</strong> ということです。</p><p>ID プロバイダーに対するメッセージも同様で: <strong>SSO のために生成されるトークンの Subject は、常にローカルで一意であり、決して再割り当てされず、長期にわたって安定していることを保証する</strong> ことです。</p><p>これら 2 つのルールに従うことで、アンチパターンを回避し、すべてのユーザーを適切かつ安全にマッピングください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 6 月 20 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限 v2 がパブリック プレビューになりました</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/</id>
    <published>2023-07-01T23:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.475Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 5 月 25 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/tenant-restriction-v2-is-now-public-preview/ba-p/3094113">Tenant Restriction v2 is now Public Preview!</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>みなさま、こんにちは。</p><p>この度、当社の商用クラウドにおいて、テナント制限 v2 (TRv2) のパブリック プレビューを開始することになりましたことをお知らせいたします！</p><p>TRv2 の利用により、データ流出リスクを抑えつつ、安全で生産的な企業間コラボレーションを実現することができます。テナント制限の設定では、外部で発行された ID を使用して、ユーザーが自社のデバイスやネットワークからアクセスできる外部テナントを制御し、組織、ユーザー、グループ、アプリケーション単位できめ細かいアクセス制御を提供することができます。</p><p>テナント制限は、以前リリースされた <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/collaborate-more-securely-with-new-cross-tenant-access-settings/ba-p/2147077">外部コラボレーション用のクロステナント アクセス設定</a> (日本語訳したブログは <a href="./azure-active-directory/collaborate-more-securely-with-new-cross-tenant-access-settings/">こちら</a>) に待望の拡張を加えたものです。これらを組み合わせることで、企業間のセキュリティとコラボレーション ポリシーを最も細かく制御することができます。</p><p>TRv2 への対応については、Microsoft Entra のプロダクト マネージャーである Vimala Ranganathan を招き、詳細を説明いたします。</p><p>よろしくお願いいたします。</p><p>Robin Goldstein (Twitter: <a href="https://twitter.com/RobinGo_MS">@RobinGo_MS</a>)<br>Partner Director of Product Management<br>Microsoft Identity Division</p><hr><p>みなさま、こんにちは。</p><p>今回は私 Vimala がテナント制限 v2 (TRv2) について説明いたします。</p><p>弊社では、M365 クラウド サービスに移行するお客様、特に組織の境界を越えてコラボレーションする必要があるお客様にとって、データの流出が大きな懸念事項であると伺っています。TRv2 はこのような懸念に対応するもので、トークンの悪用による侵入や、外部の SharePoint Online のデータへの匿名アクセス、外部の Teams 会議への匿名参加などによる情報漏えいを防ぎ、安全な外部コラボレーションを実現します。</p><p>現行のテナント制限はオンプレミスのプロキシ サーバーを使用しており、Azure Active Directory (Azure AD) によるクラウド認証時にのみ強制されていましたが、TRv2 はこれを改良しています。テナント制限 v2 を使用することで、外部組織から発行されたアカウントや未知のテナントで作成されたアカウントなどを含め、外部で発行された ID を使用してユーザーがネットワークやデバイスから外部アプリケーションにアクセスできるかどうかを管理者が制御できるようになります。</p><p>TRv2 はクラウド側のポリシーを使用し、認証とデータ プレーン保護の両方を提供します。ユーザー認証時に加え、Exchange Online、SharePoint Online、Teams、MS Graph などデータ プレーンへのアクセス時にもポリシーを適用することができます。</p><h2 id="テナント制限-V2-TRv2"><a href="#テナント制限-V2-TRv2" class="headerlink" title="テナント制限 V2 (TRv2)"></a>テナント制限 V2 (TRv2)</h2><p>TRv1 とは異なり、TRv2 では組織が所有するデバイス上および組織のネットワーク上で、外部発行の ID を使用してユーザーがどの外部テナントにアクセスできるかをテナント管理者が制御することができます。</p><p>例えば、Alice は Contoso 社の社員で、Fabrikam 社とコンサルティング業務を行っているとします。Fabrikam 社は Alice が Fabrikam 社のリソースにアクセスするために、ユーザー アカウントを発行します。Alice は Contoso 社のネットワークで Contoso 社が発行したデバイスを使用しながら、Fabrikam 社のリソースにアクセスする必要があります。Contoso 社の管理者である Cathy は、Alice の Fabrikam 社のアカウントへのアクセスを可能にする以外は、自身の組織のデバイスからの他のすべての外部 ID を使用したアクセスをブロックすることによって、データ流出のリスクを抑制したいと考えています。TRv2 の機能により、Alice は Contoso 社の完全な管理下にありながら、組織の境界を越えて活動することができます。</p><h2 id="テナント制限-v2-TRv2-のメリット"><a href="#テナント制限-v2-TRv2-のメリット" class="headerlink" title="テナント制限 v2 (TRv2) のメリット"></a>テナント制限 v2 (TRv2) のメリット</h2><p>TRv2 は以下の機能を提供します:</p><ul><li>すべての外部テナントに適用される既定のポリシー設定。</li><li>外部テナントに対する連携組織ごとのコラボレーション ポリシーの作成。</li><li>外部で発行されたユーザー ID が他の組織にアクセスする方法の制御。</li><li>特定の組織の特定のユーザーとグループのみにアクセス許可を制限。</li><li>ユーザーが外部組織で発行された ID を使用してアクセスできるようにしたい外部組織のすべてのアプリまたは特定のアプリの指定。</li><li>許可されていないテナントの認証リクエストを Azure AD でブロック - <strong>認証プレーンの保護</strong>。</li><li>MS クラウド サービスではリソース アクセスにテナント制限のポリシーを強制 - トークンの悪用による侵入を防止 <strong>データ プレーンの保護</strong>。</li><li>Teams 会議への <strong>匿名アクセスをブロックし</strong>、匿名で共有されたリソース (リンクがあればだれでもアクセスできる) へのアクセスをブロック。</li><li>Exchange Online の基本認証が許可されている場合でも、外部テナントへのアクセスをブロック。</li><li>Azure Active Directory (AAD) への通信を許可するのに社内プロキシに許可テナントを追加する工数が不要。</li><li>クラウド ポリシーを設定するためにポータル UX をサポート。</li></ul><h2 id="テナント制限ポリシーの設定"><a href="#テナント制限ポリシーの設定" class="headerlink" title="テナント制限ポリシーの設定"></a>テナント制限ポリシーの設定</h2><ol><li><p>既定の TRv2 ポリシーを設定:</p><p> Contoso 社は、ユーザーが Contoso 社のネットワークとデバイスを使用しながら、パートナーと連携する方法を制限したいとします。Contoso 社の管理者 Cathy は、まずすべての連携先テナントに適用される既定のポリシーを設定します。既定のポリシーでは、管理者はすべての外部テナント、およびすべての外部ユーザーとグループへのアクセスをブロックします。</p><p> <img src="/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/tenant-restriction-v2-is-now-public-preview1.png" alt="既定の TRv2 ポリシーの設定画面"></p></li><li><p>テナント固有の TRv2 ポリシーを設定:</p><p> Contoso 社の管理者である Cathy は、Fabrikam 社用のポリシーを設定し、Alice のみが Fabrikam 社の ID を使用して Office 365 などの特定のアプリケーションにアクセスすることを許可します。</p><p> <img src="/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/tenant-restriction-v2-is-now-public-preview2.png" alt="テナント固有の TRv2 ポリシーの設定画面"></p></li><li><p>デバイスにてクライアント側の TRv2 を有効化:</p></li></ol><p>テナント管理者である Cathy は Windows の GPO の詳細画面で、TRv2 クラウド ポリシーのテナント ID とポリシー ID を設定します。これにより、Contoso 社の全デバイスから、Microsoft への送信リクエストに対し、OS が TRv2 ポリシーへの参照を挿入するようになります。</p><p><img src="/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/tenant-restriction-v2-is-now-public-preview3.png" alt="Windows GPO のポリシー設定画面"></p><p>上記の設定により、Contoso 社の管理者は、Contoso 社のデバイスやネットワークから外部 ID を使用した外部テナントへのアクセスをすべてブロックし、加えて Fabrikam 社に対する固有のポリシーにより、Alice にのみ Alice の Fabrikam 社の ID を使用して Fabrikam 社の Office 365 アプリケーションへアクセスすることを許可できました。</p><h2 id="だれが自社のデバイスやネットワークから外部組織のリソースにアクセスしているかを把握する"><a href="#だれが自社のデバイスやネットワークから外部組織のリソースにアクセスしているかを把握する" class="headerlink" title="だれが自社のデバイスやネットワークから外部組織のリソースにアクセスしているかを把握する"></a>だれが自社のデバイスやネットワークから外部組織のリソースにアクセスしているかを把握する</h2><p>サインイン ログから、Contoso 社の管理者は Contoso 社のユーザーがどの外部テナントを使って外部組織にアクセスし、ブロックされているかを確認することができます。</p><p><img src="/blog/azure-active-directory/tenant-restriction-v2-is-now-public-preview/tenant-restriction-v2-is-now-public-preview4.png" alt="テナント制限でブロックされた場合のサインイン ログ"></p><p>クロステナント アクセス設定にあるテナント制限 v2 の詳細については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/tenant-restrictions-v2#step-3-enable-tenant-restrictions-on-windows-managed-devices">ドキュメント</a> をお読みください。</p><p>ありがとうございました。</p><p>Vimala</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 5 月 25 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect Sync Configuration Documenter 使用方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/</id>
    <published>2023-06-29T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.567Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの小出です。</p><p>今回は、 Azure AD Connect Sync Configuration Documenter 使用方法をご案内します。<br><a href="/blog/master/README/">こちら</a> に記載されている手順の解説となります。</p><p>本ツールは 2 台の Azure AD Connect サーバーの設定をレポート上で差分比較する際に利用するツールとなります。</p><p>本ブログでは出力されたレポートについて、具体的にどのような観点を確認すべきかを追記しておりますので、参考となれば幸いです。  </p><h2 id="Azure-AD-Connect-Sync-Configuration-Documenter-とは"><a href="#Azure-AD-Connect-Sync-Configuration-Documenter-とは" class="headerlink" title="Azure AD Connect Sync Configuration Documenter とは"></a>Azure AD Connect Sync Configuration Documenter とは</h2><p>2 台の Azure AD Connect の設定内容や同期ルールを比較するためのツールです。<br>各 Azure AD Connect にて設定情報を XML ファイルとしてエクスポートし、HTML レポート ファイルで比較情報を表示することができます。</p><p>同じバージョンで 2 台目以降の Azure AD Connect サーバーをステージングモードとして構築した際に両者の設定に差分がないかをレポートとして確認することが可能です。</p><p>特に、2 台目以降の Azure AD Connect サーバーを手動でインストールした場合は手作業によるミスを発見することに役立ちますので是非ご活用ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>・このツールは 2 台の Azure AD Connect の設定値を比較するものとなりますため、サーバー名や次回同期の時刻など、必ず差異が発生する項目がありますのでご留意ください。</p><p>・ 2 台の Azure AD Connect サーバーが異なるバージョンで動作している場合も差分をレポート出力することは可能ですが、バージョンが異なる場合は差分項目が非常に多くなります。可能であれば同一バージョンの設定を比較することご検討いただけますと幸いです。</p><p>・ このツールを使用して取得した設定値について、それぞれの項目がどのようなものであるかを網羅的にご案内したり、出力された結果について影響がないかの判断をしたりするご支援は、現在弊社サポートでは承っておりません。レポートの出力結果をもとに、最終的にはお客様側で設定値の比較・判断を実施ください。</p></div><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol><li>比較情報を確認するサーバーにて <a href="https://github.com/Microsoft/AADConnectConfigDocumenter/releases">Azure AD Connect Configuration Documenter</a> をダウンロードします。<br>ページ内の AzureADConnectSyncDocumenter.zip をクリックしてダウンロードします。  </li><li>ダウンロードした AzureADConnectSyncDocumenter.zip を任意のディレクトリに展開します。</li><li>展開した AzureADConnectSyncDocumenter フォルダー配下の Data フォルダーに各サーバー用のフォルダーを作成します。</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　 例) C:\temp\AzureADConnectSyncDocumenter\Data\AADCServer001 , C:\temp\AzureADConnectSyncDocumenter\Data\AADCServer002  </span><br></pre></td></tr></table></figure><ol><li>各 Azure AD Connect サーバーにて設定ファイルを取得します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-ADSyncServerConfiguration</span> <span class="literal">-Path</span> <span class="string">&quot;出力先へのパス&quot;</span></span><br></pre></td></tr></table></figure><p>(実行例)  </p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-ADSyncServerConfiguration</span> <span class="literal">-Path</span> <span class="string">&quot;C:\temp\AADC001&quot;</span></span><br></pre></td></tr></table></figure><ol start="5"><li><p>手順 4. で出力した下記のフォルダーを 3. で作成したフォルダーにサーバー毎にコピーします。<br>  Connectors<br>  GlobalSettings<br>  SynchronizationRules  </p></li><li><p>手順 2. で展開したフォルダー内の AzureADConnectSyncDocumenter-contoso.cmd をテキスト エディターで開きます。</p></li><li><p>下記箇所を手順 3. で作成したフォルダー名に合わせて、保存します。</p></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AzureADConnectSyncDocumenterCmd.exe &quot;Contoso\Pilot&quot; &quot;Contoso\Production&quot;  </span><br><span class="line">例) AzureADConnectSyncDocumenterCmd.exe &quot;AADCServer001&quot; &quot;AADCServer002&quot;  </span><br></pre></td></tr></table></figure><ol start="8"><li><p>AzureADConnectSyncDocumenter-contoso.cmd のファイル名を AzureADConnectSyncDocumenter.cmd に変更します。  </p></li><li><p> 下記コマンドを実行します。</p></li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">.\AzureADConnectSyncDocumenter.cmd</span><br></pre></td></tr></table></figure><ol start="10"><li>コマンド実行後に AzureADConnectSyncDocumenter\Report 配下に HTML ファイルが生成されます。</li><li>レポート内の Create / Update / Delete 項目で差分内容を確認します。  下記の “Only Show Changes” チェックを有効にすることで差分のみ表示可能となります。緑枠部分に、各サーバーのバージョンが表示されますので確認します。</li></ol><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/aadc-documenter1.png" alt="aadc-documenter1"></p><h2 id="差分内容につきまして"><a href="#差分内容につきまして" class="headerlink" title="差分内容につきまして"></a>差分内容につきまして</h2><p>上記にて表示された差分内容のファイルの中で、特に注意して確認してほしい点は、「現行のサーバーには設定されているのに、新しいサーバーでは削除されている・設定値が異なっている」パターンの差異です。<br>主な確認ポイントについては下記を参考ください。</p><h3 id="端末固有の値のため、一般的に無視してもよいもの"><a href="#端末固有の値のため、一般的に無視してもよいもの" class="headerlink" title="端末固有の値のため、一般的に無視してもよいもの"></a>端末固有の値のため、一般的に無視してもよいもの</h3><p>・ ステージングモードの有効・無効<br>・ 次回同期の日時やサーバー名など、サーバーによって異なる値</p><h3 id="設定を改めて確認してほしいもの"><a href="#設定を改めて確認してほしいもの" class="headerlink" title="設定を改めて確認してほしいもの"></a>設定を改めて確認してほしいもの</h3><p>・上記以外で何等かの設定差異がある場合は、改めて設定の見直しをお願いします</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>2 台目以降の Azure AD Connect サーバーを手動でインストールする場合は、本ツールで差分比較を行うことを推奨します。</p><p>なお、Azure AD Connect サーバーでは設定情報を JSON ファイルとしてエクスポートして別のサーバーにインストールすることも可能です。<br>この場合手作業による設定ミスがなくなりますので、<a href="https://jpazureid.github.io/blog/azure-active-directory-connect/aadc-import-export-config/">こちら</a> もご活用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;今回は、 Azure AD Connect Sync Configuration Documenter 使用方法をご案内します。&lt;br&gt;&lt;a href=&quot;/blog/master/READ</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect の通信要件</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/port-used-by-aadc/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/port-used-by-aadc/</id>
    <published>2023-06-28T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.671Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/07/03/azure-ad-connect-requirement/">こちらの記事</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p><p>なお、本記事は 2018 年 7 月 3 日に「Azure AD Connect サーバー - ウィルス対策ソフト除外項目 / 使用する通信ポート」 として公開しておりましたが、情報が古くなってまいりましたので、最新情報として改めて更新のうえ公開しております。</p></div><p>こんにちは！ Azure Identity サポートの小出です。<br>今回は、 Azure AD Connect の通信要件についてのまとめをご案内します。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure AD Connect は、オンプレミス AD と Azure AD のアカウントを連携するために使われているサービスです。<br>すでに多くのお客様にご利用いただき、ハイブリッド環境を構築されている企業様も多いと思いますが、これから Azure AD Connect を利用したいと検討されているお客様のなかには、どのような通信を許可すればよいか確認されたい方もいらっしゃるかと思います。</p><p>Azure AD Connect の通信要件に関しては、弊社サポートにもよくお問い合わせをいただいておりますが、公開情報の記載が複数にまたがっており、どこのページを見ればよいか分かりにくい状況でした。</p><p>そこで今回は、様々な公開情報の記載を確認しなくてもよい形で、 Azure AD Connect の通信要件の情報をおまとめします。</p><h2 id="A-最低限許可してほしい通信"><a href="#A-最低限許可してほしい通信" class="headerlink" title="A. 最低限許可してほしい通信"></a>A. 最低限許可してほしい通信</h2><h3 id="Azure-AD-Connect-を利用するための要件"><a href="#Azure-AD-Connect-を利用するための要件" class="headerlink" title="Azure AD Connect を利用するための要件"></a>Azure AD Connect を利用するための要件</h3><p>最低限必要なポートは、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/reference-connect-ports#table-1---azure-ad-connect-and-on-premises-ad">本公開情報</a> に記載の 表 １ と表 2 です。その他、環境に応じて表 3 以降のポートを開ける必要もありますが、ここでは省略します。</p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-1.png" alt="aadc-port-0626-1"></p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-2.png" alt="aadc-port-0626-2"></p><p>また、 Azure AD Connect をご利用いただくにあたって、許可いただく必要のある URL は下記の通りです。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/tshoot-connect-connectivity#troubleshoot-connectivity-issues-in-the-installation-wizard">本公開情報</a> に記載がございます。</p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-3.png" alt="aadc-port-0626-3"></p><p>もし上記 URL を許可してもエラーが発生する、正しく動作しない場合などは、まず <a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges?redirectSourcePath=%252farticle%252fOffice-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2&view=o365-worldwide">本公開情報</a> に記載されている ID 56、ID 59、ID 125 に記載の URL を許可して様子を確認してください。</p><h3 id="Azure-AD-Connect-Health-を利用するための要件"><a href="#Azure-AD-Connect-Health-を利用するための要件" class="headerlink" title="Azure AD Connect Health を利用するための要件"></a>Azure AD Connect Health を利用するための要件</h3><p>Azure AD Connect Health を利用するにあたって必要なポートにつきましては、まず<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/reference-connect-ports#table-1---azure-ad-connect-and-on-premises-ad">本公開情報</a> の表 7 をご確認ください。</p><p>また、以下の URL についても許可リストに追加してください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.blob.core.windows.net</span><br><span class="line">*.aadconnecthealth.azure.com</span><br><span class="line">**.servicebus.windows.net - ポート: (5671 がブロックされている場合、エージェントは 443 にフォールバックしますが、5671を使用することをお勧めします。 このエンドポイントは、エージェントの最新バージョンでは必要ありません。)</span><br><span class="line">*.adhybridhealth.azure.com/</span><br><span class="line">https://management.azure.com</span><br><span class="line">https://policykeyservice.dc.ad.msft.net/</span><br><span class="line">https://login.windows.net</span><br><span class="line">https://login.microsoftonline.com</span><br><span class="line">https://secure.aadcdn.microsoftonline-p.com</span><br><span class="line">https://www.office.com (このエンドポイントは、登録時の検出目的でのみ使用されます。)</span><br><span class="line">https://aadcdn.msftauth.net</span><br><span class="line">https://aadcdn.msauth.net</span><br></pre></td></tr></table></figure><p>Azure AD Connect Health でエラーが発生するお問い合わせには、上記の URL が許可されていない、プロキシ環境などで TLS 終端機能が使用されている場合などが多く見受けられます。<br>Azure AD Connect Health をご利用の際には、上記を含めた前提条件を満たすかご確認ください。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/how-to-connect-health-agent-install#outbound-connectivity-to-the-azure-service-endpoints">こちらの公開情報</a>に記載があります。</p><h3 id="Azure-AD-クラウド同期（Cloud-Sync）を利用するために必要な要件"><a href="#Azure-AD-クラウド同期（Cloud-Sync）を利用するために必要な要件" class="headerlink" title="Azure AD クラウド同期（Cloud Sync）を利用するために必要な要件"></a>Azure AD クラウド同期（Cloud Sync）を利用するために必要な要件</h3><p>Azure AD Connect ではなく、新しい Azure AD Cloud Sync をご利用のお客様は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/cloud-sync/how-to-prerequisites?tabs=public-cloud#firewall-and-proxy-requirements">こちらの要件</a>をご確認ください。</p><p>エージェントから Azure AD に送信要求を発行できるように、下記のポートを許可してください。</p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-4.png" alt="aadc-port-0626-4"></p><p>また、必要に応じて以下の URL を追加し、エージェントと Azure AD が通信できるように設定してください。</p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-5.png" alt="aadc-port-0626-5"></p><h2 id="B-要望や環境に応じて許可してほしい通信"><a href="#B-要望や環境に応じて許可してほしい通信" class="headerlink" title="B. 要望や環境に応じて許可してほしい通信"></a>B. 要望や環境に応じて許可してほしい通信</h2><h3 id="Azure-ポータルにアクセスするための要件"><a href="#Azure-ポータルにアクセスするための要件" class="headerlink" title="Azure ポータルにアクセスするための要件"></a>Azure ポータルにアクセスするための要件</h3><p>プロキシ環境で Azure ポータルにアクセスできない時は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls?tabs=public-cloud#azure-portal-urls-for-proxy-bypass">こちらの公開情報</a>の URL が許可されていないことが原因である可能性があります。<br>そのため、プロキシ環境でご利用のお客様は、上記必ず必要な通信のほかに、下記 URL も許可リストに追加してください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.aadcdn.microsoftonline-p.com</span><br><span class="line">*.aka.ms</span><br><span class="line">*.applicationinsights.io</span><br><span class="line">*.azure.com</span><br><span class="line">*.azure.net</span><br><span class="line">*.azure-api.net</span><br><span class="line">*.azuredatalakestore.net</span><br><span class="line">*.azureedge.net</span><br><span class="line">*.loganalytics.io</span><br><span class="line">*.microsoft.com</span><br><span class="line">*.microsoftonline.com</span><br><span class="line">*.microsoftonline-p.com</span><br><span class="line">*.msauth.net</span><br><span class="line">*.msftauth.net</span><br><span class="line">*.trafficmanager.net</span><br><span class="line">*.visualstudio.com</span><br><span class="line">*.asazure.windows.net (Analysis Services)</span><br><span class="line">*.core.windows.net (Azure Storage)</span><br><span class="line">*.database.windows.net (SQL Server) </span><br><span class="line">*.graph.windows.net (Azure AD Graph)</span><br><span class="line">*.kusto.windows.net (Azure Data Explorer/Kusto)</span><br><span class="line">*.search.windows.net (search)</span><br><span class="line">*.servicebus.windows.net (Azure Service Bus)</span><br></pre></td></tr></table></figure><h3 id="シームレス-SSO-に必要な要件"><a href="#シームレス-SSO-に必要な要件" class="headerlink" title="シームレス SSO に必要な要件"></a>シームレス SSO に必要な要件</h3><p>ファイアウォールまたはプロキシで許可している場合は、*.msappproxy.net もしくは tenantid.registration.msappproxy.net の URL に対するポート 443 での許可リストへの接続を追加します。<br>詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/how-to-connect-sso-quick-start#step-1-check-the-prerequisites">本公開情報</a>の前提条件をご確認ください。</p><h3 id="パスワード-ライトバックに必要な要件"><a href="#パスワード-ライトバックに必要な要件" class="headerlink" title="パスワード ライトバックに必要な要件"></a>パスワード ライトバックに必要な要件</h3><p>パスワードライトバックは以下に対し接続を行いますので、利用される場合は下記への通信も許可してください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.passwordreset.microsoftonline.com</span><br><span class="line">*.servicebus.windows.net</span><br></pre></td></tr></table></figure><h3 id="パススルー認証を使う際に必要な通信要件"><a href="#パススルー認証を使う際に必要な通信要件" class="headerlink" title="パススルー認証を使う際に必要な通信要件"></a>パススルー認証を使う際に必要な通信要件</h3><p>パススルー認証に必要な通信要件は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/connect/how-to-connect-pta-quick-start">こちらの公開情報</a>に記載があります。<br>まずは下記のポートを使用して通信ができるよう、ファイアウォールなどの設定をご確認ください。</p><p><img src="/blog/azure-active-directory-connect/port-used-by-aadc/aadc-port-0626-6.png" alt="aadc-port-0626-6"></p><p>また、公開情報に記載の通り、下記 URL への通信も許可してください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.msappproxy.net </span><br><span class="line">*.servicebus.windows.net </span><br><span class="line">autologon.microsoftazuread-sso.com （発信 HTTP プロキシを利用している場合）</span><br><span class="line">login.windows.net</span><br><span class="line">login.microsoftonline.com</span><br><span class="line">rl3.digicert.com:80</span><br><span class="line">crl4.digicert.com:80</span><br><span class="line">ocsp.digicert.com:80</span><br><span class="line">www.d-trust.net:80</span><br><span class="line">root-c3-ca2-2009.ocsp.d-trust.net:80</span><br><span class="line">crl.microsoft.com:80</span><br><span class="line">oneocsp.microsoft.com:80</span><br><span class="line">ocsp.msocsp.com:80</span><br></pre></td></tr></table></figure><h2 id="ウィルス対策ソフトでのスキャン除外項目"><a href="#ウィルス対策ソフトでのスキャン除外項目" class="headerlink" title="ウィルス対策ソフトでのスキャン除外項目"></a>ウィルス対策ソフトでのスキャン除外項目</h2><p>基本的には SQL Server 2012 Express LocalDB としての除外をご考慮いただければと存じますので、<a href="https://learn.microsoft.com/ja-JP/troubleshoot/sql/database-engine/security/antivirus-and-sql-server">こちらの公開情報</a>をまずは参考としてご参照いただければと存じます。</p><p>上記技術情報を踏まえ、AADC 製品を添付の SQL Server 2012 Express LocalDB をご利用いただいた状態で、既定でセットアップされた際の除外対象は以下となります。</p><ul><li>SQL Server データ ファイル格納先</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Microsoft Azure AD Sync\Data</span><br></pre></td></tr></table></figure><p>※ 一時的に利用される場合があるため、[C:\Program Files\Microsoft Azure AD Sync\MaData] も併せて除外していただければと存じます。</p><ul><li>ウイルス スキャンから除外するプロセス</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Microsoft SQL Server\110\LocalDB\Binn\sqlservr.exe</span><br></pre></td></tr></table></figure><p>上記に加え、SQL Server 観点として技術情報にございます [.bak / .trn / .trc / .sql] の拡張子を持つファイルの除外も念のためご検討ください。</p><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><p><strong>Q. 許可すべき通信が多すぎます。公開情報に記載の URL の中には、実際には通信していない URL もありそうでした。最低限しか許可したくないのですが、どの URL を許可すればいいですか？</strong></p><p><strong>A.</strong> 公開情報に記載されているものにつきましては、基本的に許可することを推奨しています。もしお客様環境の要件などにより、上記より絞り込む必要がある場合は、ツールなどで実際の通信を取得し、許可する通信先をお客様側で判断してください。<br>トラブル シューティングなどの際には、まずは上記 URL を許可するようご案内する場合があります。</p><p><strong>Q. 通信を許可するにあたり、どちら向きの通信を許可すればよいのでしょうか。</strong></p><p><strong>A.</strong> Azure AD Connect を起点に、 Azure AD Connect -&gt; オンプレミス AD 、 Azure AD Connect -&gt; Azure AD の向きの通信を許可します。<br>一般的に戻りの通信は許可されておりますので、この方向の通信を許可すれば、オンプレミス AD や Azure AD から返される応答の通信は許可されます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="AAD Connect" scheme="https://jpazureid.github.io/blog/tags/AAD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>招待したユーザーが利用できない</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-b2b-troubleshooting/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-b2b-troubleshooting/</id>
    <published>2023-06-26T01:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.895Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/11/27/azuread-b2b-troubleshooting/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-11-27: 本記事の初版を投稿</p><p>2023-03-26: Azure ポータル上のメニューの変更に伴い画面ショットや内容を更新</p><p>2023-06-26: Azure ポータル上のメニューの変更に伴い画面ショットや内容を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの 三輪 です。</p><p>本記事では Azure AD に招待したはずのユーザーが利用できない際の確認ポイントについて説明します。この記事はもともと 2017 年 11 月に公開されましたが、その後 Azure ポータルのメニューなどが変更されたため、内容を最新版に更新いたしました。</p><p>Azure AD へのユーザー招待は、明示的に Azure Active Directory の管理画面からゲスト ユーザーを追加した場合だけでなく、その追加したユーザーが Azure AD にすでに追加済みでなければ、Azure のサブスクリプションに対して “所有者” や “仮想マシン共同作成者” の役割を追加したときにも行われます。</p><p>ユーザーを招待した後には、招待されたユーザー側でその招待の受諾処理を行う必要があり、それが完了していないと、役割を割り当てたもののサブスクリプションの利用ができないというような状況になります。そのような状況の場合は、まずはじめに Azure ポータルにて招待状況を確認しましょう。</p><h2 id="Azure-ポータルでの招待状況の確認方法"><a href="#Azure-ポータルでの招待状況の確認方法" class="headerlink" title="Azure ポータルでの招待状況の確認方法"></a>Azure ポータルでの招待状況の確認方法</h2><p>招待操作を行ったテナントの管理者権限を持つユーザーで Azure ポータルにサインインし、[Azure Active Directory] – [ユーザー] – [すべてのユーザー] から該当のゲスト ユーザーを選択します。</p><p>[プロパティ] のタブで「外部ユーザーの状態」(赤枠) の項目が「保留中の承諾」の場合は、招待メールは送信されているものの、該当のユーザーが招待を受け付け操作を完了していない状態を示します。招待を受けたユーザーは送信された E メールに含まれる [招待の承諾] のリンクをクリックしてウィザードを完了させる必要があります。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new1.png"></p><p>なお、招待 E メールが届いていない場合、赤枠部分の「B2B コラボレーション」の [招待の再送信] - [再送信] から招待 E メールの再送も可能です。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/renew2-blue.png"></p><p>招待 E メールは下記のようなメールです。</p><p>アドレス: <a href="mailto:&#105;&#x6e;&#x76;&#x69;&#116;&#x65;&#115;&#64;&#109;&#x69;&#99;&#x72;&#111;&#x73;&#x6f;&#102;&#x74;&#46;&#x63;&#111;&#109;">&#105;&#x6e;&#x76;&#x69;&#116;&#x65;&#115;&#64;&#109;&#x69;&#99;&#x72;&#111;&#x73;&#x6f;&#102;&#x74;&#46;&#x63;&#111;&#109;</a><br>件名: 組織内のアプリケーションにアクセスするための &lt;招待者&gt; さんからの招待</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new3.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>件名に招待者の名前がない場合、ProxyAddresses 属性に値が入っていないユーザーで招待操作を行ったことが考えられます。この場合、特定のユーザー名の代わりにテナント名が記載されます。</p></div><p>もし、招待されたユーザーが E メールを利用できない場合や、E メール ボックスの作成前の場合は、招待の再送信後に表示される下記、「招待 URL ※」をコピーして、何らかの手段でその URL を招待されたユーザーにお渡しください。招待されたユーザーは、その URL にブラウザーからアクセスすることで招待の完了作業を進めることができます。</p><p>※ URL にアクセスして招待の完了作業を進めても、招待 E メールの「招待の承諾」を押す場合と同等の操作になります。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new4.png"></p><p>招待された外部ユーザーの状態が 「保留中の承諾」 ではなく、「承諾済み」となっている場合は、ユーザーの招待は完了しています。</p><p>「承諾済み」の状態で、期待したサブスクリプションの操作や Azure AD テナントの確認ができない場合は、適切なアカウントや Azure AD を選択できていない可能性がありますので、一度 <a href="https://jpazureid.github.io/blog/azure-active-directory/subscription-azuread/">サブスクリプションが見えない</a> の内容をご確認ください。</p><p>なお、招待 E メールに含まれるリンクをクリックし、ウィザードを進めた結果、次のような「表示するアプリはありません。 このコレクションを非表示にする」との画面が表示されることがありますが、こちらは問題なく招待が完了していますのでご安心ください。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new5.png"></p><p>これは、特に割り当てられたアプリケーションがないことを意味しており、招待自体は正常に完了したことを示します。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>上記内容でもご要望の動作が完了しない場合は、ぜひ弊社サポート サービスをご利用ください。その際は下記の情報を事前にご提供いただけると幸いです。</p><ul><li>招待操作を行ったテナント名 (例: xxx.onmicrosoft.com)</li><li>招待操作を行ったユーザー名 (例: <a href="mailto:&#x78;&#x78;&#x78;&#64;&#x63;&#111;&#110;&#x74;&#111;&#x73;&#111;&#46;&#99;&#111;&#x6d;">&#x78;&#x78;&#x78;&#64;&#x63;&#111;&#110;&#x74;&#111;&#x73;&#111;&#46;&#99;&#111;&#x6d;</a>)</li><li>招待操作を行った時刻</li><li>招待されるユーザーの E メールアドレス (例: <a href="mailto:&#120;&#x78;&#x78;&#64;&#x66;&#97;&#x62;&#x72;&#x69;&#x6b;&#x61;&#109;&#x2e;&#x63;&#111;&#x6d;">&#120;&#x78;&#x78;&#64;&#x66;&#97;&#x62;&#x72;&#x69;&#x6b;&#x61;&#109;&#x2e;&#x63;&#111;&#x6d;</a>)</li><li>問題となっている状況の詳細と画面ショット</li></ul><p>例としては、「招待 E メールが届かない」、「招待 E メールは届くが招待の操作が完了しない」、「招待は完了したが、その後に目的のリソースにアクセスできない」などが挙げられます。それぞれ、上記の情報を添えてお問い合わせを発行いただけますと幸いです。</p><p>また、招待 E メールを使用しないユーザーの追加や CSV を使用した一括招待の方法については、<a href="https://jpazureid.github.io/blog/azure-active-directory/b2bfaq/">Azure における ゲスト ユーザー招待 (B2B) のよくある質問</a> を参照ください。招待 E メールを使用しないユーザーの追加方法についても同様にこの記事の「よくある質問」をご確認ください。</p><p>Azure AD B2B で活用いただける PowerShell サンプルは <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/code-samples?tabs=http">Azure Active Directory B2B コラボレーション コードと PowerShell サンプル</a> にまとめられておりますので、併せてご参照ください。</p><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD におけるロール管理の新しい方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/roles-and-administrators/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/roles-and-administrators/</id>
    <published>2023-06-25T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.431Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/08/23/roles-and-administrators/">https://blogs.technet.microsoft.com/jpazureid/2018/08/23/roles-and-administrators/</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p><p>また、PIM の活用法については、<a href="https://jpazureid.github.io/blog/azure-active-directory/pim-overview/">こちら</a> でご紹介しています。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2018-08-23: 本記事の初版を投稿</p><p>2023-06-26: Azure ポータル上のメニューの変更に伴い画面ショットや内容を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの栗井です。</p><p>本記事は、2018 年 7 月末に公開された A new way to manage roles and administrators in Azure AD を元にしています。<br>これまで、 Azure AD の全体管理者などのロールを割り当てられているユーザー一覧を取得することができなかったのですが、最近の更新により、簡単に確認できるようになりました。<br>元記事を参考に、ユーザーへのディレクトリロールの新しい割り当て・管理方法について、画面キャプチャを含めてご紹介します。</p><p>ユーザの役割の確認や管理者権限の割り当てを、これまでより簡単におこなうことができます。</p><p>以下が、新しい機能の特徴です。</p><ul><li>ビルトイン (既定) のディレクトリロールの一覧と、それぞれの詳細を確認可能</li><li>役割の管理や設定がより簡単に</li><li>関連ドキュメントへのリンク追加</li></ul><p>言い換えますと 「全体管理者は何人いるのか？」「このユーザーに割り当てられているのは何の役割か？」がすぐ分かるようになりました。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/01.png"></p><p>概要画面から、新機能「ロールと管理者」がご利用できます。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>ビルトイン ディレクトリ ロールの一覧とそれぞれの簡単な説明は 「ロールと管理者」をクリックすることで確認できます。これも最近追加されました Azure AD と連携するアプリケーションの管理を目的とした新しいロールも含まれます。</p><p>現在サインインして操作を実施しているユーザー自身に何かしらのロールが割り当てられている場合、画面上部に表示されます。「ロール」をクリックすると、自身に割り当てられているロールと、それぞれの概要の一覧を確認できます。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/02.png"><br>図: 「ロールと管理者」下の、各ロールと説明の一覧</p><p>また、ロールの行をクリックすると、そのロールに割り当てられているユーザーの一覧が確認できます。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/03.png"><br>図: ロールに割り当てられているユーザー (メンバー) 一覧</p><p>各ロールによりどのようなことができるのかという質問をよく頂きますが、それぞれのロールに何の権限があるのか、その詳細を一覧でみられるようになりました。同じ画面で、関連記事のリンクも見ることができます。ロールを最大限有効に使うためにぜひご活用ください。<br>画像に示すように、ブレードの「説明」をクリックするとこの画面が見られます。もしくはロールの一覧画面から、各行の右側にある「・・・」をクリックをすることでも、同じ画面に辿り着くことができます。</p><p>あるロールに割り当てられているユーザの一覧に加えて、その逆引きである「あるユーザーに割り当てられているロールの一覧」を見ることができるようになりました。同じ画面から、ユーザーに新たなロールを追加することができます。<br>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/roles/manage-roles-portal">Azure AD ロールをユーザーに割り当てる</a> をご参照ください。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/04.png"><br>図: ユーザーに割り当てられているロールの一覧と「割り当ての追加」ボタン</p><p>一人のユーザーに複数の特権ロール (privileged roles) を割り当てることも可能です。既に割り当てられているものは表示されません。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/05.png"><br>図: 割り当て可能なロールの一覧</p><h2 id="PIM-での更新"><a href="#PIM-での更新" class="headerlink" title="PIM での更新"></a>PIM での更新</h2><p>Privileged Identity Management (PIM) を使用することで、より細やかな権限管理が可能です。<br>尚、PIM の使用には、Azure AD Premium P2 ライセンスが必要となります。<br>PIM の管理画面は、検索窓に「PIM」と入力し、検索することで開くことができます。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/06.png"><br>図: Privileged Identity Management 画面の開き方</p><p>PIM 上で Azure AD ロールを管理する際には、左ブレードで「Azure AD ロール」をクリックします。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/07.png"><br>図: PIM 上で Azure AD ロールを管理する</p><p>また、Azure AD Premium P2 ライセンスをお持ちのテナントで、PIM の画面を開くと、以降、Azure AD 上の 「ロールと管理」から Azure AD ロールの管理を行う際にも、各ロールの管理画面では PIM の画面が表示されるようになります。</p><p><img src="/blog/azure-active-directory/roles-and-administrators/08.png"><br>図: 各 Azure AD ロールの管理画面の例</p><p>上記内容が少しでも参考となりますと幸いです。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2B とは</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/what-is-b2b/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/what-is-b2b/</id>
    <published>2023-06-25T15:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.495Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-12-12: 本記事の初版を投稿</p><p>2023-04-01: Azure ポータル上のメニューの変更に伴い画面ショットや内容を更新</p><p>2023-06-26: Azure ポータル上のメニューの変更に伴い画面ショットや内容を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの三輪です。</p><p>今回は Azure AD B2B (Business-To-Business) コラボレーション機能 (以下、Azure AD B2B) について紹介します。この記事はもともと 2017 年 12 月に公開されましたが、その後 Azure ポータルのメニューなどが変更されたため、内容を最新版に更新いたしました。</p><p>Azure AD B2B の概要については、公開ドキュメントである <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b">B2B コラボレーションの概要</a> をまずご覧ください。</p><p>Azure AD B2B と聞くと、もしかしたら小難しく聞こえるかもしれませんが、要は他の Azure AD テナント上のユーザーを自テナントに追加 (招待) する機能のことです。具体的には、Azure AD を利用する中で、次のような要望がでてくることがあります。</p><ul><li>会社間 (Azure AD テナント間) で自社が公開しているリソースを共有したい</li><li>別の Azure AD テナントに紐づいているリソースを使用したい</li><li>ひとりの管理者で、複数の Azure AD テナントを管理したい 等</li></ul><p>このような連携が必要な時に利用する機能が、今回紹介する Azure AD B2B になります。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure サブスクリプションは必ず 1 つの Azure AD テナントに関連付けられています。通常、このサブスクリプションが紐づく Azure AD テナントに所属しているユーザーのみがそのサブスクリプション内のリソースを管理可能です。</p><p><img src="/blog/azure-active-directory/what-is-b2b/subscription-user.png"></p><p>では、複数の Azure AD テナントがある場合はどのようになるでしょうか。この場合、そのままでは別の Azure AD テナント B からテナント A へアクセスしたり、別の Azure AD テナント A に関連付けられているサブスクリプションに Azure AD テナント B のユーザーが管理操作をおこなったりすることはできません。</p><p><img src="/blog/azure-active-directory/what-is-b2b/subscription-user-inaccessible.png"></p><p>こんな時、Azure AD B2B を利用することで、自身の Azure AD テナントに他テナントのユーザーを招待することで、ユーザー本体は別の Azure AD テナントに所属しながら、招待した側のテナントのリソースを利用することが可能となります。</p><p><img src="/blog/azure-active-directory/what-is-b2b/invite-user-to-tenant.png"></p><h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>別の Azure AD テナントのユーザーを自テナントに招待する方法で多く利用されるものを 2 つ紹介します。</p><h3 id="1-ゲスト-ユーザーの直接的な招待"><a href="#1-ゲスト-ユーザーの直接的な招待" class="headerlink" title="1. ゲスト ユーザーの直接的な招待"></a>1. ゲスト ユーザーの直接的な招待</h3><p>明示的に別の Azure AD テナントのユーザー (または outlook.com や gmail.com など外部アカウント) を招待し追加する操作です。Azure ポータルのメニューより [Azure Active Directory] – [ユーザーとグループ] – [すべてのユーザー] – [新しいユーザー] の順に進みます。下記、[外部ユーザーの招待] からユーザーの E メール アドレス (もしくは Azure AD の UPN) を追加します。</p><p><img src="/blog/azure-active-directory/what-is-b2b/screenshot-new-guest-user-new.png"></p><p>[招待メッセージの送信] にチェックを入れると、指定されたユーザーに招待 E メールが送られますので、E メールを受け取ったユーザーは、その E メールのリンクからウィザードを完了することができます。</p><p><img src="/blog/azure-active-directory/what-is-b2b/screenshot-sendmail.png"></p><h3 id="2-RBAC-アクセス制御-IAM-によるユーザーの招待"><a href="#2-RBAC-アクセス制御-IAM-によるユーザーの招待" class="headerlink" title="2. RBAC (アクセス制御 IAM) によるユーザーの招待"></a>2. RBAC (アクセス制御 IAM) によるユーザーの招待</h3><p>RBAC を用いて、Azure サブスクリプションに紐づけられている Azure AD テナント上のユーザーに対してアクセス許可を割り当てることができます。では、RBAC でアクセス権を割り当てるときに別の Azure AD テナントのユーザーを指定したい時には、先に 1 の作業を実施しておく必要があるのでしょうか？</p><p>いいえ、もしアクセス許可を割り当てようとしているユーザーがそのテナントに存在していない場合には、RBAC の設定時に自動的に 1 のユーザー招待も併せて行われます。手順としては、Azure ポータルの [サブスクリプション] – [サブスクリプション名] – [アクセス制御 (IAM)] の順にお進みください。下記、[追加] から別の Azure AD テナントのユーザーを追加することができます。指定された E メール アドレスには、招待 E メールが送られ、その E メールよりウィザードを完了する流れは同様になりますが、同時にサブスクリプションに対するロールが割り当てられます。</p><p><img src="/blog/azure-active-directory/what-is-b2b/screenshot-iam-new.png"></p><h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><span style="color:blue">Q</span>. B2B の機能以外で Azure AD 間の連携を行うことは可能ですか？</p><p><span style="color:red">A</span>. いいえ、テナント間での連携を行いたい場合は、Azure AD B2B を利用することが基本です。Azure AD のテナント間同機の仕組みでも、Azure AD B2B の仕組みが利用されています。Azure AD B2B の機能は Azure AD のテナント同士を連携するものではなく、 Azure AD テナントと別の Azure AD テナントのユーザーを連携する機能とお考えください。</p><p><span style="color:blue">Q</span>. 別の Azure AD テナントに登録されたアプリケーションを利用するのに、Azure AD B2B の機能を利用できますか？</p><p><span style="color:red">A</span>. はい、B2B の機能で要件を満たせます。Azure AD B2B の機能で別の Azure AD テナントのユーザーを自テナントに招待することで、その招待されたユーザーが 自テナント (自社の Azure AD テナント) 上のアプリケーションを利用することが可能となります。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、Azure AD B2B に関する概要について紹介しました。Azure AD B2B に関するトラブルや Azure AD B2B 完了後のトラブル、または招待 E メールを利用しない方法などの記事も必要に応じて参照ください。また、それでも問題が解決しない場合は、弊社サポートまで遠慮なくお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="RBAC" scheme="https://jpazureid.github.io/blog/tags/RBAC/"/>
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD が発行するトークンの有効期間と考え方 (2023 年版)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/token-lifetime-2023/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/token-lifetime-2023/</id>
    <published>2023-06-23T01:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.487Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は、2018 年公開の以下の Blog の内容が、現在の機能/技術にマッチしない内容になってきたことを踏まえ、2023 年現在の機能/技術を元に改めて考え方をおまとめしたものとなります。以前に公開した <a href="https://jpazureid.github.io/blog/azure-active-directory/aad-token-lifetime/">Azure AD が発行するトークンの有効期間について (2018 年公開)</a> の記事は参考のためそのまま残し、新しく本記事を執筆しました。</p></div><p>こんにちは、Azure &amp; Identity サポートの金森です。</p><p>Azure AD (AAD) は、Microsoft 365 をはじめ様々なクラウド サービスの認証基盤 (Identity Provider / IdP) として利用されています。その重要な機能としてユーザーの認証が完了したら、アプリケーションに対してトークンを発行するというものがあります。あるサービス (Teams や Exchange Online、他に Azure AD と連携しているクラウド上のサービス) にアプリがアクセスしようとした際、そのアプリはユーザーの認証を要求します。ユーザーが AAD 上で認証し、アクセス許可へ同意すると、AAD から “そのサービスにアクセスするための” トークンが発行され、アプリに渡されます。アプリはそのトークンをサービスに提示することでクラウド上のリソース (Teams や E メール、Microsoft Graph API など) にアクセスできるというイメージです。</p><p>弊社サポートでは、この [AAD が発行するトークン] にはどのような種類があるのか、構成によってトークンの有効期間はどうなっているのか、有効期間の制御は行えるのか等、様々なお問い合わせをいただきます。このため本記事ではそれらの詳細と考え方について、以下に紹介したいと思います。</p><h2 id="よく出てくるキーワード"><a href="#よく出てくるキーワード" class="headerlink" title="よく出てくるキーワード"></a>よく出てくるキーワード</h2><p>解説に当たり、まず以下に略語の一覧をまとめます。これらのキーワードは、弊社へのお問い合わせの中でも頻繁に使用されるものであり、サポートからの回答でもよく利用されます。</p><table><thead><tr><th>略称</th><th>概要</th></tr></thead><tbody><tr><td>AAD</td><td>Azure Active Directory の略です。</td></tr><tr><td>SSO</td><td>Single Sign On の略です。</td></tr><tr><td>IdP</td><td>Identity Provider の略です。以下の説明では AAD を指します。</td></tr><tr><td>SP</td><td>Service Provider の略です。以下の説明ではアクセス先のアプリケーションを指します。</td></tr><tr><td>ADAL/MSAL</td><td>先進認証ライブラリの略です。OAuth 2.0 や OpenIDConnect のようなプロトコルを用いた認証方式を利用できるライブラリを指します。</td></tr><tr><td>Confidential クライアント</td><td>サーバー上で動く Web アプリなどのように、ユーザーの手元では動作しないアプリを指します。</td></tr><tr><td>Public クライアント</td><td>JavaScript を使用してブラウザー上で動作するアプリや、スマホおよび PC 上のネイティブ アプリなどのように、ユーザーの手元のデバイス上で動作するアプリを指します。</td></tr><tr><td>PRT</td><td><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-primary-refresh-token">Primary Refresh Token</a> の略です。</td></tr><tr><td>CA</td><td><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/overview">条件付きアクセス (Conditional Access)</a> の略です。</td></tr><tr><td>CAE</td><td><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価 (Continuous Access Evaluation)</a> の略です。</td></tr><tr><td>SIF</td><td><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime#user-sign-in-frequency">サインインの頻度 (Sign-in Frequency)</a> の略です。</td></tr></tbody></table><h2 id="トークン種別-プロトコルおよび目的"><a href="#トークン種別-プロトコルおよび目的" class="headerlink" title="トークン種別 (プロトコルおよび目的)"></a>トークン種別 (プロトコルおよび目的)</h2><p>様々なトークンの概要をまとめたものが以下です。使用するプロトコルやアクセス元のクライアントの種類、環境の構成によりさまざまな種類のトークンが使用されます。</p><p><img src="/blog/azure-active-directory/token-lifetime-2023/token-types.png"></p><h2 id="既定のトークン有効期間"><a href="#既定のトークン有効期間" class="headerlink" title="既定のトークン有効期間"></a>既定のトークン有効期間</h2><p>Azure AD が発行するトークンの有効期間をまとめたものが以下です。以下のうち SAML トークンは SAML 認証連携を使用した際に発行および利用されるものです。</p><p><img src="/blog/azure-active-directory/token-lifetime-2023/token-lifetime.png"></p><p>各トークンの有効期間については、以下の公開情報もご覧ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/access-tokens#access-token-lifetime">アクセス トークンの有効期間</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/id-tokens#id-token-lifetime">ID トークンの有効期間</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/refresh-tokens#refresh-token-lifetime">更新トークンの有効期間</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-primary-refresh-token">プライマリ更新トークンとは</a></li></ul><p>なお、特定のシナリオでは、上記の表に従わず例外的に特別な有効期間のトークンが発行されることもあります。</p><ul><li>シングル ページ アプリ (SPA) に対して発行される更新トークンは、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/refresh-tokens#refresh-token-lifetime">更新トークンの有効期間</a> のとおり 24 時間になります。</li><li>AAD ユーザーに LastPasswordChangeTimestamp 属性が同期されていないフェデレーション認証のユーザーの場合、更新トークンおよびセッション トークンの有効期間は 12 時間になり、<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/federated-users-forced-sign-in">頻繁にサインインすることを強制されます</a>。</li></ul><h2 id="アクセス-トークンの有効期間の考え方"><a href="#アクセス-トークンの有効期間の考え方" class="headerlink" title="アクセス トークンの有効期間の考え方"></a>アクセス トークンの有効期間の考え方</h2><h3 id="継続的アクセス評価-CAE-Continuous-Access-Evaluation-が提供される以前の考え方"><a href="#継続的アクセス評価-CAE-Continuous-Access-Evaluation-が提供される以前の考え方" class="headerlink" title="継続的アクセス評価 (CAE: Continuous Access Evaluation) が提供される以前の考え方"></a>継続的アクセス評価 (CAE: Continuous Access Evaluation) が提供される以前の考え方</h3><p>AAD が発行するアクセス トークンは “ある SP のリソースにアクセスするためのトークン” であり、過去には 1 時間の有効期間でした。つまり、アクセス トークンを取得したアプリは、その有効期間である 1 時間の間は目的のリソースにアクセスし続けることが可能となります。一方でこれは、その 1 時間の間は AAD にアクセスしなくてよいという意味でもあり、AAD の機能である条件付きアクセス (CA) ポリシーが適用されないということも意味していました。</p><p>例えば、Outlook アプリが Exchange Online にアクセスするために、有効期間が 1 時間のアクセス トークンを保持しているとします。これは上述のとおり、Outlook は SP のリソース (Exchange Online) に対して 1 時間の間は継続的にアクセスが可能な状態を意味します。ここで一例ですが、”社内では Exchange Online のリソース (E メールやカレンダー) に自由にアクセス可能にし、外出した先 (カフェや空港のような) では、リソースへアクセスさせたくない” というシーンがあるとします。つまり、社内では Outlook によるメールの送受信は自由に行えるが、外出先のカフェでは送受信が行えないようにしたいというご要望があるという例です。このような例では、CA ポリシーで “Exchange Online に対して、すべての場所 (社内の IP は除く) からのアクセスをブロックする” というポリシーを構成し、AAD でアクセス制御を行う方針が一般的です。</p><p>ここで “AAD でアクセス制御を行う” というのは、つまりクライアント アプリ (Outlook) が AAD にアクセスしたタイミングで、AAD 側で CA ポリシーの評価および適用が行われるという意味でした。そのため、クライアント アプリ (Outlook) が AAD にアクセスしない限り、CA ポリシーの評価を受けるタイミングが無いことになります。このため、例えば 1 時間の有効期間のアクセス トークンを社内で取得し、それを保持したデバイスを持って外出し、カフェで最新のメールをチェックする (Outlook から Exchange Online にアクセスする) ということもそのままでは行えることになります。これは、1 時間利用可能なアクセス トークンを保持しているため、改めて (そのトークンの有効期間内に) AAD へのアクセスを Outlook が行うことが無いためです。</p><p>この “1 時間のアクセス トークン” の前提では、上記の “困った時間” も最長 1 時間ということになります。社内から外出したあと、最大 1 時間程度でアクセス トークンの有効期間が終了し、再度アクセス トークンを取得しようと AAD にアクセスしたタイミングで、CA ポリシーが評価されることが期待されました。上記の例で言うと、外出した後に、最大 1 時間程度で Outlook からの E メールの送受信がブロックできるようになることが期待される状態でした。</p><p>しかしながら、このようなアクセス トークンの有効期間による CA ポリシーの適用タイミングの “ずれ” は厳密にセキュリティを確保するうえで問題となります。</p><h3 id="CAE-が有効化された後の考え方"><a href="#CAE-が有効化された後の考え方" class="headerlink" title="CAE が有効化された後の考え方"></a>CAE が有効化された後の考え方</h3><p>CAE はまさに上記の例のような “困った時間” をできるだけ生じさせず、組織リソースへのアクセスをリアルタイムで評価およびブロックできるようにすることを実現する技術となります。そのロジックの詳細は前述の CAE の Blog や公開情報に説明がありますが、ポイントは <strong>クライアントの利用環境が変化した際に SP 側でもリアルタイムにその環境変化を検知して、取得済みのアクセス トークンの有効期間に依存せず CA ポリシーの再評価タイミングを作る</strong> という考え方になります。</p><p>例えば 1 時間の有効期間のアクセス トークンを社内で取得し、それを保持したデバイスを持ってカフェで最新のメールをチェック (Outlook から Exchange Online にアクセス) しようとした場合を考えます。この時、ユーザーが社外に移動したということを検知するには、アクセスを受けた Exchange Online 側での対応が必要です。CAE が有効になると、CA のポリシー情報やユーザー情報 (AAD で認証を受けたときの場所など) が SP (Exchange Online) 側にも共有されるようになります。これにより、Exchange Online 側ではユーザーの場所の移動を検知することが可能となり、アクセス トークンの残りの有効期限にかかわらず、ユーザーを AAD に誘導して CA ポリシーを再評価できるようになります。つまり、1 時間の有効期間による “困った時間” を極力減らすことができるようになるのです。</p><p>このリアルタイムな検知機能により、アクセス トークンの有効期間に基づいて頻繁に AAD にユーザーをアクセスさせる必要がなくなりますので、現在 CAE が有効 (既定で有効) な AAD テナントでは、アクセストークンの有効期間が最大で 28 時間 (Long lived) となっています。CAE が有効なテナントでアクセス トークンの有効期間が 28 時間に延長されたのはこのためです。従来は 1 時間毎であった CA ポリシーのチェックが、アクセス トークンの有効期間に関わらずリアルタイムに行え、よりセキュリティが高まったため、トークンの有効期間を延ばすようになったとお考えください。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/cae-overview/index.html">CAE (Continuous Access Evaluation: 継続的アクセス評価)</a></p><p>CAE が無効な場合、もしくは CAE は有効だが利用するリソースが CAE に対応していない場合は、アクセス トークンの有効期間は 60-90 分となり、以前の [1 時間のアクセス トークン] 利用時とほぼ同様の考え方になります。</p><h2 id="トークンの更新タイミングの考え方"><a href="#トークンの更新タイミングの考え方" class="headerlink" title="トークンの更新タイミングの考え方"></a>トークンの更新タイミングの考え方</h2><h3 id="ADAL-MSAL-先進認証-クライアント利用時のトークン取得-更新の考え方"><a href="#ADAL-MSAL-先進認証-クライアント利用時のトークン取得-更新の考え方" class="headerlink" title="ADAL/MSAL (先進認証) クライアント利用時のトークン取得/更新の考え方"></a>ADAL/MSAL (先進認証) クライアント利用時のトークン取得/更新の考え方</h3><p>クライアントが更新トークンや PRT を保持している場合、アクセス トークンが必要になるとクライアントは AAD に (すでに保持済みの) 更新トークンおよび PRT を提示することで、再度新しいアクセス トークンを非対話的 (明示的な認証操作を必要とせず) に取得することが可能です。他の言い方をすると <strong>更新トークンおよび PRT を保持していれば、アクセス トークンはいつでも必要なタイミングで非対話的に取得が可能</strong> です。</p><p><img src="/blog/azure-active-directory/token-lifetime-2023/msal-token-flow.png"></p><p>ID トークンは OpenID Connect の流れにおいて、認証後に ID の属性情報をアプリに提示するためのトークンであり、初回のアプリへのアクセス時に参照された後は再利用されることが無いのが一般的です。そのため、上記の図では初回のアプリへのアクセスに伴う認証時のみ取得している表現としています。</p><p>一度更新トークンもしくは PRT を取得後に、改めて対話的な認証が必要となるケースは以下の通りです。</p><ul><li>90 日間以上クライアント アプリを停止した状態を維持する (ほぼ 90 日以上 OS をシャットダウン or インターネット疎通できない状態にしているようなケース)</li><li>認証した AAD ユーザーのパスワードを変更する</li><li>対象ユーザーに発行済みの更新トークンを AAD 側で意図的に失効させる</li></ul><h3 id="ブラウザーのトークン取得および更新の考え方"><a href="#ブラウザーのトークン取得および更新の考え方" class="headerlink" title="ブラウザーのトークン取得および更新の考え方"></a>ブラウザーのトークン取得および更新の考え方</h3><h4 id="非永続セッション-Cookie-の場合"><a href="#非永続セッション-Cookie-の場合" class="headerlink" title="非永続セッション (Cookie) の場合"></a>非永続セッション (Cookie) の場合</h4><p><img src="/blog/azure-active-directory/token-lifetime-2023/browser-non-persist.png"></p><p>改めて対話的な認証が必要となるケースは以下のとおりです。</p><ul><li>ブラウザーでリソースへのアクセスを行ってブラウザーを開いたまま 24 時間以上操作を行わない</li><li>ブラウザーでリソースへのアクセスを行いブラウザーを開いたまま AAD ユーザーのパスワードを変更する</li><li>ブラウザーを閉じる</li></ul><div class="alert is-info"><p class="alert-title">Note</p><p>PRT を取得済みのクライアントの場合もしくはブラウザーが PRT を利用できる場合は対話的な認証を必要とせずにアクセストークンおよびセッション トークンを取得可能です。ブラウザーが PRT を利用できるようにするためには、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#supported-browsers">サポートされているブラウザー</a> にてそれぞれ個別の構成が必要な場合があります。</p></div><h4 id="永続セッション-Cookie-の場合"><a href="#永続セッション-Cookie-の場合" class="headerlink" title="永続セッション (Cookie) の場合"></a>永続セッション (Cookie) の場合</h4><p><img src="/blog/azure-active-directory/token-lifetime-2023/browser-persist.png"></p><p>改めて対話的な認証が必要となるケースは以下のとおりです。</p><ul><li>ブラウザーでリソースへのアクセスを行ってブラウザーを開いたまま 90 日以上操作を行わない</li><li>ブラウザーでリソースへのアクセスを行いブラウザーを開いたまま AAD ユーザーのパスワードを変更する</li><li>クライアント端末のローカルに保存されている Cookie のキャッシュをクリアする</li></ul><h2 id="トークンの有効期間の制御"><a href="#トークンの有効期間の制御" class="headerlink" title="トークンの有効期間の制御"></a>トークンの有効期間の制御</h2><p>以前はトークンの有効期間を変更したい場合、PowerShell を用いてトークン ライフタイム ポリシーを AAD に構成する機能が提供されておりました。しかし、2021 年 1 月 30 日より、この “トークン ライフタイム ポリシーを用いた更新トークンとセッショントークンの有効期間を制御する機能” は廃止されています。詳細については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/configurable-token-lifetimes">Token lifetime policies for refresh tokens and session tokens</a> もご覧ください。</p><p>アクセス トークンに関しては、トークン ライフタイム ポリシーを用いた有効期間の制御が現状でも利用可能です。以前は、上述のように “1 時間のアクセス トークン” による “困った時間” を最小化するため、極力短い (10 分間) アクセス トークンの有効期間を設定したいというご要望もよくございました。しかし、CAE を用いた動的 (ポリシーの有効期間に依存しない) かつリアルタイムな CA ポリシーの評価が行える昨今では、アクセス トークンの有効期間を (主に短時間に) カスタムする運用は推奨されません。また、トークン ライフタイム ポリシーはプレビュー状態であり、運用環境への適用もお勧めできない状況です。</p><p>このため、アクセス トークンの有効期間をどうするかという観点というよりも、<strong>CA ポリシーをリアルタイムに適用したいのであれば CAE を有効にする</strong> こと、<strong>対話的な認証を再度求められるタイミングを制御したいという要件の場合は CA ポリシーのサインインの頻度 (SIF) の機能を利用すること</strong> をご検討ください。</p><p>サインインの頻度 (SIF) の機能については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime#user-sign-in-frequency">条件付きアクセスを使用して認証セッション管理を構成する</a> をご覧ください。サインインの頻度は、CA のポリシーとして適用する機能となるため、適用対象のユーザー/アプリケーションの条件を柔軟に指定することが可能です。</p><h2 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h2><p>この数年で AAD は条件付きアクセスをはじめ、セキュリティと利便性のバランスを踏まえた、多様な制御機能の公開とアップデートが行われています。例えばここまでのご案内でご紹介した機能以外にも、リスクが高い認証 (漏洩したパスワードや普段とは違う場所や国からのアクセス) 時には、MFA を要求しパスワードの変更も強制するというアクセス制御を CA で行うことも可能です。前述の CAE もそうですが、このような “クライアントの動的な環境やリスクの変化を、可能な限りリアルタイムに検出してそのレベルに応じたアクセス制御を行う” ような考え方によって、よりご利用者様にとってもストレスが無い状態で高いセキュリティ環境を維持するアプローチがとれるようになってきています。</p><p>また、Windows Hello for Business のように、<strong>高い強度の認証を突破した後は、ユーザーに極力再認証を求めないことで、パスワードそのものを利用者様が扱う機会を減らす</strong> というアプローチも増えてきています。</p><p><strong>必ず 1 時間に 1 回の頻度で対話的な認証を行えば、確認の頻度が上がるからセキュリティが安心！という考え方は逆にセキュリティを低める</strong> ことが報告されており、このような考え方からは大きく方向転換が必要かと思います。最新の仕組みを取り入れることで、セキュリティと利便性をトレードオフとすることなく、セキュリティを高めつつ利用者様への運用負担も減らすという “良いとこどり” が実現できるはずです。トークンの有効期間をベースとした静的なセキュリティから、ご利用者様の環境やリスクの変化を元にした動的なセキュリティの世界に進んでいくことを願ってやみません。</p><p>上記内容が皆様の参考となりますと幸いです。どちら様も素敵な AAD ライフをお過ごしください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は、2018 年公開の以下の Blog の内容が、現在の機能/技術にマッチしない内容になってきたことを踏まえ、2023 年現在の機能/技術を元に改めて考</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Token" scheme="https://jpazureid.github.io/blog/tags/Token/"/>
    
    <category term="OAuth" scheme="https://jpazureid.github.io/blog/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>MFA と SSPR を新しい認証方法ポリシーに移行する方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/how-to-authentication-methods-manage/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/how-to-authentication-methods-manage/</id>
    <published>2023-06-23T00:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.115Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの田辺です。</p><p>今回は、Azure AD における認証方法ポリシーの移行方法についてご紹介します。これまで MFA (Multi-Factor Authentication) と SSPR (Self Service Password Reset) で利用可能な認証方法はそれぞれ個別の画面で別々に管理されていました。現在これら別々の管理画面はレガシーな管理方法として扱われており、今後、この 2 種類のレガシー ポリシーを統一した、新しい認証方法ポリシーにて一元管理することが必要となっています。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/manage1.png"></p><p>レガシーな MFA と SSPR 用のポリシーは <strong>2024 年 9 月 30 日</strong> に非推奨となり、この期日までに新しい認証方法ポリシーに移行いただく必要がございます。適切に移行いただければ、現在と動作に変わりはなく、また今後よりきめ細かい制御も可能となります。</p><p>レガシー MFA と SSPR のポリシーの確認方法および新しい認証方法ポリシーへの移行方法につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-authentication-methods-manage">MFA と SSPR のポリシー設定を Azure AD の認証方法ポリシーに移行する方法</a> の公開情報にまとめられておりますのでご覧ください。</p><p>本ブログ記事では、上記の公開情報で案内されている認証方法ポリシーの移行方法と、よくあるご質問について情報をおまとめいたしました。2024 年 9 月が近づきますと、移行が差し迫り混乱が予想されますので、可能な限り速やかに下記対応を実施することをお勧めいたします。</p><p>なお、移行作業は 3 段階に分かれており、それぞれの段階は数十分から 1 時間程度で完了可能と思われます。移行中にダウンタイムが生じることはありませんし、適切に構成いただければ、基本的にユーザー影響が生じることもありません。万が一、予期せぬ動作が生じた際には設定を切り戻すことも可能です。</p><h2 id="1-開始する前の確認事項"><a href="#1-開始する前の確認事項" class="headerlink" title="1. 開始する前の確認事項"></a>1. 開始する前の確認事項</h2><p>はじめに、お客様のテナントにおける各レガシー ポリシーの設定をご確認ください。</p><h3 id="レガシー-MFA-ポリシーの設定の確認"><a href="#レガシー-MFA-ポリシーの設定の確認" class="headerlink" title="レガシー MFA ポリシーの設定の確認"></a>レガシー MFA ポリシーの設定の確認</h3><p>MFA で利用可能な認証方法の設定について確認します。</p><ol><li><p>[Azure Portal] &gt; [Azure Active Directory] &gt; [ユーザー] &gt; [ユーザーごとの MFA] に移動します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/legacy-mfa-1.png"></p></li><li><p>[サービス設定] に移動します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/legacy-mfa-2.png"></p></li><li><p>[検証オプション] 項目からどの項目にチェックが入っているかを控えます。これがレガシー MFA ポリシーの設定です。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/legacy-mfa-3.png"></p></li></ol><p>上記のスクリーンショットでは、ユーザーが利用可能な MFA の方法として、3 つがチェックされていることがわかります。これは、ユーザーが MFA を要求された際に、これらいずれかの方法を利用して (登録済みであれば) 認証を行えるということを意味します。</p><p>なお、Azure AD Premium ライセンスを保有されている場合は、 [Azure Active Directory] &gt; [セキュリティ] &gt; [多要素認証] &gt; [クラウドベースの多要素認証の追加設定] でも上記画面に遷移可能です。</p><h3 id="レガシー-SSPR-ポリシーの設定の確認"><a href="#レガシー-SSPR-ポリシーの設定の確認" class="headerlink" title="レガシー SSPR ポリシーの設定の確認"></a>レガシー SSPR ポリシーの設定の確認</h3><p>次に、SSPR で利用可能な認証方法の設定について確認します。</p><ol><li>[Azure Active Directory] &gt; [パスワード リセット] &gt; [認証方法] に移動します。</li><li>以下の [ユーザーが使用できる方法] でどの項目にチェックが入っているかを確認します。これがレガシー SSPR ポリシーの設定です。<img src="/blog/azure-active-directory/how-to-authentication-methods-manage/legacy-sspr-1.png"></li></ol><p>例えば、上記のスクリーンショットでは、ユーザーが利用可能な SSPR の方法として、[電子メール] または [携帯電話] にチェックされていることがわかります。これは、レガシー MFA ポリシーと同様に、ユーザーが上記のいずれかの方法を利用して SSPR を行うことができるということを意味しています。</p><h3 id="新しい認証方法ポリシーの確認"><a href="#新しい認証方法ポリシーの確認" class="headerlink" title="新しい認証方法ポリシーの確認"></a>新しい認証方法ポリシーの確認</h3><p>新しい認証方法ポリシーについては、[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] から確認します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/new-1.png"></p><p>既定ではほとんどの設定の有効状態が [いいえ] となっているはずです。</p><h2 id="2-移行の開始"><a href="#2-移行の開始" class="headerlink" title="2. 移行の開始"></a>2. 移行の開始</h2><p><a href="#1-%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AE%E7%A2%BA%E8%AA%8D%E4%BA%8B%E9%A0%85">上記手順</a>で、現在のポリシーの設定を確認したら、次に現在の認証方法ポリシーの移行状態を確認します。</p><h3 id="現在の移行状態の確認"><a href="#現在の移行状態の確認" class="headerlink" title="現在の移行状態の確認"></a>現在の移行状態の確認</h3><ol><li><p>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] に移動します。</p></li><li><p>[移行の管理] を選択します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/new-2.png"></p></li><li><p>画面右に表示される項目から、現在は [移行前] の状態にあることを確認します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/new-3.png"></p></li></ol><p>併せて、今後の移行ステップである [移行が進行中] と [移行が完了済み] についてもそれぞれの意味を確認ください。移行の各ステップでどのポリシーの設定が参照されるかついては、[移行の管理] の項目の設定状況に依存します。各ステップで参照されるポリシーについて以下にまとめましたのでご覧ください。</p><table><thead><tr><th>移行の管理の各オプション</th><th>種類</th><th>参照されるポリシー</th></tr></thead><tbody><tr><td>移行前</td><td>MFA</td><td>認証方法ポリシーとレガシー MFA ポリシー</td></tr><tr><td>〃</td><td>SSPR</td><td>レガシー SSPR ポリシーのみ</td></tr><tr><td>移行が進行中</td><td>MFA</td><td>認証方法ポリシーとレガシー MFA ポリシー</td></tr><tr><td>〃</td><td>SSPR</td><td>認証方法ポリシーとレガシー SSPR ポリシー</td></tr><tr><td>移行が完了済み</td><td>MFA</td><td>認証方法ポリシーのみ</td></tr><tr><td>〃</td><td>SSPR</td><td>認証方法ポリシーのみ</td></tr></tbody></table><p>例えば、移行前の状態では、MFA においては「認証方法ポリシーとレガシー MFA ポリシー」が両方参照されます。これは認証方法の有効状態は、認証方法ポリシーとレガシー MFA/SSPR ポリシーの有効状態の <strong>和 (OR)</strong> で行われるという意味です。これまでの例ですと、認証方法ポリシーはほぼすべてが [いいえ] であり、レガシー MFA ポリシーは以下の 3 つにチェックが入っていた状況でした。この場合、認証方法ポリシーがすべてが [いいえ] であっても、レガシー MFA ポリシーで有効な認証方法が 3 つありますので、引き続きこれら 3 つのポリシーが有効になるという結果になります。</p><ul><li>電話へのテキスト メッセージ</li><li>モバイル アプによる通知</li><li>モバイル アプリからの確認コードまたはハードウェア トークンからの確認コード</li></ul><h3 id="移行状態の-移行が進行中-への変更"><a href="#移行状態の-移行が進行中-への変更" class="headerlink" title="移行状態の [移行が進行中] への変更"></a>移行状態の [移行が進行中] への変更</h3><p>まずは移行の管理画面から移行のステップを一つ進めます。[移行が進行中] を選択し、[保存] を選択します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/new-4.png"></p><p>上記のように移行の状態を [移行が進行中] に保存しても、認証方法ポリシーとレガシー ポリシーの両方が評価されるため、これまで利用できていた認証方法が使えなくなるということはありません。</p><div class="alert is-info"><p class="alert-title">Note</p><p>この変更により、MFA で利用を許可していた認証方法が SSPR においても追加で利用可能となります。通常は MFA で使用している認証方法をそのまま SSPR でも利用することが一般的であるため、ほとんどのお客様でユーザー影響はないと想定されますが、SSPR への影響を懸念されるお客様はこの時点では移行のステップを [移行が進行中] に変更せず、一旦以降の手順を確認されることをお勧めします。</p></div><h3 id="レガシー-MFA-ポリシーの認証方法ポリシーへの移行"><a href="#レガシー-MFA-ポリシーの認証方法ポリシーへの移行" class="headerlink" title="レガシー MFA ポリシーの認証方法ポリシーへの移行"></a>レガシー MFA ポリシーの認証方法ポリシーへの移行</h3><p>それでは、まずレガシー MFA ポリシーの設定内容を認証方法ポリシーに設定する作業を開始しましょう。下表を参照し、<a href="#1-%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AE%E7%A2%BA%E8%AA%8D%E4%BA%8B%E9%A0%85">1. 開始する前の確認事項</a> で確認した レガシー MFA ポリシーの設定内容に対応する認証方法ポリシーを有効にします。</p><table><thead><tr><th>レガシー MFA ポリシー</th><th>対応する認証方法ポリシー</th></tr></thead><tbody><tr><td>電話への連絡</td><td><a href="#%E9%9F%B3%E5%A3%B0%E9%80%9A%E8%A9%B1">音声通話</a></td></tr><tr><td>電話へのテキスト メッセージ</td><td><a href="#SMS">SMS</a></td></tr><tr><td>モバイル アプによる通知</td><td><a href="#Microsoft-Authenticator">Microsoft Authenticator</a></td></tr><tr><td>モバイル アプリからの確認コードまたはハードウェア トークンからの確認コード</td><td><a href="#%E3%82%B5%E3%83%BC%E3%83%89-%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E8%A3%BD%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2-OATH-%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3">サード パーティ製のソフトウェア OATH トークン</a> <br> <a href="#%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2-OATH-%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3-%E8%BF%91%E6%97%A5%E5%85%AC%E9%96%8B%E4%BA%88%E5%AE%9A">ハードウェア OATH トークン (近日公開予定)</a> <br> <a href="#Microsoft-Authenticator">Microsoft Authenticator</a></td></tr></tbody></table><p>本記事の例ですと、レガシー MFA ポリシーの設定画面では、以下の 3 つの認証方法が有効でした。この場合は、上記表でそれぞれレガシー MFA ポリシーに対応する認証方法を認証方法ポリシーの画面で有効にします。</p><ul><li>電話へのテキスト メッセージ</li><li>モバイル アプリによる通知</li><li>モバイル アプリからの確認コードまたはハードウェア トークンからの確認コード</li></ul><p>設定の実施後の認証方法ポリシーの画面 (本記事での例) は以下のようになります。お客様でも、事前に控えておいたレガシー MFA ポリシーの設定状況を用いて認証方法ポリシーを同じように変更ください。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/image-after-mfa.png"></p><h3 id="レガシー-SSPR-ポリシーの認証方法ポリシーへの移行"><a href="#レガシー-SSPR-ポリシーの認証方法ポリシーへの移行" class="headerlink" title="レガシー SSPR ポリシーの認証方法ポリシーへの移行"></a>レガシー SSPR ポリシーの認証方法ポリシーへの移行</h3><p>レガシー MFA ポリシーの認証方法ポリシーへの移行が完了したら、次にレガシー SSPR ポリシーの内容を認証方法ポリシーに移行します。レガシー MFA ポリシーの移行時と同様に、下表を参照し、<a href="#1-%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AE%E7%A2%BA%E8%AA%8D%E4%BA%8B%E9%A0%85">1. 開始する前の確認事項</a> で確認したレガシー SSPR ポリシーの設定内容を、対応する認証方法ポリシーで有効にします。</p><table><thead><tr><th>レガシー SSPR ポリシー</th><th>対応する認証方法ポリシー</th></tr></thead><tbody><tr><td>モバイル アプリの通知</td><td><a href="#Microsoft-Authenticator">Microsoft Authenticator</a></td></tr><tr><td>モバイル アプリ コード</td><td><a href="#Microsoft-Authenticator">Microsoft Authenticator</a> <br> <a href="#%E3%82%B5%E3%83%BC%E3%83%89-%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E8%A3%BD%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2-OATH-%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3">サード パーティ製のソフトウェア OATH トークン</a></td></tr><tr><td>電子メール</td><td><a href="#%E3%83%A1%E3%83%BC%E3%83%AB-OTP">メール OTP</a></td></tr><tr><td>携帯電話</td><td><a href="#%E9%9F%B3%E5%A3%B0%E9%80%9A%E8%A9%B1">音声通話</a> <br> <a href="#SMS">SMS</a></td></tr><tr><td>会社電話</td><td><a href="#%E9%9F%B3%E5%A3%B0%E9%80%9A%E8%A9%B1">音声通話</a></td></tr><tr><td>秘密の質問</td><td><a href="#%E7%A7%98%E5%AF%86%E3%81%AE%E8%B3%AA%E5%95%8F-%E8%BF%91%E6%97%A5%E5%85%AC%E9%96%8B%E4%BA%88%E5%AE%9A">秘密の質問 (近日公開予定)</a></td></tr></tbody></table><p>本記事の例では、レガシー SSPR ポリシーにおいては上述のとおり [電子メール] と [携帯電話] がチェックされている状況でした。このため、上記表でそれぞれ [電子メール] と [携帯電話] に対応する認証方法ポリシーの設定を有効にします。</p><p>設定の実施後の認証方法ポリシーの画面 (本記事での例) は以下のようになります。お客様でも、事前に控えておいたレガシー SSPR ポリシーの設定状況を用いて認証方法ポリシーを同じように変更ください。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/image-after-sspr.png"></p><h2 id="3-移行が進行中での状態の確認"><a href="#3-移行が進行中での状態の確認" class="headerlink" title="3. 移行が進行中での状態の確認"></a>3. 移行が進行中での状態の確認</h2><p>以上の手順が完了したら、まずはユーザー影響が生じていないかなどを念のためご確認ください。特段影響がなければ、しばらくそのまま運用いただいてもかまいません。しばらく上記状態で運用いただき、移行を完了する準備が整ったら、以下の作業を進めます。</p><h2 id="4-移行の完了"><a href="#4-移行の完了" class="headerlink" title="4. 移行の完了"></a>4. 移行の完了</h2><p>[移行が進行中] の状態にてご要望の認証方法が使用可能となるよう新しい認証方法ポリシーを設定できたら、次のステップとして、レガシー MFA および SSPR ポリシーのチェックをすべて外して無効にします (全て一度に外すのが不安な場合は、一つずつ時間をかけてチェックを外していただいてもかまいません)。</p><p>上述のとおり、各認証方法の有効状態は、認証方法ポリシーとレガシー MFA/SSPR ポリシーの有効状態の和 (OR) で評価されます。このため、認証方法ポリシーにおいて各認証方法が適切に有効になっていれば、レガシー MFA/SSPR ポリシーのチェックをすべて外しても、引き続き認証方法ポリシーの設定が評価され各認証方法は有効状態となります。</p><p>レガシー MFA および SSPR ポリシーのチェックをすべて外して無効にした後、念のため、テナントにてご要望の認証方法が MFA と SSPR の双方で利用可能かご確認ください。ユーザー影響を確認するため、しばらくその状態で運用いただいてもかまいません。</p><p>動作確認が完了したら、移行のステップを [移行が進行中] から [移行が完了済み] に変更します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/finish.png"></p><p>なお、テナントにてレガシー ポリシーが有効な場合には [移行が完了済み] に変更することは出来ません。</p><p>[移行が完了済み] に変更すると、レガシー ポリシーについては以下のような表示となり、新しい認証方法ポリシーによって管理されていることが明記されます。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/mfa-finish.png" alt="[移行が完了済み] に移行後のレガシー MFA ポリシー ([検証オプション])"></p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/sspr-finish.png" alt="[移行が完了済み] に移行後のレガシー SSPR ポリシー ([パスワード リセット] &gt; [認証方法])"></p><p>[移行が完了済み] になりましたら、一連の移行作業はすべて完了です。今後はレガシー ポリシーではなく、新しい認証ポリシーの画面にて認証方法の構成を実施ください。</p><h2 id="参考-各認証方法の設定の詳細"><a href="#参考-各認証方法の設定の詳細" class="headerlink" title="参考: 各認証方法の設定の詳細"></a>参考: 各認証方法の設定の詳細</h2><p>各認証方法ごとに、設定内容の詳細と設定の変更手順をおまとめいたします。大まかな手順を上記内容で把握した後で下記詳細をご確認ください。認証方法ポリシーについては、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-methods-manage">Azure AD の認証方法を管理する</a> の公開情報でもご案内しておりますので、ご参照ください。</p><h3 id="Microsoft-Authenticator"><a href="#Microsoft-Authenticator" class="headerlink" title="Microsoft Authenticator"></a>Microsoft Authenticator</h3><h4 id="移行の条件"><a href="#移行の条件" class="headerlink" title="移行の条件"></a>移行の条件</h4><ul><li>レガシー MFA ポリシーで [モバイル アプリによる通知] が有効または、レガシー SSPR ポリシーで [モバイル アプリの通知] が有効な場合、認証方法ポリシーで [Microsoft Authenticator] を有効にします。</li><li>レガシー MFA ポリシーで [モバイル アプリまたはハードウェア トークンからの確認コード] が有効または、レガシー SSPR ポリシーで [モバイル アプリ コード] が有効な場合、[構成] タブで [Microsoft Authenticator OTP の使用を許可する] を [はい] に設定します。</li><li>プッシュ通知またはパスワードレス認証を許可するには、認証モードを [すべて] に設定します。どちらかを指定したい場合は、[パスワードレス] または [プッシュ] に変更します。</li></ul><h4 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h4><ol><li><p>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] &gt; [Microsoft Authenticator] に移動します。</p></li><li><p>[有効化およびターゲット] タブにて [有効にする] および、 [含める] &gt; [すべてのユーザー] を選択します。<br>必要に応じて、認証モードを変更します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/auth1.png"></p></li><li><p>[構成] タブの内容を確認します (既定のままで OK ですが、必要に応じて [Microsoft Authenticator OTP の使用を許可する] の設定などを変更します。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/auth2.png"></p></li><li><p>[保存] をクリックします。</p></li></ol><h3 id="SMS"><a href="#SMS" class="headerlink" title="SMS"></a>SMS</h3><h4 id="移行の条件-1"><a href="#移行の条件-1" class="headerlink" title="移行の条件"></a>移行の条件</h4><ul><li>レガシー MFA ポリシーで [電話へのテキスト メッセージ] が有効または、レガシー SSPR ポリシーで [携帯電話] が有効な場合、認証方法ポリシーで [SMS] を有効にします。</li></ul><h4 id="手順-1"><a href="#手順-1" class="headerlink" title="手順"></a>手順</h4><ol><li>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] &gt; [SMS] に移動します。</li><li>[有効化およびターゲット] タブにて [有効にする] および、 [含める] &gt; [すべてのユーザー] を選択します。</li><li>[保存] をクリックします。</li></ol><h3 id="サード-パーティ製のソフトウェア-OATH-トークン"><a href="#サード-パーティ製のソフトウェア-OATH-トークン" class="headerlink" title="サード パーティ製のソフトウェア OATH トークン"></a>サード パーティ製のソフトウェア OATH トークン</h3><h4 id="移行の条件-2"><a href="#移行の条件-2" class="headerlink" title="移行の条件"></a>移行の条件</h4><ul><li>レガシー MFA ポリシーで [モバイル アプリまたはハードウェア トークンからの確認コード] が有効または Microsoft Authenticator 以外のサードパーティー製のソフトウェア OATH トークンを許可したい場合、認証方法ポリシーで [サード パーティ製のソフトウェア OATH トークン] を有効にします。 </li></ul><h4 id="手順-2"><a href="#手順-2" class="headerlink" title="手順"></a>手順</h4><ol><li>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] &gt; [サード パーティ製のソフトウェア OATH トークン] に移動します。</li><li>[有効化およびターゲット] タブにて [有効にする] および、 [含める] &gt; [すべてのユーザー] を選択します。</li><li>[保存] をクリックします。</li></ol><h3 id="音声通話"><a href="#音声通話" class="headerlink" title="音声通話"></a>音声通話</h3><h4 id="移行の条件-3"><a href="#移行の条件-3" class="headerlink" title="移行の条件"></a>移行の条件</h4><ul><li>レガシー MFA ポリシーで [電話の呼び出し] が有効または レガシー SSPR ポリシーで [携帯電話] が有効な場合、認証方法ポリシーで [音声通話] を有効にします。 </li><li>レガシー SSPR ポリシーで [会社電話] を有効にしている等、会社電話を利用したい場合は、[構成] タブで [Office] オプションを選択します。</li></ul><h4 id="手順-3"><a href="#手順-3" class="headerlink" title="手順"></a>手順</h4><ol><li><p>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] &gt; [Microsoft Authenticator] に移動します。</p></li><li><p>[有効化およびターゲット] タブにて [有効にする] および、 [含める] &gt; [すべてのユーザー] を選択します。</p></li><li><p>必要に応じて、[構成] タブにて [Office] を有効にします。</p><p><img src="/blog/azure-active-directory/how-to-authentication-methods-manage/Office.png"></p></li><li><p>[保存] をクリックします。</p></li></ol><h3 id="メール-OTP"><a href="#メール-OTP" class="headerlink" title="メール OTP"></a>メール OTP</h3><h4 id="移行の条件-4"><a href="#移行の条件-4" class="headerlink" title="移行の条件"></a>移行の条件</h4><ul><li>レガシー SSPR ポリシーで [メール] を有効にしている場合、認証方法ポリシーで [メール OTP] を有効にします。 </li></ul><h4 id="手順-4"><a href="#手順-4" class="headerlink" title="手順"></a>手順</h4><ol><li>[Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー] &gt; [メール OTP] に移動します。</li><li>[有効化およびターゲット] タブにて [有効にする] および、 [含める] &gt; [すべてのユーザー] を選択します。</li><li>[保存] をクリックします。</li></ol><p>認証方法ポリシーの [メール OTP] の設定はゲストのメール ワンタイム パスコード (OTP) の設定にも影響します。[構成] タブの [外部ユーザーに電子メールの OTP の使用を許可する] コントロールが有効な場合、認証方法ポリシーの [メール OTP] を無効にすることはできません。</p><h3 id="ハードウェア-OATH-トークン-近日公開予定"><a href="#ハードウェア-OATH-トークン-近日公開予定" class="headerlink" title="ハードウェア OATH トークン (近日公開予定)"></a>ハードウェア OATH トークン (近日公開予定)</h3><p>認証方法ポリシーでは、[ハードウェア OATH トークン] は現在利用できません。現在パブリック プレビュー段階のハードウェア OATH トークンをご利用いただいている場合は、移行のステップを [移行が完了済み] に変更しないでください。</p><h3 id="秘密の質問-近日公開予定"><a href="#秘密の質問-近日公開予定" class="headerlink" title="秘密の質問 (近日公開予定)"></a>秘密の質問 (近日公開予定)</h3><p>認証方法ポリシーでは、[秘密の質問] は現在利用できません。秘密の質問をご利用いただいている場合は、レガシー SSPR ポリシーで [秘密の質問] を有効なままにしておいてください。レガシ SSPR ポリシーで [秘密の質問] が有効なままでも、移行のステップを [移行を完了済み] に変更できます。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p><strong>Q1.</strong> もし、2024 年 9 月 30 日 まで何もしなかった場合、どうなりますか。</p><p><strong>A1.</strong> 認証方法ポリシーへの移行を実施しなかった場合、これまでユーザーが利用していた認証方法が利用できなくなる可能性がございます。例えば、各ポリシーで以下のように設定していた場合、2024 年 9 月 30 日以降にレガシー MFA ポリシーが廃止されると、ユーザーは SMS による認証方法を利用できなくなることが予想されます。</p><table><thead><tr><th>ポリシー</th><th>設定</th></tr></thead><tbody><tr><td>レガシー MFA ポリシー</td><td>SMS による認証方法を有効に設定</td></tr><tr><td>認証方法ポリシー</td><td>SMS による認証方法を無効に設定</td></tr></tbody></table><p>このため、期日以降も想定どおりの認証方法を利用したい場合は、期日までに認証方法ポリシーに設定を以降いただく必要がございます。</p><p><strong>Q2.</strong> レガシー ポリシーへの切り戻しはできないでしょうか。</p><p><strong>A2.</strong> 万が一、何らか予期しない動作が生じた場合、レガシー ポリシーへ切り戻すことは可能です。この場合、一度「移行が完了済み」のステータスを以前のステータスに戻すこととなります。加えて、レガシー ポリシー側に以前の状態を手動で復元 (チェックボックスをつけなおす) する作業が必要です。一般的に、レガシー ポリシーへの切り戻しを行うよりも、発生している問題に応じて、新しいポリシー側の設定を見直す方がより効果的です。弊社サポート部門でも支援が可能ですので、その際はぜひお問い合わせください。</p><p><strong>Q3.</strong> 秘密の質問については近日公開予定ですが、それまでは、[移行が進行中] のままにしなければいけないのでしょうか。</p><p><strong>A3.</strong> いいえ、秘密の質問については、レガシー SSPR ポリシーで有効にしたままの状態で移行を完了できます。だたし、秘密の質問を使用していて、それらを無効にしたくない場合は、新しい認証方法ポリシーにて秘密の質問が使用可能になるまで、レガシー SSPR ポリシーで有効なままにしておいてください。</p><p>なお、現状では秘密の質問を認証方法の一つとして提供し続ける予定です。しかし、米国政府が発行している ID 標準 (NIST Special Publication 800-63B) では、ユーザー認証の方法として秘密の質問の利用が非推奨であることが挙げられます。弊社ではお客様に選択肢を提供するという意味で秘密の質問を認証方法の一つとして提供を続けますが、秘密の質問はパスワードと同様に記憶に基づく認証方法であり、認証強度の低い方法です。このため、秘密の質問ではなく、他の認証方法の利用も是非ご検討ください。</p><p>上記内容が皆様の参考となりますと幸いです。ご不明な点等がありましたら、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの田辺です。&lt;/p&gt;
&lt;p&gt;今回は、Azure AD における認証方法ポリシーの移行方法についてご紹介します。これまで MFA (Multi-Factor Authentication) と SSPR (</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://jpazureid.github.io/blog/tags/MFA/"/>
    
    <category term="SSPR" scheme="https://jpazureid.github.io/blog/tags/SSPR/"/>
    
  </entry>
  
  <entry>
    <title>Azure MFA 導入パターンを網羅的にご紹介！</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/MFA_configuration_scenarios/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/MFA_configuration_scenarios/</id>
    <published>2023-06-22T23:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.779Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は 2020 年に公開したものですが、サポートへのお問い合わせ状況などをふまえ、2023 年 6 月時点での最新の情報にアップデートいたしました。</p></div><p>こんにちは。Azure Identity チームの金森です。</p><p>弊社をはじめ、セキュリティに対する新しい考え方が次々と公開されており、おそらく [ユーザー名とパスワードだけで認証は安全！] とは考えない方がほとんどになってきたものと思います。最近の弊社の考え方をご紹介する以下のような Blog の内容も、弊社に限らず広まってきたように感じます。</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/zero-hype/">ゼロ ハイプ</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/new-tools-to-block-legacy-auth/">レガシー認証をブロックするための新しいツール</a></li></ul><p>また、リモート ワークを安全に実現したい！というご要望が高まっている昨今の状況に呼応した以下のような Blog も公開しておりますので、ぜひこちらもご参照ください。</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/faq-using-ca-to-secure-remote-access/">安全なリモート アクセスを実現するための条件付きアクセスに関するよくある質問</a></li></ul><p>セキュリティを高める方法は様々ですが、おそらく持っていない人を探す方が大変と思われる携帯電話/スマホを使って実現できる MFA (多要素認証) の導入が最もご検討いただきやすいと思われます。今回は、Azure MFA サービスを利用した MFA の実現方法について、2023 年 6 月時点の情報を元に以下の観点でご紹介いたします！</p><ol><li><strong>Azure MFA サービスを利用するためのライセンス</strong></li><li><strong>Azure MFA サービスを利用する際の構成要素の考え方</strong></li><li><strong>Azure MFA サービスの利用パターン</strong></li></ol><p>なお、本記事では以下の主旨でご案内を進めていきますので、前提としてご認識ください。</p><ul><li>Microsoft アカウント (MSA) は Azure MFA サービスを用いた MFA ではないため本記事の対象外です。</li><li>プライマリ認証 (通常はユーザー名/パスワード) に対する追加の認証方式としての MFA (多要素認証) を本記事の対象とします。</li><li>プライマリ認証をパスワードレスの認証方式 (Authenticator アプリを使用、もしくは FIDO2 キーを使用) にする考え方は、本記事では主旨が別になるため扱いません。</li></ul><p>パスワードレスの認証方式については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-passwordless">Azure Active Directory のパスワードレス認証オプション</a> をご参照ください。</p><h2 id="1-Azure-MFA-サービスを利用するためのライセンス"><a href="#1-Azure-MFA-サービスを利用するためのライセンス" class="headerlink" title="1. Azure MFA サービスを利用するためのライセンス"></a>1. Azure MFA サービスを利用するためのライセンス</h2><p>Azure MFA サービスを利用するために、MFA を利用するユーザー毎に必要なライセンスは、技術情報としても公開されていますが、シンプルにまとめると以下のような考え方になります。上から下に向かって利用できる利用可能な機能は追加されていきます。例えば Security Defaults は Azure AD Premium を付与されている場合にも利用できます。</p><p>ただし、Security Defaults は、条件付きアクセス ポリシーを構成している環境では有効にすることはできないことにご注意ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-mfa-licensing">Azure Multi-Factor Authentication の機能とライセンス</a></p><table><thead><tr><th align="left">ライセンスの種類</th><th align="left">利用可能な MFA 機能</th><th align="left">カスタマイズ性</th></tr></thead><tbody><tr><td align="left">Azure AD Free (MFA 用のライセンス不要)</td><td align="left">Security Defaults</td><td align="left">×</td></tr><tr><td align="left">すべての Microsoft 365 プラン</td><td align="left">ユーザーごとの MFA (Per-user MFA)</td><td align="left">△</td></tr><tr><td align="left">Azure AD Premium P1 (EMS E3 or Microsoft 365 E3 含む)</td><td align="left">条件付きアクセス (ヒント参照)</td><td align="left">○</td></tr><tr><td align="left">Azure AD Premium P2 (EMS E5 or Microsoft 365 E5 含む)</td><td align="left">リスクベースの条件付きアクセス</td><td align="left">○</td></tr></tbody></table><div class="alert is-success"><p class="alert-title">ヒント</p><p>他に NPS 拡張や Always on VPN、ADFS サーバーとの連携、MFA Server との連携もご利用シナリオがあります。</p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure AD Premium P1 ライセンス以上をお持ちの場合は、”ユーザーごとの MFA (Per-user MFA)” ではなく、条件付きアクセスを使用してユーザーに MFA を求めることが推奨です。”ユーザーごとの MFA (Per-user MFA)” はレガシーな MFA 設定として現在扱われています。</p></div><p>例外的な対象は以下のとおりです。</p><ul><li>AAD テナントの全体管理者の権限を持つユーザーは、MFA 用のライセンスが無い場合も Authenticator 以外の MFA 方法 (SMS) がご利用可能です。</li><li>Microsoft 365 Business Premium ライセンスは、Azure AD Premium P1 と同等の条件付きアクセスの機能が利用できます: <a href="https://learn.microsoft.com/ja-jp/microsoft-365/business-premium/secure-your-business-data?view=o365-worldwide#1-use-multi-factor-authentication">ビジネス向け Microsoft 365 を使用してデータをセキュリティで保護する</a></li></ul><p>それぞれの機能ごとのカスタマイズ性や (すべてではありませんが) 機能を利用するうえでのシナリオ例をまとめたものが以下となります。</p><table><thead><tr><th align="left">対象機能</th><th align="left">カスタマイズ性の詳細</th><th align="left">選択シナリオ例</th></tr></thead><tbody><tr><td align="left">Security Default s</td><td align="left"><ul><li>テナントに対する機能の有効/無効のみが設定できる</li><li>機能の有効/無効以外の設定はできない (ユーザー毎、アクセス先などで条件を変える等)</li><li>すべての AAD ユーザーが MFA の方法をセットアップする必要がある</li><Li>MFA の方法として Authenticator アプリでの通知を利用できる</li><li>特定の特権ユーザー (管理者ロールを保持) には、サインイン時に MFA が求められる</li><li>一般ユーザーに対しても “必要に応じて” サインイン時に MFA が求められる<br>(一般ユーザーがサインイン時に MFA を求められる条件は非公開)</li><li>レガシー認証 (Outlook 2010 や POP/IMAP/SMTP など) はブロックされる</li><li>Azure の管理用での接続である Azure PowerShell, Azure CLI, Azure ポータルへのサインインは MFA が求められる</li><li>条件付きアクセス ポリシーと本機能は共存不可。条件付きアクセス ポリシーを作成すると本機能は利用できなくなる</li></ul></td><td align="left"><ul><li>カスタマイズ性はなくても無料で MFA を使いたい！とお考えの方 (ただし、一般ユーザーについては必ずしも MFA が求められるわけではないことはご注意を)</li><li>ある程度のセキュリティが実現できれば良いとお考えの方</li></ul></td></tr><tr><td align="left">ユーザーごとの MFA (Per-user MFA)</td><td align="left"><ul><li>AAD ユーザー毎に MFA の有効/無効の設定ができる</li><li>最終的にアクセスしたいサービスは問わず、AAD へのサインインすべてが MFA の対象となる</li><li>MFA が必要 (有効) とされたユーザーのみが MFA の方法をセットアップする必要がある</li><li>MFA の方法として、Authenticator だけではなく電話 (SMS/音声) や OATH トークンも利用可能</li><li>[どの MFA の認証方法をセットアップ可能とするか] という制限もテナント全体で可能</li><li>[信頼できる IP] を登録し、その IP からの認証時には MFA をスキップさせる設定が可能</li><li>[MFA の記憶] 機能で、一度 MFA をすると指定した日数は MFA を求めないようにすることが可能</li><li>アプリケーション パスワード (レガシ認証で MFA 要求をスキップするための専用パスワード) を利用可能</li></ul></td><td align="left"><ul><li>Office 365 のライセンスをお持ちの方</li><li>ユーザーによって MFA の有効/無効を制御したいとお考えの方</li><li>グループ単位やアクセスしたいサービス毎に MFA の有効/無効は制御しなくても良いとお考えの方</li></ul></td></tr><tr><td align="left">条件付きアクセス</td><td align="left"><ul><li>AAD ユーザー毎だけではなく、グループ毎でも MFA の有効/無効の設定ができる</li><li>最終的にアクセスしたいサービス毎に MFA の有効/無効の設定ができる</li><li>接続元クライアントの OS の種類、IP (場所) なども条件として指定することができる</li><li>MFA を求める以外の制御 (ブロックやデバイス認証が必要など) を指定できる</li><li>Azure MFA ポータルのオプション機能を利用することができる</li><li>アプリケーション パスワードは利用できない (レガシはスルーで認証する、という設定は可能だが非推奨)</li></ul></td><td align="left"><ul><li>グループ単位で MFA の有効/無効を制御したいとお考えの方</li><li>アクセスしたいサービス毎に MFA の有効/無効を制御したいとお考えの方</li><li>MFA が必要という制御以外にブロックなど他の制御も条件に応じて実現されたい方</li><li>接続元デバイス (Hybrid Azure AD Join 済みデバイス、Intune ポリシー準拠済みデバイス) の条件毎に MFA の有効/無効を制御したいとお考えの方</li></ul></td></tr><tr><td align="left">リスクベースの条件付きアクセス</td><td align="left"><ul><li>すべてのユーザーに MFA の方法のセットアップを求めることができる (MFA ではなく “MFA が求められた場合の方法” のセットアップを求めることができる)</li><li>サインインのリスクが中以上と判定されたユーザーに対して MFA を求めることができる</li></ul></td><td align="left"><ul><li>危険なサインインが疑わしい場合に動的に MFA を求めたいとお考えの方</li><ul></td></tr></tbody></table><p>Security Defaults の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/concept-fundamentals-security-defaults">Azure AD のセキュリティの既定値群</a> をご参照ください。また、ユーザーごとの MFA (per User MFA) の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-mfasettings">ユーザーごとの Azure AD Multi-Factor Authentication を有効にしてサインイン イベントのセキュリティを確保する</a> をご参照ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>ユーザーごとの MFA (per User MFA) は上記の技術情報に記載の通り、”いつ MFA を求めさせるか” を柔軟に評価することができる条件付きアクセスや Security Defaults がご利用いただける環境では、融通が利かない点もあり、非推奨となります。</p></div><p>Azure MFA ポータルや条件付きアクセスで利用可能な MFA のオプション機能の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-mfasettings">Azure Multi-Factor Authentication の設定を構成する</a> をご参照ください。</p><p>条件付きアクセスの詳細は以下をご参照ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/overview">条件付きアクセスとは</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-azure-mfa">チュートリアル:Azure Multi-Factor Authentication を使用してユーザーのサインイン イベントのセキュリティを確保する</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-basic/">条件付きアクセスの基本的な考え方</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/qanda-conditional-access/">Azure AD の条件付きアクセスに関する Q&amp;A</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/howto-conditional-access-policy-risk">条件付きアクセス:リスクベースの条件付きアクセス</a></li></ul><h1 id="2-Azure-MFA-サービスを利用する際の構成要素の考え方"><a href="#2-Azure-MFA-サービスを利用する際の構成要素の考え方" class="headerlink" title="2. Azure MFA サービスを利用する際の構成要素の考え方"></a>2. Azure MFA サービスを利用する際の構成要素の考え方</h1><p>Azure MFA サービスをご利用いただくにあたって、MFA を実現するための構成要素を以下のように捉えていただくと分かりやすいかと思います。</p><table><thead><tr><th align="left">構成要素</th><th align="left">設定対象</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">Who</td><td align="left">MFA を必要とさせるユーザー</td><td align="left">誰に対して MFA を必要とするか</td></tr><tr><td align="left">When</td><td align="left">MFA を必要とさせるきっかけ</td><td align="left">いつ MFA を求めさせるか</td></tr><tr><td align="left">How</td><td align="left">SMS やモバイル アプリ等 MFA の実行方法</td><td align="left">どのような方法で MFA を実行するか</td></tr></tbody></table><p>上記 3 つの要素が揃って、初めてあるユーザーのサインイン時に MFA が求められるようになります。各機能毎のそれぞれの要素に対する考え方をまずは以下におまとめします。</p><table><thead><tr><th align="left">対象機能</th><th align="left">Who</th><th align="left">When</th><th align="left">How</th></tr></thead><tbody><tr><td align="left">Security Defaults (設定変更不可)</td><td align="left"><ul><li>特定の特権ユーザー</li><li>MFA を求める必要のある一般ユーザー</li><li>Azure 管理機能を利用するユーザー</li></ul></td><td align="left"><ul><li>特定の特権ユーザーの AAD への認証要求時</li><li>MFA を求める必要があると判断された一般ユーザーの AAD への認証要求時</li><li>Azure PowerShell, CLI, ポータルへの認証要求時</li></ul></td><td align="left">Authenticator アプリの通知/確認コード (テナントの全体管理者ユーザーは他の方法も利用可能)</td></tr><tr><td align="left">ユーザーごとの MFA (Per-user MFA)</td><td align="left">MFA を有効にしているユーザー</td><td align="left">AAD への認証要求時</td><td align="left">音声電話、SMS、Authenticator アプリの通知/確認コード、OATH トークン</td></tr><tr><td align="left">条件付きアクセス</td><td align="left">作成したポリシーの評価条件に該当するユーザー (条件は柔軟に指定可能)</td><td align="left">作成したポリシーの評価条件に該当する AAD への認証要求時</td><td align="left">音声電話、SMS、Authenticator アプリの通知/確認コード、OATH トークン</td></tr><tr><td align="left">リスクベースの条件付きアクセス</td><td align="left">サインインのリスクが中以上と判定されたユーザー</td><td align="left">サインインのリスクが中以上と判定された AAD への認証要求時</td><td align="left">音声電話、SMS、Authenticator アプリの通知/確認コード、OATH トークン</td></tr></tbody></table><p>Who と When はご利用になる各機能にて設定/提供されます。また、How (MFA の実行方法) は、各機能ではなく AAD ユーザー自身が保持する設定値になります。そのため、ご利用になる機能が変わっても、仮に MFA を求める機能を使用しない場合も How (MFA の実行方法) は AAD ユーザー毎に保持することが可能です。</p><p>また、各 AAD ユーザーは自身の How (MFA の実行方法) のセットアップを以下のタイミングで実行することが可能です。</p><ul><li>各機能から MFA の実行が求められるタイミングで、該当ユーザーの How がまだ未構成の場合</li><li>MFA の実行方法を <a href="https://aka.ms/mysecurityinfo">セットアップするサイト</a> を利用する</li></ul><p>上記のセットアップページに対し、ユーザーが Azure AD ユーザーとしてサインインすることで、現在設定済みの MFA 方法の確認や、新規 MFA 方法の登録、登録済み MFA 方法の削除等が行えます。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>無料版もしくは試用版の AAD テナントをご利用の方は、MFA の方法として音声電話 (Voice) はご利用いただけません。</p><p>SMS はご利用いただけますが、選択肢に音声電話が無いという状況の際には、無料/試用版の AAD テナントではご利用いただけないのが適切な状態ですのでご留意ください。</p></div><h2 id="3-Azure-MFA-サービスの利用パターン"><a href="#3-Azure-MFA-サービスの利用パターン" class="headerlink" title="3. Azure MFA サービスの利用パターン"></a>3. Azure MFA サービスの利用パターン</h2><p>ここまでのご案内は基本的に “クライアントから AAD へのサインイン時に Azure MFA サービスで MFA を求める” ことを前提としていました。しかし、Azure MFA はオンプレミスの他の認証システムとも連携することが可能です！つまりこれは、”Azure MFA サービスに話しかけているのがクライアント端末ではなく何らかのサーバー” になるようなパターンです。</p><p>それではざっくりとご利用いただける Azure MFA サービスの利用パターンを見てみましょう。</p><p><img src="/blog/azure-active-directory/MFA_configuration_scenarios/image.jpg" alt="MFA 構成パターン図"></p><p>それぞれのパターンごとに以下にご紹介いたします。たくさんあって大変… という印象もあるかもしれませんが、”どんな認証システムをご利用になっているか/なりたいか” が先にあるかと思いますので、そのご要件に沿って Azure MFA と連携できるかご検討ください。</p><h3 id="1-クライアントから-AAD-へのサインイン"><a href="#1-クライアントから-AAD-へのサインイン" class="headerlink" title="1. クライアントから AAD へのサインイン"></a>1. クライアントから AAD へのサインイン</h3><p>こちらのパターンはこれまでご紹介した機能が対象となります。</p><h3 id="2-NPS-Server-への-Always-on-VPN-認証時"><a href="#2-NPS-Server-への-Always-on-VPN-認証時" class="headerlink" title="2. NPS Server への Always on VPN 認証時"></a>2. NPS Server への Always on VPN 認証時</h3><p>こちらは、Windows 10 クライアントに対して Always On VPN を構成した際のオプションとして条件付きアクセスと連携して MFA 認証を求めるシナリオになります。</p><p><a href="https://learn.microsoft.com/ja-jp/Windows-server/remote/remote-access/tutorial-aovpn-deploy-setup">チュートリアル: Always On VPN を展開する - Always On VPN のインフラストラクチャを設定する</a><br>-&gt; Always On VPN 機能の概要です。</p><p><a href="https://learn.microsoft.com/ja-jp/Windows-server/remote//remote-access/how-to-aovpn-conditional-access">Azure AD を使用した VPN 接続への条件付きアクセス</a><br>-&gt; Always On VPN 機能をご利用になる際に、条件付きアクセスの機能と連携させることで MFA 認証を求める設定の手順です。</p><h3 id="3-AD-FS-へのフェデレーション認証時"><a href="#3-AD-FS-へのフェデレーション認証時" class="headerlink" title="3. AD FS へのフェデレーション認証時"></a>3. AD FS へのフェデレーション認証時</h3><p>こちらは、AD FS へのフェデレーション認証時に [ADFS サーバーが直接 Azure MFA サービスと連携] することで、MFA 認証を求めるシナリオになります。主なポイントは以下のとおりです。</p><ul><li>AD FS サーバーは Windows Server 2016 以降の必要がある</li><li>AAD ユーザーの How (MFA 方法のセットアップ) が事前に完了している必要がある</li><li>AD FS におけるプライマリ認証、セカンダリ認証のどちらに対しても [Azure MFA サービスでの MFA 認証] を、認証方法として指定することができる</li><li>Windows Server 2016 では、プライマリ認証方法として Azure MFA を使用すると Authenticator のみが利用可能</li></ul><p><a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa">AD FS を使用して Azure AD 多要素認証を認証プロバイダーとして構成する</a><br>-&gt; 構成手順はこちらの情報をご参照ください。</p><h3 id="4-NPS-Server-への-RADIUS-認証時"><a href="#4-NPS-Server-への-RADIUS-認証時" class="headerlink" title="4. NPS Server への RADIUS 認証時"></a>4. NPS Server への RADIUS 認証時</h3><p>こちらは、NPS Server に [NPS 拡張] 機能をインストールし、RADIUS 認証要求を NPS Server にて受け付けた際に MFA 認証を求めるシナリオになります。主なポイントは以下のとおりです。</p><ul><li>NPS Server に [NPS 拡張] 機能を追加でインストールする必要がある</li><li>AAD ユーザーの How (MFA 方法のセットアップ) が事前に完了している必要がある</li><li>AAD ユーザーは、オンプレミス AD から Azure AD Connect (AADC) で同期されている必要がある</li><li>RADIUS 構成におけるパスワードの暗号化方式によって、利用可能な MFA 方法が異なる<br>(PAP の場合はすべての MFA 方法が利用可能、CHAPv2 と EAP の場合は音声電話と Authenticator アプリの通知の2種類が利用可能)</li></ul><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-nps-extension">Azure AD Multi-Factor Authentication と既存のネットワーク ポリシー サーバー (NPS) インフラストラクチャの統合</a><br>-&gt; 構成手順はこちらの情報をご参照ください。</p><h2 id="5-2024-年-9-月リタイア予定-オンプレミスに-MFA-Server-を導入"><a href="#5-2024-年-9-月リタイア予定-オンプレミスに-MFA-Server-を導入" class="headerlink" title="5. (2024 年 9 月リタイア予定) オンプレミスに MFA Server を導入"></a>5. (2024 年 9 月リタイア予定) オンプレミスに MFA Server を導入</h2><p>こちらは、Windows Server に [MFA Server] の機能をインストールし、複数のオンプレミスの認証システムと連携して Azure MFA サービスへのプロキシを行い、MFA 認証を求めるシナリオになります。以下のような認証システムと連携することが可能です。</p><ul><li>AD FS サーバー (3. は AD FS サーバーが直接 Azure MFA サービスと連携しますが、AD FS が MFA 連携先として MFA Server を利用することも可能です)</li><li>LDAP 認証、Active Directory 認証 (クライアントからの LDAP 認証要求を受け取るプロキシとして動作)</li><li>RADIUS 認証 (4. とは違い、RADIUS 認証要求を受け取るプロキシとして動作し、”≒ NPS サーバー” の立ち位置になる)</li><li>IIS 認証</li><li>Windows 認証</li></ul><p>MFA Server 自身が MFA 認証処理を行っているのではなく、ある認証システムと Azure MFA サーバー間の橋渡し、MFA 認証要求のプロキシを行うような立ち位置となっています。MFA サーバーの概要については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfaserver-deploy">Azure Multi-Factor Authentication Server の概要</a> のページもご覧ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>MFA Server は <strong>2019 年 7 月 1 日以降にご利用を開始された AAD テナントではすでにご利用いただけなくなっています</strong>。</p><p>また、上記技術情報にも記載がある通り、2024 年 9 月 30 日にリタイアが予定されています。今後はクラウドである Azure MFA サービスに集約されている流れとなっているため、新規に MFA の実現を検討されるお客様は、1. ～ 4. のシナリオをご検討いただくことになります。</p><p>現在 MFA Server をご利用のお客様は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-migrate-mfa-server-to-azure-mfa">MFA Server から Azure AD Multi-Factor Authentication に移行する</a> の技術情報もご参照ください。</p></div><p>上記内容が Azure MFA サービスのご利用をご検討いただくに際して皆様の参考となりますと幸いです。どちら様も素敵な AAD ライフをお過ごしください！</p><p>ご不明な点等がありましたら、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は 2020 年に公開したものですが、サポートへのお問い合わせ状況などをふまえ、2023 年 6 月時点での最新の情報にアップデートいたしました。&lt;/p</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://jpazureid.github.io/blog/tags/MFA/"/>
    
  </entry>
  
  <entry>
    <title>MFA 認証方法を 変更 / 再登録 / 追加 したい！</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/change-mfa-verification-method/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/change-mfa-verification-method/</id>
    <published>2023-06-21T19:00:00.000Z</published>
    <updated>2023-07-28T06:27:30.943Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は 2020 年に公開したものですが、サポートへのお問い合わせ状況などをふまえ、2023 年 6 月時点での最新の情報にアップデートいたしました。</p></div><p>こんにちは。Azure Identity サポート チームの栗井です。</p><p>弊社サポートチームでは、 Azure Active Directory に関して、以下のようなご要望に関するお問い合わせをよくいただきます。</p><ul><li>スマートフォンを買い替えたので、MFA 認証方法を変更したい。</li><li>スマートフォンを紛失したので、MFA 認証方法を再登録したい。</li><li>社用のスマートフォンに加えて、私用スマートフォンを、MFA 認証方法として追加したい。</li></ul><p>このブログでは、こういったご要望に答えるために、MFA の方法を 変更 / 再登録 / 追加 するための方法と手順をご紹介いたします。</p><p><strong>読者のターゲット:</strong> テナントの管理者。組織内のユーザーが MFA 認証方法の変更 / 再登録 / 追加 が必要となった際にご参照ください。</p><p>操作の手順は、以下の場合ごとに異なるため、それぞれ別項目でご説明します。</p><ul><li>現在登録されているモバイル デバイスで MFA 認証ができる場合 (モバイル デバイスの買い替えや追加など)</li><li>現在登録されているモバイル デバイスで MFA 認証ができない場合 (モバイル デバイスの紛失や故障など)</li></ul><h2 id="現在登録されているモバイル-デバイスで、MFA-認証ができる場合"><a href="#現在登録されているモバイル-デバイスで、MFA-認証ができる場合" class="headerlink" title="現在登録されているモバイル デバイスで、MFA 認証ができる場合"></a>現在登録されているモバイル デバイスで、MFA 認証ができる場合</h2><p>この場合、MFA 認証方法の変更 / 追加は、ユーザー自身の操作のみで行うことができます。管理者側での操作は不要です。ユーザーには以下の方法で、MFA 認証方法の変更 / 追加を行ってもらってください。</p><h3 id="MFA-認証方法の変更-追加手順"><a href="#MFA-認証方法の変更-追加手順" class="headerlink" title="MFA 認証方法の変更 / 追加手順"></a>MFA 認証方法の変更 / 追加手順</h3><p>ユーザーに、任意のデバイスで <a href="https://aka.ms/mfasetup">https://aka.ms/mfasetup</a> にアクセスします。サインインと MFA が要求たら、それぞれ認証を行いましょう。</p><p>以下の画面 (URL: <a href="https://mysignins.microsoft.com/security-info">https://mysignins.microsoft.com/security-info</a>) が表示されます。[+ 方法の追加] を選択してください。画面の表示に従って、新しいモバイル デバイスを、MFA 認証方法として登録しましょう。</p><p><img src="/blog/azure-active-directory/change-mfa-verification-method/figure1.png"></p><h2 id="現在登録されているモバイル-デバイスで、MFA-認証ができない場合"><a href="#現在登録されているモバイル-デバイスで、MFA-認証ができない場合" class="headerlink" title="現在登録されているモバイル デバイスで、MFA 認証ができない場合"></a>現在登録されているモバイル デバイスで、MFA 認証ができない場合</h2><p>この場合、以下のいずれかの方法によって、管理者がユーザーの MFA 認証方法をリセットもしくは変更ください。</p><ol><li>管理者による MFA 認証方法のリセット</li><li>管理者による MFA 認証用電話番号の指定</li></ol><h3 id="1-管理者によるMFA-認証方法のリセット"><a href="#1-管理者によるMFA-認証方法のリセット" class="headerlink" title="1. 管理者によるMFA 認証方法のリセット"></a>1. 管理者によるMFA 認証方法のリセット</h3><p>管理者によって現在の MFA 認証方法をリセットした後、ユーザーが再登録を行う方法です。</p><ol><li><p>特権認証管理者、もしくはグローバル管理者のアカウントで Azure Portal (<a href="https://portal.azure.com/">https://portal.azure.com</a>) へアクセスします。</p></li><li><p>[すべてのサービス] &gt; [Azure Active Directory] &gt; [ユーザー] に移動します。</p></li><li><p>ユーザー一覧から、該当ユーザーの行を選択して開きます。 </p></li><li><p>画面左側のメニューから [認証方法] タブを選択します。</p><p> <img src="/blog/azure-active-directory/change-mfa-verification-method/auth-method-tab.png">  </p></li><li><p>[MFA の再登録が必要] を押下します。</p><p> <img src="/blog/azure-active-directory/change-mfa-verification-method/auth-method-reset.png">  </p></li></ol><p>管理者によって、ユーザーの MFA 認証方法がリセットされたら、ユーザーは MFA 認証方法を再登録する必要があります。前述の「現在登録されているモバイル デバイスで、MFA 認証ができる場合」の手順に従って、新しいデバイスを MFA 認証方法として登録ください。</p><h3 id="2-管理者が直接-MFA-認証用電話番号を指定"><a href="#2-管理者が直接-MFA-認証用電話番号を指定" class="headerlink" title="2. 管理者が直接 MFA 認証用電話番号を指定"></a>2. 管理者が直接 MFA 認証用電話番号を指定</h3><p>管理者は Azure Portal 上で、ユーザーの MFA 認証のための電話番号を直接指定することができます。以下の流れで操作します。</p><p><a href="https://portal.azure.com/">Azure Portal</a> &gt; [Azure Active Directory] &gt; [ユーザー] &gt; (一覧からユーザーを選択) &gt; [認証方法]</p><p>上記ページの [+ 認証方法の追加] から、[電話番号] を選択し、ユーザーのモバイル デバイスの電話番号を追加ください。</p><p><img src="/blog/azure-active-directory/change-mfa-verification-method/figure3.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>電話番号の入力は “+81 8099999999” のように、「国番号の指定が必須」かつ「ハイフン不要」である点にご留意ください。</p><p>[方法の選択] で選択可能な [メール] は、MFA ではなく セルフサービス パスワード リセットの連絡先追加のための項目です。ここでは選択しないでください。</p></div><p><img src="/blog/azure-active-directory/change-mfa-verification-method/figure4.png"></p><p>次回からは、指定した電話番号に MFA の要求が届くようになります。</p><h2 id="例外-テナント管理者の-MFA-認証方法をリセットする必要がある場合"><a href="#例外-テナント管理者の-MFA-認証方法をリセットする必要がある場合" class="headerlink" title="例外: テナント管理者の MFA 認証方法をリセットする必要がある場合"></a>例外: テナント管理者の MFA 認証方法をリセットする必要がある場合</h2><p>MFA 認証方法の再登録には、テナントの管理者による、MFA 認証方法のリセットが必要です。ただし、テナントの管理者自身のモバイル デバイスの紛失および故障などにより、MFA 認証方法の再登録したい場合、上記の手順を進めることができない場合がございます。これは、「Azure Portal、Azure MFA Portal のいずれにも、MFA が必要な設定をしているので、アクセスすることができない！」といった場合です。</p><p>このようなときの、対処法をご案内いたします。</p><h3 id="1-テナントに管理者が複数存在する場合"><a href="#1-テナントに管理者が複数存在する場合" class="headerlink" title="1. テナントに管理者が複数存在する場合"></a>1. テナントに管理者が複数存在する場合</h3><p>MFA 認証方法を再登録する必要がある管理者以外に、別の管理者が存在する場合は、その管理者によって、前述の [管理者による MFA 認証方法のリセット方法] を行います。その後、MFA 認証方法を再登録する必要がある管理者によって、前述の [MFA 認証方法の変更 / 追加手順] の手順を進めます。</p><h3 id="2-Azure-のサブスクリプションをクラウド-ソリューション-プロバイダー-パートナー-CSP-パートナー-からご購入頂いている場合"><a href="#2-Azure-のサブスクリプションをクラウド-ソリューション-プロバイダー-パートナー-CSP-パートナー-からご購入頂いている場合" class="headerlink" title="2. Azure のサブスクリプションをクラウド ソリューション プロバイダー パートナー (CSP パートナー) からご購入頂いている場合"></a>2. Azure のサブスクリプションをクラウド ソリューション プロバイダー パートナー (CSP パートナー) からご購入頂いている場合</h3><p>CSP パートナーのアカウントは、お客様のテナントにアクセスする権限を持っています。CSP パートナーに連絡を取り、お客様のテナントにアクセスができる CSP アカウントによって、前述の [管理者による MFA 認証方法のリセット方法] を行ってもらいましょう。</p><p>その後、MFA 認証方法を再登録する必要がある管理者によって、前述の [MFA 認証方法の変更 / 追加手順] を行ってください。</p><h3 id="3-上記-1-と-2-のいずれにも当てはまらない場合"><a href="#3-上記-1-と-2-のいずれにも当てはまらない場合" class="headerlink" title="3. 上記 1. と 2. のいずれにも当てはまらない場合"></a>3. 上記 1. と 2. のいずれにも当てはまらない場合</h3><p>これは、これまでご紹介した方法がいずれも実行不可能場合のみに行っていただく、最終手段です。テナントのすべてのグローバル管理者がサインイン不可能になった場合には、弊社データセンター側で、管理者の MFA を、一時的に解除いたします。解除には、数営業日いただくことになり、場合によっては解除ができない場合もございます。まずは、弊社サポート チームまでお問い合わせいただければと思います。</p><p>お問い合わせ時には下記の情報を予めお知らせください。</p><ul><li>テナント名 (~.onmicrosoft.com) またはテナント ID</li><li>グローバル管理者の UPN</li><li>状況 (何かしら操作をした日時、操作内容など)</li></ul><p>また併せて、<a href="https://jpazureid.github.io/blog/azure-active-directory/ga-is-locked-out/">グローバル管理者ロールを持つユーザーでサインインできない！</a> の記事もご覧ください。Azure Portal にログインできない場合は、<a href="https://aka.ms/AzurePortalHelp">https://aka.ms/AzurePortalHelp</a> からリクエストを起票することも検討ください。</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul><li>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings">Azure Multi-factor Authentication のユーザー設定の管理</a></li><li>公開情報: <a href="https://support.microsoft.com/ja-jp/office/%e8%bf%bd%e5%8a%a0%e3%81%ae%e7%a2%ba%e8%aa%8d%e6%96%b9%e6%b3%95%e3%82%92%e5%a4%89%e6%9b%b4%e3%81%99%e3%82%8b-956ec8d0-7081-4518-a701-f8414cc20831?ui=ja-JP&rs=ja-JP&ad=JP">追加の確認方法を変更する</a></li><li>サポート ブログ: <a href="https://jpazureid.github.io/blog/azure-active-directory/mfa-reset/">多要素認証 (MFA) のリセット手順</a></li></ul><h2 id="サービスの-URL"><a href="#サービスの-URL" class="headerlink" title="サービスの URL"></a>サービスの URL</h2><ul><li><a href="https://portal.azure.com/">Azure Portal</a></li><li><a href="https://account.activedirectory.windowsazure.com/usermanagement/multifactorverification.aspx">Azure MFA Portal (管理者専用)</a></li><li><a href="https://aka.ms/mfasetup">MFA 認証情報確認 / 登録ページ</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は 2020 年に公開したものですが、サポートへのお問い合わせ状況などをふまえ、2023 年 6 月時点での最新の情報にアップデートいたしました。&lt;/p</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://jpazureid.github.io/blog/tags/MFA/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/</id>
    <published>2023-06-21T16:00:00.000Z</published>
    <updated>2023-07-28T06:27:31.479Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/">https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/</a> の内容を移行したものです。</p><p>また本記事は 2018 年に公開したものですが、サポートへのお問い合わせ状況ならびにエラー画面の変更などをふまえ、2023 年 6 月時点での最新の情報にアップデートいたしました。</p></div><p>こんにちは！ Azure &amp; Identity サポート チームの栗井です。</p><p>今回は Azure AD のテナント制限の機能に関して、よくあるお問い合わせと、その回答をご紹介いたします。</p><h2 id="テナント制限とは"><a href="#テナント制限とは" class="headerlink" title="テナント制限とは"></a>テナント制限とは</h2><p>テナント制限の機能では、ユーザーがアクセス可能な Azure AD テナントを制限することが可能です。</p><p>具体的には、クライアント端末から Azure AD に対する認証の通信をプロキシ経由させ、そのプロキシから送信されるデータに許可対象の Azure AD テナントの情報を付与します。その結果、それ以外の Azure AD テナントへのアクセスがブロックされる動作となります。</p><p>テナント制限の機能の詳細については、以下の公開情報をご参照ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/tenant-restrictions">公開情報: テナント制限を使用して SaaS アプリへのアクセスを管理する - Microsoft Entra | Microsoft Learn</a></li></ul><p>テナント制限によって許可されていないテナントへアクセスを試行すると、下記のように 「ネットワーク管理者によってアクセスがブロックされました」というエラーメッセージが表示されます (エラーコード: AADSTS500021)。</p><p><img src="/blog/azure-active-directory/tenant-restriction/AADSTS500021.png"></p><p>以下にて、テナント制限に関連する FAQ をまとめました。ぜひご参照ください！</p><h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><font color="DeepSkyBlue">Q</font> : テナント制限の機能のライセンス要件はありますか？</p><p><font color = "red">A</font> : テナント制限のご利用には、Azure AD Premium P1 もしくは P2 相当のライセンスが必要です。</p><p>テナント制限に関する公開情報の中では、Azure AD Premium のライセンスが無くとも、利用の状況・条件によってはテナント制限の利用が可能と受け取れる記載が 2020 年までございました。</p><p>この公開情報をもとに 2017 年に発行された日本語でのブログ記事 (現在はアーカイブ済み) においても、ライセンスに関する適切ではない記述がありましたが、 Azure AD Premium のライセンスが必要となります点ご留意ください。</p><p><font color="DeepSkyBlue">Q</font> : Microsoft アカウント (コンシューマー向けアカウント) によるアクセスを制限することは可能ですか。</p><p><font color = "red">A</font> : はい、可能です。この場合は login.live.com 宛への通信に対してヘッダーを設定しますが、 “Restrict-Access-To-Tenants” とは異なるヘッダーを利用します。</p><p>Microsoft アカウントによるアクセスを制限する場合は、”sec-Restrict-Tenant-Access-Policy” ヘッダーに “restrict-msa” という値が含まれるように構成ください。<br>この設定によって、 Microsoft アカウントの認証エンドポイント (login.live.com) へのアクセスがブロックされます。</p><p>アクセス ブロック時のメッセージとエラーコードは下記の通りです。</p><ul><li>メッセージ: “ここからアクセスすることはできません お客様の IT 部門によって承認されていない組織に属するリソースへのアクセスを試みているようです。” </li><li>エラーコード: 80045C4D</li></ul><p><img src="/blog/azure-active-directory/tenant-restriction/80045C4D.png"></p><p><font color="DeepSkyBlue">Q</font> : 制限されるのは Office 365 だけですか？</p><p><font color = "red">A</font>  : いいえ。以下の認証エンドポイントを使用する、すべてのサービス、言い換えますと Azure AD と連携するサービスが制限されます。</p><ul><li>login.microsoftonline.com  </li><li>login.windows.net  </li><li>login.microsoft.com</li></ul><p>例えば Azure ポータル、EA ポータルにアクセスする際も制限されます。また、ゲストユーザーの場合、招待されたテナントではなく、管理元のテナントで認証が行われるため、ゲストユーザーの招待元テナントも、テナント制限で許可する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : (クライアントですが)、テナント制限によってアクセスできないテナントにアクセスできるようにしてほしい。</p><p><font color = "red">A</font> : 接続元のクライアントが利用するプロキシサーバーの設定変更が必要です。プロキシ サーバーを管理している IT 部門へ申請をあげるなどで、テナント制限の許可するリストに該当のテナントを追加してもらってください。</p><p>テナント制限は設定をおこなったプロキシ経由でのアクセスに制限を加えるものですので、プロキシサーバーによる制限を受けないネットワーク環境から接続することでもテナント制限による制御は回避できます。</p><p><font color="DeepSkyBlue">Q</font> : Azure AD 側での設定変更は必要ですか？</p><p><font color = "red">A</font> : いいえ。プロキシの設定のみで、テナント制限が機能します。</p><p><font color="DeepSkyBlue">Q</font> : “Restrict-Access-To-Tenants” に、ワイルドカードは利用できますか？</p><p><font color = "red">A</font> : いいえ。テナント名かテナント ID を不足なく、入力する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : テナント制限で許可をすることができるテナント数に上限はありますか？</p><p><font color = "red">A</font> : テナント制限にて、許可をするテナント数自体には上限は設けられていません。しかし、ヘッダーの長さの上限 (MaxFieldLength) と、リクエストとヘッダーを含めた合計のサイズの上限 (MaxRequestBytes) があるため、多数のディレクトリを追加する場合、この上限を超えないように注意が必要です。</p><h2 id="新機能-テナント間アクセスについて-2023-年-6-月-追記"><a href="#新機能-テナント間アクセスについて-2023-年-6-月-追記" class="headerlink" title="新機能: テナント間アクセスについて (2023 年 6 月 追記)"></a>新機能: テナント間アクセスについて (2023 年 6 月 追記)</h2><p>もし 2023 年の現在においてテナント制限の導入を検討されている場合、2022 年に公開された「テナント間アクセス設定 (Cross-tenant access)」の機能もぜひご検討ください。テナント間アクセスは、組織内のユーザーによる外部テナントへのアクセスを制限する機能です。テナント制限との差別化点としては下記のようなポイントが挙げられます。</p><ul><li><p>テナント間アクセスの設定は、Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) 上の操作ですべて完結します。</p><p>  ※ テナント制限は、Azure ポータルではなくプロキシ側での設定が必要です。</p></li><li><p>テナント間アクセスは、制御対象のユーザーおよびアプリケーションを指定可能です。</p><p>  ※ テナント制限は、プロキシを通過したすべてのアクセスが一律に制御対象となります。</p></li><li><p>テナント間アクセスは、ユーザーによるすべてのアクセスを網羅的に制御可能です。</p><p>  ※ テナント制限は、プロキシを通過しないアクセスを制御することができません。</p></li></ul><p>テナント間アクセスについての詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/cross-tenant-access-overview">Azure AD External Identities を使用したテナント間アクセス</a> の公開情報をぜひご覧ください。ご不明点やご相談事項があれば、ぜひ弊社サポートまでお問い合わせください。</p><p>上記内容が、皆様のご参考になれば幸甚です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Tenant Restrictions" scheme="https://jpazureid.github.io/blog/tags/Tenant-Restrictions/"/>
    
    <category term="テナント制限" scheme="https://jpazureid.github.io/blog/tags/%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90/"/>
    
  </entry>
  
</feed>
